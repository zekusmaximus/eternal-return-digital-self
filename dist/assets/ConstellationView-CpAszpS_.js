const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ThreeJSComponents-DsTkXfxN.js","assets/three-vendor-BSwpqFLI.js","assets/react-vendor-DaKsb8LL.js","assets/node-view-CX8ZmfD4.js","assets/constellation-DYOcMIlB.js","assets/node-view-BvMPabFr.css"])))=>i.map(i=>d[i]);
var I=Object.defineProperty;var O=(c,e,r)=>e in c?I(c,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):c[e]=r;var d=(c,e,r)=>O(c,typeof e!="symbol"?e+"":e,r);import{j as n,_ as S}from"./three-vendor-BSwpqFLI.js";import{u as z,b as s,j as V}from"./react-vendor-DaKsb8LL.js";import{w as A,x as D,d as _}from"./constellation-DYOcMIlB.js";import{v as N,w as y}from"./app-B5tT0hPV.js";const h=class h{constructor(){d(this,"basePositions",{});d(this,"currentPositions",{});d(this,"lastUpdateTime",0);d(this,"updateCallbacks",new Set);d(this,"isUpdating",!1)}static getInstance(){return h.instance||(h.instance=new h),h.instance}setBasePositions(e){this.basePositions={...e},this.currentPositions={...e}}updatePositions(e,r=!1){return this.isUpdating?this.currentPositions:(this.isUpdating=!0,e-this.lastUpdateTime>=.15&&(this.lastUpdateTime=e,Object.keys(this.basePositions).forEach(a=>{const o=this.basePositions[a];if(o)if(r)this.currentPositions[a]=[...o];else{const f=Math.sin(o[0]*.1+e*.02)*.01,i=Math.sin((o[1]+100)*.1+e*.02)*.01,b=Math.sin((o[2]+200)*.1+e*.02)*.01,g=.01,p=Math.min(Math.abs(f),g)*Math.sign(f),m=Math.min(Math.abs(i),g)*Math.sign(i),C=Math.min(Math.abs(b),g)*Math.sign(b),w=[o[0]+p,o[1]+m,o[2]+C];this.currentPositions[a]=w}}),this.updateCallbacks.forEach(a=>{try{a({...this.currentPositions})}catch(o){console.error("Error in position update callback:",o)}})),this.isUpdating=!1,this.currentPositions)}getCurrentPositions(){return{...this.currentPositions}}subscribeToUpdates(e){return this.updateCallbacks.add(e),()=>this.updateCallbacks.delete(e)}reset(){this.basePositions={},this.currentPositions={},this.lastUpdateTime=0,this.updateCallbacks.clear(),this.isUpdating=!1}};d(h,"instance");let L=h;const $=s.lazy(()=>S(()=>import("./ThreeJSComponents-DsTkXfxN.js"),__vite__mapDeps([0,1,2,3,4,5]))),q=()=>n.jsxs("div",{className:"constellation-loading",children:[n.jsx("div",{className:"loading-spinner"}),n.jsx("p",{children:"Generating constellation view..."})]}),B=({onDismiss:c})=>n.jsxs("div",{className:"webgl-error-container",children:[n.jsx("div",{className:"webgl-error-header",children:"WebGL Error Detected"}),n.jsx("div",{className:"webgl-error-message",children:"A graphics rendering error occurred. This may affect the constellation display. You can continue using the application in text-only mode."}),n.jsx("div",{className:"webgl-error-actions",children:n.jsx("button",{className:"webgl-error-action",onClick:c,children:"Continue in Text Mode"})})]}),Q=()=>{const c=z(),[e,r]=s.useState(null),u=V(A),a=V(D),o=!1,f=s.useRef(null),i=s.useRef(null);s.useEffect(()=>(console.log("[ConstellationView] Component mounted"),N.registerViewMount("constellation",!0),()=>{console.log("[ConstellationView] Component unmounting"),N.registerViewMount("constellation",!1),i.current&&(console.log(`[ConstellationView] Unmounting, disposing WebGL context: ${i.current}`),y.disposeContext(i.current),i.current=null)}),[]);const b=s.useMemo(()=>a.map(t=>({source:t.start,target:t.end})),[a]),g=s.useMemo(()=>a.map(t=>({source:t.start,target:t.end})),[a]),p=s.useRef(L.getInstance()),[m,C]=s.useState({}),w=s.useMemo(()=>{console.log("Calculating positions for nodes:",u.length);const t={};return u.length===0?(console.warn("No nodes to position"),t):(u.forEach((l,x)=>{const P=u.length,M=15,j=2/P,W=Math.PI*(3-Math.sqrt(5)),E=x*j-1+j/2,v=Math.sqrt(1-E*E),G=x*W,R=Math.cos(G)*v*M,k=Math.sin(G)*v*M;t[l.id]=[R,E*M,k]}),p.current.setBasePositions(t),t)},[u]);s.useEffect(()=>{const t=p.current.subscribeToUpdates(l=>{C(l)});return()=>{t()}},[]);const T=Object.keys(m).length>0?m:w,U=s.useCallback(t=>{if(i.current){console.log(`[ConstellationView] Context already registered: ${i.current}`);return}const l=y.registerContext(t,"constellation",2,()=>{console.log("[ConstellationView] Suspending WebGL rendering")},()=>{console.log("[ConstellationView] Resuming WebGL rendering")});i.current=l,console.log(`[ConstellationView] Registered WebGL context: ${l}`)},[]);return s.useEffect(()=>{const t=l=>{const{contextId:x,type:P}=l.detail;(i.current&&i.current===x||P==="constellation")&&(console.error("[ConstellationView] Received WebGL context loss event"),r(new Error("WebGL context lost - application event")))};return window.addEventListener("webgl-context-loss",t),()=>{window.removeEventListener("webgl-context-loss",t)}},[]),n.jsxs("div",{className:"constellation-container",children:[n.jsx(s.Suspense,{fallback:n.jsx(q,{}),children:n.jsx($,{nodes:u,nodePositions:T,connections:g,mappedConnections:b,instancedMeshRef:f,isInitialChoicePhase:o,onWebGLContextCreated:U,onWebGLError:t=>{console.error("[ConstellationView] WebGL error reported:",t),r(t)},positionSynchronizer:p.current})}),e&&n.jsx(B,{onDismiss:()=>{c(_("reading")),r(null)}})]})};export{Q as default};
//# sourceMappingURL=ConstellationView-CpAszpS_.js.map
