const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/markdown-vendor-DLF9SFWa.js","assets/three-vendor-CMUj8LmA.js","assets/react-vendor-CLXXY-Bz.js","assets/MiniConstellation-ue-DY_FZ.js","assets/constellation-9EXX-9rV.js","assets/node-view-BVBDDUA3.js","assets/node-view-_8ZIE8wg.css","assets/MarginaliaSidebar-ajBWTPjr.js","assets/NarramorphRenderer-BHn5tT2_.js","assets/narramorph-DAUxO-pP.js","assets/narramorph-DivzNTyX.css"])))=>i.map(i=>d[i]);
import{j as t,_ as L}from"./three-vendor-CMUj8LmA.js";import{b as s,c as E}from"./react-vendor-CLXXY-Bz.js";import{u as D}from"./narramorph-DAUxO-pP.js";import{v as R,w as G}from"./app-wopjO8iA.js";import{q as J,a as B,w as O,g as W,A as F,v as q,B as U}from"./constellation-9EXX-9rV.js";import"./node-view-BVBDDUA3.js";class K extends s.Component{constructor(n){super(n),this.state={hasError:!1,error:null}}static getDerivedStateFromError(n){return{hasError:!0,error:n}}componentDidCatch(n,r){console.error("ErrorBoundary caught an error:",n),console.error("Component stack:",r.componentStack)}render(){return this.state.hasError?this.props.fallback:this.props.children}}const Q=({children:o,transformations:n,nodeId:r})=>{const[e,x]=s.useState(0),[m,u]=s.useState(!1);s.useEffect(()=>{if(n.length!==e){if(n.length>e){u(!0);const l=setTimeout(()=>{u(!1)},2e3);return()=>clearTimeout(l)}x(n.length)}},[n.length,e]);const w=()=>{if(n.length===0)return"";const l={};n.forEach(g=>{l[g.type]=(l[g.type]||0)+1});const c=[];return l.replace&&c.push(`${l.replace} replacements`),l.emphasize&&c.push(`${l.emphasize} emphasis`),l.expand&&c.push(`${l.expand} expansions`),l.fragment&&c.push(`${l.fragment} fragmentations`),l.metaComment&&c.push(`${l.metaComment} comments`),c.join(", ")};return t.jsxs("div",{className:`simple-transformation-container ${m?"newly-transformed":""}`,"data-transformation-count":n.length,"data-node-id":r,children:[n.length>0&&t.jsxs("div",{className:`transformation-indicator ${m?"active":""}`,title:w(),children:[t.jsx("span",{className:"transformation-count",children:n.length}),m&&n.length>e&&t.jsxs("span",{className:"transformation-change",children:["+",n.length-e]})]}),t.jsx("div",{className:"simple-transformation-content",children:o}),m&&t.jsx("div",{className:"transformation-overlay","aria-hidden":"true"})]})},X=(o,n)=>{if(!o||!n.length)return o;let r=o;const e=[...n].sort((x,m)=>{const u={high:3,medium:2,low:1},w=u[x.priority||"medium"]||2;return(u[m.priority||"medium"]||2)-w});for(const x of e){const{type:m,selector:u,replacement:w,emphasis:l}=x;if(u)try{switch(m){case"replace":{if(w){const g=`<span class="text-transformation text-replaced" data-transform-type="replace">${w}</span>`;r=r.replace(new RegExp(u,"g"),g)}break}case"emphasize":{const c=l||"color",g=`<span class="text-transformation text-emphasis text-emphasis-${c}" data-transform-type="emphasize" data-emphasis="${c}">${u}</span>`;r=r.replace(new RegExp(u,"g"),g);break}case"expand":{const c=`<span class="text-transformation text-expanded" data-transform-type="expand">${u}</span>`;r=r.replace(new RegExp(u,"g"),c);break}case"fragment":{const c=`<span class="text-transformation text-fragmented" data-transform-type="fragment">${u}</span>`;r=r.replace(new RegExp(u,"g"),c);break}case"metaComment":{const c=`<span class="text-transformation text-commented" data-transform-type="metaComment">${u}</span>`;r=r.replace(new RegExp(u,"g"),c);break}}}catch(c){console.error(`[SimpleTextRenderer] Error applying transformation ${m}:`,c)}}return r},Y=s.memo(({nodeId:o,onRenderComplete:n,onVisibilityChange:r})=>{const{node:e,transformedContent:x,appliedTransformations:m}=D(o),[u,w]=s.useState(""),[l,c]=s.useState(!0),[g,y]=s.useState(!0),C=s.useRef(null),p=s.useRef(null),[S,v]=s.useState(0);return E(a=>a.reader.path),s.useEffect(()=>{if(e!=null&&e.currentContent){console.log(`[SimpleTextRenderer] Processing content for node: ${e.id}, length: ${e.currentContent.length}`),y(!0);const a=x||e.currentContent;requestAnimationFrame(()=>{const b=X(a,m);w(b),v(N=>N+1),y(!1),n&&(console.log(`[SimpleTextRenderer] Render complete for node: ${e.id}`),setTimeout(n,50)),r&&r(!0)})}},[e==null?void 0:e.currentContent,e==null?void 0:e.id,x,m,n,r]),s.useEffect(()=>{if(C.current)return p.current&&p.current.disconnect(),p.current=new IntersectionObserver(a=>{const b=a[0];if(!b)return;const N=b.isIntersecting;l!==N&&(c(N),r&&r(N))},{root:null,rootMargin:"0px",threshold:.1}),p.current.observe(C.current),()=>{var a;(a=p.current)==null||a.disconnect()}},[l,r]),!e||!e.currentContent?t.jsx("div",{className:"simple-renderer-loading",children:"Loading narrative content..."}):t.jsxs("div",{className:`simple-renderer-container ${l?"is-visible":""}`,"data-node-id":e.id,"data-render-count":S,style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px"},children:[t.jsxs(Q,{transformations:m,nodeId:e.id,children:[g&&t.jsxs("div",{className:"simple-renderer-loading",style:{padding:"20px 0"},children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Preparing narrative content..."})]}),t.jsx("div",{ref:C,className:"simple-renderer-content","data-transformations-count":m.length,style:{display:"block",visibility:"visible",opacity:1},children:t.jsx("div",{dangerouslySetInnerHTML:{__html:u},className:"content-inner"})})]}),!1]})});function V(o){return"memory"in o}const T=s.lazy(()=>(console.log("[NodeView] Loading ReactMarkdown component"),L(()=>import("./markdown-vendor-DLF9SFWa.js").then(o=>o.i),__vite__mapDeps([0,1,2])).then(o=>(console.log("[NodeView] ReactMarkdown component loaded"),o)))),Z=s.lazy(()=>L(()=>import("./MiniConstellation-ue-DY_FZ.js"),__vite__mapDeps([3,1,2,4,5,6]))),ee=s.lazy(()=>L(()=>import("./MarginaliaSidebar-ajBWTPjr.js"),__vite__mapDeps([7,1,2,4,5,6]))),k=L(()=>import("./NarramorphRenderer-BHn5tT2_.js"),__vite__mapDeps([8,1,2,9,4,10])),te=s.lazy(()=>(console.log("[NodeView] Loading NarramorphRenderer component"),k.then(o=>(console.log("[NodeView] NarramorphRenderer component loaded"),o)))),M=L(()=>import("./markdown-vendor-DLF9SFWa.js").then(o=>o.a),__vite__mapDeps([0,1,2])).then(o=>(console.log("[NodeView] remark-gfm plugin loaded"),o.default)),ne=!1,re=()=>t.jsxs("div",{className:"content-loading",children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Loading content..."})]}),H=()=>t.jsx("div",{className:"side-component-loading"}),de=()=>{const o=J(),n=E(B),r=E(O),e=E(i=>n?W(i,n):null),x=s.useMemo(()=>R.getUniqueViewKey(),[]),[m,u]=s.useState(!1),[w,l]=s.useState(!1),[c,g]=s.useState(ne),[y,C]=s.useState(!0),p=s.useRef(null),[S,v]=s.useState({loadStarted:!1,contentLoaded:!1,renderStarted:!1,narramorphActivated:!1,visibilityIssue:!1,errorOccurred:!1});s.useEffect(()=>{if(r==="reading"){R.registerViewMount("reading",!0);const i=G.checkWebGLSupport();C(!i.isLowEndDevice),console.log(`[NodeView] Mounted reading view, WebGL available: ${y}`)}return()=>{r==="reading"&&(R.registerViewMount("reading",!1),console.log("[NodeView] Unmounted reading view"))}},[r,y]),s.useEffect(()=>(n&&console.time(`node-${n}-visibility`),()=>{n&&console.timeEnd(`node-${n}-visibility`)}),[n]);const[a,b]=s.useState({transitionTime:0,lastViewMode:r,transitionCount:0,renderCount:0}),[N,$]=s.useState({jsHeapSizeLimit:0,totalJSHeapSize:0,usedJSHeapSize:0,timestamp:0});s.useEffect(()=>{if(a.lastViewMode!==r){const i=Date.now();if(console.log(`[NodeView] View transition: ${a.lastViewMode} -> ${r} at ${i}`),b(d=>({...d,lastViewMode:r,transitionTime:i,transitionCount:d.transitionCount+1})),v(d=>({...d,loadStarted:!1,contentLoaded:!1,renderStarted:!1,narramorphActivated:!1,visibilityIssue:!1,errorOccurred:!1})),V(performance)&&performance.memory){const d=performance.memory;$({jsHeapSizeLimit:d.jsHeapSizeLimit,totalJSHeapSize:d.totalJSHeapSize,usedJSHeapSize:d.usedJSHeapSize,timestamp:i}),console.log("[NodeView] Memory usage at transition:",{usedHeap:Math.round(d.usedJSHeapSize/(1024*1024))+"MB",totalHeap:Math.round(d.totalJSHeapSize/(1024*1024))+"MB",limit:Math.round(d.jsHeapSizeLimit/(1024*1024))+"MB"})}}b(i=>({...i,renderCount:i.renderCount+1}))},[r,a.lastViewMode]),s.useEffect(()=>{n&&(!(e!=null&&e.content)||!(e!=null&&e.currentContent))&&(console.log(`[NodeView] Loading content for node: ${n}`,{viewMode:r,transitionCount:a.transitionCount,timeElapsed:Date.now()-a.transitionTime+"ms"}),v(i=>({...i,loadStarted:!0})),o(F(n))),e!=null&&e.currentContent&&(console.log(`[NodeView] Content loaded for node: ${n}`,{contentLength:e.currentContent.length,visitCount:e.visitCount,timeElapsed:Date.now()-a.transitionTime+"ms"}),v(i=>({...i,contentLoaded:!0})),(e.currentContent.includes("[object Object]")||e.currentContent.includes("undefined")||e.currentContent.length<10)&&console.error("[NodeView] Possible content corruption detected:",{contentStart:e.currentContent.substring(0,100),contentLength:e.currentContent.length}))},[n,e,o,r,a.transitionCount,a.transitionTime]),s.useEffect(()=>{n&&o(q(n))},[n,o]),s.useEffect(()=>{if(e!=null&&e.currentContent){console.log(`[NodeView] Preparing to activate Narramorph for node: ${e.id}`,{viewMode:r,timeElapsed:Date.now()-a.transitionTime+"ms",contentLength:e.currentContent.length}),v(h=>({...h,renderStarted:!0}));let i=!1;console.log("[NodeView] Preloading NarramorphRenderer component"),k.then(()=>{if(i=!0,console.log("[NodeView] NarramorphRenderer preload complete"),e!=null&&e.id&&(console.log(`[NodeView] Activating Narramorph renderer for node: ${e.id} after preload`),u(!0),v(h=>({...h,narramorphActivated:!0})),p.current)){const h=p.current.getBoundingClientRect();console.log("[NodeView] Post-preload container dimensions:",{width:h.width,height:h.height,display:window.getComputedStyle(p.current).display,visibility:window.getComputedStyle(p.current).visibility})}}).catch(h=>{console.error("[NodeView] Error preloading NarramorphRenderer:",h),g(!0)});const d=setTimeout(()=>{if(p.current){console.log("[NodeView] Force checking content visibility");const h=p.current.offsetParent!==null,f=p.current.getBoundingClientRect(),j=window.getComputedStyle(p.current);console.log("[NodeView] Content visibility check:",{isVisible:h,width:f.width,height:f.height,display:j.display,visibility:j.visibility,zIndex:j.zIndex,position:j.position,opacity:j.opacity,componentLoaded:i}),(!h||f.width===0||f.height===0)&&(console.warn("[NodeView] Content invisible after rendering - forcing simple renderer"),g(!0),v(A=>({...A,visibilityIssue:!0})))}},1500);return()=>clearTimeout(d)}},[e==null?void 0:e.currentContent,e==null?void 0:e.id,r,a.transitionTime]),s.useEffect(()=>{const i=d=>{var h;if(d.message&&(d.message.includes("WebGL context lost")||d.message.includes("THREE.WebGLRenderer"))&&(console.error("[NodeView] WebGL context loss detected!",{message:d.message,stack:((h=d.error)==null?void 0:h.stack)||"No stack trace",viewMode:r,timeElapsed:Date.now()-a.transitionTime+"ms",renderCount:a.renderCount}),l(!0),u(!1),v(f=>({...f,errorOccurred:!0})),V(performance)&&performance.memory)){const f=performance.memory;$({jsHeapSizeLimit:f.jsHeapSizeLimit,totalJSHeapSize:f.totalJSHeapSize,usedJSHeapSize:f.usedJSHeapSize,timestamp:Date.now()}),console.log("[NodeView] Memory usage at WebGL error:",{usedHeap:Math.round(f.usedJSHeapSize/1048576)+"MB",totalHeap:Math.round(f.totalJSHeapSize/1048576)+"MB",limit:Math.round(f.jsHeapSizeLimit/1048576)+"MB"})}};return window.addEventListener("error",i),()=>{window.removeEventListener("error",i)}},[r,a.renderCount,a.transitionTime]);const z=()=>{o(U())};if(r!=="reading"||!e)return null;const _=`${e.character.toLowerCase()}-theme`,I=()=>e.temporalValue<=3?"past-indicator":e.temporalValue<=6?"present-indicator":"future-indicator",P=()=>e.currentContent?t.jsxs("div",{ref:p,className:`content-container ${e.currentState}`,"data-content-loaded":"true","data-node-id":e.id,"data-visit-count":e.visitCount,style:{position:"relative",visibility:"visible",display:"block"},children:[c||!y?t.jsx(Y,{nodeId:e.id,onRenderComplete:()=>{console.log("[NodeView] SimpleTextRenderer completed rendering"),v(i=>({...i,visibilityIssue:!1}))},onVisibilityChange:i=>{console.log(`[NodeView] Content visibility changed to: ${i?"visible":"hidden"}`),v(d=>({...d,visibilityIssue:!i}))}},`simple-${e.id}-${e.visitCount}`):t.jsx(s.Suspense,{fallback:t.jsx(re,{}),children:m&&!w?t.jsx(K,{fallback:t.jsxs("div",{className:"fallback-content",style:{visibility:"visible",display:"block"},children:[t.jsx("p",{className:"error-notice",children:"Advanced rendering unavailable - showing basic content"}),t.jsx(T,{remarkPlugins:[()=>M],children:e.currentContent})]}),children:t.jsx("div",{style:{minHeight:"200px",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(te,{nodeId:e.id,onVisibilityChange:i=>{console.log(`[NodeView] Content visibility changed to: ${i?"visible":"hidden"}`),v(d=>({...d,visibilityIssue:!i})),!i&&S.narramorphActivated&&(console.warn("[NodeView] Content disappeared - switching to simple renderer"),g(!0))}},`narramorph-${e.id}-${e.visitCount}`)})}):t.jsxs("div",{style:{visibility:"visible",display:"block",position:"relative",minHeight:"100px"},children:[t.jsxs("div",{className:"content-loading",style:{marginBottom:"10px"},children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Preparing content..."})]}),t.jsx(T,{remarkPlugins:[()=>M],children:e.currentContent},`markdown-${e.id}-${e.visitCount}`)]})}),t.jsxs("div",{className:"debug-indicator",children:[t.jsx("div",{className:`status-dot ${S.contentLoaded?"status-green":"status-red"}`,title:"Content loaded"}),t.jsx("div",{className:`status-dot ${S.narramorphActivated?"status-green":"status-yellow"}`,title:"Narramorph active"}),t.jsx("div",{className:`status-dot ${S.errorOccurred?"status-red":"status-green"}`,title:"No errors"}),t.jsx("div",{className:`status-dot ${S.visibilityIssue?"status-red":"status-green"}`,title:"Content visible"}),t.jsx("div",{className:`status-dot ${c?"status-blue":"status-yellow"}`,title:"Simple renderer"}),t.jsx("div",{className:`status-dot ${y?"status-green":"status-red"}`,title:"WebGL available"}),t.jsxs("div",{className:"debug-metrics",children:[t.jsxs("span",{title:"View transition count",children:["T:",a.transitionCount]}),t.jsxs("span",{title:"Render count",children:["R:",a.renderCount]}),N.usedJSHeapSize>0&&t.jsxs("span",{title:"Memory usage",children:["M:",Math.round(N.usedJSHeapSize/(1024*1024)),"MB"]})]})]})]}):t.jsx("div",{className:"node-loading",children:t.jsx("span",{children:"Loading narrative fragment..."})});return t.jsxs("div",{className:`node-view-container ${_}`,children:[t.jsx("div",{className:`temporal-indicator ${I()}`}),t.jsxs("div",{className:"node-header",children:[t.jsx("h1",{children:e.title}),t.jsxs("div",{className:"node-metadata",children:[t.jsx("span",{className:"node-character",children:e.character}),t.jsx("span",{className:"node-state",children:e.currentState}),t.jsxs("span",{className:"node-visits",children:["Visits: ",e.visitCount]})]})]}),t.jsx("div",{className:"node-content force-visible",style:{position:"relative"},children:P()}),t.jsx("div",{className:"node-navigation",children:t.jsx("button",{onClick:z,className:"navigation-button",children:"Return to Constellation"})}),t.jsx("div",{className:"mini-constellation",children:t.jsx(s.Suspense,{fallback:t.jsx(H,{}),children:t.jsx(Z,{currentNodeId:e.id})})}),t.jsx(s.Suspense,{fallback:t.jsx(H,{}),children:t.jsx(ee,{nodeId:e.id,strangeAttractors:e.strangeAttractors})})]},x)};export{de as default};
//# sourceMappingURL=NodeView-DAT5rllo.js.map
