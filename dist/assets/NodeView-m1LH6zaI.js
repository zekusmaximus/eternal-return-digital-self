const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/markdown-vendor-Bfyu7to_.js","assets/three-vendor-rJ5vKMTC.js","assets/react-vendor-DaKsb8LL.js","assets/MiniConstellation-B21NH0sn.js","assets/constellation-CzSJAdlk.js","assets/node-view-XdiLjT_l.js","assets/node-view-CrwFC8Ay.css","assets/MarginaliaSidebar-CTlZkFAr.js","assets/NarramorphRenderer-D8aPU9Cz.js","assets/narramorph-BlMiJuN1.js","assets/narramorph-DivzNTyX.css"])))=>i.map(i=>d[i]);
import{j as t,_ as T}from"./three-vendor-rJ5vKMTC.js";import{b as n,u as X,j as k}from"./react-vendor-DaKsb8LL.js";import{u as Y,i as Z,f as J}from"./narramorph-BlMiJuN1.js";import{C as O,D as B,a as ee,x as te,g as ne,E as re,v as ie,F as se,G as oe}from"./constellation-CzSJAdlk.js";import{v as ae}from"./app-CJGXHHib.js";import{u as ce}from"./node-view-XdiLjT_l.js";class le extends n.Component{constructor(s){super(s),this.state={hasError:!1,error:null}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,l){console.error("ErrorBoundary caught an error:",s),console.error("Component stack:",l.componentStack)}render(){return this.state.hasError?this.props.fallback:this.props.children}}const de=({children:o,transformations:s,nodeId:l})=>{const[e,C]=n.useState(0),[g,y]=n.useState(!1),[v,N]=n.useState("");n.useEffect(()=>{const c=s.map(r=>`${r.type}-${r.selector||"no-selector"}-${JSON.stringify(r)}`).sort().join("|");if(c!==v)if(s.length>e){y(!0);const r=setTimeout(()=>{y(!1)},2e3);return C(s.length),N(c),()=>clearTimeout(r)}else C(s.length),N(c)},[s,v,e]);const S=()=>{if(s.length===0)return"";const c={};s.forEach(f=>{c[f.type]=(c[f.type]||0)+1});const r=[];return c.replace&&r.push(`${c.replace} replacements`),c.emphasize&&r.push(`${c.emphasize} emphasis`),c.expand&&r.push(`${c.expand} expansions`),c.fragment&&r.push(`${c.fragment} fragmentations`),c.metaComment&&r.push(`${c.metaComment} comments`),r.join(", ")};return t.jsxs("div",{className:`simple-transformation-container ${g?"newly-transformed":""}`,"data-transformation-count":s.length,"data-node-id":l,children:[s.length>0&&t.jsxs("div",{className:`transformation-indicator ${g?"active":""}`,title:S(),children:[t.jsx("span",{className:"transformation-count",children:s.length}),g&&s.length>e&&t.jsxs("span",{className:"transformation-change",children:["+",s.length-e]})]}),t.jsx("div",{className:"simple-transformation-content",children:o}),g&&t.jsx("div",{className:"transformation-overlay","aria-hidden":"true"})]})};function ue({nodeId:o,onRenderComplete:s,onVisibilityChange:l}){const{node:e,transformedContent:C,appliedTransformations:g}=Y(o),[y,v]=n.useState(""),[N,S]=n.useState(!0),[c,r]=n.useState(!0),[f,x]=n.useState(!1),[R,L]=n.useState(0),p=n.useRef(null),w=n.useRef(!1),j=X();return k(h=>h.reader.path),n.useEffect(()=>{w.current=!1},[e==null?void 0:e.id]),n.useEffect(()=>{if(e!=null&&e.currentContent||e!=null&&e.originalContent){r(!0),x(!1);try{const h=e.originalContent||e.currentContent||"";if(Z(h))if(x(!0),e.originalContent&&e.originalContent!==h){j(O(e.id));return}else{v("⚠️ Content temporarily unavailable. Please refresh to restore."),r(!1);return}const V=J(C||h);v(V),j(B(e.id)),L(m=>m+1),r(!1),S(!0),w.current||(w.current=!0,s&&setTimeout(s,10),l&&l(!0))}catch(h){console.error("[SimpleTextRenderer] Error processing content:",h),x(!0),v("❌ Content processing error. Please refresh to restore."),r(!1)}}},[e==null?void 0:e.currentContent,e==null?void 0:e.originalContent,e==null?void 0:e.id,C,j,s,l]),!e||!e.currentContent?t.jsx("div",{className:"simple-renderer-loading",children:"Loading narrative content..."}):t.jsxs("div",{className:`simple-renderer-container ${N?"is-visible":""}`,"data-node-id":e.id,"data-render-count":R,style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px"},children:[t.jsxs(de,{transformations:g,nodeId:e.id,children:[c&&t.jsxs("div",{className:"simple-renderer-loading",style:{padding:"20px 0"},children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Preparing narrative content..."})]}),f&&t.jsxs("div",{className:"content-corruption-warning",style:{padding:"15px",margin:"10px 0",backgroundColor:"#fff3cd",border:"1px solid #ffeeba",borderRadius:"4px",color:"#856404"},children:[t.jsx("strong",{children:"⚠️ Content Recovery Mode"}),t.jsx("p",{children:"Content corruption detected. Attempting recovery..."})]}),t.jsx("div",{ref:p,className:"simple-renderer-content","data-transformations-count":g.length,"data-corruption-detected":f,style:{display:"block",visibility:"visible",opacity:f?.7:1},children:t.jsx("div",{dangerouslySetInnerHTML:{__html:y},className:"content-inner"})})]}),!1]})}function I(o){return"memory"in o}const P=n.lazy(()=>(console.log("[NodeView] Loading ReactMarkdown component"),T(()=>import("./markdown-vendor-Bfyu7to_.js").then(o=>o.i),__vite__mapDeps([0,1,2])).then(o=>(console.log("[NodeView] ReactMarkdown component loaded"),o)))),pe=n.lazy(()=>T(()=>import("./MiniConstellation-B21NH0sn.js"),__vite__mapDeps([3,1,2,4,5,6]))),me=n.lazy(()=>T(()=>import("./MarginaliaSidebar-CTlZkFAr.js"),__vite__mapDeps([7,1,2,4,5,6]))),G=T(()=>import("./NarramorphRenderer-D8aPU9Cz.js"),__vite__mapDeps([8,1,2,9,4,10])),fe=n.lazy(()=>(console.log("[NodeView] Loading NarramorphRenderer component"),G.then(o=>(console.log("[NodeView] NarramorphRenderer component loaded"),o)))),D=T(()=>import("./markdown-vendor-Bfyu7to_.js").then(o=>o.a),__vite__mapDeps([0,1,2])).then(o=>(console.log("[NodeView] remark-gfm plugin loaded"),o.default)),he=()=>t.jsxs("div",{className:"content-loading",children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Loading content..."})]}),A=()=>t.jsx("div",{className:"side-component-loading"}),Ne=()=>{var H;const o=ce(),s=k(ee),l=k(te),e=k(i=>s?ne(i,s):null),C=n.useMemo(()=>ae.getUniqueViewKey(),[]),[g,y]=n.useState(!1),[v,N]=n.useState(!1),[S,c]=n.useState(!0),r=n.useRef(null),f=n.useRef(!1),x=n.useRef(null),R=n.useRef(!1),L=n.useRef(null),[p,w]=n.useState({transitionTime:Date.now(),lastViewMode:l,transitionCount:0,renderCount:0}),[j,h]=n.useState({jsHeapSizeLimit:0,totalJSHeapSize:0,usedJSHeapSize:0,timestamp:0}),M=n.useCallback(i=>{if(console.log(`[NodeView] Content visibility changed to: ${i?"visible":"hidden"}`),!i&&r.current){console.warn("[NodeView] Forcing content visibility after hidden state detected"),r.current.style.display="block",r.current.style.visibility="visible",r.current.style.opacity="1";return}},[]),[V,m]=n.useState({loadStarted:!1,contentLoaded:!1,renderStarted:!1,narramorphActivated:!1,visibilityIssue:!1,errorOccurred:!1}),F=n.useCallback(()=>{if(f.current){console.log("[NodeView] Skipping duplicate onRenderComplete call");return}f.current=!0,console.log("[NodeView] SimpleTextRenderer completed rendering"),r.current&&(console.log("[NodeView] Forcing container visibility after render complete"),r.current.style.display="block",r.current.style.visibility="visible",r.current.style.opacity="1"),m(i=>({...i,visibilityIssue:!1})),setTimeout(()=>{if(r.current){const i=r.current.offsetParent!==null&&window.getComputedStyle(r.current).display!=="none"&&window.getComputedStyle(r.current).visibility!=="hidden";console.log(`[NodeView] Post-render visibility check: ${i?"visible":"not visible"}`),i||(console.warn("[NodeView] Content became invisible after render - forcing visibility"),r.current.style.display="block",r.current.style.visibility="visible",r.current.style.opacity="1")}},500)},[]);n.useEffect(()=>{s!==x.current&&(f.current=!1,x.current=s,R.current=!1)},[s]),n.useEffect(()=>{if(p.lastViewMode!==l){const i=Date.now();if(console.log(`[NodeView] View transition: ${p.lastViewMode} -> ${l} at ${i}`),w(a=>({...a,lastViewMode:l,transitionTime:i,transitionCount:a.transitionCount+1,renderCount:a.renderCount+1})),m({loadStarted:!1,contentLoaded:!1,renderStarted:!1,narramorphActivated:!1,visibilityIssue:!1,errorOccurred:!1}),I(performance)&&performance.memory){const a=performance.memory;h({jsHeapSizeLimit:a.jsHeapSizeLimit,totalJSHeapSize:a.totalJSHeapSize,usedJSHeapSize:a.usedJSHeapSize,timestamp:i})}}else w(i=>({...i,renderCount:i.renderCount+1}))},[l,p.lastViewMode]),n.useEffect(()=>{s&&!(e!=null&&e.content)&&(console.log(`[NodeView] Loading content for node: ${s}`,{viewMode:l}),m(a=>({...a,loadStarted:!0})),o(re(s)))},[s,o,l,e==null?void 0:e.content]);const b=((H=e==null?void 0:e.currentContent)==null?void 0:H.length)||0,_=n.useMemo(()=>e!=null&&e.currentContent?J(e.currentContent):"",[e==null?void 0:e.currentContent]),z=n.useMemo(()=>e!=null&&e.currentContent?e.currentContent.includes("[object Object]")||e.currentContent.includes("undefined")||e.currentContent.length<10:!1,[e==null?void 0:e.currentContent]),$=n.useMemo(()=>{var i;return((i=e==null?void 0:e.currentContent)==null?void 0:i.substring(0,50))||"NO CONTENT"},[e==null?void 0:e.currentContent]);n.useEffect(()=>{if(e!=null&&e.id&&x.current===s){const i=b>0;console.log(`[NodeView] Content processed for node: ${s}`,{hasContent:i,visitCount:e.visitCount,contentLength:b,contentPreview:$,enhancedContentExists:!!e.enhancedContent,contentExists:!!e.content}),m(a=>({...a,contentLoaded:i})),i&&z&&console.error("[NodeView] Possible content corruption detected:",{contentStart:$,contentLength:b})}},[s,e==null?void 0:e.id,e==null?void 0:e.visitCount,e==null?void 0:e.content,e==null?void 0:e.enhancedContent,b,$,z]),n.useEffect(()=>{if(e!=null&&e.id&&b>0&&!R.current){console.log(`[NodeView] Preparing to activate Narramorph for node: ${e.id}`,{viewMode:l,hasContent:b>0}),m(d=>({...d,renderStarted:!0})),R.current=!0;let i=!1;console.log("[NodeView] Preloading NarramorphRenderer component"),G.then(()=>{if(i=!0,console.log("[NodeView] NarramorphRenderer preload complete"),e!=null&&e.id&&(console.log(`[NodeView] Activating Narramorph renderer for node: ${e.id} after preload`),y(!0),m(d=>({...d,narramorphActivated:!0})),r.current)){const d=r.current.getBoundingClientRect();console.log("[NodeView] Post-preload container dimensions:",{width:d.width,height:d.height,display:window.getComputedStyle(r.current).display,visibility:window.getComputedStyle(r.current).visibility})}}).catch(d=>{console.error("[NodeView] Error preloading NarramorphRenderer:",d),c(!0)});const a=setTimeout(()=>{if(r.current){console.log("[NodeView] Force checking content visibility");const d=r.current.offsetParent!==null,u=r.current.getBoundingClientRect(),E=window.getComputedStyle(r.current);console.log("[NodeView] Content visibility check:",{isVisible:d,width:u.width,height:u.height,display:E.display,visibility:E.visibility,zIndex:E.zIndex,position:E.position,opacity:E.opacity,componentLoaded:i}),(!d||u.width===0||u.height===0)&&(console.warn("[NodeView] Content invisible after rendering - forcing simple renderer"),c(!0),m(Q=>({...Q,visibilityIssue:!0})))}},1500);return()=>clearTimeout(a)}},[b,e==null?void 0:e.id,l]),n.useEffect(()=>{if(!(e!=null&&e.id)||e.id===L.current)return;o(ie(e.id));const i=e.currentContent??"",a=e.title??"",d=i.replace(/<[^>]*>/g,"").replace(/\s+/g," ").trim().slice(0,100);o(se({id:e.id,title:a,synopsis:d})),L.current=e.id},[o,e==null?void 0:e.id]),n.useEffect(()=>{e!=null&&e.id&&(e!=null&&e.currentContent)&&(o(B(e.id)),e.transformationState==="corrupted"&&e.originalContent&&(console.warn(`[NodeView] Content corruption detected for node ${e.id}, initiating recovery`),o(O(e.id))))},[e==null?void 0:e.id,e==null?void 0:e.currentContent,e==null?void 0:e.transformationState,e==null?void 0:e.originalContent,o]),n.useEffect(()=>{const i=a=>{var d;if(a.message&&(a.message.includes("WebGL context lost")||a.message.includes("THREE.WebGLRenderer"))&&(console.error("[NodeView] WebGL context loss detected!",{message:a.message,stack:((d=a.error)==null?void 0:d.stack)||"No stack trace",viewMode:l,timeElapsed:Date.now()-p.transitionTime+"ms",renderCount:p.renderCount}),N(!0),y(!1),m(u=>({...u,errorOccurred:!0})),I(performance)&&performance.memory)){const u=performance.memory;h({jsHeapSizeLimit:u.jsHeapSizeLimit,totalJSHeapSize:u.totalJSHeapSize,usedJSHeapSize:u.usedJSHeapSize,timestamp:Date.now()}),console.log("[NodeView] Memory usage at WebGL error:",{usedHeap:Math.round(u.usedJSHeapSize/1048576)+"MB",totalHeap:Math.round(u.totalJSHeapSize/1048576)+"MB",limit:Math.round(u.jsHeapSizeLimit/1048576)+"MB"})}};return window.addEventListener("error",i),()=>{window.removeEventListener("error",i)}},[l,p.renderCount,p.transitionTime]);const W=()=>{o(oe())};if(l!=="reading"||!e)return null;const U=`${e.character.toLowerCase()}-theme`,q=()=>e.temporalValue<=3?"past-indicator":e.temporalValue<=6?"present-indicator":"future-indicator",K=()=>e.currentContent?t.jsxs("div",{ref:r,className:`content-container ${e.currentState}`,"data-content-loaded":"true","data-node-id":e.id,"data-visit-count":e.visitCount,style:{position:"relative",visibility:"visible",display:"block"},children:[S?t.jsx("div",{className:"simple-renderer-wrapper",style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px",opacity:1,zIndex:5},children:t.jsx(ue,{nodeId:e.id,onRenderComplete:F,onVisibilityChange:M},`simple-${e.id}-${e.visitCount}`)}):t.jsx(n.Suspense,{fallback:t.jsx(he,{}),children:g&&!v?t.jsx(le,{fallback:t.jsxs("div",{className:"fallback-content",style:{visibility:"visible",display:"block"},children:[t.jsx("p",{className:"error-notice",children:"Advanced rendering unavailable - showing basic content"}),t.jsx(P,{remarkPlugins:[()=>D],children:_})]}),children:t.jsx("div",{style:{minHeight:"200px",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(fe,{nodeId:e.id,onVisibilityChange:i=>{console.log(`[NodeView] Content visibility changed to: ${i?"visible":"hidden"}`);const a=setTimeout(()=>{r.current&&(m(d=>({...d,visibilityIssue:!i})),i||c(!0))},1e3);return()=>clearTimeout(a)}},`narramorph-${e.id}-${e.visitCount}`)})}):t.jsxs("div",{style:{visibility:"visible",display:"block",position:"relative",minHeight:"100px"},children:[t.jsxs("div",{className:"content-loading",style:{marginBottom:"10px"},children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Preparing content..."})]}),"                ",t.jsx(P,{remarkPlugins:[()=>D],children:_},`markdown-${e.id}-${e.visitCount}`)]})}),t.jsxs("div",{className:"debug-indicator",children:[t.jsx("div",{className:`status-dot ${V.contentLoaded?"status-green":"status-red"}`,title:"Content loaded"}),t.jsx("div",{className:`status-dot ${V.narramorphActivated?"status-green":"status-yellow"}`,title:"Narramorph active"}),t.jsx("div",{className:`status-dot ${V.errorOccurred?"status-red":"status-green"}`,title:"No errors"}),t.jsx("div",{className:`status-dot ${V.visibilityIssue?"status-red":"status-green"}`,title:"Content visible"}),t.jsx("div",{className:`status-dot ${S?"status-blue":"status-yellow"}`,title:"Simple renderer"}),t.jsx("div",{className:"status-dot status-green",title:"WebGL available"}),t.jsxs("div",{className:"debug-metrics",children:[t.jsxs("span",{title:"View transition count",children:["T:",p.transitionCount]}),t.jsxs("span",{title:"Render count",children:["R:",p.renderCount]}),j.usedJSHeapSize>0&&t.jsxs("span",{title:"Memory usage",children:["M:",Math.round(j.usedJSHeapSize/(1024*1024)),"MB"]})]})]})]}):t.jsx("div",{className:"node-loading",children:t.jsx("span",{children:"Loading narrative fragment..."})});return t.jsxs("div",{className:`node-view-container ${U}`,children:[t.jsx("div",{className:`temporal-indicator ${q()}`}),t.jsxs("div",{className:"node-header",children:[t.jsx("h1",{children:e.title}),t.jsxs("div",{className:"node-metadata",children:[t.jsx("span",{className:"node-character",children:e.character}),t.jsx("span",{className:"node-state",children:e.currentState}),t.jsxs("span",{className:"node-visits",children:["Visits: ",e.visitCount]})]})]}),t.jsx("div",{className:"node-content force-visible",style:{position:"relative"},children:K()}),t.jsx("div",{className:"node-navigation",children:t.jsx("button",{onClick:W,className:"navigation-button",children:"Return to Constellation"})}),t.jsx("div",{style:{position:"absolute",bottom:"20px",right:"20px",width:"300px",height:"300px",pointerEvents:"auto"},children:t.jsx(n.Suspense,{fallback:t.jsx(A,{}),children:t.jsx(pe,{})})}),t.jsx(n.Suspense,{fallback:t.jsx(A,{}),children:t.jsx(me,{nodeId:e.id,strangeAttractors:e.strangeAttractors})})]},C)};export{Ne as default};
//# sourceMappingURL=NodeView-m1LH6zaI.js.map
