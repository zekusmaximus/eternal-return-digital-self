const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/markdown-vendor-CHcODoc4.js","assets/three-vendor-B0HHzWfL.js","assets/react-vendor-DaKsb8LL.js","assets/MiniConstellation-UDYlUtEb.js","assets/constellation-D77L-avc.js","assets/node-view-CKzL31Pm.js","assets/node-view-BvMPabFr.css","assets/MarginaliaSidebar-CAFnZgO2.js","assets/NarramorphRenderer-Dy0c4-ja.js","assets/narramorph-hy4W2TfA.js","assets/narramorph-DivzNTyX.css"])))=>i.map(i=>d[i]);
import{j as t,_ as k}from"./three-vendor-B0HHzWfL.js";import{b as n,j as L}from"./react-vendor-DaKsb8LL.js";import{u as F}from"./narramorph-hy4W2TfA.js";import{u as W,v as q}from"./app-COOZFrDm.js";import{a as K,w as Q,g as X,B as Y,v as Z,C as ee}from"./constellation-D77L-avc.js";import"./node-view-CKzL31Pm.js";class te extends n.Component{constructor(s){super(s),this.state={hasError:!1,error:null}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,i){console.error("ErrorBoundary caught an error:",s),console.error("Component stack:",i.componentStack)}render(){return this.state.hasError?this.props.fallback:this.props.children}}const ne=({children:a,transformations:s,nodeId:i})=>{const[e,x]=n.useState(0),[h,d]=n.useState(!1),[C,v]=n.useState("");n.useEffect(()=>{const l=s.map(r=>`${r.type}-${r.selector||"no-selector"}-${JSON.stringify(r)}`).sort().join("|");if(l!==C)if(s.length>e){d(!0);const r=setTimeout(()=>{d(!1)},2e3);return x(s.length),v(l),()=>clearTimeout(r)}else x(s.length),v(l)},[s,C,e]);const u=()=>{if(s.length===0)return"";const l={};s.forEach(N=>{l[N.type]=(l[N.type]||0)+1});const r=[];return l.replace&&r.push(`${l.replace} replacements`),l.emphasize&&r.push(`${l.emphasize} emphasis`),l.expand&&r.push(`${l.expand} expansions`),l.fragment&&r.push(`${l.fragment} fragmentations`),l.metaComment&&r.push(`${l.metaComment} comments`),r.join(", ")};return t.jsxs("div",{className:`simple-transformation-container ${h?"newly-transformed":""}`,"data-transformation-count":s.length,"data-node-id":i,children:[s.length>0&&t.jsxs("div",{className:`transformation-indicator ${h?"active":""}`,title:u(),children:[t.jsx("span",{className:"transformation-count",children:s.length}),h&&s.length>e&&t.jsxs("span",{className:"transformation-change",children:["+",s.length-e]})]}),t.jsx("div",{className:"simple-transformation-content",children:a}),h&&t.jsx("div",{className:"transformation-overlay","aria-hidden":"true"})]})},re=(a,s)=>{if(!a||!s.length)return a;let i=a;const e=[...s].sort((x,h)=>{const d={high:3,medium:2,low:1},C=d[x.priority||"medium"]||2;return(d[h.priority||"medium"]||2)-C});for(const x of e){const{type:h,selector:d,replacement:C,emphasis:v}=x;if(d)try{switch(h){case"replace":{if(C){const l=`<span class="text-transformation text-replaced" data-transform-type="replace">${C}</span>`;i=i.replace(new RegExp(d,"g"),l)}break}case"emphasize":{const u=v||"color",l=`<span class="text-transformation text-emphasis text-emphasis-${u}" data-transform-type="emphasize" data-emphasis="${u}">${d}</span>`;i=i.replace(new RegExp(d,"g"),l);break}case"expand":{const u=`<span class="text-transformation text-expanded" data-transform-type="expand">${d}</span>`;i=i.replace(new RegExp(d,"g"),u);break}case"fragment":{const u=`<span class="text-transformation text-fragmented" data-transform-type="fragment">${d}</span>`;i=i.replace(new RegExp(d,"g"),u);break}case"metaComment":{const u=`<span class="text-transformation text-commented" data-transform-type="metaComment">${d}</span>`;i=i.replace(new RegExp(d,"g"),u);break}}}catch(u){console.error(`[SimpleTextRenderer] Error applying transformation ${h}:`,u)}}return i},se=n.memo(({nodeId:a,onRenderComplete:s,onVisibilityChange:i})=>{const{node:e,transformedContent:x,appliedTransformations:h}=F(a),[d,C]=n.useState(""),[v,u]=n.useState(!0),[l,r]=n.useState(!0),N=n.useRef(null),$=n.useRef(null),j=n.useRef(null),[S,V]=n.useState(0);L(b=>b.reader.path);const E=n.useRef(!1);return n.useEffect(()=>{if(e!=null&&e.currentContent){console.log(`[SimpleTextRenderer] Processing content for node: ${e.id}, length: ${e.currentContent.length}`),r(!0);const b=x||e.currentContent;try{console.log("[SimpleTextRenderer] Starting content processing synchronously");const f=re(b,h);C(f),V(w=>w+1),r(!1),u(!0),E.current||(E.current=!0,s&&(console.log(`[SimpleTextRenderer] Render complete for node: ${e.id}`),setTimeout(s,10)),i&&(console.log("[SimpleTextRenderer] Explicitly marking content as visible"),i(!0)))}catch(f){console.error("[SimpleTextRenderer] Error processing content:",f),r(!1)}}},[e==null?void 0:e.currentContent,e==null?void 0:e.id,x]),n.useEffect(()=>{E.current=!1},[e==null?void 0:e.id]),n.useEffect(()=>{const b=N.current,f=$.current;if(b)return console.log(`[DEBUG] Setting up IntersectionObserver for node: ${e==null?void 0:e.id}, current visibility: ${v}`),f&&f.disconnect(),v||(console.log(`[DEBUG] Forcing initial visibility to true for node: ${e==null?void 0:e.id}`),u(!0),i&&!E.current&&i(!0)),console.log(`[DEBUG] Skipping IntersectionObserver setup to prevent infinite loops for node: ${e==null?void 0:e.id}`),()=>{console.log(`[DEBUG] Cleaning up IntersectionObserver for node: ${e==null?void 0:e.id}`),f&&f.disconnect()}},[e==null?void 0:e.id,v]),n.useEffect(()=>{const b=N.current;if(!b)return;console.log(`[DEBUG] Setting up MutationObserver for node: ${e==null?void 0:e.id}`),j.current&&j.current.disconnect();let f=null;return j.current=new MutationObserver(w=>{f&&clearTimeout(f),f=window.setTimeout(()=>{w.forEach(p=>{if(p.type==="attributes"&&(p.attributeName==="style"||p.attributeName==="class"||p.attributeName==="display"||p.attributeName==="visibility"||p.attributeName==="opacity")){const g=p.target,R=window.getComputedStyle(g);console.log(`[DEBUG] Style mutation detected on ${g.tagName}#${g.id}.${g.className}:`,{display:R.display,visibility:R.visibility,opacity:R.opacity}),(R.display==="none"||R.visibility==="hidden"||parseFloat(R.opacity)===0)&&(console.warn("[DEBUG] Preventing content from being hidden by style mutation"),g.style.display=g.style.display==="none"?"block":g.style.display,g.style.visibility=g.style.visibility==="hidden"?"visible":g.style.visibility,g.style.opacity=parseFloat(g.style.opacity)===0?"1":g.style.opacity,g===b&&i&&!E.current&&(console.log("[DEBUG] Notifying parent that content is still visible after mutation"),i(!0)))}})},100)}),j.current.observe(b,{attributes:!0,attributeFilter:["style","class"],childList:!1,subtree:!1}),()=>{var w;console.log(`[DEBUG] Cleaning up MutationObserver for node: ${e==null?void 0:e.id}`),f&&clearTimeout(f),(w=j.current)==null||w.disconnect()}},[e==null?void 0:e.id]),!e||!e.currentContent?t.jsx("div",{className:"simple-renderer-loading",children:"Loading narrative content..."}):t.jsxs("div",{className:`simple-renderer-container ${v?"is-visible":""}`,"data-node-id":e.id,"data-render-count":S,style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px"},children:[t.jsxs(ne,{transformations:h,nodeId:e.id,children:[l&&t.jsxs("div",{className:"simple-renderer-loading",style:{padding:"20px 0"},children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Preparing narrative content..."})]}),t.jsx("div",{ref:N,className:"simple-renderer-content","data-transformations-count":h.length,style:{display:"block",visibility:"visible",opacity:1},children:t.jsx("div",{dangerouslySetInnerHTML:{__html:d},className:"content-inner"})})]}),!1]})});function I(a){return"memory"in a}const _=n.lazy(()=>(console.log("[NodeView] Loading ReactMarkdown component"),k(()=>import("./markdown-vendor-CHcODoc4.js").then(a=>a.i),__vite__mapDeps([0,1,2])).then(a=>(console.log("[NodeView] ReactMarkdown component loaded"),a)))),ie=n.lazy(()=>k(()=>import("./MiniConstellation-UDYlUtEb.js"),__vite__mapDeps([3,1,2,4,5,6]))),oe=n.lazy(()=>k(()=>import("./MarginaliaSidebar-CAFnZgO2.js"),__vite__mapDeps([7,1,2,4,5,6]))),B=k(()=>import("./NarramorphRenderer-Dy0c4-ja.js"),__vite__mapDeps([8,1,2,9,4,10])),ae=n.lazy(()=>(console.log("[NodeView] Loading NarramorphRenderer component"),B.then(a=>(console.log("[NodeView] NarramorphRenderer component loaded"),a)))),P=k(()=>import("./markdown-vendor-CHcODoc4.js").then(a=>a.a),__vite__mapDeps([0,1,2])).then(a=>(console.log("[NodeView] remark-gfm plugin loaded"),a.default)),le=()=>t.jsxs("div",{className:"content-loading",children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Loading content..."})]}),D=()=>t.jsx("div",{className:"side-component-loading"}),ge=()=>{var z;const a=W(),s=L(K),i=L(Q),e=L(o=>s?X(o,s):null),x=n.useMemo(()=>q.getUniqueViewKey(),[]),[h,d]=n.useState(!1),[C,v]=n.useState(!1),[u,l]=n.useState(!0),r=n.useRef(null),N=n.useRef(!1),$=n.useRef(null),j=n.useRef(!1),[S,V]=n.useState({transitionTime:Date.now(),lastViewMode:i,transitionCount:0,renderCount:0}),[E,b]=n.useState({jsHeapSizeLimit:0,totalJSHeapSize:0,usedJSHeapSize:0,timestamp:0}),f=n.useCallback(o=>{if(console.log(`[NodeView] Content visibility changed to: ${o?"visible":"hidden"}`),!o&&r.current){console.warn("[NodeView] Forcing content visibility after hidden state detected"),r.current.style.display="block",r.current.style.visibility="visible",r.current.style.opacity="1";return}N.current||p(c=>({...c,visibilityIssue:!o}))},[]),[w,p]=n.useState({loadStarted:!1,contentLoaded:!1,renderStarted:!1,narramorphActivated:!1,visibilityIssue:!1,errorOccurred:!1}),g=n.useCallback(()=>{if(N.current){console.log("[NodeView] Skipping duplicate onRenderComplete call");return}N.current=!0,console.log("[NodeView] SimpleTextRenderer completed rendering"),r.current&&(console.log("[NodeView] Forcing container visibility after render complete"),r.current.style.display="block",r.current.style.visibility="visible",r.current.style.opacity="1"),p(o=>({...o,visibilityIssue:!1})),setTimeout(()=>{if(r.current){const o=r.current.offsetParent!==null&&window.getComputedStyle(r.current).display!=="none"&&window.getComputedStyle(r.current).visibility!=="hidden";console.log(`[NodeView] Post-render visibility check: ${o?"visible":"not visible"}`),o||(console.warn("[NodeView] Content became invisible after render - forcing visibility"),r.current.style.display="block",r.current.style.visibility="visible",r.current.style.opacity="1")}},500)},[]);n.useEffect(()=>{s!==$.current&&(N.current=!1,$.current=s,j.current=!1)},[s]),n.useEffect(()=>{if(S.lastViewMode!==i){const o=Date.now();if(console.log(`[NodeView] View transition: ${S.lastViewMode} -> ${i} at ${o}`),V(c=>({...c,lastViewMode:i,transitionTime:o,transitionCount:c.transitionCount+1,renderCount:c.renderCount+1})),p(c=>({...c,loadStarted:!1,contentLoaded:!1,renderStarted:!1,narramorphActivated:!1,visibilityIssue:!1,errorOccurred:!1})),I(performance)&&performance.memory){const c=performance.memory;b({jsHeapSizeLimit:c.jsHeapSizeLimit,totalJSHeapSize:c.totalJSHeapSize,usedJSHeapSize:c.usedJSHeapSize,timestamp:o})}}else V(o=>({...o,renderCount:o.renderCount+1}))},[i,S.lastViewMode]),n.useEffect(()=>{s&&!(e!=null&&e.content)&&(console.log(`[NodeView] Loading content for node: ${s}`,{viewMode:i}),p(c=>({...c,loadStarted:!0})),a(Y(s)))},[s,a,i,e==null?void 0:e.content]);const R=((z=e==null?void 0:e.currentContent)==null?void 0:z.length)||0,H=!!(e!=null&&e.content),M=!!(e!=null&&e.enhancedContent);n.useEffect(()=>{var o;if(e!=null&&e.id&&$.current===s){const c=!!e.currentContent;console.log(`[NodeView] Content processed for node: ${s}`,{hasContent:c,visitCount:e.visitCount,contentLength:R,contentPreview:((o=e.currentContent)==null?void 0:o.substring(0,50))||"NO CONTENT",enhancedContentExists:M,contentExists:H}),p(m=>({...m,contentLoaded:c})),e.currentContent&&(e.currentContent.includes("[object Object]")||e.currentContent.includes("undefined")||e.currentContent.length<10)&&console.error("[NodeView] Possible content corruption detected:",{contentStart:e.currentContent.substring(0,100),contentLength:e.currentContent.length})}},[s,e==null?void 0:e.id,e==null?void 0:e.visitCount,R,H,M,e==null?void 0:e.currentContent]),n.useEffect(()=>{s&&a(Z(s))},[s,a]),n.useEffect(()=>{if(e!=null&&e.id&&(e!=null&&e.currentContent)&&!j.current){console.log(`[NodeView] Preparing to activate Narramorph for node: ${e.id}`,{viewMode:i,hasContent:!!e.currentContent}),p(m=>({...m,renderStarted:!0})),j.current=!0;let o=!1;console.log("[NodeView] Preloading NarramorphRenderer component"),B.then(()=>{if(o=!0,console.log("[NodeView] NarramorphRenderer preload complete"),e!=null&&e.id&&(console.log(`[NodeView] Activating Narramorph renderer for node: ${e.id} after preload`),d(!0),p(m=>({...m,narramorphActivated:!0})),r.current)){const m=r.current.getBoundingClientRect();console.log("[NodeView] Post-preload container dimensions:",{width:m.width,height:m.height,display:window.getComputedStyle(r.current).display,visibility:window.getComputedStyle(r.current).visibility})}}).catch(m=>{console.error("[NodeView] Error preloading NarramorphRenderer:",m),l(!0)});const c=setTimeout(()=>{if(r.current){console.log("[NodeView] Force checking content visibility");const m=r.current.offsetParent!==null,y=r.current.getBoundingClientRect(),T=window.getComputedStyle(r.current);console.log("[NodeView] Content visibility check:",{isVisible:m,width:y.width,height:y.height,display:T.display,visibility:T.visibility,zIndex:T.zIndex,position:T.position,opacity:T.opacity,componentLoaded:o}),(!m||y.width===0||y.height===0)&&(console.warn("[NodeView] Content invisible after rendering - forcing simple renderer"),l(!0),p(U=>({...U,visibilityIssue:!0})))}},1500);return()=>clearTimeout(c)}},[e==null?void 0:e.currentContent,e==null?void 0:e.id,i]),n.useEffect(()=>{const o=c=>{var m;if(c.message&&(c.message.includes("WebGL context lost")||c.message.includes("THREE.WebGLRenderer"))&&(console.error("[NodeView] WebGL context loss detected!",{message:c.message,stack:((m=c.error)==null?void 0:m.stack)||"No stack trace",viewMode:i,timeElapsed:Date.now()-S.transitionTime+"ms",renderCount:S.renderCount}),v(!0),d(!1),p(y=>({...y,errorOccurred:!0})),I(performance)&&performance.memory)){const y=performance.memory;b({jsHeapSizeLimit:y.jsHeapSizeLimit,totalJSHeapSize:y.totalJSHeapSize,usedJSHeapSize:y.usedJSHeapSize,timestamp:Date.now()}),console.log("[NodeView] Memory usage at WebGL error:",{usedHeap:Math.round(y.usedJSHeapSize/1048576)+"MB",totalHeap:Math.round(y.totalJSHeapSize/1048576)+"MB",limit:Math.round(y.jsHeapSizeLimit/1048576)+"MB"})}};return window.addEventListener("error",o),()=>{window.removeEventListener("error",o)}},[i,S.renderCount,S.transitionTime]);const O=()=>{a(ee())};if(i!=="reading"||!e)return null;const G=`${e.character.toLowerCase()}-theme`,A=()=>e.temporalValue<=3?"past-indicator":e.temporalValue<=6?"present-indicator":"future-indicator",J=()=>e.currentContent?t.jsxs("div",{ref:r,className:`content-container ${e.currentState}`,"data-content-loaded":"true","data-node-id":e.id,"data-visit-count":e.visitCount,style:{position:"relative",visibility:"visible",display:"block"},children:[u?t.jsx("div",{className:"simple-renderer-wrapper",style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px",opacity:1,zIndex:5},children:t.jsx(se,{nodeId:e.id,onRenderComplete:g,onVisibilityChange:f},`simple-${e.id}-${e.visitCount}`)}):t.jsx(n.Suspense,{fallback:t.jsx(le,{}),children:h&&!C?t.jsx(te,{fallback:t.jsxs("div",{className:"fallback-content",style:{visibility:"visible",display:"block"},children:[t.jsx("p",{className:"error-notice",children:"Advanced rendering unavailable - showing basic content"}),t.jsx(_,{remarkPlugins:[()=>P],children:e.currentContent})]}),children:t.jsx("div",{style:{minHeight:"200px",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(ae,{nodeId:e.id,onVisibilityChange:o=>{console.log(`[NodeView] Content visibility changed to: ${o?"visible":"hidden"}`);const c=setTimeout(()=>{r.current&&(p(m=>({...m,visibilityIssue:!o})),o||l(!0))},1e3);return()=>clearTimeout(c)}},`narramorph-${e.id}-${e.visitCount}`)})}):t.jsxs("div",{style:{visibility:"visible",display:"block",position:"relative",minHeight:"100px"},children:[t.jsxs("div",{className:"content-loading",style:{marginBottom:"10px"},children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Preparing content..."})]}),t.jsx(_,{remarkPlugins:[()=>P],children:e.currentContent},`markdown-${e.id}-${e.visitCount}`)]})}),t.jsxs("div",{className:"debug-indicator",children:[t.jsx("div",{className:`status-dot ${w.contentLoaded?"status-green":"status-red"}`,title:"Content loaded"}),t.jsx("div",{className:`status-dot ${w.narramorphActivated?"status-green":"status-yellow"}`,title:"Narramorph active"}),t.jsx("div",{className:`status-dot ${w.errorOccurred?"status-red":"status-green"}`,title:"No errors"}),t.jsx("div",{className:`status-dot ${w.visibilityIssue?"status-red":"status-green"}`,title:"Content visible"}),t.jsx("div",{className:`status-dot ${u?"status-blue":"status-yellow"}`,title:"Simple renderer"}),t.jsx("div",{className:"status-dot status-green",title:"WebGL available"}),t.jsxs("div",{className:"debug-metrics",children:[t.jsxs("span",{title:"View transition count",children:["T:",S.transitionCount]}),t.jsxs("span",{title:"Render count",children:["R:",S.renderCount]}),E.usedJSHeapSize>0&&t.jsxs("span",{title:"Memory usage",children:["M:",Math.round(E.usedJSHeapSize/(1024*1024)),"MB"]})]})]})]}):t.jsx("div",{className:"node-loading",children:t.jsx("span",{children:"Loading narrative fragment..."})});return t.jsxs("div",{className:`node-view-container ${G}`,children:[t.jsx("div",{className:`temporal-indicator ${A()}`}),t.jsxs("div",{className:"node-header",children:[t.jsx("h1",{children:e.title}),t.jsxs("div",{className:"node-metadata",children:[t.jsx("span",{className:"node-character",children:e.character}),t.jsx("span",{className:"node-state",children:e.currentState}),t.jsxs("span",{className:"node-visits",children:["Visits: ",e.visitCount]})]})]}),t.jsx("div",{className:"node-content force-visible",style:{position:"relative"},children:J()}),t.jsx("div",{className:"node-navigation",children:t.jsx("button",{onClick:O,className:"navigation-button",children:"Return to Constellation"})}),t.jsx("div",{style:{position:"absolute",bottom:"20px",right:"20px",width:"300px",height:"300px",pointerEvents:"auto"},children:t.jsx(n.Suspense,{fallback:t.jsx(D,{}),children:t.jsx(ie,{})})}),t.jsx(n.Suspense,{fallback:t.jsx(D,{}),children:t.jsx(oe,{nodeId:e.id,strangeAttractors:e.strangeAttractors})})]},x)};export{ge as default};
//# sourceMappingURL=NodeView-DDr-52vj.js.map
