import{j as l}from"./three-vendor-rJ5vKMTC.js";import{b as s,j as q}from"./react-vendor-DaKsb8LL.js";import{u as B,f as H,T as F}from"./narramorph-BlMiJuN1.js";import{k as O}from"./constellation-CzSJAdlk.js";const Y=s.memo(({nodeId:y,onVisibilityChange:h})=>{const{node:t,transformedContent:b,newlyTransformed:T,appliedTransformations:u}=B(y),d=s.useRef(null),m=s.useRef(null);s.useRef(null);const E=s.useRef(Date.now()),x=s.useRef(0),R=s.useRef(!0),[P,L]=s.useState(0),[i,j]=s.useState(!0),[_,z]=s.useState(null),[U,v]=s.useState({renderTime:0,transformationsCount:0,visibilityChanges:0,deferredTransformations:0}),[k,S]=s.useState([]),w=s.useMemo(()=>b?H(b):"",[b]),K=s.useMemo(()=>t!=null&&t.currentContent?H(t.currentContent):"Content unavailable",[t==null?void 0:t.currentContent]);q(e=>e.reader.path),s.useEffect(()=>{const e=r=>{r.message&&(r.message.includes("WebGL context lost")||r.message.includes("THREE.WebGLRenderer"))&&(console.error("[NarramorphRenderer] WebGL context loss detected!",r.message),z(new Error(r.message)))};return window.addEventListener("error",e),()=>{window.removeEventListener("error",e)}},[i,h]);const C=s.useCallback((e,r,n)=>{if(!n||!d.current)return!1;const o=Date.now()-E.current,f=x.current>3&&o<15e3;return i!==e&&o>3e3&&!f&&r===i},[i]),N=s.useCallback((e,r)=>{r&&(E.current=Date.now(),x.current+=1,j(e),setTimeout(()=>{r&&(x.current=0)},15e3),h&&(console.log("[NarramorphRenderer] Calling onVisibilityChange:",e,"Previous:",i),h(e)),v(n=>({...n,visibilityChanges:n.visibilityChanges+1})),t!=null&&t.id&&O.setContentVisibility(t.id,e,t.id===y?2:1),e&&L(n=>n+1))},[i,h,t==null?void 0:t.id,y]),A=s.useCallback((e,r,n)=>{var o;if(!n)return;(((o=r[0])==null?void 0:o.isIntersecting)??!0)===e?N(e,n):console.log("[NarramorphRenderer] Visibility state inconsistent - ignoring change")},[N]),$=s.useCallback((e,r,n)=>{C(e,R.current,n)&&setTimeout(()=>{A(e,r,n)},500)},[C,A]),G=s.useCallback((e,r,n)=>{const a=e.getAttribute("data-transform-type"),o=e.textContent||"",f=r.find(p=>p.type===a&&o.includes(p.selector||"")&&n.includes(`${p.type}-${p.selector}`));if(!f)return;e.classList.add("narramorph-transform-new");const c={replace:"narramorph-replaced",fragment:"narramorph-fragmented",expand:"narramorph-expanded",emphasize:`narramorph-emphasis-${f.emphasis||"color"}`,metaComment:"narramorph-commented"}[a];c&&e.classList.add(c),setTimeout(()=>{e.classList.remove("narramorph-transform-new")},2e3)},[]),M=s.useCallback((e,r,n)=>{e.forEach(a=>{G(a,r,n)})},[G]),W=s.useCallback((e,r=5)=>{const n=[];for(let a=0;a<e.length;a+=r)n.push(Array.from(e).slice(a,a+r));return n},[]),I=s.useCallback((e,r,n,a=50)=>{const o=W(e,5),f=5;o.forEach((g,c)=>{setTimeout(()=>{M(g,r,n)},c*a*f)})},[W,M]);s.useEffect(()=>{if(!d.current)return;m.current&&(m.current.disconnect(),m.current=null),m.current||(j(!0),h&&h(!0));let e=null,r=!0;return m.current=new IntersectionObserver(n=>{var o;if(!r||!d.current)return;const a=((o=n[0])==null?void 0:o.isIntersecting)??!0;R.current=i,C(a,R.current,r)&&(e&&window.clearTimeout(e),console.log(`[NarramorphRenderer] Potential visibility change detected: ${i} -> ${a}`),e=window.setTimeout(()=>{$(a,n,r),e=null},1200))},{root:null,rootMargin:"500px",threshold:.01}),d.current&&r&&m.current.observe(d.current),()=>{if(r=!1,e&&(window.clearTimeout(e),e=null),m.current){try{m.current.disconnect(),console.log("[NarramorphRenderer] Intersection observer disconnected cleanly")}catch(n){console.warn("[NarramorphRenderer] Error disconnecting observer:",n)}m.current=null}}},[t==null?void 0:t.id,y,i,h,$,C]);const D=s.useMemo(()=>{if(!u.length)return[];if(i)return u;const e=u.filter(r=>r.priority==="high"||r.applyImmediately===!0);return v(r=>({...r,deferredTransformations:u.length-e.length})),e},[u,i]);return s.useEffect(()=>{if(!T||!d.current||!i)return;const e=performance.now();L(r=>r+1),requestAnimationFrame(()=>{var g;const r=(g=d.current)==null?void 0:g.querySelectorAll("[data-transform-type]");if(!r||r.length===0)return;const n=u.map(c=>`${c.type}-${c.selector}`),a=n.filter(c=>!k.includes(c));if(a.length===0)return;const o={replace:[],fragment:[],expand:[],emphasize:[],metaComment:[]};r.forEach(c=>{const p=c.getAttribute("data-transform-type");p&&p in o&&o[p].push(c)}),Object.values(o).forEach(c=>{I(c,u,a)}),S(n);const f=performance.now();v(c=>({...c,renderTime:f-e,transformationsCount:u.length}))})},[T,u,k,i,I]),s.useEffect(()=>{t!=null&&t.id&&(S([]),v({renderTime:0,transformationsCount:0,visibilityChanges:0,deferredTransformations:0}))},[t==null?void 0:t.id]),_?(console.error("[NarramorphRenderer] Rendering in error state due to WebGL issue"),l.jsxs("div",{className:"narramorph-error",children:[l.jsx("p",{children:"Advanced rendering unavailable"}),l.jsx("div",{dangerouslySetInnerHTML:{__html:K}})]})):!t||!b?l.jsx("div",{className:"narramorph-loading",children:"Loading content..."}):l.jsxs("div",{className:`narramorph-container ${i?"is-visible":"is-hidden"}`,"data-node-id":t.id,"data-visibility":i?"visible":"hidden",style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px"},children:[l.jsx(F,{transformations:D,isNewlyTransformed:T,nodeId:t.id,children:l.jsxs("div",{ref:d,className:`narramorph-content ${i?"is-visible":"is-hidden"}`,"data-transformations-count":D.length,"data-node-id":t.id,"data-visit-count":t.visitCount,style:{display:"block",visibility:"visible",position:"relative"},children:[!w&&l.jsxs("div",{className:"narramorph-loading-indicator",style:{margin:"20px 0"},children:[l.jsx("div",{className:"loading-spinner"}),l.jsx("p",{children:"Preparing narrative transformations..."})]}),w&&l.jsx("div",{dangerouslySetInnerHTML:{__html:w},style:{opacity:i?1:.99,transition:"opacity 0.3s ease-in"}})]})}),!1]},P)});export{Y as default};
//# sourceMappingURL=NarramorphRenderer-D8aPU9Cz.js.map
