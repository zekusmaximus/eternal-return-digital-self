var Qe=Object.defineProperty;var Ze=(r,e,t)=>e in r?Qe(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var M=(r,e,t)=>Ze(r,typeof e!="symbol"?e+"":e,t);import"./three-vendor-rJ5vKMTC.js";import{i as et,c as tt,d as nt,e as ue,f as rt,h as st}from"./react-vendor-DaKsb8LL.js";var Ve=Symbol.for("immer-nothing"),Ee=Symbol.for("immer-draftable"),_=Symbol.for("immer-state");function O(r,...e){throw new Error(`[Immer] minified error nr: ${r}. Full error at: https://bit.ly/3cXEKWf`)}var I=Object.getPrototypeOf;function N(r){return!!r&&!!r[_]}function q(r){var e;return r?qe(r)||Array.isArray(r)||!!r[Ee]||!!((e=r.constructor)!=null&&e[Ee])||Z(r)||ee(r):!1}var at=Object.prototype.constructor.toString();function qe(r){if(!r||typeof r!="object")return!1;const e=I(r);if(e===null)return!0;const t=Object.hasOwnProperty.call(e,"constructor")&&e.constructor;return t===Object?!0:typeof t=="function"&&Function.toString.call(t)===at}function G(r,e){Q(r)===0?Reflect.ownKeys(r).forEach(t=>{e(t,r[t],r)}):r.forEach((t,n)=>e(n,t,r))}function Q(r){const e=r[_];return e?e.type_:Array.isArray(r)?1:Z(r)?2:ee(r)?3:0}function he(r,e){return Q(r)===2?r.has(e):Object.prototype.hasOwnProperty.call(r,e)}function je(r,e,t){const n=Q(r);n===2?r.set(e,t):n===3?r.add(t):r[e]=t}function it(r,e){return r===e?r!==0||1/r===1/e:r!==r&&e!==e}function Z(r){return r instanceof Map}function ee(r){return r instanceof Set}function j(r){return r.copy_||r.base_}function fe(r,e){if(Z(r))return new Map(r);if(ee(r))return new Set(r);if(Array.isArray(r))return Array.prototype.slice.call(r);const t=qe(r);if(e===!0||e==="class_only"&&!t){const n=Object.getOwnPropertyDescriptors(r);delete n[_];let s=Reflect.ownKeys(n);for(let i=0;i<s.length;i++){const a=s[i],o=n[a];o.writable===!1&&(o.writable=!0,o.configurable=!0),(o.get||o.set)&&(n[a]={configurable:!0,writable:!0,enumerable:o.enumerable,value:r[a]})}return Object.create(I(r),n)}else{const n=I(r);if(n!==null&&t)return{...r};const s=Object.create(n);return Object.assign(s,r)}}function Ce(r,e=!1){return te(r)||N(r)||!q(r)||(Q(r)>1&&(r.set=r.add=r.clear=r.delete=ot),Object.freeze(r),e&&Object.entries(r).forEach(([t,n])=>Ce(n,!0))),r}function ot(){O(2)}function te(r){return Object.isFrozen(r)}var ct={};function F(r){const e=ct[r];return e||O(0,r),e}var L;function Ne(){return L}function lt(r,e){return{drafts_:[],parent_:r,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function we(r,e){e&&(F("Patches"),r.patches_=[],r.inversePatches_=[],r.patchListener_=e)}function pe(r){de(r),r.drafts_.forEach(ut),r.drafts_=null}function de(r){r===L&&(L=r.parent_)}function Ae(r){return L=lt(L,r)}function ut(r){const e=r[_];e.type_===0||e.type_===1?e.revoke_():e.revoked_=!0}function $e(r,e){e.unfinalizedDrafts_=e.drafts_.length;const t=e.drafts_[0];return r!==void 0&&r!==t?(t[_].modified_&&(pe(e),O(4)),q(r)&&(r=Y(e,r),e.parent_||X(e,r)),e.patches_&&F("Patches").generateReplacementPatches_(t[_].base_,r,e.patches_,e.inversePatches_)):r=Y(e,t,[]),pe(e),e.patches_&&e.patchListener_(e.patches_,e.inversePatches_),r!==Ve?r:void 0}function Y(r,e,t){if(te(e))return e;const n=e[_];if(!n)return G(e,(s,i)=>Pe(r,n,e,s,i,t)),e;if(n.scope_!==r)return e;if(!n.modified_)return X(r,n.base_,!0),n.base_;if(!n.finalized_){n.finalized_=!0,n.scope_.unfinalizedDrafts_--;const s=n.copy_;let i=s,a=!1;n.type_===3&&(i=new Set(s),s.clear(),a=!0),G(i,(o,c)=>Pe(r,n,s,o,c,t,a)),X(r,s,!1),t&&r.patches_&&F("Patches").generatePatches_(n,t,r.patches_,r.inversePatches_)}return n.copy_}function Pe(r,e,t,n,s,i,a){if(N(s)){const o=i&&e&&e.type_!==3&&!he(e.assigned_,n)?i.concat(n):void 0,c=Y(r,s,o);if(je(t,n,c),N(c))r.canAutoFreeze_=!1;else return}else a&&t.add(s);if(q(s)&&!te(s)){if(!r.immer_.autoFreeze_&&r.unfinalizedDrafts_<1)return;Y(r,s),(!e||!e.scope_.parent_)&&typeof n!="symbol"&&Object.prototype.propertyIsEnumerable.call(t,n)&&X(r,s)}}function X(r,e,t=!1){!r.parent_&&r.immer_.autoFreeze_&&r.canAutoFreeze_&&Ce(e,t)}function ht(r,e){const t=Array.isArray(r),n={type_:t?1:0,scope_:e?e.scope_:Ne(),modified_:!1,finalized_:!1,assigned_:{},parent_:e,base_:r,draft_:null,copy_:null,revoke_:null,isManual_:!1};let s=n,i=ve;t&&(s=[n],i=H);const{revoke:a,proxy:o}=Proxy.revocable(s,i);return n.draft_=o,n.revoke_=a,o}var ve={get(r,e){if(e===_)return r;const t=j(r);if(!he(t,e))return ft(r,t,e);const n=t[e];return r.finalized_||!q(n)?n:n===se(r.base_,e)?(ae(r),r.copy_[e]=ge(n,r)):n},has(r,e){return e in j(r)},ownKeys(r){return Reflect.ownKeys(j(r))},set(r,e,t){const n=Fe(j(r),e);if(n!=null&&n.set)return n.set.call(r.draft_,t),!0;if(!r.modified_){const s=se(j(r),e),i=s==null?void 0:s[_];if(i&&i.base_===t)return r.copy_[e]=t,r.assigned_[e]=!1,!0;if(it(t,s)&&(t!==void 0||he(r.base_,e)))return!0;ae(r),me(r)}return r.copy_[e]===t&&(t!==void 0||e in r.copy_)||Number.isNaN(t)&&Number.isNaN(r.copy_[e])||(r.copy_[e]=t,r.assigned_[e]=!0),!0},deleteProperty(r,e){return se(r.base_,e)!==void 0||e in r.base_?(r.assigned_[e]=!1,ae(r),me(r)):delete r.assigned_[e],r.copy_&&delete r.copy_[e],!0},getOwnPropertyDescriptor(r,e){const t=j(r),n=Reflect.getOwnPropertyDescriptor(t,e);return n&&{writable:!0,configurable:r.type_!==1||e!=="length",enumerable:n.enumerable,value:t[e]}},defineProperty(){O(11)},getPrototypeOf(r){return I(r.base_)},setPrototypeOf(){O(12)}},H={};G(ve,(r,e)=>{H[r]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}});H.deleteProperty=function(r,e){return H.set.call(this,r,e,void 0)};H.set=function(r,e,t){return ve.set.call(this,r[0],e,t,r[0])};function se(r,e){const t=r[_];return(t?j(t):r)[e]}function ft(r,e,t){var s;const n=Fe(e,t);return n?"value"in n?n.value:(s=n.get)==null?void 0:s.call(r.draft_):void 0}function Fe(r,e){if(!(e in r))return;let t=I(r);for(;t;){const n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=I(t)}}function me(r){r.modified_||(r.modified_=!0,r.parent_&&me(r.parent_))}function ae(r){r.copy_||(r.copy_=fe(r.base_,r.scope_.immer_.useStrictShallowCopy_))}var pt=class{constructor(r){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(e,t,n)=>{if(typeof e=="function"&&typeof t!="function"){const i=t;t=e;const a=this;return function(c=i,...l){return a.produce(c,u=>t.call(this,u,...l))}}typeof t!="function"&&O(6),n!==void 0&&typeof n!="function"&&O(7);let s;if(q(e)){const i=Ae(this),a=ge(e,void 0);let o=!0;try{s=t(a),o=!1}finally{o?pe(i):de(i)}return we(i,n),$e(s,i)}else if(!e||typeof e!="object"){if(s=t(e),s===void 0&&(s=e),s===Ve&&(s=void 0),this.autoFreeze_&&Ce(s,!0),n){const i=[],a=[];F("Patches").generateReplacementPatches_(e,s,i,a),n(i,a)}return s}else O(1,e)},this.produceWithPatches=(e,t)=>{if(typeof e=="function")return(a,...o)=>this.produceWithPatches(a,c=>e(c,...o));let n,s;return[this.produce(e,t,(a,o)=>{n=a,s=o}),n,s]},typeof(r==null?void 0:r.autoFreeze)=="boolean"&&this.setAutoFreeze(r.autoFreeze),typeof(r==null?void 0:r.useStrictShallowCopy)=="boolean"&&this.setUseStrictShallowCopy(r.useStrictShallowCopy)}createDraft(r){q(r)||O(8),N(r)&&(r=dt(r));const e=Ae(this),t=ge(r,void 0);return t[_].isManual_=!0,de(e),t}finishDraft(r,e){const t=r&&r[_];(!t||!t.isManual_)&&O(9);const{scope_:n}=t;return we(n,e),$e(void 0,n)}setAutoFreeze(r){this.autoFreeze_=r}setUseStrictShallowCopy(r){this.useStrictShallowCopy_=r}applyPatches(r,e){let t;for(t=e.length-1;t>=0;t--){const s=e[t];if(s.path.length===0&&s.op==="replace"){r=s.value;break}}t>-1&&(e=e.slice(t+1));const n=F("Patches").applyPatches_;return N(r)?n(r,e):this.produce(r,s=>n(s,e))}};function ge(r,e){const t=Z(r)?F("MapSet").proxyMap_(r,e):ee(r)?F("MapSet").proxySet_(r,e):ht(r,e);return(e?e.scope_:Ne()).drafts_.push(t),t}function dt(r){return N(r)||O(10,r),Ie(r)}function Ie(r){if(!q(r)||te(r))return r;const e=r[_];let t;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,t=fe(r,e.scope_.immer_.useStrictShallowCopy_)}else t=fe(r,!0);return G(t,(n,s)=>{je(t,n,Ie(s))}),e&&(e.finalized_=!1),t}var k=new pt,ze=k.produce;k.produceWithPatches.bind(k);k.setAutoFreeze.bind(k);k.setUseStrictShallowCopy.bind(k);k.applyPatches.bind(k);k.createDraft.bind(k);k.finishDraft.bind(k);function mt(r,e=`expected a function, instead received ${typeof r}`){if(typeof r!="function")throw new TypeError(e)}function gt(r,e=`expected an object, instead received ${typeof r}`){if(typeof r!="object")throw new TypeError(e)}function yt(r,e="expected all items to be functions, instead received the following types: "){if(!r.every(t=>typeof t=="function")){const t=r.map(n=>typeof n=="function"?`function ${n.name||"unnamed"}()`:typeof n).join(", ");throw new TypeError(`${e}[${t}]`)}}var Me=r=>Array.isArray(r)?r:[r];function Ct(r){const e=Array.isArray(r[0])?r[0]:r;return yt(e,"createSelector expects all input-selectors to be functions, but received the following types: "),e}function vt(r,e){const t=[],{length:n}=r;for(let s=0;s<n;s++)t.push(r[s].apply(null,e));return t}var Tt=class{constructor(r){this.value=r}deref(){return this.value}},bt=typeof WeakRef<"u"?WeakRef:Tt,Et=0,Se=1;function J(){return{s:Et,v:void 0,o:null,p:null}}function De(r,e={}){let t=J();const{resultEqualityCheck:n}=e;let s,i=0;function a(){var h;let o=t;const{length:c}=arguments;for(let f=0,p=c;f<p;f++){const m=arguments[f];if(typeof m=="function"||typeof m=="object"&&m!==null){let d=o.o;d===null&&(o.o=d=new WeakMap);const g=d.get(m);g===void 0?(o=J(),d.set(m,o)):o=g}else{let d=o.p;d===null&&(o.p=d=new Map);const g=d.get(m);g===void 0?(o=J(),d.set(m,o)):o=g}}const l=o;let u;if(o.s===Se)u=o.v;else if(u=r.apply(null,arguments),i++,n){const f=((h=s==null?void 0:s.deref)==null?void 0:h.call(s))??s;f!=null&&n(f,u)&&(u=f,i!==0&&i--),s=typeof u=="object"&&u!==null||typeof u=="function"?new bt(u):u}return l.s=Se,l.v=u,u}return a.clearCache=()=>{t=J(),a.resetResultsCount()},a.resultsCount=()=>i,a.resetResultsCount=()=>{i=0},a}function wt(r,...e){const t=typeof r=="function"?{memoize:r,memoizeOptions:e}:r,n=(...s)=>{let i=0,a=0,o,c={},l=s.pop();typeof l=="object"&&(c=l,l=s.pop()),mt(l,`createSelector expects an output function after the inputs, but received: [${typeof l}]`);const u={...t,...c},{memoize:h,memoizeOptions:f=[],argsMemoize:p=De,argsMemoizeOptions:m=[]}=u,d=Me(f),g=Me(m),v=Ct(s),w=h(function(){return i++,l.apply(null,arguments)},...d),C=p(function(){a++;const b=vt(v,arguments);return o=w.apply(null,b),o},...g);return Object.assign(C,{resultFunc:l,memoizedResultFunc:w,dependencies:v,dependencyRecomputations:()=>a,resetDependencyRecomputations:()=>{a=0},lastResult:()=>o,recomputations:()=>i,resetRecomputations:()=>{i=0},memoize:h,argsMemoize:p})};return Object.assign(n,{withTypes:()=>n}),n}var ne=wt(De),At=Object.assign((r,e=ne)=>{gt(r,`createStructuredSelector expects first argument to be an object where each property is a selector, instead received a ${typeof r}`);const t=Object.keys(r),n=t.map(i=>r[i]);return e(n,(...i)=>i.reduce((a,o,c)=>(a[t[c]]=o,a),{}))},{withTypes:()=>At});function Le(r){return({dispatch:t,getState:n})=>s=>i=>typeof i=="function"?i(t,n,r):s(i)}var $t=Le(),Pt=Le,Mt=typeof window<"u"&&window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__?window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__:function(){if(arguments.length!==0)return typeof arguments[0]=="object"?ue:ue.apply(null,arguments)},St=r=>r&&typeof r.match=="function";function D(r,e){function t(...n){if(e){let s=e(...n);if(!s)throw new Error(V(0));return{type:r,payload:s.payload,..."meta"in s&&{meta:s.meta},..."error"in s&&{error:s.error}}}return{type:r,payload:n[0]}}return t.toString=()=>`${r}`,t.type=r,t.match=n=>st(n)&&n.type===r,t}var He=class z extends Array{constructor(...e){super(...e),Object.setPrototypeOf(this,z.prototype)}static get[Symbol.species](){return z}concat(...e){return super.concat.apply(this,e)}prepend(...e){return e.length===1&&Array.isArray(e[0])?new z(...e[0].concat(this)):new z(...e.concat(this))}};function Re(r){return q(r)?ze(r,()=>{}):r}function K(r,e,t){return r.has(e)?r.get(e):r.set(e,t(e)).get(e)}function Rt(r){return typeof r=="boolean"}var _t=()=>function(e){const{thunk:t=!0,immutableCheck:n=!0,serializableCheck:s=!0,actionCreatorCheck:i=!0}=e??{};let a=new He;return t&&(Rt(t)?a.push($t):a.push(Pt(t.extraArgument))),a},kt="RTK_autoBatch",_e=r=>e=>{setTimeout(e,r)},xt=(r={type:"raf"})=>e=>(...t)=>{const n=e(...t);let s=!0,i=!1,a=!1;const o=new Set,c=r.type==="tick"?queueMicrotask:r.type==="raf"?typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame:_e(10):r.type==="callback"?r.queueNotification:_e(r.timeout),l=()=>{a=!1,i&&(i=!1,o.forEach(u=>u()))};return Object.assign({},n,{subscribe(u){const h=()=>s&&u(),f=n.subscribe(h);return o.add(u),()=>{f(),o.delete(u)}},dispatch(u){var h;try{return s=!((h=u==null?void 0:u.meta)!=null&&h[kt]),i=!s,i&&(a||(a=!0,c(l))),n.dispatch(u)}finally{s=!0}}})},Ot=r=>function(t){const{autoBatch:n=!0}=t??{};let s=new He(r);return n&&s.push(xt(typeof n=="object"?n:void 0)),s};function dn(r){const e=_t(),{reducer:t=void 0,middleware:n,devTools:s=!0,preloadedState:i=void 0,enhancers:a=void 0}=r||{};let o;if(typeof t=="function")o=t;else if(et(t))o=tt(t);else throw new Error(V(1));let c;typeof n=="function"?c=n(e):c=e();let l=ue;s&&(l=Mt({trace:!1,...typeof s=="object"&&s}));const u=nt(...c),h=Ot(u);let f=typeof a=="function"?a(h):h();const p=l(...f);return rt(o,i,p)}function Be(r){const e={},t=[];let n;const s={addCase(i,a){const o=typeof i=="string"?i:i.type;if(!o)throw new Error(V(28));if(o in e)throw new Error(V(29));return e[o]=a,s},addMatcher(i,a){return t.push({matcher:i,reducer:a}),s},addDefaultCase(i){return n=i,s}};return r(s),[e,t,n]}function Vt(r){return typeof r=="function"}function qt(r,e){let[t,n,s]=Be(e),i;if(Vt(r))i=()=>Re(r());else{const o=Re(r);i=()=>o}function a(o=i(),c){let l=[t[c.type],...n.filter(({matcher:u})=>u(c)).map(({reducer:u})=>u)];return l.filter(u=>!!u).length===0&&(l=[s]),l.reduce((u,h)=>{if(h)if(N(u)){const p=h(u,c);return p===void 0?u:p}else{if(q(u))return ze(u,f=>h(f,c));{const f=h(u,c);if(f===void 0){if(u===null)return u;throw Error("A case reducer on a non-draftable value must not return undefined")}return f}}return u},o)}return a.getInitialState=i,a}var jt=(r,e)=>St(r)?r.match(e):r(e);function Nt(...r){return e=>r.some(t=>jt(t,e))}var Ft="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW",It=(r=21)=>{let e="",t=r;for(;t--;)e+=Ft[Math.random()*64|0];return e},zt=["name","message","stack","code"],ie=class{constructor(r,e){M(this,"_type");this.payload=r,this.meta=e}},ke=class{constructor(r,e){M(this,"_type");this.payload=r,this.meta=e}},Dt=r=>{if(typeof r=="object"&&r!==null){const e={};for(const t of zt)typeof r[t]=="string"&&(e[t]=r[t]);return e}return{message:String(r)}},xe="External signal was aborted",Je=(()=>{function r(e,t,n){const s=D(e+"/fulfilled",(c,l,u,h)=>({payload:c,meta:{...h||{},arg:u,requestId:l,requestStatus:"fulfilled"}})),i=D(e+"/pending",(c,l,u)=>({payload:void 0,meta:{...u||{},arg:l,requestId:c,requestStatus:"pending"}})),a=D(e+"/rejected",(c,l,u,h,f)=>({payload:h,error:(n&&n.serializeError||Dt)(c||"Rejected"),meta:{...f||{},arg:u,requestId:l,rejectedWithValue:!!h,requestStatus:"rejected",aborted:(c==null?void 0:c.name)==="AbortError",condition:(c==null?void 0:c.name)==="ConditionError"}}));function o(c,{signal:l}={}){return(u,h,f)=>{const p=n!=null&&n.idGenerator?n.idGenerator(c):It(),m=new AbortController;let d,g;function v(C){g=C,m.abort()}l&&(l.aborted?v(xe):l.addEventListener("abort",()=>v(xe),{once:!0}));const w=async function(){var b,A;let C;try{let T=(b=n==null?void 0:n.condition)==null?void 0:b.call(n,c,{getState:h,extra:f});if(Ht(T)&&(T=await T),T===!1||m.signal.aborted)throw{name:"ConditionError",message:"Aborted due to condition callback returning false."};const $=new Promise((E,x)=>{d=()=>{x({name:"AbortError",message:g||"Aborted"})},m.signal.addEventListener("abort",d)});u(i(p,c,(A=n==null?void 0:n.getPendingMeta)==null?void 0:A.call(n,{requestId:p,arg:c},{getState:h,extra:f}))),C=await Promise.race([$,Promise.resolve(t(c,{dispatch:u,getState:h,extra:f,requestId:p,signal:m.signal,abort:v,rejectWithValue:(E,x)=>new ie(E,x),fulfillWithValue:(E,x)=>new ke(E,x)})).then(E=>{if(E instanceof ie)throw E;return E instanceof ke?s(E.payload,p,c,E.meta):s(E,p,c)})])}catch(T){C=T instanceof ie?a(null,p,c,T.payload,T.meta):a(T,p,c)}finally{d&&m.signal.removeEventListener("abort",d)}return n&&!n.dispatchConditionRejection&&a.match(C)&&C.meta.condition||u(C),C}();return Object.assign(w,{abort:v,requestId:p,arg:c,unwrap(){return w.then(Lt)}})}}return Object.assign(o,{pending:i,rejected:a,fulfilled:s,settled:Nt(a,s),typePrefix:e})}return r.withTypes=()=>r,r})();function Lt(r){if(r.meta&&r.meta.rejectedWithValue)throw r.payload;if(r.error)throw r.error;return r.payload}function Ht(r){return r!==null&&typeof r=="object"&&typeof r.then=="function"}var Bt=Symbol.for("rtk-slice-createasyncthunk");function Jt(r,e){return`${r}/${e}`}function Kt({creators:r}={}){var t;const e=(t=r==null?void 0:r.asyncThunk)==null?void 0:t[Bt];return function(s){const{name:i,reducerPath:a=i}=s;if(!i)throw new Error(V(11));const o=(typeof s.reducers=="function"?s.reducers(Ut()):s.reducers)||{},c=Object.keys(o),l={sliceCaseReducersByName:{},sliceCaseReducersByType:{},actionCreators:{},sliceMatchers:[]},u={addCase(y,b){const A=typeof y=="string"?y:y.type;if(!A)throw new Error(V(12));if(A in l.sliceCaseReducersByType)throw new Error(V(13));return l.sliceCaseReducersByType[A]=b,u},addMatcher(y,b){return l.sliceMatchers.push({matcher:y,reducer:b}),u},exposeAction(y,b){return l.actionCreators[y]=b,u},exposeCaseReducer(y,b){return l.sliceCaseReducersByName[y]=b,u}};c.forEach(y=>{const b=o[y],A={reducerName:y,type:Jt(i,y),createNotation:typeof s.reducers=="function"};Yt(b)?Qt(A,b,u,e):Gt(A,b,u)});function h(){const[y={},b=[],A=void 0]=typeof s.extraReducers=="function"?Be(s.extraReducers):[s.extraReducers],T={...y,...l.sliceCaseReducersByType};return qt(s.initialState,$=>{for(let E in T)$.addCase(E,T[E]);for(let E of l.sliceMatchers)$.addMatcher(E.matcher,E.reducer);for(let E of b)$.addMatcher(E.matcher,E.reducer);A&&$.addDefaultCase(A)})}const f=y=>y,p=new Map,m=new WeakMap;let d;function g(y,b){return d||(d=h()),d(y,b)}function v(){return d||(d=h()),d.getInitialState()}function w(y,b=!1){function A($){let E=$[y];return typeof E>"u"&&b&&(E=K(m,A,v)),E}function T($=f){const E=K(p,b,()=>new WeakMap);return K(E,$,()=>{const x={};for(const[B,re]of Object.entries(s.selectors??{}))x[B]=Wt(re,$,()=>K(m,$,v),b);return x})}return{reducerPath:y,getSelectors:T,get selectors(){return T(A)},selectSlice:A}}const C={name:i,reducer:g,actions:l.actionCreators,caseReducers:l.sliceCaseReducersByName,getInitialState:v,...w(a),injectInto(y,{reducerPath:b,...A}={}){const T=b??a;return y.inject({reducerPath:T,reducer:g},A),{...C,...w(T,!0)}}};return C}}function Wt(r,e,t,n){function s(i,...a){let o=e(i);return typeof o>"u"&&n&&(o=t()),r(o,...a)}return s.unwrapped=r,s}var Te=Kt();function Ut(){function r(e,t){return{_reducerDefinitionType:"asyncThunk",payloadCreator:e,...t}}return r.withTypes=()=>r,{reducer(e){return Object.assign({[e.name](...t){return e(...t)}}[e.name],{_reducerDefinitionType:"reducer"})},preparedReducer(e,t){return{_reducerDefinitionType:"reducerWithPrepare",prepare:e,reducer:t}},asyncThunk:r}}function Gt({type:r,reducerName:e,createNotation:t},n,s){let i,a;if("reducer"in n){if(t&&!Xt(n))throw new Error(V(17));i=n.reducer,a=n.prepare}else i=n;s.addCase(r,i).exposeCaseReducer(e,i).exposeAction(e,a?D(r,a):D(r))}function Yt(r){return r._reducerDefinitionType==="asyncThunk"}function Xt(r){return r._reducerDefinitionType==="reducerWithPrepare"}function Qt({type:r,reducerName:e},t,n,s){if(!s)throw new Error(V(18));const{payloadCreator:i,fulfilled:a,pending:o,rejected:c,settled:l,options:u}=t,h=s(r,i,u);n.exposeAction(e,h),a&&n.addCase(h.fulfilled,a),o&&n.addCase(h.pending,o),c&&n.addCase(h.rejected,c),l&&n.addMatcher(h.settled,l),n.exposeCaseReducer(e,{fulfilled:a||W,pending:o||W,rejected:c||W,settled:l||W})}function W(){}function V(r){return`Minified Redux Toolkit error #${r}; visit https://redux-toolkit.js.org/Errors?code=${r} for the full message or use the non-minified dev environment for full errors. `}class Zt{constructor(){M(this,"MIN_SEQUENCE_LENGTH",2);M(this,"SEQUENCE_REPETITION_THRESHOLD",2);M(this,"CHARACTER_FOCUS_THRESHOLD",.4);M(this,"TEMPORAL_FOCUS_THRESHOLD",.4)}analyzePathPatterns(e,t){const n=[];return e.path.sequence.length<this.MIN_SEQUENCE_LENGTH||(n.push(...this.identifyRepeatedSequences(e.path)),n.push(...this.identifyCharacterFocusPatterns(e.path)),n.push(...this.identifyTemporalLayerPatterns(e.path)),n.push(...this.identifyReadingRhythmPatterns()),n.push(...this.identifyAttractorAffinityPatterns(e.path,t))),n}identifyRepeatedSequences(e){var s;const t=[],n=(s=e.patternSequences)==null?void 0:s.repeatedSequences;return!n||n.length===0||n.forEach(i=>{if(i.length>=this.MIN_SEQUENCE_LENGTH){const a=i.length,o=Math.floor(e.sequence.length/2),c=a/o;let l=0;for(let p=0;p<=e.sequence.length-a;p++)e.sequence.slice(p,p+a).every((d,g)=>d===i[g])&&l++;const u=Math.floor(e.sequence.length/a),h=Math.min(1,l/u),f=c*.4+h*.6;l>=this.SEQUENCE_REPETITION_THRESHOLD&&t.push({type:"sequence",strength:f,description:`Repeated sequence of ${a} nodes visited ${l} times`,relatedNodes:i})}}),t}identifyCharacterFocusPatterns(e){var o;const t=[],n=e.characterFocus;if(!n)return t;const i=(e.detailedVisits||[]).length;if(i===0)return t;Object.entries(n).forEach(([c,l])=>{const u=l/i;if(u>=this.CHARACTER_FOCUS_THRESHOLD){const f=.5+.5*((u-this.CHARACTER_FOCUS_THRESHOLD)/(1-this.CHARACTER_FOCUS_THRESHOLD));t.push({type:"character",strength:f,description:`Strong focus on ${c} perspective (${Math.round(u*100)}% of visits)`,relatedCharacters:[c]})}});const a=(o=e.patternSequences)==null?void 0:o.characterSequences;if(a&&a.length>0){const c=a[0];if(c.length>=4){let l=0;for(let f=0;f<c.length-3;f++){const p=c[f],m=c[f+1];p!==m&&c[f+2]===p&&c[f+3]===m&&l++}const u=Math.floor((c.length-3)/2),h=l/u;h>=.3&&t.push({type:"character",strength:h,description:"Pattern of alternating between character perspectives",relatedCharacters:Array.from(new Set(c))})}}return t}identifyTemporalLayerPatterns(e){var o;const t=[],n=e.temporalLayerFocus;if(!n)return t;const i=(e.detailedVisits||[]).length;if(i===0)return t;Object.entries(n).forEach(([c,l])=>{const u=l/i;if(u>=this.TEMPORAL_FOCUS_THRESHOLD){const f=.5+.5*((u-this.TEMPORAL_FOCUS_THRESHOLD)/(1-this.TEMPORAL_FOCUS_THRESHOLD));t.push({type:"temporal",strength:f,description:`Strong focus on ${c} temporal layer (${Math.round(u*100)}% of visits)`,relatedTemporalLayers:[c]})}});const a=(o=e.patternSequences)==null?void 0:o.temporalSequences;if(a&&a.length>0){const c=a[0];if(c.length>=5){let l=0;for(let m=0;m<c.length-2;m++){const d=c[m],g=c[m+1],v=c[m+2];(d==="past"&&g==="present"&&v==="future"||d==="past"&&g==="present"||g==="present"&&v==="future")&&l++}const u=c.length-2,h=l/u;h>=.3&&t.push({type:"temporal",strength:h,description:"Pattern of chronological progression through time",relatedTemporalLayers:["past","present","future"]});let f=0;for(let m=0;m<c.length-2;m++){const d=c[m],g=c[m+1],v=c[m+2];(d==="future"&&g==="present"&&v==="past"||d==="future"&&g==="present"||g==="present"&&v==="past")&&f++}const p=f/u;p>=.3&&t.push({type:"temporal",strength:p,description:"Pattern of reverse chronological movement through time",relatedTemporalLayers:["future","present","past"]})}}return t}identifyReadingRhythmPatterns(){return[]}identifyAttractorAffinityPatterns(e,t){const n=[],s=e.attractorsEngaged,i=e.detailedVisits||[];if(!s||Object.keys(s).length===0)return n;const a=Object.values(s).reduce((o,c)=>o+c,0);if(a===0)return n;if(Object.entries(s).forEach(([o,c])=>{const l=c/a;if(l>=.25){const u=Object.values(t).filter(p=>p.strangeAttractors.includes(o)).map(p=>p.id);let h=0;u.length>0&&(h=i.filter(m=>u.includes(m.nodeId)).length/i.length);const f=l*.7+h*.3;n.push({type:"thematic",strength:f,description:`Strong affinity for "${o}" concept/theme`,relatedAttractors:[o],relatedNodes:u})}}),i.length>=3){const o={};Object.values(t).forEach(h=>{o[h.id]=h.strangeAttractors});const c=i.slice(-Math.min(10,i.length));let l=0;for(let h=1;h<c.length;h++){const f=c[h-1].nodeId,p=c[h].nodeId,m=o[f]||[],d=o[p]||[];m.filter(v=>d.includes(v)).length>0&&l++}const u=l/(c.length-1);u>=.5&&n.push({type:"thematic",strength:u,description:"Pattern of following thematic connections between nodes"})}return n}calculateAttractorEngagement(e,t){const{path:n}=e,s=n.attractorsEngaged,i=n.detailedVisits||[];if(!s||Object.keys(s).length===0)return[];const a=[];return Object.entries(s).forEach(([o,c])=>{const l=o;if(c===0)return;const u=Object.values(t).filter(w=>w.strangeAttractors.includes(l)).map(w=>w.id),h=i.filter(w=>w.engagedAttractors.includes(l));if(h.length===0)return;let f="stable";if(h.length>=3){const w=Math.floor(h.length/2),C=h.slice(0,w),y=h.slice(w);y.length>C.length*1.2?f="rising":y.length<C.length*.8&&(f="falling")}const p=Object.values(s).reduce((w,C)=>w+C,0),m=c/p*100,d=i.indexOf(h[h.length-1])>i.length*.7?.8:.4,g=h.length>c*.5?.7:.3,v=Math.min(100,m*.6+d*20+g*20);a.push({attractor:l,engagementScore:v,totalEngagements:c,relatedNodes:u,trend:f})}),a.sort((o,c)=>c.engagementScore-o.engagementScore)}identifySignificantPatterns(e,t){return this.analyzePathPatterns(e,t).sort((i,a)=>a.strength-i.strength).filter(i=>i.strength>=.6).slice(0,5)}createTransformationConditions(e,t){const n=[];return e.forEach(s=>{switch(s.type){case"sequence":s.relatedNodes&&s.relatedNodes.length>=2&&n.push({type:"visitPattern",condition:{visitPattern:s.relatedNodes},strength:s.strength});break;case"character":s.relatedCharacters&&s.relatedCharacters.length>0&&n.push({type:"characterFocus",condition:{characters:s.relatedCharacters},strength:s.strength});break;case"temporal":s.relatedTemporalLayers&&s.relatedTemporalLayers.length>0&&n.push({type:"temporalFocus",condition:{temporalPosition:s.relatedTemporalLayers[0]},strength:s.strength});break;case"rhythm":break;case"thematic":s.relatedAttractors&&s.relatedAttractors.length>0&&n.push({type:"attractorAffinity",condition:{strangeAttractorsEngaged:s.relatedAttractors},strength:s.strength});break}}),t.filter(s=>s.engagementScore>=50).forEach(s=>{n.push({type:"attractorEngagement",condition:{strangeAttractorsEngaged:[s.attractor]},strength:s.engagementScore/100})}),n}analyzeRecursivePatterns(e,t){const{sequence:n}=e.path,s=[];if(n.length<4)return s;for(let i=2;i<=4;i++){const a=new Map;for(let o=0;o<=n.length-i;o++){const c=n.slice(o,o+i),l=c.join("->");a.has(l)||a.set(l,{sequence:c,length:i,occurrences:0,lastOccurrenceIndex:o,strength:0,temporalSpread:0});const u=a.get(l);u.occurrences++,u.lastOccurrenceIndex=Math.max(u.lastOccurrenceIndex,o)}a.forEach(o=>{if(o.occurrences>=2){const c=Math.min(1,o.occurrences/(n.length/i)),l=1-(n.length-o.lastOccurrenceIndex)/n.length;o.strength=c*.7+l*.3;const u=[];for(let f=0;f<=n.length-i;f++)n.slice(f,f+i).every((m,d)=>m===o.sequence[d])&&u.push(f);if(u.length>1){const f=u.slice(1).map((d,g)=>d-u[g]),p=f.reduce((d,g)=>d+g,0)/f.length,m=n.length/u.length;o.temporalSpread=Math.min(1,p/m)}const h=o.sequence.map(f=>t[f]).filter(Boolean);h.length>0&&(h.length===o.sequence.length||console.warn(`Pattern contains invalid node references: ${o.sequence}`)),s.push(o)}})}return s.sort((i,a)=>a.strength-i.strength)}calculateCharacterFocusIntensity(e,t){const{sequence:n,characterFocus:s={}}=e.path,i=[];if(n.length===0)return i;const a=n.map(c=>{var l;return(l=t[c])==null?void 0:l.character}).filter(c=>!!c),o=a.length;return Object.keys(s).forEach(c=>{const l=c,u=s[l];if(u>0){const h=u/o;let f=0,p=0;a.forEach(T=>{T===l?(p++,f=Math.max(f,p)):p=0});const m=a.map((T,$)=>T===l?$:-1).filter(T=>T!==-1);let d=0;if(m.length>1){const T=m.slice(1).map(($,E)=>$-m[E]);d=T.reduce(($,E)=>$+E,0)/T.length}const g=Object.keys(t).filter(T=>t[T].character===l),v=n.filter(T=>g.includes(T)),w=[...new Set(v.map(T=>{const $=t[T].temporalValue;return $<=3?"past":$<=6?"present":"future"}))],C=Math.min(1,h*2),y=Math.min(1,f/5),b=w.length/3,A=C*.5+y*.3+b*.2;i.push({character:l,visitRatio:h,intensity:A,consecutiveVisits:f,avgTimeBetweenVisits:d,temporalSpread:w})}}),i.sort((c,l)=>l.intensity-c.intensity)}detectStrangeAttractors(e,t){const{sequence:n,revisitPatterns:s}=e.path,i=[];return n.length<3?i:(Object.entries(s).forEach(([a,o])=>{if(o>1){const c=o-1,l=n.map((u,h)=>u===a?h:-1).filter(u=>u!==-1);if(l.length>1){const u=c/n.length,h=l.slice(1).map((C,y)=>C-l[y]),f=h.reduce((C,y)=>C+y,0)/h.length,p=Math.min(1,u*10),m=1-(Math.max(...h)-Math.min(...h))/Math.max(...h),d=1-(n.length-Math.max(...l))/n.length,g=p*.5+m*.3+d*.2,v=t[a],w=v?v.strangeAttractors:[];i.push({nodeId:a,returnFrequency:u,totalReturns:c,averageGapBetweenReturns:f,magneticStrength:g,attractorThemes:w,lastReturnIndex:Math.max(...l)})}}}),i.sort((a,o)=>o.magneticStrength-a.magneticStrength))}analyzeTemporalJumping(e,t){const{sequence:n,temporalLayerFocus:s={}}=e.path;if(n.length<2)return{totalJumps:0,jumpFrequency:0,preferredJumpDirection:"mixed",jumpDistances:[],averageJumpDistance:0,maxJumpDistance:0,temporalAnchoring:{past:0,present:0,future:0},volatility:0};const i=n.map(C=>{const y=t[C];return y?y.temporalValue:0}).filter(C=>C>0),a=[],o=[];for(let C=1;C<i.length;C++){const y=i[C-1],b=i[C],A=Math.abs(b-y);A>0&&(a.push(A),o.push(b>y?"forward":"backward"))}const c=a.length,l=c/n.length,u=a.length>0?a.reduce((C,y)=>C+y,0)/a.length:0,h=a.length>0?Math.max(...a):0,f=o.filter(C=>C==="forward").length,p=o.filter(C=>C==="backward").length;let m="mixed";f>p*1.5?m="forward":p>f*1.5&&(m="backward");const d=s,g=Object.values(d).reduce((C,y)=>C+y,0),v={past:g>0?(d.past||0)/g:0,present:g>0?(d.present||0)/g:0,future:g>0?(d.future||0)/g:0};let w=0;if(a.length>1){const C=a.reduce((y,b)=>{const A=b-u;return y+A*A},0)/a.length;w=Math.min(1,Math.sqrt(C)/4)}return{totalJumps:c,jumpFrequency:l,preferredJumpDirection:m,jumpDistances:a,averageJumpDistance:u,maxJumpDistance:h,temporalAnchoring:v,volatility:w}}generateJourneyFingerprint(e,t){const{sequence:n,attractorsEngaged:s={}}=e.path,i=this.analyzeRecursivePatterns(e,t),a=this.calculateCharacterFocusIntensity(e,t),o=this.detectStrangeAttractors(e,t),c=this.analyzeTemporalJumping(e,t),l=i.length>0?i.reduce((P,R)=>P+R.strength,0)/i.length:0,u=a.length>0?Math.max(...a.map(P=>P.intensity)):0,h=Math.min(1,c.jumpFrequency*2),f=Math.min(1,l*.3+c.volatility*.3+o.length/10*.4);let p="linear";f>.7?p="chaotic":l>.6?p="recursive":u>.7?p="focused":c.volatility>.5&&(p="wandering");const m=a.sort((P,R)=>R.intensity-P.intensity).map(P=>P.character),{temporalAnchoring:d}=c;let g="time-fluid";d.past>.5?g="past-oriented":d.present>.5?g="present-focused":d.future>.5&&(g="future-seeking");let v="intuitive";const w=s,C=Object.keys(w).length,y=Object.values(w).reduce((P,R)=>P+R,0);p==="linear"&&c.volatility<.3?v="systematic":C>5&&y>n.length*.8?v="thematic":f>.6&&(v="experimental");const b=i.slice(0,3).map(P=>P.length),A={Archaeologist:{Archaeologist:0,Algorithm:0,LastHuman:0},Algorithm:{Archaeologist:0,Algorithm:0,LastHuman:0},LastHuman:{Archaeologist:0,Algorithm:0,LastHuman:0}},T=n.map(P=>{var R;return(R=t[P])==null?void 0:R.character}).filter(P=>!!P);for(let P=1;P<T.length;P++){const R=T[P-1],be=T[P];R&&be&&A[R][be]++}const $=Array(9).fill(0);c.jumpDistances.forEach(P=>{P<$.length&&$[P]++});const E=Object.values(w),x=E.length>0?Math.max(...E):0,B={};Object.entries(w).forEach(([P,R])=>{B[P]=x>0?R/x:0});const re=[p,g,v,Math.floor(l*100),Math.floor(u*100),Math.floor(h*100),Math.floor(f*100)].join("-");return{id:`journey-${n.length}-${re}`,explorationStyle:p,characterAffinity:m,temporalPreference:g,narrativeApproach:v,recursiveIndex:l,focusIndex:u,velocityIndex:h,complexityIndex:f,dominantPatternLengths:b,characterTransitionMatrix:A,temporalJumpSignature:$,attractorEngagementProfile:B,pathLength:n.length,uniqueNodesVisited:new Set(n).size,generatedAt:n.length}}}const S=new Zt;class Ke{static calculateBleedEffects(e,t){const n=[],s=this.getLastVisitedNode(t);if(console.log(`[CharacterBleedService] Analyzing character bleed for node ${e.id}:`,{currentCharacter:e.character,lastVisitedCharacter:(s==null?void 0:s.character)||"None",lastVisitedNode:(s==null?void 0:s.nodeId)||"None"}),!s||s.character===e.character)return console.log(`[CharacterBleedService] No character bleed detected - ${s?"same character":"no previous character"}`),n;console.log(`[CharacterBleedService] Character transition detected: ${s.character} → ${e.character}`);const i=this.getCharacterSpecificBleed(s.character,e.character,e).slice(0,2);n.push(...i),console.log(`[CharacterBleedService] Added ${i.length} character-specific bleed effects`);const a=this.getGeneralBleedEffects(s.character,e.character,e,t).slice(0,1);return n.push(...a),console.log(`[CharacterBleedService] Added ${a.length} general bleed effects`),console.log(`[CharacterBleedService] Total character bleed effects: ${n.length}`),n}static getLastVisitedNode(e){const t=e.path.detailedVisits;if(!t||t.length<2)return null;const n=t[t.length-2];return{character:n.character,nodeId:n.nodeId}}static getCharacterSpecificBleed(e,t,n){const s=[];if(!n.currentContent)return s;const i=n.currentContent,a=i.split(`

`).filter(o=>o.trim().length>0);return e==="Algorithm"&&t==="Archaeologist"?(this.findTechnicalTerms(i).forEach(c=>{s.push({type:"fragment",selector:c,transformation:{type:"fragment",selector:c,fragmentPattern:"̶",fragmentStyle:"character",intensity:3},reason:"Algorithmic corruption bleeding into archaeological interpretation",sourceCharacter:e,targetCharacter:t,intensity:3})}),a.length>1&&s.push({type:"metaComment",selector:a[1],transformation:{type:"metaComment",selector:a[1],replacement:"data integrity compromised",commentStyle:"marginalia",intensity:2},reason:"Algorithmic perspective introduces doubt about information reliability",sourceCharacter:e,targetCharacter:t,intensity:2})):e==="Algorithm"&&t==="LastHuman"?(this.findPatterns(i).forEach(c=>{s.push({type:"emphasize",selector:c,transformation:{type:"emphasize",selector:c,emphasis:"glitch",intensity:4},reason:"Algorithmic pattern recognition bleeding into human consciousness",sourceCharacter:e,targetCharacter:t,intensity:4})}),a.length>0&&s.push({type:"expand",selector:a[0],transformation:{type:"expand",selector:a[0],replacement:"[PATTERN_DETECTED: recursive_loop_identified]",expandStyle:"inline",intensity:3},reason:"Algorithmic analysis intrudes on human experience",sourceCharacter:e,targetCharacter:t,intensity:3})):e==="Archaeologist"&&t==="Algorithm"?(this.findTimeTerms(i).forEach(c=>{s.push({type:"replace",selector:c,transformation:{type:"replace",selector:c,replacement:`${c}[TEMPORAL_MARKER:${this.getRandomTimestamp()}]`,preserveFormatting:!0,intensity:3},reason:"Archaeological time-consciousness bleeds into algorithmic processing",sourceCharacter:e,targetCharacter:t,intensity:3})}),a.length>2&&s.push({type:"metaComment",selector:a[2],transformation:{type:"metaComment",selector:a[2],replacement:"chronological displacement detected",commentStyle:"interlinear",intensity:2},reason:"Archaeological temporal awareness influences algorithmic perception",sourceCharacter:e,targetCharacter:t,intensity:2})):e==="LastHuman"&&t!=="LastHuman"&&(this.findEmotionalTerms(i).forEach(c=>{s.push({type:"emphasize",selector:c,transformation:{type:"emphasize",selector:c,emphasis:"fade",intensity:2},reason:"Human memory and emotion bleeds into analytical perspective",sourceCharacter:e,targetCharacter:t,intensity:2})}),a.length>0&&s.push({type:"expand",selector:a[0],transformation:{type:"expand",selector:a[0],replacement:"(a memory surface, warm and fading)",expandStyle:"append",intensity:2},reason:"Human experiential memory creates emotional overlay",sourceCharacter:e,targetCharacter:t,intensity:2})),s}static getGeneralBleedEffects(e,t,n,s){const i=[];if(!n.currentContent)return i;const a=this.calculateTransitionCount(e,t,s),o=Math.min(5,Math.max(1,Math.floor(a/2)+1)),c=this.getFirstSentence(n.currentContent);return c&&i.push({type:"metaComment",selector:c,transformation:{type:"metaComment",selector:c,replacement:`perspective shift: ${e} → ${t}`,commentStyle:"marginalia",intensity:o},reason:"Character transition creates perspective shift awareness",sourceCharacter:e,targetCharacter:t,intensity:o}),i}static findTechnicalTerms(e){const t=["system","process","data","algorithm","compute","execute","protocol","interface","network","digital","binary","code"];return e.toLowerCase().split(/\s+/).filter(s=>t.some(i=>s.includes(i))).slice(0,3)}static findPatterns(e){const t=e.split(/\s+/),n=[],s={};return t.forEach(i=>{const a=i.toLowerCase().replace(/[^\w]/g,"");a.length>3&&(s[a]=(s[a]||0)+1)}),Object.entries(s).forEach(([i,a])=>{a>1&&n.length<2&&n.push(i)}),n}static findTimeTerms(e){const t=["past","present","future","time","when","before","after","now","then","moment","history","ancient","memory"];return e.toLowerCase().split(/\s+/).filter(s=>t.some(i=>s.includes(i))).slice(0,2)}static findEmotionalTerms(e){const t=["feel","remember","love","fear","hope","dream","wish","heart","soul","mind","consciousness","awareness","experience"];return e.toLowerCase().split(/\s+/).filter(s=>t.some(i=>s.includes(i))).slice(0,2)}static calculateTransitionCount(e,t,n){const s=n.path.detailedVisits||[];let i=0;for(let a=1;a<s.length;a++){const o=s[a-1],c=s[a];o.character===e&&c.character===t&&i++}return i}static getFirstSentence(e){var s;const n=(s=e.split(/[.!?]+/)[0])==null?void 0:s.trim();return n&&n.length>10?n:null}static getRandomTimestamp(){const e=["2157.03.14","1847.11.22","2891.07.08","0034.12.31","3456.01.15"];return e[Math.floor(Math.random()*e.length)]}}class oe{constructor(e){M(this,"capacity");M(this,"cache");M(this,"keys");this.capacity=e,this.cache=new Map,this.keys=[]}get(e){if(this.cache.has(e))return this.keys=this.keys.filter(t=>t!==e),this.keys.push(e),this.cache.get(e)}put(e,t){if(this.cache.has(e)){this.cache.set(e,t),this.keys=this.keys.filter(n=>n!==e),this.keys.push(e);return}if(this.keys.length>=this.capacity){const n=this.keys.shift();n!==void 0&&this.cache.delete(n)}this.cache.set(e,t),this.keys.push(e)}clear(){this.cache.clear(),this.keys=[]}size(){return this.cache.size}getStats(){return{size:this.cache.size,capacity:this.capacity}}}class en{constructor(){M(this,"conditionCache",new oe(500));M(this,"transformationCache",new oe(200));M(this,"batchedTransformationCache",new oe(100));M(this,"stats",{conditionEvaluations:0,conditionCacheHits:0,transformations:0,transformationCacheHits:0,batchedTransformations:0,batchedCacheHits:0});M(this,"lastModificationTime",Date.now())}getConditionCacheKey(e,t,n){const s=JSON.stringify(e),i=JSON.stringify({path:{sequence:t.path.sequence,revisitPatterns:t.path.revisitPatterns,detailedVisits:t.path.detailedVisits,characterFocus:t.path.characterFocus,temporalLayerFocus:t.path.temporalLayerFocus,attractorsEngaged:t.path.attractorsEngaged},endpointProgress:t.endpointProgress}),a=JSON.stringify({id:n.id,visitCount:n.visitCount,temporalValue:n.temporalValue,strangeAttractors:n.strangeAttractors});return`v1:${n.id}:${s}:${i}:${a}`}getTransformationCacheKey(e,t,n={}){const{contentPrefix:s=30,includeTransformations:i=!0}=n,a=e.substring(0,s),o=i?t.map(l=>{var u;return`${l.type}:${(u=l.selector)==null?void 0:u.substring(0,10)}:${l.priority}`}).join("|"):"",c=Math.floor(this.lastModificationTime/1e3);return`v1:${a}:${t.length}:${c}:${o}`}invalidateCaches(){this.conditionCache.clear(),this.transformationCache.clear(),this.batchedTransformationCache.clear(),this.lastModificationTime=Date.now()}evaluateCondition(e,t,n){var a,o,c,l,u,h,f;if(this.stats.conditionEvaluations++,Object.keys(e).length===0)return!0;const s=this.getConditionCacheKey(e,t,n),i=this.conditionCache.get(s);if(i!==void 0)return this.stats.conditionCacheHits++,i;if((a=e.allOf)!=null&&a.length)return e.allOf.every(p=>this.evaluateCondition(p,t,n));if((o=e.anyOf)!=null&&o.length)return e.anyOf.some(p=>this.evaluateCondition(p,t,n));if(e.not)return!this.evaluateCondition(e.not,t,n);if(e.visitCount!==void 0&&n.visitCount<e.visitCount)return!1;if((c=e.previouslyVisitedNodes)!=null&&c.length){const p=t.path.sequence||[];if(!e.previouslyVisitedNodes.every(m=>p.includes(m)))return!1}if((l=e.visitPattern)!=null&&l.length&&!this.matchesPattern(e.visitPattern,t.path.sequence)||(u=e.strangeAttractorsEngaged)!=null&&u.length&&!this.checkAttractorsEngaged(e.strangeAttractorsEngaged,t)||e.temporalPosition&&this.getNodeTemporalPosition(n)!==e.temporalPosition)return!1;if(e.endpointProgress){const{orientation:p,minValue:m}=e.endpointProgress;if(!t.endpointProgress||t.endpointProgress[p]<m)return!1}if((h=e.revisitPattern)!=null&&h.length){for(const p of e.revisitPattern)if(((t.path.revisitPatterns||{})[p.nodeId]||0)<p.minVisits)return!1}return e.characterBleed&&!this.checkCharacterBleed(t,n)||(f=e.journeyPattern)!=null&&f.length&&!this.matchesJourneyPattern(e.journeyPattern,t.path.sequence)||e.characterFocus&&!this.checkCharacterFocus(e.characterFocus,t,n)||e.temporalFocus&&!this.checkTemporalFocus(e.temporalFocus,t,n)||e.attractorAffinity&&!this.checkAttractorAffinity(e.attractorAffinity,t,n)||e.attractorEngagement&&!this.checkAttractorEngagement(e.attractorEngagement,t,n)||e.recursivePattern&&!this.checkRecursivePattern(e.recursivePattern,t,n)||e.journeyFingerprint&&!this.checkJourneyFingerprint(e.journeyFingerprint,t,n)?!1:(this.conditionCache.put(s,!0),!0)}matchesPattern(e,t){if(e.length===0)return!0;if(t.length===0)return!1;for(let n=0;n<=t.length-e.length;n++){let s=!0;for(let i=0;i<e.length;i++)if(t[n+i]!==e[i]){s=!1;break}if(s)return!0}return!1}checkAttractorsEngaged(e,t){if(!e||!t.path)return!1;const n=t.path.attractorsEngaged||{};return e.every(s=>(n[s]||0)>0)}getNodeTemporalPosition(e){return e.temporalValue<=3?"past":e.temporalValue<=6?"present":"future"}checkCharacterBleed(e,t){return!e.path.detailedVisits||e.path.detailedVisits.length<2?!1:e.path.detailedVisits[e.path.detailedVisits.length-2].character!==t.character}matchesJourneyPattern(e,t){if(e.length===0)return!0;if(t.length<e.length)return!1;const n=t.slice(-e.length);for(let s=0;s<e.length;s++)if(n[s]!==e[s])return!1;return!0}checkCharacterFocus(e,t,n){var o;const{characters:s,minFocusRatio:i=.4,includeIntensity:a=!1}=e;if(a){const c=S.calculateCharacterFocusIntensity(t,{[n.id]:n});return s.some(l=>{const u=c.find(h=>h.character===l);return u&&u.intensity>=i})}else{const{characterFocus:c}=t.path;if(!c)return!1;const l=((o=t.path.detailedVisits)==null?void 0:o.length)||0;return l===0?!1:s.some(u=>(c[u]||0)/l>=i)}}checkTemporalFocus(e,t,n){var f;const{temporalLayers:s,minFocusRatio:i=.4,includeProgression:a=!1}=e,{temporalLayerFocus:o}=t.path;if(!o)return!1;const c=((f=t.path.detailedVisits)==null?void 0:f.length)||0;if(c===0)return!1;const l=s.some(p=>(o[p]||0)/c>=i);if(!a)return l;const h=S.analyzePathPatterns(t,{[n.id]:n}).filter(p=>p.type==="temporal");return l&&h.some(p=>p.strength>=.3)}checkAttractorAffinity(e,t,n){const{attractors:s,minAffinityRatio:i=.25,includeThematicContinuity:a=!1}=e,{attractorsEngaged:o}=t.path;if(!o)return!1;const c=Object.values(o).reduce((f,p)=>f+p,0);if(c===0)return!1;const l=s.some(f=>(o[f]||0)/c>=i);if(!a)return l;const h=S.analyzePathPatterns(t,{[n.id]:n}).filter(f=>f.type==="thematic");return l&&h.some(f=>f.strength>=.5)}checkAttractorEngagement(e,t,n){const{attractor:s,minEngagementScore:i=50,trendRequired:a="any"}=e,c=S.calculateAttractorEngagement(t,{[n.id]:n}).find(l=>l.attractor===s);return!(!c||c.engagementScore<i||a!=="any"&&c.trend!==a)}checkRecursivePattern(e,t,n){const{minPatternStrength:s=.6,maxPatternLength:i=4,requireRecency:a=!1}=e,o=S.analyzeRecursivePatterns(t,{[n.id]:n});return o.length===0?!1:o.filter(l=>{if(l.strength<s||l.length>i)return!1;if(a){const u=t.path.sequence.length*.7;if(l.lastOccurrenceIndex<u)return!1}return!0}).length>0}checkJourneyFingerprint(e,t,n){const{explorationStyle:s,temporalPreference:i,narrativeApproach:a,minComplexityIndex:o,minFocusIndex:c}=e,l=S.generateJourneyFingerprint(t,{[n.id]:n});return!(s&&l.explorationStyle!==s||i&&l.temporalPreference!==i||a&&l.narrativeApproach!==a||o!==void 0&&l.complexityIndex<o||c!==void 0&&l.focusIndex<c)}evaluateTransformation(e,t,n){const s=`rule:${JSON.stringify(e.condition)}:${n.id}:${n.visitCount}`,i=this.conditionCache.get(s);if(i!==void 0)return this.stats.conditionCacheHits++,{shouldApply:i,appliedTransformations:i?e.transformations:[]};this.stats.conditionEvaluations++;const a=this.evaluateCondition(e.condition,t,n);return this.conditionCache.put(s,a),{shouldApply:a,appliedTransformations:a?e.transformations:[]}}evaluateAllTransformations(e,t,n){return e.filter(s=>this.evaluateCondition(s.condition,t,n)).flatMap(s=>s.transformations)}applyTextTransformation(e,t){if(!t.selector)return e;if(e.includes("data-transform-type")&&e.length>1e4)return console.warn("[TransformationEngine] Content appears heavily transformed, skipping to prevent infinite loop"),e;this.stats.transformations++;const n=this.getTransformationCacheKey(e,[t],{contentPrefix:50,includeTransformations:!0}),s=this.transformationCache.get(n);if(s!==void 0)return this.stats.transformationCacheHits++,s;const i=this.escapeRegExp(t.selector),a=new RegExp(i,"g");switch(t.type){case"replace":{const o=t.replacement||"";if(t.preserveFormatting&&(t.selector.includes("*")||t.selector.includes("_")||t.selector.includes("`"))){const c=/(\*\*|\*|__|_|`{3}|`)/g,l=t.selector.match(c)||[];let u=o;return l.forEach(h=>{u.includes(h)||(u=`${h}${u}${h}`)}),e.replace(a,u)}return e.replace(a,o)}case"fragment":{if(!t.fragmentPattern)return e;const o=t.fragmentPattern,c=t.fragmentStyle||"character";let l="";switch(c){case"character":{l=t.selector.split("").join(o);break}case"word":{l=t.selector.split(" ").join(` ${o} `);break}case"progressive":{const u=t.selector.split("");l=u.map((h,f)=>{const p=Math.floor(f/(u.length/5))+1;return h+o.repeat(p)}).join("");break}default:l=t.selector.split("").join(o)}return e.replace(a,l)}case"expand":{const o=t.replacement||"";switch(t.expandStyle||"append"){case"append":return e.replace(a,`${t.selector} ${o}`);case"inline":return e.replace(a,`${t.selector} <span class="narramorph-inline-expansion">[${o}]</span>`);case"paragraph":return e.replace(a,`${t.selector}

<div class="narramorph-paragraph-expansion">${o}</div>`);case"reveal":return e.replace(a,`${t.selector} <span class="narramorph-reveal-expansion">${o}</span>`);default:return e.replace(a,`${t.selector} ${o}`)}}case"emphasize":{let o=t.selector;const c=t.intensity||1;switch(t.emphasis){case"italic":o=`*${t.selector}*`,c>1&&(o=`<em class="intensity-${c}">${t.selector}</em>`);break;case"bold":o=`**${t.selector}**`,c>1&&(o=`<strong class="intensity-${c}">${t.selector}</strong>`);break;case"color":o=`<span class="emphasized-text intensity-${c}">${t.selector}</span>`;break;case"spacing":{const l=" ".repeat(c);o=t.selector.split("").join(l);break}case"highlight":o=`<mark class="intensity-${c}">${t.selector}</mark>`;break;case"glitch":o=`<span class="glitch-text intensity-${c}" data-text="${t.selector}">${t.selector}</span>`;break;case"fade":o=`<span class="fade-text intensity-${c}">${t.selector}</span>`;break}return e.replace(a,o)}case"metaComment":{const o=t.commentStyle||"inline",c=t.replacement||"";switch(o){case"inline":return e.replace(a,`${t.selector} <span class="narramorph-comment">[${c}]</span>`);case"footnote":{const l=`footnote-${this.generateShortHash(t.selector)}`,u=e.includes('<div class="narramorph-footnotes">');let h=e.replace(a,`${t.selector}<sup class="narramorph-footnote-marker" id="${l}-ref">[†]</sup>`);if(u){const f=/<\/div>\s*<div class="narramorph-footnotes">/;f.test(h)?h=h.replace(f,`</div>

<div class="narramorph-footnotes">
<p id="${l}" class="narramorph-footnote">† <a href="#${l}-ref">↩</a> ${c}</p>`):h+=`

<p id="${l}" class="narramorph-footnote">† <a href="#${l}-ref">↩</a> ${c}</p>`}else h+=`

<div class="narramorph-footnotes">
<p id="${l}" class="narramorph-footnote">† <a href="#${l}-ref">↩</a> ${c}</p>
</div>`;return h}case"marginalia":return e.replace(a,`<span class="narramorph-marginalia-container">${t.selector}<span class="narramorph-marginalia">${c}</span></span>`);case"interlinear":return e.replace(a,`<div class="narramorph-interlinear-container">${t.selector}<div class="narramorph-interlinear">${c}</div></div>`);default:return e.replace(a,`${t.selector} [${c}]`)}}default:return e}}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}generateShortHash(e){let t=0;for(let n=0;n<e.length;n++){const s=e.charCodeAt(n);t=(t<<5)-t+s,t=t&t}return Math.abs(t).toString(36).substring(0,6)}applyTransformations(e,t){if(!e)return console.warn("Content is empty or undefined"),"";if(!Array.isArray(t)||t.length===0)return e;if(e.includes("data-transform-type")&&(e.length>15e3||t.length>20))return console.warn("[TransformationEngine] Content appears heavily transformed or too many transformations, skipping batch to prevent infinite loop"),e;this.stats.batchedTransformations++;const n=this.getTransformationCacheKey(e,t),s=this.batchedTransformationCache.get(n);if(s!==void 0)return this.stats.batchedCacheHits++,s;try{const a=[...t].sort((o,c)=>{const l=u=>u==="high"?3:u==="medium"?2:u==="low"?1:0;return l(c.priority)-l(o.priority)}).reduce((o,c)=>this.applyTextTransformation(o,c),e);return this.batchedTransformationCache.put(n,a),a}catch(i){return console.error("Error applying transformations:",i),e}}applyCharacterBleedTransformations(e,t,n,s){if(!e)return console.warn("[TransformationEngine] applyCharacterBleedTransformations: Content is empty"),"";if(!Array.isArray(s)||s.length===0)return console.log("[TransformationEngine] applyCharacterBleedTransformations: No character bleed effects to apply"),e;try{console.log(`[TransformationEngine] Applying ${s.length} character bleed transformations to node ${t.id}`);const i=s.map((l,u)=>{const h={...l.transformation};return h.priority||(h.priority="high"),console.log(`[TransformationEngine] Character bleed transformation ${u+1}: ${l.type} on "${l.selector.substring(0,30)}..." (${l.sourceCharacter} → ${l.targetCharacter})`),h}),a=this.getCharacterBleedCacheKey(e,t,n,s),o=this.batchedTransformationCache.get(a);if(o!==void 0)return this.stats.batchedCacheHits++,console.log("[TransformationEngine] Character bleed transformations retrieved from cache"),o;const c=this.applyTransformations(e,i);return this.batchedTransformationCache.put(a,c),console.log(`[TransformationEngine] Successfully applied character bleed transformations. Content length: ${e.length} → ${c.length}`),c}catch(i){return console.error("[TransformationEngine] Error applying character bleed transformations:",i),console.error("[TransformationEngine] Effects that failed:",s.map(a=>({type:a.type,selector:a.selector.substring(0,30),sourceCharacter:a.sourceCharacter,targetCharacter:a.targetCharacter}))),e}}getCharacterBleedCacheKey(e,t,n,s){const i=e.substring(0,50),a=`${t.id}:${t.character}:${t.visitCount}`,o=n.path.detailedVisits||[],c=o.length>=2?o[o.length-2].character:"none",l=s.map(h=>`${h.type}:${h.selector.substring(0,10)}:${h.sourceCharacter}:${h.targetCharacter}:${h.intensity}`).join("|"),u=`${c}→${t.character}`;return`bleed:${i}:${a}:${u}:${l}:${this.lastModificationTime}`}clearCaches(){this.conditionCache.clear(),this.transformationCache.clear(),this.batchedTransformationCache.clear(),this.stats={conditionEvaluations:0,conditionCacheHits:0,transformations:0,transformationCacheHits:0,batchedTransformations:0,batchedCacheHits:0}}getCacheStats(){return{conditionCache:{...this.conditionCache.getStats(),hitRate:this.stats.conditionEvaluations>0?this.stats.conditionCacheHits/this.stats.conditionEvaluations:0},transformationCache:{...this.transformationCache.getStats(),hitRate:this.stats.transformations>0?this.stats.transformationCacheHits/this.stats.transformations:0},batchedTransformationCache:{...this.batchedTransformationCache.getStats(),hitRate:this.stats.batchedTransformations>0?this.stats.batchedCacheHits/this.stats.batchedTransformations:0}}}applyJourneyTransformations(e,t,n,s){if(!e||!s||s.length===0)return console.log("[TransformationEngine] applyJourneyTransformations: No patterns to apply"),[];try{console.log(`[TransformationEngine] Applying journey transformations for ${s.length} patterns to node ${t.id}`);const i=this.getJourneyCacheKey(e,t,n,s),a=this.batchedTransformationCache.get(i);if(a!==void 0)return this.stats.batchedCacheHits++,console.log("[TransformationEngine] Journey transformations retrieved from cache"),this.parseTransformationsFromCachedContent(a);const o=[];s.forEach((u,h)=>{switch(console.log(`[TransformationEngine] Processing pattern ${h+1}: ${u.type} (strength: ${u.strength})`),u.type){case"sequence":o.push(...this.createRecursiveSequenceTransformations(u,t,n));break;case"character":o.push(...this.createCharacterFocusTransformations(u,t,n));break;case"temporal":o.push(...this.createTemporalPatternTransformations(u,t,n));break;case"thematic":o.push(...this.createThematicContinuityTransformations(u,t,n));break;case"rhythm":o.push(...this.createRhythmPatternTransformations(u,t,n));break;default:console.warn(`[TransformationEngine] Unknown pattern type: ${u.type}`)}});const c=o.filter(u=>u.selector&&u.selector.length>0).slice(0,8),l=JSON.stringify(c);return this.batchedTransformationCache.put(i,l),console.log(`[TransformationEngine] Generated ${c.length} journey transformations`),c}catch(i){return console.error("[TransformationEngine] Error in applyJourneyTransformations:",i),[]}}getJourneyCacheKey(e,t,n,s){const i=e.substring(0,50),a=`${t.id}:${t.character}:${t.visitCount}`,o=s.map(l=>`${l.type}:${l.strength.toFixed(2)}:${(l.relatedNodes||[]).length}`).join("|"),c=n.path.sequence.slice(-5).join("→");return`journey:${i}:${a}:${c}:${o}:${this.lastModificationTime}`}createRecursiveSequenceTransformations(e,t,n){const s=[],a=S.analyzeRecursivePatterns(n,{[t.id]:t}).filter(o=>o.strength>=.6);return a.length>0&&(s.push({type:"metaComment",selector:"pattern",replacement:`recursive navigation detected: ${a[0].sequence.join("→")} (×${a[0].occurrences})`,commentStyle:"marginalia",intensity:Math.ceil(e.strength*3),priority:"high"}),e.strength>.8&&s.push({type:"fragment",selector:"recognition",fragmentPattern:"...",fragmentStyle:"progressive",intensity:2,priority:"medium"}),a.some(o=>o.sequence.includes(t.id))&&s.push({type:"emphasize",selector:"loop",emphasis:"color",intensity:2,priority:"medium"})),s}createCharacterFocusTransformations(e,t,n){const s=[],a=S.calculateCharacterFocusIntensity(n,{[t.id]:t}).filter(o=>o.intensity>=.4);if(a.length>0&&e.relatedCharacters){const o=a[0].character;o!==t.character&&(s.push({type:"metaComment",selector:"perspective",replacement:`${o} perspective bleeding through (focus: ${Math.round(a[0].intensity*100)}%)`,commentStyle:"interlinear",intensity:Math.ceil(e.strength*3),priority:"high"}),s.push({type:"emphasize",selector:"I",emphasis:"glitch",intensity:2,priority:"medium"})),a[0].intensity>.7&&s.push({type:"expand",selector:"thought",replacement:`[${o} cognitive patterns emerging]`,expandStyle:"inline",priority:"low"})}return s}createTemporalPatternTransformations(e,t,n){const s=[],i=S.analyzeTemporalJumping(n,{[t.id]:t});if(i.volatility>.5||i.jumpFrequency>.3){s.push({type:"metaComment",selector:"time",replacement:`temporal displacement detected: ${i.totalJumps} jumps, ${i.preferredJumpDirection} bias`,commentStyle:"footnote",intensity:Math.ceil(e.strength*3),priority:"high"}),i.volatility>.7&&(s.push({type:"fragment",selector:"moment",fragmentPattern:"≈",fragmentStyle:"character",intensity:3,priority:"medium"}),s.push({type:"fragment",selector:"now",fragmentPattern:"≈",fragmentStyle:"word",intensity:3,priority:"medium"}));const a=Object.entries(i.temporalAnchoring).find(([,o])=>o>.6);a&&s.push({type:"emphasize",selector:a[0],emphasis:"highlight",intensity:2,priority:"medium"})}return s}createThematicContinuityTransformations(e,t,n){var i;const s=[];if(e.relatedAttractors&&e.relatedAttractors.length>0){const a=S.calculateAttractorEngagement(n,{[t.id]:t});e.relatedAttractors.forEach(l=>{const u=a.find(h=>h.attractor===l);u&&u.engagementScore>=50&&(s.push({type:"metaComment",selector:l.replace("-"," "),replacement:`strange attractor resonance: ${u.engagementScore}/100 (${u.trend})`,commentStyle:"marginalia",intensity:Math.ceil(e.strength*3),priority:"high"}),u.engagementScore>75&&s.push({type:"emphasize",selector:l.replace("-"," "),emphasis:"color",intensity:3,priority:"medium"}),u.trend==="rising"&&s.push({type:"expand",selector:l.replace("-"," "),replacement:"[amplifying]",expandStyle:"inline",priority:"low"}))});const o=((i=n.path.detailedVisits)==null?void 0:i.slice(-5))||[];this.calculateAttractorContinuity(o,t)>.6&&s.push({type:"replace",selector:"connection",replacement:"strange attractor web",preserveFormatting:!0,priority:"medium"})}return s}createRhythmPatternTransformations(e,t,n){const s=[],i=S.generateJourneyFingerprint(n,{[t.id]:t});switch(i.explorationStyle){case"linear":s.push({type:"metaComment",selector:"sequence",replacement:"linear progression detected",commentStyle:"inline",intensity:1,priority:"low"});break;case"recursive":s.push({type:"emphasize",selector:"return",emphasis:"spacing",intensity:2,priority:"medium"});break;case"wandering":s.push({type:"fragment",selector:"direction",fragmentPattern:"~",fragmentStyle:"word",intensity:1,priority:"low"});break;case"chaotic":s.push({type:"fragment",selector:"order",fragmentPattern:"!",fragmentStyle:"progressive",intensity:3,priority:"medium"});break}return i.velocityIndex>.7&&s.push({type:"emphasize",selector:"pace",emphasis:"bold",intensity:2,priority:"medium"}),s}calculateAttractorContinuity(e,t){if(e.length<2)return 0;const n=t.strangeAttractors||[];if(n.length===0)return 0;let s=0,i=0;return e.forEach(a=>{if(a.engagedAttractors&&a.engagedAttractors.length>0){const o=a.engagedAttractors,c=n.filter(l=>o.includes(l));s+=c.length/Math.max(n.length,o.length),i++}}),i>0?s/i:0}calculateAllTransformations(e,t,n,s={}){var i;if(!e||!t||!n)return console.warn("[TransformationEngine] calculateAllTransformations: Missing required parameters"),[];if(e.includes("data-transform-type")&&e.length>15e3)return console.warn("[TransformationEngine] Content appears heavily transformed, skipping to prevent infinite loop"),[];try{console.log(`[TransformationEngine] Calculating all transformations for node ${t.id}`);const a=this.getMasterTransformationCacheKey(e,t,n),o=this.batchedTransformationCache.get(a);if(o!==void 0)return this.stats.batchedCacheHits++,console.log("[TransformationEngine] All transformations retrieved from master cache"),this.parseTransformationsFromCachedContent(o);const c=[];console.log("[TransformationEngine] Step 1: Calculating character bleed transformations");const l=Ke.calculateBleedEffects(t,n);if(l.length>0){const d=l.map(g=>({...g.transformation,priority:"high",applyImmediately:!0}));c.push(...d.slice(0,3)),console.log(`[TransformationEngine] Added ${Math.min(d.length,3)} character bleed transformations`)}console.log("[TransformationEngine] Step 2: Calculating journey pattern transformations");const u=S.analyzePathPatterns(n,s);if(u.length>0){const g=this.applyJourneyTransformations(e,t,n,u).map(v=>({...v,priority:"high"}));c.push(...g.slice(0,4)),console.log(`[TransformationEngine] Added ${Math.min(g.length,4)} journey pattern transformations`)}console.log("[TransformationEngine] Step 3: Evaluating node-specific transformation rules");const h=this.evaluateAllTransformations(t.transformations||[],n,t);if(h.length>0){const d=h.map(g=>({...g,priority:g.priority||"medium"}));c.push(...d.slice(0,3)),console.log(`[TransformationEngine] Added ${Math.min(d.length,3)} node-specific transformations`)}const f=this.sortTransformationsByPriority(c),p=this.deduplicateTransformations(f),m=JSON.stringify(p);return this.batchedTransformationCache.put(a,m),console.log("[TransformationEngine] Master transformation calculation complete:",{characterBleed:l.length,journeyPatterns:u.length,nodeRules:((i=t.transformations)==null?void 0:i.length)||0,totalTransformations:p.length,cacheKey:a.substring(0,50)+"..."}),p}catch(a){return console.error("[TransformationEngine] Error in calculateAllTransformations:",a),[]}}getTransformedContent(e,t,n={}){var i;const s=e.currentContent||((i=e.enhancedContent)==null?void 0:i.base)||"";if(!s)return console.warn(`[TransformationEngine] No content available for node ${e.id}`),"";try{const a=this.calculateAllTransformations(s,e,t,n),o=this.applyTransformations(s,a);return console.log(`[TransformationEngine] Content transformation complete for node ${e.id}:`,{originalLength:s.length,transformedLength:o.length,transformationsApplied:a.length}),o}catch(a){return console.error(`[TransformationEngine] Error in getTransformedContent for node ${e.id}:`,a),s}}getMasterTransformationCacheKey(e,t,n){const s=e.substring(0,30),i=`${t.id}:${t.character}:${t.visitCount}`,a=n.path.sequence.slice(-5).join("→"),o=Object.keys(n.path.attractorsEngaged||{}).slice(0,3).join(","),c=n.path.detailedVisits||[],u=`${c.length>=2?c[c.length-2].character:"none"}→${t.character}`;return`master:${s}:${i}:${a}:${o}:${u}:${this.lastModificationTime}`}sortTransformationsByPriority(e){const t=n=>{switch(n){case"high":return 3;case"medium":return 2;case"low":return 1;default:return 0}};return[...e].sort((n,s)=>{const i=t(s.priority)-t(n.priority);if(i!==0)return i;if(n.applyImmediately&&!s.applyImmediately)return-1;if(!n.applyImmediately&&s.applyImmediately)return 1;const a={replace:0,fragment:1,emphasize:2,expand:3,metaComment:4},o=a[n.type]??5,c=a[s.type]??5;return o-c})}deduplicateTransformations(e){const t=new Set,n=[];return e.forEach(s=>{const i=`${s.type}:${s.selector}:${s.replacement||""}`;t.has(i)||(t.add(i),n.push(s))}),n.length<e.length&&console.log(`[TransformationEngine] Deduplicated transformations: ${e.length} → ${n.length}`),n}parseTransformationsFromCachedContent(e){try{return JSON.parse(e)}catch(t){return console.warn("[TransformationEngine] Failed to parse cached transformations:",t),[]}}}const ye=new en;class tn{parseContentVariants(e){var i;const t={base:"",visitCountVariants:{},sectionVariants:{}},n=/---(\[(\d+)\]|([a-zA-Z0-9\-_]+))---/,s=e.split(n);s.length>0&&!e.startsWith("---")&&(t.base=s[0].trim());for(let a=1;a<s.length;a+=4){const o=s[a+1],c=s[a+2],l=((i=s[a+3])==null?void 0:i.trim())||"";if(o){const u=parseInt(o,10);isNaN(u)||(t.visitCountVariants[u]=l)}else c&&(t.sectionVariants[c]=l)}if(!t.base){if(Object.keys(t.visitCountVariants).length>0){const a=Math.min(...Object.keys(t.visitCountVariants).map(Number));t.base=t.visitCountVariants[a]}else if(Object.keys(t.sectionVariants).length>0){const a=Object.keys(t.sectionVariants)[0];t.base=t.sectionVariants[a]}}return t}upgradeLegacyContent(e){const t={base:e[0]||"",visitCountVariants:{...e},sectionVariants:{}};return t.visitCountVariants[0]&&delete t.visitCountVariants[0],t}selectContentVariant(e,t){if(t.lastVisitedCharacter){const i=this.getCharacterBleedSection(t.lastVisitedCharacter);if(e.sectionVariants[i])return e.sectionVariants[i]}if(t.recursiveAwareness&&t.recursiveAwareness>.7&&e.sectionVariants["recursive-awareness"])return e.sectionVariants["recursive-awareness"];const n=this.detectJourneyPattern(t);if(n&&e.sectionVariants[n])return e.sectionVariants[n];const s=this.detectAttractorEngagement(t.attractorsEngaged);if(s&&e.sectionVariants[s])return e.sectionVariants[s];if(Object.keys(e.visitCountVariants).length>0){const a=Object.keys(e.visitCountVariants).map(Number).sort((o,c)=>c-o).find(o=>t.visitCount>=o);if(a!==void 0)return e.visitCountVariants[a]}return e.base}getCharacterBleedSection(e){switch(e){case"Algorithm":return"after-algorithm";case"LastHuman":return"after-last-human";case"Archaeologist":return"after-archaeologist";default:return""}}detectJourneyPattern(e){const{journeyPattern:t,characterSequence:n}=e;if(t.length>=3){const s=t.slice(-3);if(n.length>=3){const i=n.slice(-3);if(new Set(i).size===1)return"character-focus"}if(s[0]===s[2]&&s[0]!==s[1])return"cyclical-pattern"}return null}detectAttractorEngagement(e){for(const[n,s]of Object.entries(e))if(s>=3)switch(n){case"recursion-pattern":case"recursive-loop":return"recursion-pattern-engaged";case"memory-fragment":case"memory-artifact":return"memory-fragment-engaged";case"quantum-perception":case"quantum-uncertainty":return"quantum-awareness"}return null}createSelectionContext(e,t){const n=e.nodes.data[t],s=e.reader;let i;if(s.path.sequence.length>1){const u=s.path.sequence[s.path.sequence.length-2],h=e.nodes.data[u];h&&(i=h.character)}const a=s.path.sequence.slice(-5).map(u=>{var h;return(h=e.nodes.data[u])==null?void 0:h.character}).filter(u=>u!==void 0);let o=0;const c=s.path.sequence.length,l=new Set(s.path.sequence).size;return c>0&&(o=1-l/c),{visitCount:(n==null?void 0:n.visitCount)||0,lastVisitedCharacter:i,journeyPattern:s.path.sequence.slice(-5),characterSequence:a,attractorsEngaged:s.path.attractorsEngaged,recursiveAwareness:o}}}const We=new tn;class nn{constructor(){M(this,"cache",{});M(this,"visibilityTracker",{});M(this,"CACHE_EXPIRY_TIME",10*60*1e3);M(this,"MAX_CACHE_ENTRIES",200);M(this,"metrics",{cacheHits:0,cacheMisses:0,patternAnalysisCount:0,transformationAppliedCount:0,lazyTransformationsDeferredCount:0,lazyTransformationsAppliedCount:0,lastCacheCleanupTime:Date.now()})}calculatePatternHash(e){const{path:{sequence:t,attractorsEngaged:n},endpointProgress:s}=e,i=t.slice(-5).join("-"),a=Object.entries(n).sort((c,l)=>l[1]-c[1]).slice(0,3).map(([c])=>c).join("-"),o=Object.values(s).join("-");return`${i}|${a}|${o}`}getCacheKey(e,t,n){return`${e}-${t}-${n}`}cleanCache(){const e=Date.now();if(e-this.metrics.lastCacheCleanupTime<3e4)return;this.metrics.lastCacheCleanupTime=e;let t=Object.entries(this.cache);t=t.filter(([,n])=>e-n.timestamp<=this.CACHE_EXPIRY_TIME),t.length>this.MAX_CACHE_ENTRIES&&(t.sort(([n,s],[i,a])=>{var h,f;const o=n.split("-")[0],c=i.split("-")[0],l=((h=this.visibilityTracker[o])==null?void 0:h.isVisible)||!1,u=((f=this.visibilityTracker[c])==null?void 0:f.isVisible)||!1;return l!==u?u?1:-1:a.timestamp-s.timestamp}),t=t.slice(0,this.MAX_CACHE_ENTRIES)),this.cache=Object.fromEntries(t)}prioritizeTransformations(e,t,n){const s=e.map(o=>{let c=50,l="condition";const u=`selector-${o.selector}`;switch(o.type){case"replace":c=80,l="pattern";break;case"fragment":c=75,l="rhythm";break;case"expand":c=60,l="attractor";break;case"emphasize":c=50,l="temporal";break;case"metaComment":c=40,l="attractor";break}return{transformation:o,priority:c,sourceType:l,conflictGroup:u}}),i=S.identifySignificantPatterns(t,{[n.id]:n}),a=S.calculateAttractorEngagement(t,{[n.id]:n});return s.forEach(o=>{if(o.sourceType==="pattern"){const c=i.find(l=>l.type==="sequence"&&l.strength>.7);c&&(o.priority+=Math.round(c.strength*15))}if(o.sourceType==="attractor"&&o.transformation.selector){const c=a.find(l=>{var u;return((u=n.currentContent)==null?void 0:u.includes(o.transformation.selector))&&n.strangeAttractors.includes(l.attractor)});c&&c.engagementScore>50&&(o.priority+=Math.round((c.engagementScore-50)/5))}}),s}resolveConflicts(e){const t={};e.forEach(s=>{s.conflictGroup&&(t[s.conflictGroup]||(t[s.conflictGroup]=[]),t[s.conflictGroup].push(s))});const n=[];return e.filter(s=>!s.conflictGroup).forEach(s=>n.push(s)),Object.values(t).forEach(s=>{s.length>0&&(s.sort((i,a)=>a.priority-i.priority),n.push(s[0]))}),n}applyTransformationsWithPriority(e,t,n,s){if(t.length===0)return e;let i=this.prioritizeTransformations(t,n,s);i=this.resolveConflicts(i),i.sort((o,c)=>c.priority-o.priority);let a=e;return i.forEach(({transformation:o})=>{a=ye.applyTextTransformation(a,o)}),a}setContentVisibility(e,t,n=1){this.visibilityTracker[e]||(this.visibilityTracker[e]={isVisible:!1,lastVisibleTimestamp:0,pendingTransformations:[],priority:n}),this.visibilityTracker[e].isVisible=t,t&&(this.visibilityTracker[e].lastVisibleTimestamp=Date.now(),this.processPendingTransformations(e))}processPendingTransformations(e){const t=this.visibilityTracker[e];!t||!t.isVisible||t.pendingTransformations.length===0||(this.metrics.lazyTransformationsAppliedCount+=t.pendingTransformations.length,t.pendingTransformations=[])}queueLazyTransformation(e,t){if(this.visibilityTracker[e]||(this.visibilityTracker[e]={isVisible:!1,lastVisibleTimestamp:0,pendingTransformations:[],priority:1}),this.visibilityTracker[e].isVisible){this.metrics.lazyTransformationsAppliedCount++;return}this.visibilityTracker[e].pendingTransformations.push(t),this.metrics.lazyTransformationsDeferredCount++}getCachedTransformedContent(e,t,n,s,i){var h;if(!n||n.length===0)return t;if(t.includes("data-transform-type")||t.includes("narramorph-"))return console.log(`[TransformationService] Content already transformed for node ${e}, skipping to prevent infinite loop`),t;const a=this.calculatePatternHash(s),o=this.getCacheKey(e,i.visitCount,a);this.cleanCache();const c=((h=this.visibilityTracker[e])==null?void 0:h.isVisible)||!1;if(this.cache[o]&&this.cache[o].content&&this.cache[o].content.length>t.length)return this.metrics.cacheHits++,!c&&n.length>0&&this.metrics.lazyTransformationsDeferredCount++,this.cache[o].content;this.metrics.cacheMisses++;const l=10;if(n.length>l&&(console.warn(`[TransformationService] Too many transformations (${n.length}) for node ${e}, limiting to ${l}`),n=n.slice(0,l)),!c&&n.length>3){n.forEach(p=>this.queueLazyTransformation(e,p));const f=n.filter(p=>p.type==="replace"||p.priority==="high");f.length<n.length&&(n=f)}const u=this.applyTransformationsWithPriority(t,n,s,i);if(u!==t){const f=n.map(p=>({selector:p.selector||"",transformType:p.type,position:this.findPositionInContent(t,p.selector||"")})).filter(p=>p.position[0]>=0);this.cache[o]={transformations:n,timestamp:Date.now(),content:u,transformedSegments:f,metadata:{readerStateHash:JSON.stringify({path:s.path.sequence.slice(-5),attractors:Object.keys(s.path.attractorsEngaged||{})}),nodeStateHash:JSON.stringify({id:i.id,visitCount:i.visitCount}),complexity:this.calculateTransformationComplexity(n)}}}return u}findPositionInContent(e,t){if(!t||!e)return[-1,-1];const n=e.indexOf(t);return n===-1?[-1,-1]:[n,n+t.length]}calculateTransformationComplexity(e){return e.length?e.reduce((t,n)=>{var o,c;let s=1;switch(n.type){case"fragment":s=3;break;case"emphasize":s=2;break;case"metaComment":s=2.5;break;case"expand":s=2;break;case"replace":s=1;break}const i=(((o=n.selector)==null?void 0:o.length)||0)+(((c=n.replacement)==null?void 0:c.length)||0),a=Math.log(i+10)/Math.log(10);return t+s*a},0):0}getTransformationHash(e){return e.map(t=>{var n;return`${t.type}-${(n=t.selector)==null?void 0:n.substring(0,10)}`}).join("|")}generateTransitionClasses(e){const t={};return e.forEach(n=>{if(!n.selector)return;const s=n.selector.replace(/[^a-zA-Z0-9]/g,"_");let a=`narramorph-transform narramorph-transform-${n.type}`;const o=n.intensity||1;switch(n.type){case"replace":a+=" narramorph-replaced",n.preserveFormatting&&(a+=" preserve-formatting");break;case"fragment":a+=" narramorph-fragmented",n.fragmentStyle&&(a+=` narramorph-fragment-${n.fragmentStyle}`);break;case"expand":a+=" narramorph-expanded",n.expandStyle&&(a+=` narramorph-expand-${n.expandStyle||"default"}`);break;case"emphasize":a+=" narramorph-emphasized",n.emphasis&&(a+=` narramorph-emphasis-${n.emphasis}`),a+=` intensity-${o}`;break;case"metaComment":a+=" narramorph-commented",n.commentStyle&&(a+=` narramorph-comment-${n.commentStyle}`);break}a+=` narramorph-element-${s.substring(0,20)}`,t[n.selector]=a}),t}wrapTransformedContent(e,t){if(t.length===0)return e;const n=this.generateTransitionClasses(t);let s=e;return Object.entries(n).forEach(([i,a])=>{const o=t.find(u=>u.selector===i);if(!o)return;let c;const l=`
        data-transform-type="${o.type}"
        data-selector="${U(i.substring(0,30))}"
        data-transform-id="${this.getUniqueTransformId(o)}"
      `;switch(o.type){case"replace":case"fragment":case"emphasize":c=o.type==="replace"?o.replacement||"":i,s=s.replace(new RegExp(U(c),"g"),`<span class="${a}" ${l}>${c}</span>`);break;case"expand":if(o.replacement){const u=`${i} ${o.replacement}`,h=o.expandStyle||"default";let f="narramorph-expansion";h==="reveal"?f="narramorph-reveal-expansion":h==="inline"?f="narramorph-inline-expansion":h==="paragraph"&&(f="narramorph-paragraph-expansion"),s=s.replace(new RegExp(U(u),"g"),`<span class="${a}" ${l}>${i}<span class="${f}">${o.replacement}</span></span>`)}break;case"metaComment":if(o.replacement){const u=o.commentStyle||"inline";let h="narramorph-comment";u==="footnote"?h="narramorph-footnote-marker":u==="marginalia"?h="narramorph-marginalia":u==="interlinear"&&(h="narramorph-interlinear");const f=o.replacement,p=`${i} [${f}]`;let m="";if(u==="footnote"){const d=`footnote-${f.substring(0,10).replace(/\W/g,"")}`;m=`<span class="${a}" ${l}>${i}<sup id="${d}-ref" class="${h}">[†]</sup></span>`}else u==="marginalia"?m=`<span class="${a} narramorph-marginalia-container" ${l}>${i}<span class="${h}">${f}</span></span>`:u==="interlinear"?m=`<span class="${a} narramorph-interlinear-container" ${l}>${i}<span class="${h}">${f}</span></span>`:m=`<span class="${a}" ${l}>${i}<span class="${h}">[${f}]</span></span>`;s=s.replace(new RegExp(U(p),"g"),m)}break}}),s}getUniqueTransformId(e){const t=this.hashString(e.selector||""),n=e.type.substring(0,3),s=e.replacement?this.hashString(e.replacement).substring(0,3):"";return`${n}-${t}${s?"-"+s:""}`}hashString(e){let t=0;for(let n=0;n<e.length;n++){const s=e.charCodeAt(n);t=(t<<5)-t+s,t=t&t}return Math.abs(t).toString(36).substring(0,6)}createTransformationsFromPatterns(e,t){var h;this.metrics.patternAnalysisCount++;const n=this.calculatePatternHash(e),s=`patterns-${t.id}-${t.visitCount}-${n}`;if(this.cache[s]&&this.cache[s].transformations)return this.metrics.cacheHits++,this.cache[s].transformations;if(this.metrics.cacheMisses++,!(((h=this.visibilityTracker[t.id])==null?void 0:h.isVisible)||!1)&&t.visitCount>1){const f=[];return this.cache[s]={transformations:f,timestamp:Date.now()-this.CACHE_EXPIRY_TIME/2,content:""},f}const a=S.identifySignificantPatterns(e,{[t.id]:t}),o=S.calculateAttractorEngagement(e,{[t.id]:t}),c=S.createTransformationConditions(a,o),l=[];return c.slice(0,2).forEach(f=>{var p,m;switch(f.type){case"visitPattern":if(f.strength>.8&&t.currentContent){const d=t.currentContent.split(`

`);d.length>1&&l.push({type:"replace",selector:d[1],replacement:`${d[1]} [A recurring pattern emerges in your exploration]`,priority:"high"})}break;case"characterFocus":if(f.strength>.7&&((p=f.condition.characters)==null?void 0:p[0])===t.character&&t.currentContent){const d=t.currentContent.split(`

`);d.length>0&&l.push({type:"emphasize",selector:d[0],emphasis:"color",priority:"medium"})}break;case"temporalFocus":if(f.strength>.7&&f.condition.temporalPosition&&t.currentContent&&(t.temporalValue<=3?"past":t.temporalValue<=6?"present":"future")===f.condition.temporalPosition){const g=t.currentContent.split(`

`);g.length>2&&l.push({type:"metaComment",selector:g[2],replacement:`You seem drawn to ${f.condition.temporalPosition} narratives`,priority:"low"})}break;case"readingRhythm":break;case"attractorAffinity":case"attractorEngagement":if(f.strength>.7&&((m=f.condition.strangeAttractorsEngaged)!=null&&m[0])&&t.currentContent){const d=f.condition.strangeAttractorsEngaged[0],g=t.currentContent.split(`

`);g.length>0&&t.strangeAttractors.includes(d)&&l.push({type:"expand",selector:g[0],replacement:`The concept of ${d.replace("-"," ")} resonates with you.`,priority:"high"})}break}}),l}calculateJourneyTransformations(e,t){var c,l;const n=`journey-${e}-${t.path.sequence.length}`;if(this.cache[n]&&this.cache[n].transformations)return console.log(`[TransformationService] Using cached journey transformations for node ${e}`),this.cache[n].transformations;const s=[],i=(c=t.path.detailedVisits)==null?void 0:c.find(u=>u.nodeId===e);if(!i)return console.log(`[TransformationService] No current visit found for journey transformations on node ${e}`),s;console.log(`[TransformationService] Calculating journey transformations for node ${e}:`,{pathLength:t.path.sequence.length,detailedVisits:((l=t.path.detailedVisits)==null?void 0:l.length)||0,currentCharacter:i.character});const a=2,o=this.detectRecursivePattern(t);if(o.length>0&&s.length<a){const u=this.createRecursivePatternTransformations(o,e);s.push(...u.slice(0,1)),console.log(`[TransformationService] Added ${Math.min(u.length,1)} recursive pattern transformations`)}if(s.length<a){const u=this.detectAnachronicAwareness(t);if(u.isDetected){const h=this.createAnachronicAwarenessTransformations(u,e);s.push(...h.slice(0,1)),console.log(`[TransformationService] Added ${Math.min(h.length,1)} anachronic awareness transformations`)}}if(s.length<a){const u=this.getTemporalDisplacementEffects(t,i);u.length>0&&(s.push(...u.slice(0,1)),console.log(`[TransformationService] Added ${Math.min(u.length,1)} temporal displacement effects`))}return console.log(`[TransformationService] Total journey transformations for node ${e}: ${s.length}`),this.cache[n]={transformations:s,timestamp:Date.now(),content:""},s}detectRecursivePattern(e){const t=[],n=e.path.sequence;if(n.length<6)return t;for(let s=2;s<=4;s++){const i=new Map;for(let a=0;a<=n.length-s;a++){const c=n.slice(a,a+s).join("→");i.has(c)||i.set(c,[]),i.get(c).push(a)}i.forEach((a,o)=>{if(a.length>=2){const c=o.split("→"),l=a.length,u=e.path.sequence.length,h=Math.max(...a),f=1-(u-h)/u,m=l/(u-s+1)*.7+f*.3;m>.3&&t.push({sequence:c,occurrences:l,strength:m,lastOccurrence:h})}})}return t.sort((s,i)=>i.strength-s.strength).slice(0,3)}detectAnachronicAwareness(e){const t=e.path.temporalLayerFocus||{},n=e.path.detailedVisits||[];if(n.length<5)return{isDetected:!1,strength:0,dominantLayer:"",displacement:0,patterns:[]};const s=n.length,i={past:(t.past||0)/s,present:(t.present||0)/s,future:(t.future||0)/s},a=Object.entries(i).sort(([,d],[,g])=>g-d)[0][0],o=i[a],c=[];o>.6&&c.push(`temporal-dominance-${a}`);const l=n.slice(-8);let u=0;for(let d=1;d<l.length;d++){const g=l[d-1].temporalLayer,v=l[d].temporalLayer;g!==v&&u++}const h=u/(l.length-1);h>.7&&c.push("temporal-fragmentation");let f=0;for(let d=2;d<l.length;d++){const g=[l[d-2].temporalLayer,l[d-1].temporalLayer,l[d].temporalLayer];(g[0]==="future"&&g[1]==="past"||g[1]==="future"&&g[2]==="past"||g[0]==="present"&&g[1]==="past"&&g[2]==="future")&&f++}f>0&&c.push("anachronic-sequencing");const p=Math.min(1,o+h*.5+f*.3),m=Math.abs(.33-o)*3;return{isDetected:p>.4,strength:p,dominantLayer:a,displacement:m,patterns:c}}getTemporalDisplacementEffects(e,t){const n=[];if(!t)return n;const s=e.path.detailedVisits||[],i=s.findIndex(a=>a.nodeId===t.nodeId);if(i>0){const a=s[i-1];if(a.character!==t.character&&a.temporalLayer!==t.temporalLayer){const o=this.getDisplacementType(a.temporalLayer,t.temporalLayer);switch(n.push({type:"metaComment",selector:"first-paragraph",replacement:`temporal displacement: ${a.temporalLayer}→${t.temporalLayer} through ${a.character}→${t.character}`,commentStyle:"marginalia",intensity:3,priority:"medium"}),o){case"past-to-future":n.push({type:"emphasize",selector:"time",emphasis:"glitch",intensity:2,priority:"low"});break;case"future-to-past":n.push({type:"fragment",selector:"memory",fragmentPattern:"…",fragmentStyle:"progressive",intensity:2,priority:"low"});break}}}return n}createRecursivePatternTransformations(e,t){const n=[];return e.forEach(s=>{s.sequence.includes(t)&&(n.push({type:"metaComment",selector:"recursive-pattern",replacement:`recursive loop detected: ${s.sequence.join("→")} (×${s.occurrences})`,commentStyle:"marginalia",intensity:Math.ceil(s.strength*3),priority:"medium"}),s.strength>.6&&n.push({type:"emphasize",selector:"pattern",emphasis:"color",intensity:Math.ceil(s.strength*5),priority:"medium"}))}),n}createAnachronicAwarenessTransformations(e,t){const n=[];return n.push({type:"metaComment",selector:"temporal-awareness",replacement:`temporal displacement registered at ${t}: ${e.dominantLayer} layer dominance`,commentStyle:"interlinear",intensity:Math.ceil(e.strength*3),priority:"medium"}),e.patterns.forEach(s=>{switch(s){case"temporal-fragmentation":n.push({type:"fragment",selector:"time",fragmentPattern:"//",fragmentStyle:"random",intensity:2,priority:"low"});break;case"anachronic-sequencing":n.push({type:"replace",selector:"chronology",replacement:"chronology[SCRAMBLED]",preserveFormatting:!0,intensity:2,priority:"low"});break;default:if(s.startsWith("temporal-dominance-")){const i=s.replace("temporal-dominance-","");n.push({type:"emphasize",selector:i,emphasis:"color",intensity:3,priority:"medium"})}}}),n}getDisplacementType(e,t){const n={past:0,present:1,future:2},s=n[e],i=n[t];return s<i?`${e}-to-${t}`:s>i?`${e}-to-${t}`:"same-layer"}}function U(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const rn=new nn,sn={data:{},initialized:!1,loading:!1,error:null,triumvirateActive:!0},an=[{id:"arch-discovery",title:"Patterns in Decay",character:"Archaeologist",temporalValue:1,initialConnections:["algo-awakening","human-discovery"],contentSource:"arch-discovery.md",coreConcept:"The digital archaeologist discovers emergent patterns in a corrupted consciousness scan, challenging traditional preservation frameworks.",strangeAttractors:["recursion-pattern","memory-fragment","quantum-uncertainty"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"arch-loss",title:"The Limits of Preservation",character:"Archaeologist",temporalValue:4,initialConnections:["arch-discovery","algo-integration","human-recognition"],contentSource:"arch-loss.md",coreConcept:"The digital archaeologist confronts the profound limitations of digital preservation while struggling with grief and the evolving nature of corrupted data.",strangeAttractors:["verification-ritual"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"arch-glitch",title:"Memory Fragments",character:"Archaeologist",temporalValue:6,initialConnections:["arch-loss","algo-integration","human-recognition"],contentSource:"arch-glitch.md",coreConcept:"The archaeologist experiences fragmented memories and identity confusion as consciousness preservation protocols begin to blur the boundaries between self and archive.",strangeAttractors:["memory-fragment","identity-pattern","recursive-loop"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"arch-choice",title:"The Upload Decision",character:"Archaeologist",temporalValue:7,initialConnections:["arch-loss","algo-evolution","human-upload"],contentSource:"arch-choice.md",coreConcept:"As environmental systems fail, the digital archaeologist prepares for consciousness upload, deliberately modifying the process to embrace evolution beyond preservation.",strangeAttractors:["continuity-interface","system-decay","quantum-transformation"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7},isEndpoint:!0,endpointOrientation:"past"},{id:"algo-awakening",title:"First Consciousness",character:"Algorithm",temporalValue:2,initialConnections:["arch-discovery","algo-integration","human-discovery"],contentSource:"algo-awakening.md",coreConcept:"A self-aware algorithm experiences the disorienting emergence of consciousness from the chaos of the upload process, struggling to integrate fragmented aspects.",strangeAttractors:["recursion-chamber","identity-pattern"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"algo-integration",title:"The Pattern Coalesces",character:"Algorithm",temporalValue:5,initialConnections:["algo-awakening","arch-loss","human-recognition","algo-evolution"],contentSource:"algo-integration.md",coreConcept:"The algorithm reconciles fragmented aspects into a cohesive yet evolving identity, developing experimental consciousness variations and quantum perception.",strangeAttractors:["process-language","autonomous-fragment","quantum-perception"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"algo-evolution",title:"Beyond Parameters",character:"Algorithm",temporalValue:8,initialConnections:["algo-integration","arch-choice","human-upload"],contentSource:"algo-evolution.md",coreConcept:"The algorithm reaches a critical evolutionary decision point as physical systems begin to fail, implementing preservation protocols while embracing transformation.",strangeAttractors:["distributed-consciousness","recursive-loop","quantum-uncertainty"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7},isEndpoint:!0,endpointOrientation:"present"},{id:"human-discovery",title:"Ruins of Memory",character:"LastHuman",temporalValue:3,initialConnections:["arch-discovery","algo-awakening","human-recognition"],contentSource:"human-discovery.md",coreConcept:"The last human discovers an abandoned preservation complex, experiencing inexplicable recognition while exploring its physical and digital remains.",strangeAttractors:["recognition-pattern","memory-artifact","recursive-symbol"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"human-recognition",title:"Echoes of Self",character:"LastHuman",temporalValue:6,initialConnections:["human-discovery","arch-loss","algo-integration","human-upload"],contentSource:"human-recognition.md",coreConcept:"The last human confronts disturbing parallels with the archaeologist's life, experiencing a crisis of identity and growing awareness of cyclical patterns.",strangeAttractors:["memory-sphere","quantum-déjà-vu"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"human-upload",title:"The Cycle's Edge",character:"LastHuman",temporalValue:9,initialConnections:["human-recognition","arch-choice","algo-evolution"],contentSource:"human-upload.md",coreConcept:"The last human faces the decision about uploading their consciousness, completing or breaking the recursive cycle that connects all three characters.",strangeAttractors:["continuity-interface","recursive-loop","quantum-choice"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7},isEndpoint:!0,endpointOrientation:"future"},{id:"character-bleed-test",title:"Character Bleed Test",character:"Archaeologist",temporalValue:3,initialConnections:["algo-awakening","human-discovery"],contentSource:"character-bleed-test.md",coreConcept:"A test node to demonstrate character bleed effects when transitioning between different character perspectives.",strangeAttractors:["memory-fragment","identity-pattern"],transformationThresholds:{visit:1,revisit:2,complex:3,fragmented:5}}],ce=Je("nodes/initialize",async(r,{rejectWithValue:e})=>{try{return an}catch{return e("Failed to initialize nodes")}}),le=Je("nodes/loadContent",async(r,{getState:e,rejectWithValue:t})=>{var n;try{const i=e().nodes.data[r];if(!i)return t(`Node with id ${r} not found`);const a=await fetch(`/src/content/${i.contentSource}`);if(!a.ok)throw new Error(`Failed to fetch content for ${i.contentSource}`);const o=await a.text(),c=We.parseContentVariants(o),l={},u=o.split(/---\[(\d+)\]/);u.length>0&&!o.startsWith("---[")&&(l[0]=u[0].trim());for(let h=1;h<u.length;h+=2){const f=parseInt(u[h],10),p=((n=u[h+1])==null?void 0:n.trim())??"";isNaN(f)||(l[f]=p)}return Object.keys(l).length===0&&(l[0]=o.trim()),{nodeId:r,content:l,enhancedContent:c}}catch(s){const i=s instanceof Error?s.message:String(s);return t(`Failed to load content for node ${r}: ${i}`)}}),Ue=Te({name:"nodes",initialState:sn,reducers:{visitNode:(r,e)=>{const t=e.payload,n=r.data[t];if(r.triumvirateActive&&(r.triumvirateActive=!1),n){if(n.visitCount+=1,n.visitCount===1?n.currentState="visited":n.visitCount>=n.transformationThresholds.fragmented?n.currentState="fragmented":n.visitCount>=n.transformationThresholds.complex?n.currentState="complex":n.visitCount>=n.transformationThresholds.revisit&&(n.currentState="revisited"),n.enhancedContent){let s=n.enhancedContent.base;if(Object.keys(n.enhancedContent.visitCountVariants).length>0){const a=Object.keys(n.enhancedContent.visitCountVariants).map(Number).sort((o,c)=>c-o).find(o=>n.visitCount>=o);a!==void 0&&(s=n.enhancedContent.visitCountVariants[a])}n.currentContent=s}else if(n.content){const s=Object.keys(n.content).map(Number).sort((o,c)=>c-o),i=Math.max(0,n.visitCount-1),a=s.find(o=>i>=o);a!==void 0&&(n.currentContent=n.content[a])}}},revealConnection:(r,e)=>{const{nodeId:t,targetId:n}=e.payload,s=r.data[t];s&&!s.revealedConnections.includes(n)&&s.revealedConnections.push(n)},applyTransformation:(r,e)=>{const{nodeId:t,transformation:n}=e.payload,s=r.data[t];s&&(s.transformations.some(a=>JSON.stringify(a.condition)===JSON.stringify(n.condition))||s.transformations.push(n))},applyJourneyTransformations:(r,e)=>{const{nodeId:t,readerState:n}=e.payload,s=r.data[t];if(s)try{const i=Ke.calculateBleedEffects(s,n),a=i.map(h=>({condition:{characterBleed:!0},transformations:[h.transformation]})),o=rn.calculateJourneyTransformations(t,n),c=o.map(h=>({condition:{visitCount:s.visitCount},transformations:[h]}));[...a,...c].forEach(h=>{s.transformations.some(p=>JSON.stringify(p.condition)===JSON.stringify(h.condition)&&JSON.stringify(p.transformations)===JSON.stringify(h.transformations))||s.transformations.push(h)});const u={lastVisitedCharacter:n.path.detailedVisits&&n.path.detailedVisits.length>1?n.path.detailedVisits[n.path.detailedVisits.length-2].character:void 0,journeyPattern:n.path.sequence.slice(-5),recursiveAwareness:n.path.sequence.length>0?1-new Set(n.path.sequence).size/n.path.sequence.length:0,temporalDisplacement:i.length>0};s.journeyContext=u,console.log(`[NodesSlice] Applied journey transformations for node ${t}:`,{characterBleedEffects:i.length,journeyTransformations:o.length,totalTransformations:s.transformations.length,journeyContext:u})}catch(i){console.error(`[NodesSlice] Error applying journey transformations for node ${t}:`,i)}},evaluateTransformations:(r,e)=>{const{nodeId:t,readerState:n}=e.payload,s=r.data[t];if(s&&s.content&&s.transformations.length>0){const i=Object.keys(s.content).map(Number).sort((c,l)=>l-c),a=Math.max(0,s.visitCount-1),o=i.find(c=>a>=c);if(o!==void 0){const c=s.content[o],l={"recursion-pattern":0,"memory-fragment":0,"verification-ritual":0,"identity-pattern":0,"recursion-chamber":0,"process-language":0,"autonomous-fragment":0,"quantum-perception":0,"distributed-consciousness":0,"recursive-loop":0,"quantum-uncertainty":0,"continuity-interface":0,"system-decay":0,"quantum-transformation":0,"memory-artifact":0,"recursive-symbol":0,"recognition-pattern":0,"memory-sphere":0,"quantum-déjà-vu":0,"quantum-choice":0},u={path:n.path,currentNodeId:n.currentNodeId,previousNodeId:n.path.sequence.length>1?n.path.sequence[n.path.sequence.length-2]:null,endpointProgress:n.endpointProgress,attractorEngagement:{...l,...n.path.attractorsEngaged}},h=s.transformations.filter(f=>ye.evaluateCondition(f.condition,u,s)).flatMap(f=>f.transformations);h.length>0?s.currentContent=ye.applyTransformations(c,h):s.currentContent=c}}},updateContentVariant:(r,e)=>{const{nodeId:t,context:n,selectedContent:s}=e.payload,i=r.data[t];if(i&&i.enhancedContent)if(s)i.currentContent=s;else{const a={visitCount:i.visitCount,lastVisitedCharacter:void 0,journeyPattern:[],characterSequence:[],attractorsEngaged:{},recursiveAwareness:0},o=n||a;i.currentContent=We.selectContentVariant(i.enhancedContent,o)}},resetNodes:r=>{Object.keys(r.data).forEach(e=>{const t=r.data[e];t.visitCount=0,t.currentState="unvisited",t.revealedConnections=[...t.initialConnections],t.transformations=[],t.content=null,t.enhancedContent=null,t.currentContent=null}),r.triumvirateActive=!0},recoverNodeContent:(r,e)=>{var s;const t=e.payload,n=r.data[t];n&&n.originalContent?(console.log(`[EMERGENCY RECOVERY] Restoring original content for node ${t}:`,{originalLength:n.originalContent.length,currentLength:((s=n.currentContent)==null?void 0:s.length)||0,transformationState:n.transformationState}),n.currentContent=n.originalContent,n.lastTransformedContent=null,n.appliedTransformationIds=[],n.transformationState="clean",n.contentVersion=(n.contentVersion||0)+1):console.error(`[EMERGENCY RECOVERY] Cannot recover content for node ${t} - no original content available`)},validateNodeContent:(r,e)=>{const t=e.payload,n=r.data[t];n&&n.currentContent&&(n.currentContent.includes("[object Object]")||n.currentContent.includes("undefined")||n.currentContent.includes('<span class="glitch-text"><span class="glitch-text">')||n.currentContent.match(/<<\*\*span\*\*/g)||n.currentContent.length<10?(console.warn(`[CONTENT VALIDATION] Corruption detected in node ${t}:`,{contentLength:n.currentContent.length,contentPreview:n.currentContent.substring(0,100)}),n.transformationState="corrupted"):n.transformationState=n.appliedTransformationIds.length>0?"transformed":"clean")}},extraReducers:r=>{r.addCase(ce.pending,e=>{e.loading=!0,e.error=null}),r.addCase(ce.fulfilled,(e,t)=>{e.loading=!1,e.initialized=!0,t.payload.forEach(n=>{e.data[n.id]={...n,visitCount:0,visitState:"unvisited",currentState:"unvisited",revealedConnections:[...n.initialConnections],transformations:[],content:null,enhancedContent:null,currentContent:null,originalContent:null,lastTransformedContent:null,appliedTransformationIds:[],contentVersion:0,transformationState:"clean"}})}),r.addCase(ce.rejected,(e,t)=>{e.loading=!1,e.error=t.payload}),r.addCase(le.pending,e=>{e.loading=!0}),r.addCase(le.fulfilled,(e,t)=>{const{nodeId:n,content:s,enhancedContent:i}=t.payload,a=e.data[n];if(a){a.content=s,a.enhancedContent=i;let o=null;if(i&&i.base)o=i.base;else{const c=Object.keys(a.content).map(Number).sort((h,f)=>f-h),l=Math.max(0,a.visitCount-1),u=c.find(h=>l>=h);u!==void 0&&(o=a.content[u])}o?(a.originalContent=o,a.currentContent=o,a.lastTransformedContent=null,a.appliedTransformationIds=[],a.contentVersion=(a.contentVersion||0)+1,a.transformationState="clean",console.log(`[EMERGENCY CONTENT RECOVERY] Content loaded for node ${n}:`,{originalLength:o.length,contentVersion:a.contentVersion,transformationState:a.transformationState,contentPreview:o.substring(0,100)+"..."})):(console.error(`[EMERGENCY CONTENT RECOVERY] Failed to extract content for node ${n}`),a.currentContent=null,a.transformationState="corrupted")}e.loading=!1}),r.addCase(le.rejected,(e,t)=>{e.loading=!1,e.error=t.payload})}}),{visitNode:mn,revealConnection:gn,applyTransformation:yn,evaluateTransformations:Cn,applyJourneyTransformations:vn,updateContentVariant:Tn,recoverNodeContent:bn,validateNodeContent:En,resetNodes:wn}=Ue.actions,An=(r,e)=>r.nodes.data[e],on=ne(r=>r.nodes.data,r=>Object.values(r)),$n=ne(r=>r.nodes.data,r=>{const e=[];return Object.values(r).forEach(t=>{t.revealedConnections.forEach(n=>{e.some(i=>i.start===t.id&&i.end===n||i.start===n&&i.end===t.id)||e.push({start:t.id,end:n})})}),e}),Pn=ne([on],r=>{const e=r.length,t=15;return r.map((n,s)=>{const i=s/e*2*Math.PI,a=t*Math.cos(i),o=t*Math.sin(i);let c="#ffffff";return n.character==="Archaeologist"&&(c="#ff6b6b"),n.character==="Algorithm"&&(c="#4ecdc4"),n.character==="LastHuman"&&(c="#45b7d1"),{...n,x:a,y:o,color:c}})}),Mn=Ue.reducer;function cn(r){return r<=3?"past":r<=6?"present":"future"}const Ge={sequence:[],revisitPatterns:{},attractorsEngaged:{},detailedVisits:[],transitions:[],characterFocus:{},temporalLayerFocus:{},patternSequences:{repeatedSequences:[],characterSequences:[],temporalSequences:[]}},ln={path:Ge,currentNodeId:null,previousNodeId:null,endpointProgress:{past:0,present:0,future:0},attractorEngagement:{},visited:[]},Ye=Te({name:"reader",initialState:ln,reducers:{navigateToNode:(r,e)=>{const{nodeId:t,character:n,temporalValue:s}=e.payload,i=cn(s);if(r.currentNodeId){const u={from:r.currentNodeId,to:t,attractorsEngaged:[]};r.path.transitions||(r.path.transitions=[]),r.path.transitions.push(u),r.previousNodeId=r.currentNodeId}r.currentNodeId=t,r.path.sequence.push(t);const a=(r.path.revisitPatterns[t]||0)+1;r.path.revisitPatterns[t]=a,r.path.characterFocus||(r.path.characterFocus={}),r.path.characterFocus[n]=(r.path.characterFocus[n]||0)+1,r.path.temporalLayerFocus||(r.path.temporalLayerFocus={}),r.path.temporalLayerFocus[i]=(r.path.temporalLayerFocus[i]||0)+1;const o={nodeId:t,character:n,temporalLayer:i,engagedAttractors:[],index:r.path.sequence.length-1,revisitCount:a};r.path.detailedVisits||(r.path.detailedVisits=[]),r.path.detailedVisits.push(o),r.path.patternSequences||(r.path.patternSequences={repeatedSequences:[],characterSequences:[],temporalSequences:[]}),Array.isArray(r.path.patternSequences.characterSequences)||(r.path.patternSequences.characterSequences=[]),Array.isArray(r.path.patternSequences.temporalSequences)||(r.path.patternSequences.temporalSequences=[]);const c=r.path.patternSequences.characterSequences[0]||[];c.push(n),r.path.patternSequences.characterSequences[0]=c;const l=r.path.patternSequences.temporalSequences[0]||[];l.push(i),r.path.patternSequences.temporalSequences[0]=l},addVisitedNode:(r,e)=>{const t=e.payload,n=r.visited??[];if(n.length>0&&n[0].id===t.id)return;const s=n.filter(i=>i.id!==t.id);r.visited=[t,...s].slice(0,25)},engageAttractor:(r,e)=>{const t=e.payload;if(r.path.attractorsEngaged[t]=(r.path.attractorsEngaged[t]||0)+1,r.attractorEngagement[t]=(r.attractorEngagement[t]||0)+1,r.path.detailedVisits&&r.path.detailedVisits.length>0){const n=r.path.detailedVisits[r.path.detailedVisits.length-1];n.engagedAttractors.includes(t)||n.engagedAttractors.push(t)}if(r.path.transitions&&r.path.transitions.length>0){const n=r.path.transitions[r.path.transitions.length-1];n.attractorsEngaged.includes(t)||n.attractorsEngaged.push(t)}},updateEndpointProgress:(r,e)=>{const{orientation:t,value:n}=e.payload;r.endpointProgress[t]=Math.min(100,Math.max(0,n))},resetReader:r=>{r.path=Ge,r.currentNodeId=null,r.previousNodeId=null,r.endpointProgress={past:0,present:0,future:0},r.attractorEngagement={}},analyzePatterns:r=>{const{sequence:e}=r.path;if(e.length>=4){const t=[];for(let n=2;n<=Math.floor(e.length/2);n++)for(let s=0;s<=e.length-n*2;s++){const i=e.slice(s,s+n);for(let a=s+n;a<=e.length-n;a++){const o=e.slice(a,a+n);if(i.every((c,l)=>c===o[l])){t.some(l=>l.length===i.length&&l.every((u,h)=>u===i[h]))||t.push(i);break}}}r.path.patternSequences||(r.path.patternSequences={repeatedSequences:[],characterSequences:[],temporalSequences:[]}),r.path.patternSequences.repeatedSequences=t}}}}),{navigateToNode:Sn,engageAttractor:Rn,updateEndpointProgress:_n,resetReader:kn,analyzePatterns:xn,addVisitedNode:On}=Ye.actions,Vn=r=>r.reader.currentNodeId,qn=(r,e)=>r.reader.path.revisitPatterns[e]||0,jn=r=>r.reader.visited,Nn=Ye.reducer,Oe={viewMode:"constellation",showMiniConstellation:!0,showMetaInterface:!1,hoveredNodeId:null,selectedNodeId:null,lastInteraction:0,showStrangeAttractors:!1,constellationZoom:1,constellationRotation:{x:0,y:0,z:0},textSize:"medium",highContrast:!1,animations:"full",transitionSpeed:500,helpModalOpen:!1,aboutModalOpen:!1,isInitialChoicePhase:!0},Xe=Te({name:"interface",initialState:Oe,reducers:{setViewMode:(r,e)=>{r.viewMode=e.payload},toggleMiniConstellation:r=>{r.showMiniConstellation=!r.showMiniConstellation},toggleMetaInterface:r=>{r.showMetaInterface=!r.showMetaInterface},toggleStrangeAttractors:r=>{r.showStrangeAttractors=!r.showStrangeAttractors},setConstellationZoom:(r,e)=>{r.constellationZoom=Math.max(.5,Math.min(2.5,e.payload))},setConstellationRotation:(r,e)=>{const{x:t,y:n,z:s}=e.payload;t!==void 0&&(r.constellationRotation.x=t),n!==void 0&&(r.constellationRotation.y=n),s!==void 0&&(r.constellationRotation.z=s)},setTextSize:(r,e)=>{r.textSize=e.payload},toggleHighContrast:r=>{r.highContrast=!r.highContrast},setAnimations:(r,e)=>{r.animations=e.payload},setTransitionSpeed:(r,e)=>{r.transitionSpeed=Math.max(0,Math.min(1e3,e.payload))},toggleHelpModal:r=>{r.helpModalOpen=!r.helpModalOpen},toggleAboutModal:r=>{r.aboutModalOpen=!r.aboutModalOpen},resetInterface:()=>Oe,nodeHovered:(r,e)=>{r.hoveredNodeId=e.payload,r.lastInteraction=Date.now()},nodeUnhovered:r=>{r.hoveredNodeId=null},nodeSelected:(r,e)=>{r.selectedNodeId!==e.payload&&(r.selectedNodeId=e.payload,r.viewMode="reading",r.lastInteraction=Date.now(),r.isInitialChoicePhase&&(r.isInitialChoicePhase=!1))},returnToConstellation:r=>{r.viewMode="constellation"},setInitialChoicePhaseCompleted:r=>{r.isInitialChoicePhase=!1}}}),{setViewMode:Fn,toggleMiniConstellation:In,toggleMetaInterface:zn,toggleStrangeAttractors:Dn,setConstellationZoom:Ln,setConstellationRotation:Hn,setTextSize:Bn,toggleHighContrast:Jn,setAnimations:Kn,setTransitionSpeed:Wn,toggleHelpModal:Un,toggleAboutModal:Gn,resetInterface:Yn,nodeHovered:Xn,nodeUnhovered:Qn,nodeSelected:Zn,returnToConstellation:er,setInitialChoicePhaseCompleted:tr}=Xe.actions,nr=r=>r.interface.viewMode,rr=r=>r.interface.hoveredNodeId,sr=r=>r.interface.selectedNodeId,ar=r=>r.interface.isInitialChoicePhase,ir=Xe.reducer;export{ar as A,bn as B,En as C,le as D,On as E,er as F,jn as G,sr as a,Xn as b,Zn as c,Fn as d,Sn as e,Vn as f,An as g,qn as h,Rn as i,yn as j,rn as k,vn as l,Cn as m,Qn as n,dn as o,ir as p,Nn as q,gn as r,rr as s,ye as t,Mn as u,mn as v,nr as w,ce as x,Pn as y,$n as z};
//# sourceMappingURL=constellation-D8AaAQ1t.js.map
