var N=Object.defineProperty;var _=(E,t,e)=>t in E?N(E,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):E[t]=e;var P=(E,t,e)=>_(E,typeof t!="symbol"?t+"":t,e);import{u as L,b as y,j as R}from"./react-vendor-DaKsb8LL.js";import{t as V,f as j,g as z,h as F,e as q,v as D,d as I,r as U,i as G,j as B,k as X}from"./constellation-DYOcMIlB.js";import{j as x}from"./three-vendor-BSwpqFLI.js";class Q{constructor(){P(this,"MIN_SEQUENCE_LENGTH",2);P(this,"SEQUENCE_REPETITION_THRESHOLD",2);P(this,"CHARACTER_FOCUS_THRESHOLD",.4);P(this,"TEMPORAL_FOCUS_THRESHOLD",.4)}analyzePathPatterns(t,e){const n=[];return t.path.sequence.length<this.MIN_SEQUENCE_LENGTH||(n.push(...this.identifyRepeatedSequences(t.path)),n.push(...this.identifyCharacterFocusPatterns(t.path)),n.push(...this.identifyTemporalLayerPatterns(t.path)),n.push(...this.identifyReadingRhythmPatterns()),n.push(...this.identifyAttractorAffinityPatterns(t.path,e))),n}identifyRepeatedSequences(t){var s;const e=[],n=(s=t.patternSequences)==null?void 0:s.repeatedSequences;return!n||n.length===0||n.forEach(c=>{if(c.length>=this.MIN_SEQUENCE_LENGTH){const o=c.length,a=Math.floor(t.sequence.length/2),r=o/a;let l=0;for(let f=0;f<=t.sequence.length-o;f++)t.sequence.slice(f,f+o).every((d,C)=>d===c[C])&&l++;const h=Math.floor(t.sequence.length/o),i=Math.min(1,l/h),u=r*.4+i*.6;l>=this.SEQUENCE_REPETITION_THRESHOLD&&e.push({type:"sequence",strength:u,description:`Repeated sequence of ${o} nodes visited ${l} times`,relatedNodes:c})}}),e}identifyCharacterFocusPatterns(t){var a;const e=[],n=t.characterFocus;if(!n)return e;const c=(t.detailedVisits||[]).length;if(c===0)return e;Object.entries(n).forEach(([r,l])=>{const h=l/c;if(h>=this.CHARACTER_FOCUS_THRESHOLD){const u=.5+.5*((h-this.CHARACTER_FOCUS_THRESHOLD)/(1-this.CHARACTER_FOCUS_THRESHOLD));e.push({type:"character",strength:u,description:`Strong focus on ${r} perspective (${Math.round(h*100)}% of visits)`,relatedCharacters:[r]})}});const o=(a=t.patternSequences)==null?void 0:a.characterSequences;if(o&&o.length>0){const r=o[0];if(r.length>=4){let l=0;for(let u=0;u<r.length-3;u++){const f=r[u],m=r[u+1];f!==m&&r[u+2]===f&&r[u+3]===m&&l++}const h=Math.floor((r.length-3)/2),i=l/h;i>=.3&&e.push({type:"character",strength:i,description:"Pattern of alternating between character perspectives",relatedCharacters:Array.from(new Set(r))})}}return e}identifyTemporalLayerPatterns(t){var a;const e=[],n=t.temporalLayerFocus;if(!n)return e;const c=(t.detailedVisits||[]).length;if(c===0)return e;Object.entries(n).forEach(([r,l])=>{const h=l/c;if(h>=this.TEMPORAL_FOCUS_THRESHOLD){const u=.5+.5*((h-this.TEMPORAL_FOCUS_THRESHOLD)/(1-this.TEMPORAL_FOCUS_THRESHOLD));e.push({type:"temporal",strength:u,description:`Strong focus on ${r} temporal layer (${Math.round(h*100)}% of visits)`,relatedTemporalLayers:[r]})}});const o=(a=t.patternSequences)==null?void 0:a.temporalSequences;if(o&&o.length>0){const r=o[0];if(r.length>=5){let l=0;for(let m=0;m<r.length-2;m++){const d=r[m],C=r[m+1],v=r[m+2];(d==="past"&&C==="present"&&v==="future"||d==="past"&&C==="present"||C==="present"&&v==="future")&&l++}const h=r.length-2,i=l/h;i>=.3&&e.push({type:"temporal",strength:i,description:"Pattern of chronological progression through time",relatedTemporalLayers:["past","present","future"]});let u=0;for(let m=0;m<r.length-2;m++){const d=r[m],C=r[m+1],v=r[m+2];(d==="future"&&C==="present"&&v==="past"||d==="future"&&C==="present"||C==="present"&&v==="past")&&u++}const f=u/h;f>=.3&&e.push({type:"temporal",strength:f,description:"Pattern of reverse chronological movement through time",relatedTemporalLayers:["future","present","past"]})}}return e}identifyReadingRhythmPatterns(){return[]}identifyAttractorAffinityPatterns(t,e){const n=[],s=t.attractorsEngaged,c=t.detailedVisits||[];if(!s||Object.keys(s).length===0)return n;const o=Object.values(s).reduce((a,r)=>a+r,0);if(o===0)return n;if(Object.entries(s).forEach(([a,r])=>{const l=r/o;if(l>=.25){const h=Object.values(e).filter(f=>f.strangeAttractors.includes(a)).map(f=>f.id);let i=0;h.length>0&&(i=c.filter(m=>h.includes(m.nodeId)).length/c.length);const u=l*.7+i*.3;n.push({type:"thematic",strength:u,description:`Strong affinity for "${a}" concept/theme`,relatedAttractors:[a],relatedNodes:h})}}),c.length>=3){const a={};Object.values(e).forEach(i=>{a[i.id]=i.strangeAttractors});const r=c.slice(-Math.min(10,c.length));let l=0;for(let i=1;i<r.length;i++){const u=r[i-1].nodeId,f=r[i].nodeId,m=a[u]||[],d=a[f]||[];m.filter(v=>d.includes(v)).length>0&&l++}const h=l/(r.length-1);h>=.5&&n.push({type:"thematic",strength:h,description:"Pattern of following thematic connections between nodes"})}return n}calculateAttractorEngagement(t,e){const{path:n}=t,s=n.attractorsEngaged,c=n.detailedVisits||[];if(!s||Object.keys(s).length===0)return[];const o=[];return Object.entries(s).forEach(([a,r])=>{const l=a;if(r===0)return;const h=Object.values(e).filter(b=>b.strangeAttractors.includes(l)).map(b=>b.id),i=c.filter(b=>b.engagedAttractors.includes(l));if(i.length===0)return;let u="stable";if(i.length>=3){const b=Math.floor(i.length/2),p=i.slice(0,b),g=i.slice(b);g.length>p.length*1.2?u="rising":g.length<p.length*.8&&(u="falling")}const f=Object.values(s).reduce((b,p)=>b+p,0),m=r/f*100,d=c.indexOf(i[i.length-1])>c.length*.7?.8:.4,C=i.length>r*.5?.7:.3,v=Math.min(100,m*.6+d*20+C*20);o.push({attractor:l,engagementScore:v,totalEngagements:r,relatedNodes:h,trend:u})}),o.sort((a,r)=>r.engagementScore-a.engagementScore)}identifySignificantPatterns(t,e){return this.analyzePathPatterns(t,e).sort((c,o)=>o.strength-c.strength).filter(c=>c.strength>=.6).slice(0,5)}createTransformationConditions(t,e){const n=[];return t.forEach(s=>{switch(s.type){case"sequence":s.relatedNodes&&s.relatedNodes.length>=2&&n.push({type:"visitPattern",condition:{visitPattern:s.relatedNodes},strength:s.strength});break;case"character":s.relatedCharacters&&s.relatedCharacters.length>0&&n.push({type:"characterFocus",condition:{characters:s.relatedCharacters},strength:s.strength});break;case"temporal":s.relatedTemporalLayers&&s.relatedTemporalLayers.length>0&&n.push({type:"temporalFocus",condition:{temporalPosition:s.relatedTemporalLayers[0]},strength:s.strength});break;case"rhythm":break;case"thematic":s.relatedAttractors&&s.relatedAttractors.length>0&&n.push({type:"attractorAffinity",condition:{strangeAttractorsEngaged:s.relatedAttractors},strength:s.strength});break}}),e.filter(s=>s.engagementScore>=50).forEach(s=>{n.push({type:"attractorEngagement",condition:{strangeAttractorsEngaged:[s.attractor]},strength:s.engagementScore/100})}),n}}const k=new Q;class J{constructor(){P(this,"cache",{});P(this,"visibilityTracker",{});P(this,"CACHE_EXPIRY_TIME",10*60*1e3);P(this,"MAX_CACHE_ENTRIES",200);P(this,"metrics",{cacheHits:0,cacheMisses:0,patternAnalysisCount:0,transformationAppliedCount:0,lazyTransformationsDeferredCount:0,lazyTransformationsAppliedCount:0,lastCacheCleanupTime:Date.now()})}calculatePatternHash(t){const{path:{sequence:e,attractorsEngaged:n},endpointProgress:s}=t,c=e.slice(-5).join("-"),o=Object.entries(n).sort((r,l)=>l[1]-r[1]).slice(0,3).map(([r])=>r).join("-"),a=Object.values(s).join("-");return`${c}|${o}|${a}`}getCacheKey(t,e,n){return`${t}-${e}-${n}`}cleanCache(){const t=Date.now();if(t-this.metrics.lastCacheCleanupTime<3e4)return;this.metrics.lastCacheCleanupTime=t;let e=Object.entries(this.cache);e=e.filter(([,n])=>t-n.timestamp<=this.CACHE_EXPIRY_TIME),e.length>this.MAX_CACHE_ENTRIES&&(e.sort(([n,s],[c,o])=>{var i,u;const a=n.split("-")[0],r=c.split("-")[0],l=((i=this.visibilityTracker[a])==null?void 0:i.isVisible)||!1,h=((u=this.visibilityTracker[r])==null?void 0:u.isVisible)||!1;return l!==h?h?1:-1:o.timestamp-s.timestamp}),e=e.slice(0,this.MAX_CACHE_ENTRIES)),this.cache=Object.fromEntries(e)}prioritizeTransformations(t,e,n){const s=t.map(a=>{let r=50,l="condition";const h=`selector-${a.selector}`;switch(a.type){case"replace":r=80,l="pattern";break;case"fragment":r=75,l="rhythm";break;case"expand":r=60,l="attractor";break;case"emphasize":r=50,l="temporal";break;case"metaComment":r=40,l="attractor";break}return{transformation:a,priority:r,sourceType:l,conflictGroup:h}}),c=k.identifySignificantPatterns(e,{[n.id]:n}),o=k.calculateAttractorEngagement(e,{[n.id]:n});return s.forEach(a=>{if(a.sourceType==="pattern"){const r=c.find(l=>l.type==="sequence"&&l.strength>.7);r&&(a.priority+=Math.round(r.strength*15))}if(a.sourceType==="attractor"&&a.transformation.selector){const r=o.find(l=>{var h;return((h=n.currentContent)==null?void 0:h.includes(a.transformation.selector))&&n.strangeAttractors.includes(l.attractor)});r&&r.engagementScore>50&&(a.priority+=Math.round((r.engagementScore-50)/5))}}),s}resolveConflicts(t){const e={};t.forEach(s=>{s.conflictGroup&&(e[s.conflictGroup]||(e[s.conflictGroup]=[]),e[s.conflictGroup].push(s))});const n=[];return t.filter(s=>!s.conflictGroup).forEach(s=>n.push(s)),Object.values(e).forEach(s=>{s.length>0&&(s.sort((c,o)=>o.priority-c.priority),n.push(s[0]))}),n}applyTransformationsWithPriority(t,e,n,s){if(e.length===0)return t;let c=this.prioritizeTransformations(e,n,s);c=this.resolveConflicts(c),c.sort((a,r)=>r.priority-a.priority);let o=t;return c.forEach(({transformation:a})=>{o=V.applyTextTransformation(o,a)}),o}setContentVisibility(t,e,n=1){this.visibilityTracker[t]||(this.visibilityTracker[t]={isVisible:!1,lastVisibleTimestamp:0,pendingTransformations:[],priority:n}),this.visibilityTracker[t].isVisible=e,e&&(this.visibilityTracker[t].lastVisibleTimestamp=Date.now(),this.processPendingTransformations(t))}processPendingTransformations(t){const e=this.visibilityTracker[t];!e||!e.isVisible||e.pendingTransformations.length===0||(this.metrics.lazyTransformationsAppliedCount+=e.pendingTransformations.length,e.pendingTransformations=[])}queueLazyTransformation(t,e){if(this.visibilityTracker[t]||(this.visibilityTracker[t]={isVisible:!1,lastVisibleTimestamp:0,pendingTransformations:[],priority:1}),this.visibilityTracker[t].isVisible){this.metrics.lazyTransformationsAppliedCount++;return}this.visibilityTracker[t].pendingTransformations.push(e),this.metrics.lazyTransformationsDeferredCount++}getCachedTransformedContent(t,e,n,s,c){var i;const o=this.calculatePatternHash(s),a=this.getCacheKey(t,c.visitCount,o);this.cleanCache();const r=((i=this.visibilityTracker[t])==null?void 0:i.isVisible)||!1;if(this.cache[a]&&this.cache[a].content)return this.metrics.cacheHits++,!r&&n.length>0&&this.metrics.lazyTransformationsDeferredCount++,this.cache[a].content;if(this.metrics.cacheMisses++,!r&&n.length>3){n.forEach(f=>this.queueLazyTransformation(t,f));const u=n.filter(f=>f.type==="replace"||f.priority==="high");u.length<n.length&&(n=u)}const l=this.applyTransformationsWithPriority(e,n,s,c),h=n.map(u=>({selector:u.selector||"",transformType:u.type,position:this.findPositionInContent(e,u.selector||"")})).filter(u=>u.position[0]>=0);return this.cache[a]={transformations:n,timestamp:Date.now(),content:l,transformedSegments:h,metadata:{readerStateHash:JSON.stringify({path:s.path.sequence.slice(-5),attractors:Object.keys(s.path.attractorsEngaged||{})}),nodeStateHash:JSON.stringify({id:c.id,visitCount:c.visitCount}),complexity:this.calculateTransformationComplexity(n)}},l}findPositionInContent(t,e){if(!e||!t)return[-1,-1];const n=t.indexOf(e);return n===-1?[-1,-1]:[n,n+e.length]}calculateTransformationComplexity(t){return t.length?t.reduce((e,n)=>{var a,r;let s=1;switch(n.type){case"fragment":s=3;break;case"emphasize":s=2;break;case"metaComment":s=2.5;break;case"expand":s=2;break;case"replace":s=1;break}const c=(((a=n.selector)==null?void 0:a.length)||0)+(((r=n.replacement)==null?void 0:r.length)||0),o=Math.log(c+10)/Math.log(10);return e+s*o},0):0}getTransformationHash(t){return t.map(e=>{var n;return`${e.type}-${(n=e.selector)==null?void 0:n.substring(0,10)}`}).join("|")}generateTransitionClasses(t){const e={};return t.forEach(n=>{if(!n.selector)return;const s=n.selector.replace(/[^a-zA-Z0-9]/g,"_");let o=`narramorph-transform narramorph-transform-${n.type}`;const a=n.intensity||1;switch(n.type){case"replace":o+=" narramorph-replaced",n.preserveFormatting&&(o+=" preserve-formatting");break;case"fragment":o+=" narramorph-fragmented",n.fragmentStyle&&(o+=` narramorph-fragment-${n.fragmentStyle}`);break;case"expand":o+=" narramorph-expanded",n.expandStyle&&(o+=` narramorph-expand-${n.expandStyle||"default"}`);break;case"emphasize":o+=" narramorph-emphasized",n.emphasis&&(o+=` narramorph-emphasis-${n.emphasis}`),o+=` intensity-${a}`;break;case"metaComment":o+=" narramorph-commented",n.commentStyle&&(o+=` narramorph-comment-${n.commentStyle}`);break}o+=` narramorph-element-${s.substring(0,20)}`,e[n.selector]=o}),e}wrapTransformedContent(t,e){if(e.length===0)return t;const n=this.generateTransitionClasses(e);let s=t;return Object.entries(n).forEach(([c,o])=>{const a=e.find(h=>h.selector===c);if(!a)return;let r;const l=`
        data-transform-type="${a.type}"
        data-selector="${O(c.substring(0,30))}"
        data-transform-id="${this.getUniqueTransformId(a)}"
      `;switch(a.type){case"replace":case"fragment":case"emphasize":r=a.type==="replace"?a.replacement||"":c,s=s.replace(new RegExp(O(r),"g"),`<span class="${o}" ${l}>${r}</span>`);break;case"expand":if(a.replacement){const h=`${c} ${a.replacement}`,i=a.expandStyle||"default";let u="narramorph-expansion";i==="reveal"?u="narramorph-reveal-expansion":i==="inline"?u="narramorph-inline-expansion":i==="paragraph"&&(u="narramorph-paragraph-expansion"),s=s.replace(new RegExp(O(h),"g"),`<span class="${o}" ${l}>${c}<span class="${u}">${a.replacement}</span></span>`)}break;case"metaComment":if(a.replacement){const h=a.commentStyle||"inline";let i="narramorph-comment";h==="footnote"?i="narramorph-footnote-marker":h==="marginalia"?i="narramorph-marginalia":h==="interlinear"&&(i="narramorph-interlinear");const u=a.replacement,f=`${c} [${u}]`;let m="";if(h==="footnote"){const d=`footnote-${u.substring(0,10).replace(/\W/g,"")}`;m=`<span class="${o}" ${l}>${c}<sup id="${d}-ref" class="${i}">[â€ ]</sup></span>`}else h==="marginalia"?m=`<span class="${o} narramorph-marginalia-container" ${l}>${c}<span class="${i}">${u}</span></span>`:h==="interlinear"?m=`<span class="${o} narramorph-interlinear-container" ${l}>${c}<span class="${i}">${u}</span></span>`:m=`<span class="${o}" ${l}>${c}<span class="${i}">[${u}]</span></span>`;s=s.replace(new RegExp(O(f),"g"),m)}break}}),s}getUniqueTransformId(t){const e=this.hashString(t.selector||""),n=t.type.substring(0,3),s=t.replacement?this.hashString(t.replacement).substring(0,3):"";return`${n}-${e}${s?"-"+s:""}`}hashString(t){let e=0;for(let n=0;n<t.length;n++){const s=t.charCodeAt(n);e=(e<<5)-e+s,e=e&e}return Math.abs(e).toString(36).substring(0,6)}createTransformationsFromPatterns(t,e){var h;this.metrics.patternAnalysisCount++;const n=this.calculatePatternHash(t),s=`patterns-${e.id}-${e.visitCount}-${n}`;if(this.cache[s]&&this.cache[s].transformations)return this.metrics.cacheHits++,this.cache[s].transformations;if(this.metrics.cacheMisses++,!(((h=this.visibilityTracker[e.id])==null?void 0:h.isVisible)||!1)&&e.visitCount>1){const i=[];return this.cache[s]={transformations:i,timestamp:Date.now()-this.CACHE_EXPIRY_TIME/2,content:""},i}const o=k.identifySignificantPatterns(t,{[e.id]:e}),a=k.calculateAttractorEngagement(t,{[e.id]:e}),r=k.createTransformationConditions(o,a),l=[];return r.forEach(i=>{var u,f;switch(i.type){case"visitPattern":if(i.strength>.8&&e.currentContent){const m=e.currentContent.split(`

`);m.length>1&&l.push({type:"replace",selector:m[1],replacement:`${m[1]} [A recurring pattern emerges in your exploration]`,priority:"high"})}break;case"characterFocus":if(i.strength>.7&&((u=i.condition.characters)==null?void 0:u[0])===e.character&&e.currentContent){const m=e.currentContent.split(`

`);m.length>0&&l.push({type:"emphasize",selector:m[0],emphasis:"color",priority:"medium"})}break;case"temporalFocus":if(i.strength>.7&&i.condition.temporalPosition&&e.currentContent&&(e.temporalValue<=3?"past":e.temporalValue<=6?"present":"future")===i.condition.temporalPosition){const d=e.currentContent.split(`

`);d.length>2&&l.push({type:"metaComment",selector:d[2],replacement:`You seem drawn to ${i.condition.temporalPosition} narratives`,priority:"low"})}break;case"readingRhythm":break;case"attractorAffinity":case"attractorEngagement":if(i.strength>.7&&((f=i.condition.strangeAttractorsEngaged)!=null&&f[0])&&e.currentContent){const m=i.condition.strangeAttractorsEngaged[0],d=e.currentContent.split(`

`);d.length>0&&e.strangeAttractors.includes(m)&&l.push({type:"expand",selector:d[0],replacement:`The concept of ${m.replace("-"," ")} resonates with you.`,priority:"high"})}break}}),l}}function O(E){return E.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const H=new J,tt=E=>{const t=L(),[e,n]=y.useState([]),[s,c]=y.useState(!1),o=R(j),a=E||o,r=R(p=>a?z(p,a):null),l=R(p=>p.nodes.data),h=R(p=>a?F(p,a):0),i=R(p=>p.reader),u=y.useCallback(p=>{const g=l[p];g?(t(q({nodeId:p,character:g.character,temporalValue:g.temporalValue,attractors:g.strangeAttractors})),t(D(p)),t(I("reading")),console.log(`Navigating to node: ${p}`)):console.error(`Could not navigate to node: ${p} - node data not found`)},[t,l]),f=y.useCallback((p,g)=>{t(U({nodeId:p,targetId:g}))},[t]),m=y.useCallback(p=>{t(G(p))},[t]),d=y.useCallback((p,g)=>{t(B({nodeId:p,transformation:g}))},[t]),C=y.useMemo(()=>r?r.revealedConnections:[],[r]),v=y.useMemo(()=>{if(!(r!=null&&r.currentContent))return null;const g=[...H.createTransformationsFromPatterns(i,r),...r.transformations.flatMap(T=>V.evaluateCondition(T.condition,i,r)?T.transformations:[])],A=H.getCachedTransformedContent(r.id,r.currentContent,g,i,r),$=H.wrapTransformedContent(A,g);return JSON.stringify(e)!==JSON.stringify(g)&&(n(g),c(!0)),$},[r,i,e]);y.useEffect(()=>{if(s){const p=setTimeout(()=>{c(!1)},2e3);return()=>clearTimeout(p)}},[s]),y.useEffect(()=>{if(!(!r||!a)){if(r.visitCount===1&&d(a,{condition:{visitCount:1},transformations:[{type:"emphasize",selector:"first-paragraph",emphasis:"italic"}]}),r.visitCount>=2){const p=H.createTransformationsFromPatterns(i,r);if(p.length>0){const g={condition:{visitCount:r.visitCount},transformations:p};d(a,g)}}t(X({nodeId:a,readerState:i}))}},[r,a,h,i,t,d]);const b=y.useCallback(p=>r?V.evaluateCondition(p,i,r):!1,[r,i]);return{node:r,navigateTo:u,revealNodeConnection:f,engageWithAttractor:m,applyNodeTransformation:d,evaluateCondition:b,neighbors:C,revisitCount:h,transformedContent:v,newlyTransformed:s,appliedTransformations:e}},et=({children:E,transformations:t,isNewlyTransformed:e,nodeId:n})=>{const s=y.useRef(null),c=y.useRef(null),[o,a]=y.useState("idle"),[r,l]=y.useState(t.length),[h,i]=y.useState(0),[u,f]=y.useState(null),[m,d]=y.useState(!0);y.useEffect(()=>{if(h<3){const p=setTimeout(()=>{i(g=>g+1),console.log(`[AnimationContainer] Forced re-render for node: ${n}, attempt: ${h+1}`)},100);return()=>clearTimeout(p)}},[n,h]),y.useEffect(()=>{if(e){a("entering");const p=setTimeout(()=>{a("active")},1e3);return()=>clearTimeout(p)}},[e,t]),y.useEffect(()=>{a("idle"),l(t.length),console.log(`[AnimationContainer] Node changed to: ${n}, transformations: ${t.length}`)},[n,t.length]),y.useLayoutEffect(()=>{if(!s.current)return;const p=()=>{if(!s.current)return;const T=window.getComputedStyle(s.current),S=s.current.getBoundingClientRect(),w={width:S.width,height:S.height,visibility:T.visibility,display:T.display,opacity:T.opacity,position:T.position,zIndex:T.zIndex,overflow:T.overflow};f(w);const M=S.width>0&&S.height>0&&T.visibility!=="hidden"&&T.display!=="none"&&parseFloat(T.opacity)>0;d(M),m!==M&&console.log(`[AnimationContainer] Content visibility changed to: ${M?"visible":"hidden"}`,{nodeId:n,transformations:t.length,animationState:o,measurements:w})};p();const g=setTimeout(p,1100);let A=null;const $=new MutationObserver(T=>{T.length>2&&console.log(`[AnimationContainer] DOM mutations detected: ${T.length}`),A&&clearTimeout(A),A=window.setTimeout(()=>{p(),A=null},500)});return $.observe(s.current,{attributes:!0,childList:!0,subtree:!1}),()=>{clearTimeout(g),$.disconnect()}},[n,t,o,m]);const C=()=>{if(o==="idle")return"";const p=t.some($=>$.type==="replace"),g=t.some($=>$.type==="emphasize"),A=t.some($=>$.type==="expand");return o==="entering"?p?"narramorph-container-replace-active":g?"narramorph-container-emphasis-active":A?"narramorph-container-expand-active":"narramorph-container-transform-active":"narramorph-container-active"},v=()=>{if(t.length===0)return"";const p={};t.forEach(A=>{p[A.type]=(p[A.type]||0)+1});const g=[];return p.replace&&g.push(`${p.replace} replacements`),p.emphasize&&g.push(`${p.emphasize} emphasis`),p.expand&&g.push(`${p.expand} expansions`),p.fragment&&g.push(`${p.fragment} fragmentations`),p.metaComment&&g.push(`${p.metaComment} comments`),g.join(", ")},b=t.length!==r;return y.useEffect(()=>{e&&console.log(`[AnimationContainer] Animation started for node: ${n}`,{transformations:t.length,animationState:o,contentVisible:m})},[e,n,t.length,o,m]),x.jsxs("div",{ref:s,className:`narramorph-animation-container ${C()}`,"data-transformation-count":t.length,"data-newly-transformed":e,"data-animation-state":o,"data-visible":m,"data-render-attempt":h,style:{overflow:"visible",minHeight:"150px",position:"relative",visibility:"visible",display:"block",opacity:1},children:[t.length>0&&x.jsxs("div",{className:`narramorph-transformation-indicator ${e?"active":""}`,title:v(),children:[x.jsx("span",{className:"transformation-count",children:t.length}),b&&x.jsxs("span",{className:"transformation-change-indicator",children:[t.length>r?"+":"",t.length-r]})]}),x.jsx("div",{ref:c,className:"narramorph-animation-content",style:{position:"relative",visibility:"visible",display:"block",opacity:1,minHeight:"100px"},children:h===0?x.jsx("div",{className:"animation-placeholder",style:{padding:"20px",textAlign:"center"},children:x.jsx("p",{children:"Preparing narrative..."})}):E}),!1]})};export{et as T,H as t,tt as u};
//# sourceMappingURL=narramorph-P_FFBqAj.js.map
