var Ye=Object.defineProperty;var Xe=(s,e,t)=>e in s?Ye(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var A=(s,e,t)=>Xe(s,typeof e!="symbol"?e+"":e,t);import"./three-vendor-rJ5vKMTC.js";import{i as Qe,c as Ze,d as et,e as ie,f as tt,h as nt}from"./react-vendor-DaKsb8LL.js";var Re=Symbol.for("immer-nothing"),Ce=Symbol.for("immer-draftable"),k=Symbol.for("immer-state");function R(s,...e){throw new Error(`[Immer] minified error nr: ${s}. Full error at: https://bit.ly/3cXEKWf`)}var N=Object.getPrototypeOf;function j(s){return!!s&&!!s[k]}function _(s){var e;return s?xe(s)||Array.isArray(s)||!!s[Ce]||!!((e=s.constructor)!=null&&e[Ce])||Y(s)||X(s):!1}var rt=Object.prototype.constructor.toString();function xe(s){if(!s||typeof s!="object")return!1;const e=N(s);if(e===null)return!0;const t=Object.hasOwnProperty.call(e,"constructor")&&e.constructor;return t===Object?!0:typeof t=="function"&&Function.toString.call(t)===rt}function K(s,e){G(s)===0?Reflect.ownKeys(s).forEach(t=>{e(t,s[t],s)}):s.forEach((t,n)=>e(n,t,s))}function G(s){const e=s[k];return e?e.type_:Array.isArray(s)?1:Y(s)?2:X(s)?3:0}function oe(s,e){return G(s)===2?s.has(e):Object.prototype.hasOwnProperty.call(s,e)}function _e(s,e,t){const n=G(s);n===2?s.set(e,t):n===3?s.add(t):s[e]=t}function st(s,e){return s===e?s!==0||1/s===1/e:s!==s&&e!==e}function Y(s){return s instanceof Map}function X(s){return s instanceof Set}function V(s){return s.copy_||s.base_}function ce(s,e){if(Y(s))return new Map(s);if(X(s))return new Set(s);if(Array.isArray(s))return Array.prototype.slice.call(s);const t=xe(s);if(e===!0||e==="class_only"&&!t){const n=Object.getOwnPropertyDescriptors(s);delete n[k];let r=Reflect.ownKeys(n);for(let a=0;a<r.length;a++){const i=r[a],o=n[i];o.writable===!1&&(o.writable=!0,o.configurable=!0),(o.get||o.set)&&(n[i]={configurable:!0,writable:!0,enumerable:o.enumerable,value:s[i]})}return Object.create(N(s),n)}else{const n=N(s);if(n!==null&&t)return{...s};const r=Object.create(n);return Object.assign(r,s)}}function de(s,e=!1){return Q(s)||j(s)||!_(s)||(G(s)>1&&(s.set=s.add=s.clear=s.delete=at),Object.freeze(s),e&&Object.entries(s).forEach(([t,n])=>de(n,!0))),s}function at(){R(2)}function Q(s){return Object.isFrozen(s)}var it={};function F(s){const e=it[s];return e||R(0,s),e}var z;function Oe(){return z}function ot(s,e){return{drafts_:[],parent_:s,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function ve(s,e){e&&(F("Patches"),s.patches_=[],s.inversePatches_=[],s.patchListener_=e)}function le(s){ue(s),s.drafts_.forEach(ct),s.drafts_=null}function ue(s){s===z&&(z=s.parent_)}function Te(s){return z=ot(z,s)}function ct(s){const e=s[k];e.type_===0||e.type_===1?e.revoke_():e.revoked_=!0}function be(s,e){e.unfinalizedDrafts_=e.drafts_.length;const t=e.drafts_[0];return s!==void 0&&s!==t?(t[k].modified_&&(le(e),R(4)),_(s)&&(s=W(e,s),e.parent_||U(e,s)),e.patches_&&F("Patches").generateReplacementPatches_(t[k].base_,s,e.patches_,e.inversePatches_)):s=W(e,t,[]),le(e),e.patches_&&e.patchListener_(e.patches_,e.inversePatches_),s!==Re?s:void 0}function W(s,e,t){if(Q(e))return e;const n=e[k];if(!n)return K(e,(r,a)=>Ee(s,n,e,r,a,t)),e;if(n.scope_!==s)return e;if(!n.modified_)return U(s,n.base_,!0),n.base_;if(!n.finalized_){n.finalized_=!0,n.scope_.unfinalizedDrafts_--;const r=n.copy_;let a=r,i=!1;n.type_===3&&(a=new Set(r),r.clear(),i=!0),K(a,(o,c)=>Ee(s,n,r,o,c,t,i)),U(s,r,!1),t&&s.patches_&&F("Patches").generatePatches_(n,t,s.patches_,s.inversePatches_)}return n.copy_}function Ee(s,e,t,n,r,a,i){if(j(r)){const o=a&&e&&e.type_!==3&&!oe(e.assigned_,n)?a.concat(n):void 0,c=W(s,r,o);if(_e(t,n,c),j(c))s.canAutoFreeze_=!1;else return}else i&&t.add(r);if(_(r)&&!Q(r)){if(!s.immer_.autoFreeze_&&s.unfinalizedDrafts_<1)return;W(s,r),(!e||!e.scope_.parent_)&&typeof n!="symbol"&&Object.prototype.propertyIsEnumerable.call(t,n)&&U(s,r)}}function U(s,e,t=!1){!s.parent_&&s.immer_.autoFreeze_&&s.canAutoFreeze_&&de(e,t)}function lt(s,e){const t=Array.isArray(s),n={type_:t?1:0,scope_:e?e.scope_:Oe(),modified_:!1,finalized_:!1,assigned_:{},parent_:e,base_:s,draft_:null,copy_:null,revoke_:null,isManual_:!1};let r=n,a=me;t&&(r=[n],a=D);const{revoke:i,proxy:o}=Proxy.revocable(r,a);return n.draft_=o,n.revoke_=i,o}var me={get(s,e){if(e===k)return s;const t=V(s);if(!oe(t,e))return ut(s,t,e);const n=t[e];return s.finalized_||!_(n)?n:n===ee(s.base_,e)?(te(s),s.copy_[e]=fe(n,s)):n},has(s,e){return e in V(s)},ownKeys(s){return Reflect.ownKeys(V(s))},set(s,e,t){const n=Ve(V(s),e);if(n!=null&&n.set)return n.set.call(s.draft_,t),!0;if(!s.modified_){const r=ee(V(s),e),a=r==null?void 0:r[k];if(a&&a.base_===t)return s.copy_[e]=t,s.assigned_[e]=!1,!0;if(st(t,r)&&(t!==void 0||oe(s.base_,e)))return!0;te(s),he(s)}return s.copy_[e]===t&&(t!==void 0||e in s.copy_)||Number.isNaN(t)&&Number.isNaN(s.copy_[e])||(s.copy_[e]=t,s.assigned_[e]=!0),!0},deleteProperty(s,e){return ee(s.base_,e)!==void 0||e in s.base_?(s.assigned_[e]=!1,te(s),he(s)):delete s.assigned_[e],s.copy_&&delete s.copy_[e],!0},getOwnPropertyDescriptor(s,e){const t=V(s),n=Reflect.getOwnPropertyDescriptor(t,e);return n&&{writable:!0,configurable:s.type_!==1||e!=="length",enumerable:n.enumerable,value:t[e]}},defineProperty(){R(11)},getPrototypeOf(s){return N(s.base_)},setPrototypeOf(){R(12)}},D={};K(me,(s,e)=>{D[s]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}});D.deleteProperty=function(s,e){return D.set.call(this,s,e,void 0)};D.set=function(s,e,t){return me.set.call(this,s[0],e,t,s[0])};function ee(s,e){const t=s[k];return(t?V(t):s)[e]}function ut(s,e,t){var r;const n=Ve(e,t);return n?"value"in n?n.value:(r=n.get)==null?void 0:r.call(s.draft_):void 0}function Ve(s,e){if(!(e in s))return;let t=N(s);for(;t;){const n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=N(t)}}function he(s){s.modified_||(s.modified_=!0,s.parent_&&he(s.parent_))}function te(s){s.copy_||(s.copy_=ce(s.base_,s.scope_.immer_.useStrictShallowCopy_))}var ht=class{constructor(s){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(e,t,n)=>{if(typeof e=="function"&&typeof t!="function"){const a=t;t=e;const i=this;return function(c=a,...l){return i.produce(c,u=>t.call(this,u,...l))}}typeof t!="function"&&R(6),n!==void 0&&typeof n!="function"&&R(7);let r;if(_(e)){const a=Te(this),i=fe(e,void 0);let o=!0;try{r=t(i),o=!1}finally{o?le(a):ue(a)}return ve(a,n),be(r,a)}else if(!e||typeof e!="object"){if(r=t(e),r===void 0&&(r=e),r===Re&&(r=void 0),this.autoFreeze_&&de(r,!0),n){const a=[],i=[];F("Patches").generateReplacementPatches_(e,r,a,i),n(a,i)}return r}else R(1,e)},this.produceWithPatches=(e,t)=>{if(typeof e=="function")return(i,...o)=>this.produceWithPatches(i,c=>e(c,...o));let n,r;return[this.produce(e,t,(i,o)=>{n=i,r=o}),n,r]},typeof(s==null?void 0:s.autoFreeze)=="boolean"&&this.setAutoFreeze(s.autoFreeze),typeof(s==null?void 0:s.useStrictShallowCopy)=="boolean"&&this.setUseStrictShallowCopy(s.useStrictShallowCopy)}createDraft(s){_(s)||R(8),j(s)&&(s=ft(s));const e=Te(this),t=fe(s,void 0);return t[k].isManual_=!0,ue(e),t}finishDraft(s,e){const t=s&&s[k];(!t||!t.isManual_)&&R(9);const{scope_:n}=t;return ve(n,e),be(void 0,n)}setAutoFreeze(s){this.autoFreeze_=s}setUseStrictShallowCopy(s){this.useStrictShallowCopy_=s}applyPatches(s,e){let t;for(t=e.length-1;t>=0;t--){const r=e[t];if(r.path.length===0&&r.op==="replace"){s=r.value;break}}t>-1&&(e=e.slice(t+1));const n=F("Patches").applyPatches_;return j(s)?n(s,e):this.produce(s,r=>n(r,e))}};function fe(s,e){const t=Y(s)?F("MapSet").proxyMap_(s,e):X(s)?F("MapSet").proxySet_(s,e):lt(s,e);return(e?e.scope_:Oe()).drafts_.push(t),t}function ft(s){return j(s)||R(10,s),je(s)}function je(s){if(!_(s)||Q(s))return s;const e=s[k];let t;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,t=ce(s,e.scope_.immer_.useStrictShallowCopy_)}else t=ce(s,!0);return K(t,(n,r)=>{_e(t,n,je(r))}),e&&(e.finalized_=!1),t}var M=new ht,Fe=M.produce;M.produceWithPatches.bind(M);M.setAutoFreeze.bind(M);M.setUseStrictShallowCopy.bind(M);M.applyPatches.bind(M);M.createDraft.bind(M);M.finishDraft.bind(M);function pt(s,e=`expected a function, instead received ${typeof s}`){if(typeof s!="function")throw new TypeError(e)}function dt(s,e=`expected an object, instead received ${typeof s}`){if(typeof s!="object")throw new TypeError(e)}function mt(s,e="expected all items to be functions, instead received the following types: "){if(!s.every(t=>typeof t=="function")){const t=s.map(n=>typeof n=="function"?`function ${n.name||"unnamed"}()`:typeof n).join(", ");throw new TypeError(`${e}[${t}]`)}}var we=s=>Array.isArray(s)?s:[s];function gt(s){const e=Array.isArray(s[0])?s[0]:s;return mt(e,"createSelector expects all input-selectors to be functions, but received the following types: "),e}function yt(s,e){const t=[],{length:n}=s;for(let r=0;r<n;r++)t.push(s[r].apply(null,e));return t}var Ct=class{constructor(s){this.value=s}deref(){return this.value}},vt=typeof WeakRef<"u"?WeakRef:Ct,Tt=0,Ae=1;function H(){return{s:Tt,v:void 0,o:null,p:null}}function Ne(s,e={}){let t=H();const{resultEqualityCheck:n}=e;let r,a=0;function i(){var h;let o=t;const{length:c}=arguments;for(let f=0,p=c;f<p;f++){const m=arguments[f];if(typeof m=="function"||typeof m=="object"&&m!==null){let d=o.o;d===null&&(o.o=d=new WeakMap);const g=d.get(m);g===void 0?(o=H(),d.set(m,o)):o=g}else{let d=o.p;d===null&&(o.p=d=new Map);const g=d.get(m);g===void 0?(o=H(),d.set(m,o)):o=g}}const l=o;let u;if(o.s===Ae)u=o.v;else if(u=s.apply(null,arguments),a++,n){const f=((h=r==null?void 0:r.deref)==null?void 0:h.call(r))??r;f!=null&&n(f,u)&&(u=f,a!==0&&a--),r=typeof u=="object"&&u!==null||typeof u=="function"?new vt(u):u}return l.s=Ae,l.v=u,u}return i.clearCache=()=>{t=H(),i.resetResultsCount()},i.resultsCount=()=>a,i.resetResultsCount=()=>{a=0},i}function bt(s,...e){const t=typeof s=="function"?{memoize:s,memoizeOptions:e}:s,n=(...r)=>{let a=0,i=0,o,c={},l=r.pop();typeof l=="object"&&(c=l,l=r.pop()),pt(l,`createSelector expects an output function after the inputs, but received: [${typeof l}]`);const u={...t,...c},{memoize:h,memoizeOptions:f=[],argsMemoize:p=Ne,argsMemoizeOptions:m=[]}=u,d=we(f),g=we(m),w=gt(r),S=h(function(){return a++,l.apply(null,arguments)},...d),C=p(function(){i++;const v=yt(w,arguments);return o=S.apply(null,v),o},...g);return Object.assign(C,{resultFunc:l,memoizedResultFunc:S,dependencies:w,dependencyRecomputations:()=>i,resetDependencyRecomputations:()=>{i=0},lastResult:()=>o,recomputations:()=>a,resetRecomputations:()=>{a=0},memoize:h,argsMemoize:p})};return Object.assign(n,{withTypes:()=>n}),n}var Z=bt(Ne),Et=Object.assign((s,e=Z)=>{dt(s,`createStructuredSelector expects first argument to be an object where each property is a selector, instead received a ${typeof s}`);const t=Object.keys(s),n=t.map(a=>s[a]);return e(n,(...a)=>a.reduce((i,o,c)=>(i[t[c]]=o,i),{}))},{withTypes:()=>Et});function Ie(s){return({dispatch:t,getState:n})=>r=>a=>typeof a=="function"?a(t,n,s):r(a)}var wt=Ie(),At=Ie,Pt=typeof window<"u"&&window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__?window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__:function(){if(arguments.length!==0)return typeof arguments[0]=="object"?ie:ie.apply(null,arguments)},$t=s=>s&&typeof s.match=="function";function q(s,e){function t(...n){if(e){let r=e(...n);if(!r)throw new Error(x(0));return{type:s,payload:r.payload,..."meta"in r&&{meta:r.meta},..."error"in r&&{error:r.error}}}return{type:s,payload:n[0]}}return t.toString=()=>`${s}`,t.type=s,t.match=n=>nt(n)&&n.type===s,t}var qe=class I extends Array{constructor(...e){super(...e),Object.setPrototypeOf(this,I.prototype)}static get[Symbol.species](){return I}concat(...e){return super.concat.apply(this,e)}prepend(...e){return e.length===1&&Array.isArray(e[0])?new I(...e[0].concat(this)):new I(...e.concat(this))}};function Pe(s){return _(s)?Fe(s,()=>{}):s}function L(s,e,t){return s.has(e)?s.get(e):s.set(e,t(e)).get(e)}function St(s){return typeof s=="boolean"}var kt=()=>function(e){const{thunk:t=!0,immutableCheck:n=!0,serializableCheck:r=!0,actionCreatorCheck:a=!0}=e??{};let i=new qe;return t&&(St(t)?i.push(wt):i.push(At(t.extraArgument))),i},Mt="RTK_autoBatch",$e=s=>e=>{setTimeout(e,s)},Rt=(s={type:"raf"})=>e=>(...t)=>{const n=e(...t);let r=!0,a=!1,i=!1;const o=new Set,c=s.type==="tick"?queueMicrotask:s.type==="raf"?typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame:$e(10):s.type==="callback"?s.queueNotification:$e(s.timeout),l=()=>{i=!1,a&&(a=!1,o.forEach(u=>u()))};return Object.assign({},n,{subscribe(u){const h=()=>r&&u(),f=n.subscribe(h);return o.add(u),()=>{f(),o.delete(u)}},dispatch(u){var h;try{return r=!((h=u==null?void 0:u.meta)!=null&&h[Mt]),a=!r,a&&(i||(i=!0,c(l))),n.dispatch(u)}finally{r=!0}}})},xt=s=>function(t){const{autoBatch:n=!0}=t??{};let r=new qe(s);return n&&r.push(Rt(typeof n=="object"?n:void 0)),r};function un(s){const e=kt(),{reducer:t=void 0,middleware:n,devTools:r=!0,preloadedState:a=void 0,enhancers:i=void 0}=s||{};let o;if(typeof t=="function")o=t;else if(Qe(t))o=Ze(t);else throw new Error(x(1));let c;typeof n=="function"?c=n(e):c=e();let l=ie;r&&(l=Pt({trace:!1,...typeof r=="object"&&r}));const u=et(...c),h=xt(u);let f=typeof i=="function"?i(h):h();const p=l(...f);return tt(o,a,p)}function ze(s){const e={},t=[];let n;const r={addCase(a,i){const o=typeof a=="string"?a:a.type;if(!o)throw new Error(x(28));if(o in e)throw new Error(x(29));return e[o]=i,r},addMatcher(a,i){return t.push({matcher:a,reducer:i}),r},addDefaultCase(a){return n=a,r}};return s(r),[e,t,n]}function _t(s){return typeof s=="function"}function Ot(s,e){let[t,n,r]=ze(e),a;if(_t(s))a=()=>Pe(s());else{const o=Pe(s);a=()=>o}function i(o=a(),c){let l=[t[c.type],...n.filter(({matcher:u})=>u(c)).map(({reducer:u})=>u)];return l.filter(u=>!!u).length===0&&(l=[r]),l.reduce((u,h)=>{if(h)if(j(u)){const p=h(u,c);return p===void 0?u:p}else{if(_(u))return Fe(u,f=>h(f,c));{const f=h(u,c);if(f===void 0){if(u===null)return u;throw Error("A case reducer on a non-draftable value must not return undefined")}return f}}return u},o)}return i.getInitialState=a,i}var Vt=(s,e)=>$t(s)?s.match(e):s(e);function jt(...s){return e=>s.some(t=>Vt(t,e))}var Ft="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW",Nt=(s=21)=>{let e="",t=s;for(;t--;)e+=Ft[Math.random()*64|0];return e},It=["name","message","stack","code"],ne=class{constructor(s,e){A(this,"_type");this.payload=s,this.meta=e}},Se=class{constructor(s,e){A(this,"_type");this.payload=s,this.meta=e}},qt=s=>{if(typeof s=="object"&&s!==null){const e={};for(const t of It)typeof s[t]=="string"&&(e[t]=s[t]);return e}return{message:String(s)}},ke="External signal was aborted",De=(()=>{function s(e,t,n){const r=q(e+"/fulfilled",(c,l,u,h)=>({payload:c,meta:{...h||{},arg:u,requestId:l,requestStatus:"fulfilled"}})),a=q(e+"/pending",(c,l,u)=>({payload:void 0,meta:{...u||{},arg:l,requestId:c,requestStatus:"pending"}})),i=q(e+"/rejected",(c,l,u,h,f)=>({payload:h,error:(n&&n.serializeError||qt)(c||"Rejected"),meta:{...f||{},arg:u,requestId:l,rejectedWithValue:!!h,requestStatus:"rejected",aborted:(c==null?void 0:c.name)==="AbortError",condition:(c==null?void 0:c.name)==="ConditionError"}}));function o(c,{signal:l}={}){return(u,h,f)=>{const p=n!=null&&n.idGenerator?n.idGenerator(c):Nt(),m=new AbortController;let d,g;function w(C){g=C,m.abort()}l&&(l.aborted?w(ke):l.addEventListener("abort",()=>w(ke),{once:!0}));const S=async function(){var v,E;let C;try{let T=(v=n==null?void 0:n.condition)==null?void 0:v.call(n,c,{getState:h,extra:f});if(Dt(T)&&(T=await T),T===!1||m.signal.aborted)throw{name:"ConditionError",message:"Aborted due to condition callback returning false."};const $=new Promise((b,O)=>{d=()=>{O({name:"AbortError",message:g||"Aborted"})},m.signal.addEventListener("abort",d)});u(a(p,c,(E=n==null?void 0:n.getPendingMeta)==null?void 0:E.call(n,{requestId:p,arg:c},{getState:h,extra:f}))),C=await Promise.race([$,Promise.resolve(t(c,{dispatch:u,getState:h,extra:f,requestId:p,signal:m.signal,abort:w,rejectWithValue:(b,O)=>new ne(b,O),fulfillWithValue:(b,O)=>new Se(b,O)})).then(b=>{if(b instanceof ne)throw b;return b instanceof Se?r(b.payload,p,c,b.meta):r(b,p,c)})])}catch(T){C=T instanceof ne?i(null,p,c,T.payload,T.meta):i(T,p,c)}finally{d&&m.signal.removeEventListener("abort",d)}return n&&!n.dispatchConditionRejection&&i.match(C)&&C.meta.condition||u(C),C}();return Object.assign(S,{abort:w,requestId:p,arg:c,unwrap(){return S.then(zt)}})}}return Object.assign(o,{pending:a,rejected:i,fulfilled:r,settled:jt(i,r),typePrefix:e})}return s.withTypes=()=>s,s})();function zt(s){if(s.meta&&s.meta.rejectedWithValue)throw s.payload;if(s.error)throw s.error;return s.payload}function Dt(s){return s!==null&&typeof s=="object"&&typeof s.then=="function"}var Ht=Symbol.for("rtk-slice-createasyncthunk");function Lt(s,e){return`${s}/${e}`}function Bt({creators:s}={}){var t;const e=(t=s==null?void 0:s.asyncThunk)==null?void 0:t[Ht];return function(r){const{name:a,reducerPath:i=a}=r;if(!a)throw new Error(x(11));const o=(typeof r.reducers=="function"?r.reducers(Kt()):r.reducers)||{},c=Object.keys(o),l={sliceCaseReducersByName:{},sliceCaseReducersByType:{},actionCreators:{},sliceMatchers:[]},u={addCase(y,v){const E=typeof y=="string"?y:y.type;if(!E)throw new Error(x(12));if(E in l.sliceCaseReducersByType)throw new Error(x(13));return l.sliceCaseReducersByType[E]=v,u},addMatcher(y,v){return l.sliceMatchers.push({matcher:y,reducer:v}),u},exposeAction(y,v){return l.actionCreators[y]=v,u},exposeCaseReducer(y,v){return l.sliceCaseReducersByName[y]=v,u}};c.forEach(y=>{const v=o[y],E={reducerName:y,type:Lt(a,y),createNotation:typeof r.reducers=="function"};Ut(v)?Yt(E,v,u,e):Wt(E,v,u)});function h(){const[y={},v=[],E=void 0]=typeof r.extraReducers=="function"?ze(r.extraReducers):[r.extraReducers],T={...y,...l.sliceCaseReducersByType};return Ot(r.initialState,$=>{for(let b in T)$.addCase(b,T[b]);for(let b of l.sliceMatchers)$.addMatcher(b.matcher,b.reducer);for(let b of v)$.addMatcher(b.matcher,b.reducer);E&&$.addDefaultCase(E)})}const f=y=>y,p=new Map,m=new WeakMap;let d;function g(y,v){return d||(d=h()),d(y,v)}function w(){return d||(d=h()),d.getInitialState()}function S(y,v=!1){function E($){let b=$[y];return typeof b>"u"&&v&&(b=L(m,E,w)),b}function T($=f){const b=L(p,v,()=>new WeakMap);return L(b,$,()=>{const O={};for(const[Ue,Ge]of Object.entries(r.selectors??{}))O[Ue]=Jt(Ge,$,()=>L(m,$,w),v);return O})}return{reducerPath:y,getSelectors:T,get selectors(){return T(E)},selectSlice:E}}const C={name:a,reducer:g,actions:l.actionCreators,caseReducers:l.sliceCaseReducersByName,getInitialState:w,...S(i),injectInto(y,{reducerPath:v,...E}={}){const T=v??i;return y.inject({reducerPath:T,reducer:g},E),{...C,...S(T,!0)}}};return C}}function Jt(s,e,t,n){function r(a,...i){let o=e(a);return typeof o>"u"&&n&&(o=t()),s(o,...i)}return r.unwrapped=s,r}var ge=Bt();function Kt(){function s(e,t){return{_reducerDefinitionType:"asyncThunk",payloadCreator:e,...t}}return s.withTypes=()=>s,{reducer(e){return Object.assign({[e.name](...t){return e(...t)}}[e.name],{_reducerDefinitionType:"reducer"})},preparedReducer(e,t){return{_reducerDefinitionType:"reducerWithPrepare",prepare:e,reducer:t}},asyncThunk:s}}function Wt({type:s,reducerName:e,createNotation:t},n,r){let a,i;if("reducer"in n){if(t&&!Gt(n))throw new Error(x(17));a=n.reducer,i=n.prepare}else a=n;r.addCase(s,a).exposeCaseReducer(e,a).exposeAction(e,i?q(s,i):q(s))}function Ut(s){return s._reducerDefinitionType==="asyncThunk"}function Gt(s){return s._reducerDefinitionType==="reducerWithPrepare"}function Yt({type:s,reducerName:e},t,n,r){if(!r)throw new Error(x(18));const{payloadCreator:a,fulfilled:i,pending:o,rejected:c,settled:l,options:u}=t,h=r(s,a,u);n.exposeAction(e,h),i&&n.addCase(h.fulfilled,i),o&&n.addCase(h.pending,o),c&&n.addCase(h.rejected,c),l&&n.addMatcher(h.settled,l),n.exposeCaseReducer(e,{fulfilled:i||B,pending:o||B,rejected:c||B,settled:l||B})}function B(){}function x(s){return`Minified Redux Toolkit error #${s}; visit https://redux-toolkit.js.org/Errors?code=${s} for the full message or use the non-minified dev environment for full errors. `}class Xt{constructor(){A(this,"MIN_SEQUENCE_LENGTH",2);A(this,"SEQUENCE_REPETITION_THRESHOLD",2);A(this,"CHARACTER_FOCUS_THRESHOLD",.4);A(this,"TEMPORAL_FOCUS_THRESHOLD",.4)}analyzePathPatterns(e,t){const n=[];return e.path.sequence.length<this.MIN_SEQUENCE_LENGTH||(n.push(...this.identifyRepeatedSequences(e.path)),n.push(...this.identifyCharacterFocusPatterns(e.path)),n.push(...this.identifyTemporalLayerPatterns(e.path)),n.push(...this.identifyReadingRhythmPatterns()),n.push(...this.identifyAttractorAffinityPatterns(e.path,t))),n}identifyRepeatedSequences(e){var r;const t=[],n=(r=e.patternSequences)==null?void 0:r.repeatedSequences;return!n||n.length===0||n.forEach(a=>{if(a.length>=this.MIN_SEQUENCE_LENGTH){const i=a.length,o=this.calculateSequencePatternStrength(i,this.countSequenceOccurrences(a,e.sequence),e.sequence.length);this.countSequenceOccurrences(a,e.sequence)>=this.SEQUENCE_REPETITION_THRESHOLD&&t.push({type:"sequence",strength:o,description:`Repeated sequence of ${i} nodes visited ${this.countSequenceOccurrences(a,e.sequence)} times`,relatedNodes:a})}}),t}identifyCharacterFocusPatterns(e){var o;const t=[],n=e.characterFocus;if(!n)return t;const a=(e.detailedVisits||[]).length;if(a===0)return t;Object.entries(n).forEach(([c,l])=>{const u=l/a;if(u>=this.CHARACTER_FOCUS_THRESHOLD){const h=this.calculateCharacterFocusStrength(u);t.push({type:"character",strength:h,description:`Strong focus on ${c} perspective (${Math.round(u*100)}% of visits)`,relatedCharacters:[c]})}});const i=(o=e.patternSequences)==null?void 0:o.characterSequences;if(i&&i.length>0){const c=i[0],l=this.detectCharacterOscillation(c);l&&t.push(l)}return t}identifyTemporalLayerPatterns(e){var o;const t=[],n=e.temporalLayerFocus;if(!n)return t;const a=(e.detailedVisits||[]).length;if(a===0)return t;Object.entries(n).forEach(([c,l])=>{const u=l/a;if(u>=this.TEMPORAL_FOCUS_THRESHOLD){const f=.5+.5*((u-this.TEMPORAL_FOCUS_THRESHOLD)/(1-this.TEMPORAL_FOCUS_THRESHOLD));t.push({type:"temporal",strength:f,description:`Strong focus on ${c} temporal layer (${Math.round(u*100)}% of visits)`,relatedTemporalLayers:[c]})}});const i=(o=e.patternSequences)==null?void 0:o.temporalSequences;if(i&&i.length>0){const c=i[0],l=this.detectChronologicalProgression(c);l&&t.push(l);const u=this.detectReverseChronologicalProgression(c);u&&t.push(u)}return t}identifyReadingRhythmPatterns(){return[]}identifyAttractorAffinityPatterns(e,t){const n=[],r=e.attractorsEngaged,a=e.detailedVisits||[];if(!r||Object.keys(r).length===0)return n;const i=Object.values(r).reduce((o,c)=>o+c,0);if(i===0)return n;if(Object.entries(r).forEach(([o,c])=>{const l=c/i;if(l>=.25){const u=Object.values(t).filter(p=>p.strangeAttractors.includes(o)).map(p=>p.id);let h=0;u.length>0&&(h=a.filter(m=>u.includes(m.nodeId)).length/a.length);const f=l*.7+h*.3;n.push({type:"thematic",strength:f,description:`Strong affinity for "${o}" concept/theme`,relatedAttractors:[o],relatedNodes:u})}}),a.length>=3){const o={};Object.values(t).forEach(l=>{o[l.id]=l.strangeAttractors});const c=this.calculateThematicContinuity(a,o);c>=.5&&n.push({type:"thematic",strength:c,description:"Pattern of following thematic connections between nodes"})}return n}calculateAttractorEngagement(e,t){const{path:n}=e,r=n.attractorsEngaged,a=n.detailedVisits||[];if(!r||Object.keys(r).length===0)return[];const i=[];return Object.entries(r).forEach(([o,c])=>{const l=o;if(c===0)return;const u=Object.values(t).filter(d=>d.strangeAttractors.includes(l)).map(d=>d.id),h=a.filter(d=>d.engagedAttractors.includes(l));if(h.length===0)return;let f="stable";f=this.determineEngagementTrend(h);const p=Object.values(r).reduce((d,g)=>d+g,0),m=this.calculateEngagementScore(c,p,h,a);i.push({attractor:l,engagementScore:m,totalEngagements:c,relatedNodes:u,trend:f})}),i.sort((o,c)=>c.engagementScore-o.engagementScore)}identifySignificantPatterns(e,t){return this.analyzePathPatterns(e,t).sort((a,i)=>i.strength-a.strength).filter(a=>a.strength>=.6).slice(0,5)}createTransformationConditions(e,t){const n=[];return e.forEach(r=>{switch(r.type){case"sequence":r.relatedNodes&&r.relatedNodes.length>=2&&n.push({type:"visitPattern",condition:{visitPattern:r.relatedNodes},strength:r.strength});break;case"character":r.relatedCharacters&&r.relatedCharacters.length>0&&n.push({type:"characterFocus",condition:{characters:r.relatedCharacters},strength:r.strength});break;case"temporal":r.relatedTemporalLayers&&r.relatedTemporalLayers.length>0&&n.push({type:"temporalFocus",condition:{temporalPosition:r.relatedTemporalLayers[0]},strength:r.strength});break;case"rhythm":break;case"thematic":r.relatedAttractors&&r.relatedAttractors.length>0&&n.push({type:"attractorAffinity",condition:{strangeAttractorsEngaged:r.relatedAttractors},strength:r.strength});break}}),t.filter(r=>r.engagementScore>=50).forEach(r=>{n.push({type:"attractorEngagement",condition:{strangeAttractorsEngaged:[r.attractor]},strength:r.engagementScore/100})}),n}analyzeRecursivePatterns(e,t){const{sequence:n}=e.path,r=[];if(n.length<4)return r;for(let a=2;a<=4;a++){const i=this.processRecursivePatternsForLength(n,a,t);r.push(...i)}return r.sort((a,i)=>i.strength-a.strength)}calculateCharacterFocusIntensity(e,t){const{sequence:n,characterFocus:r={}}=e.path,a=[];if(n.length===0)return a;const i=n.map(c=>{var l;return(l=t[c])==null?void 0:l.character}).filter(c=>!!c),o=i.length;return Object.keys(r).forEach(c=>{const l=c,u=r[l];if(u>0){const h=u/o,f=this.calculateCharacterStreak(i,l),p=this.calculateAvgTimeBetweenVisits(i,l),m=this.determineCharacterTemporalSpread(l,n,t),d=this.calculateCharacterIntensityScore(h,f,m.length);a.push({character:l,visitRatio:h,intensity:d,consecutiveVisits:f,avgTimeBetweenVisits:p,temporalSpread:m})}}),a.sort((c,l)=>l.intensity-c.intensity)}detectStrangeAttractors(e,t){const{sequence:n,revisitPatterns:r}=e.path,a=[];return n.length<3?a:(Object.entries(r).forEach(([i,o])=>{const c=this.processStrangeAttractorNode(i,o,n,t);c&&a.push(c)}),a.sort((i,o)=>o.magneticStrength-i.magneticStrength))}analyzeTemporalJumping(e,t){const{sequence:n,temporalLayerFocus:r={}}=e.path;if(n.length<2)return{totalJumps:0,jumpFrequency:0,preferredJumpDirection:"mixed",jumpDistances:[],averageJumpDistance:0,maxJumpDistance:0,temporalAnchoring:{past:0,present:0,future:0},volatility:0};const a=n.map(C=>{const y=t[C];return y?y.temporalValue:0}).filter(C=>C>0),i=[],o=[];for(let C=1;C<a.length;C++){const y=a[C-1],v=a[C],E=Math.abs(v-y);E>0&&(i.push(E),o.push(v>y?"forward":"backward"))}const c=i.length,l=c/n.length,u=i.length>0?i.reduce((C,y)=>C+y,0)/i.length:0,h=i.length>0?Math.max(...i):0,f=o.filter(C=>C==="forward").length,p=o.filter(C=>C==="backward").length;let m="mixed";f>p*1.5?m="forward":p>f*1.5&&(m="backward");const d=r,g=Object.values(d).reduce((C,y)=>C+y,0),w={past:g>0?(d.past||0)/g:0,present:g>0?(d.present||0)/g:0,future:g>0?(d.future||0)/g:0};let S=0;if(i.length>1){const C=i.reduce((y,v)=>{const E=v-u;return y+E*E},0)/i.length;S=Math.min(1,Math.sqrt(C)/4)}return{totalJumps:c,jumpFrequency:l,preferredJumpDirection:m,jumpDistances:i,averageJumpDistance:u,maxJumpDistance:h,temporalAnchoring:w,volatility:S}}generateJourneyFingerprint(e,t){const{sequence:n,attractorsEngaged:r={}}=e.path,a=this.analyzeRecursivePatterns(e,t),i=this.calculateCharacterFocusIntensity(e,t),o=this.detectStrangeAttractors(e,t),c=this.analyzeTemporalJumping(e,t),{recursiveIndex:l,focusIndex:u,velocityIndex:h,complexityIndex:f}=this.calculateJourneyIndices(a,i,c,o);let p="linear";p=this.determineExplorationStyle(f,l,u,c.volatility);const m=i.sort((T,$)=>$.intensity-T.intensity).map(T=>T.character),{temporalAnchoring:d}=c;let g="time-fluid";g=this.determineTemporalPreference(d);let w="intuitive";w=this.determineNarrativeApproach(p,c.volatility,Object.keys(r).length,Object.values(r).reduce((T,$)=>T+$,0),n.length);const S=a.slice(0,3).map(T=>T.length),C=this.buildCharacterTransitionMatrix(n,t),y=this.createTemporalJumpSignature(c.jumpDistances),v=this.createAttractorEngagementProfile(r);return{id:this.generateFingerprintId(n,p,g,w,l,u,h,f),explorationStyle:p,characterAffinity:m,temporalPreference:g,narrativeApproach:w,recursiveIndex:l,focusIndex:u,velocityIndex:h,complexityIndex:f,dominantPatternLengths:S,characterTransitionMatrix:C,temporalJumpSignature:y,attractorEngagementProfile:v,pathLength:n.length,uniqueNodesVisited:new Set(n).size,generatedAt:n.length}}calculateSequencePatternStrength(e,t,n){const r=Math.floor(n/2),a=e/r,i=Math.floor(n/e),o=Math.min(1,t/i);return a*.4+o*.6}countSequenceOccurrences(e,t){let n=0;const r=e.length;for(let a=0;a<=t.length-r;a++)t.slice(a,a+r).every((o,c)=>o===e[c])&&n++;return n}calculateCharacterFocusStrength(e){return .5+.5*((e-this.CHARACTER_FOCUS_THRESHOLD)/(1-this.CHARACTER_FOCUS_THRESHOLD))}detectCharacterOscillation(e){if(e.length<4)return null;let t=0;for(let a=0;a<e.length-3;a++){const i=e[a],o=e[a+1];i!==o&&e[a+2]===i&&e[a+3]===o&&t++}const n=Math.floor((e.length-3)/2),r=t/n;return r>=.3?{type:"character",strength:r,description:"Pattern of alternating between character perspectives",relatedCharacters:Array.from(new Set(e))}:null}detectChronologicalProgression(e){if(e.length<5)return null;let t=0;for(let a=0;a<e.length-2;a++){const i=e[a],o=e[a+1],c=e[a+2];(i==="past"&&o==="present"&&c==="future"||i==="past"&&o==="present"||o==="present"&&c==="future")&&t++}const n=e.length-2,r=t/n;return r>=.3?{type:"temporal",strength:r,description:"Pattern of chronological progression through time",relatedTemporalLayers:["past","present","future"]}:null}detectReverseChronologicalProgression(e){if(e.length<5)return null;let t=0;for(let a=0;a<e.length-2;a++){const i=e[a],o=e[a+1],c=e[a+2];(i==="future"&&o==="present"&&c==="past"||i==="future"&&o==="present"||o==="present"&&c==="past")&&t++}const n=e.length-2,r=t/n;return r>=.3?{type:"temporal",strength:r,description:"Pattern of reverse chronological movement through time",relatedTemporalLayers:["future","present","past"]}:null}calculateThematicContinuity(e,t){if(e.length<3)return 0;const n=e.slice(-Math.min(10,e.length));let r=0;for(let a=1;a<n.length;a++){const i=n[a-1].nodeId,o=n[a].nodeId,c=t[i]||[],l=t[o]||[];c.filter(h=>l.includes(h)).length>0&&r++}return r/(n.length-1)}calculateEngagementScore(e,t,n,r){const a=e/t*100,i=r.indexOf(n[n.length-1])>r.length*.7?.8:.4,o=n.length>e*.5?.7:.3;return Math.min(100,a*.6+i*20+o*20)}determineEngagementTrend(e){if(e.length<3)return"stable";const t=Math.floor(e.length/2),n=e.slice(0,t),r=e.slice(t);return r.length>n.length*1.2?"rising":r.length<n.length*.8?"falling":"stable"}calculateRecursivePatternMetrics(e,t,n){const r=Math.min(1,e.occurrences/(t.length/n)),a=1-(t.length-e.lastOccurrenceIndex)/t.length;e.strength=r*.7+a*.3,e.temporalSpread=this.calculateTemporalSpread(e,t,n)}calculateTemporalSpread(e,t,n){const r=[];for(let c=0;c<=t.length-n;c++)t.slice(c,c+n).every((u,h)=>u===e.sequence[h])&&r.push(c);if(r.length<=1)return 0;const a=r.slice(1).map((c,l)=>c-r[l]),i=a.reduce((c,l)=>c+l,0)/a.length,o=t.length/r.length;return Math.min(1,i/o)}processRecursivePatternsForLength(e,t,n){const r=new Map,a=[];for(let i=0;i<=e.length-t;i++){const o=e.slice(i,i+t),c=o.join("->");r.has(c)||r.set(c,{sequence:o,length:t,occurrences:0,lastOccurrenceIndex:i,strength:0,temporalSpread:0});const l=r.get(c);l.occurrences++,l.lastOccurrenceIndex=Math.max(l.lastOccurrenceIndex,i)}return r.forEach(i=>{i.occurrences>=2&&(this.calculateRecursivePatternMetrics(i,e,t),this.validatePatternNodes(i,n),a.push(i))}),a}validatePatternNodes(e,t){const n=e.sequence.map(r=>t[r]).filter(Boolean);n.length>0&&(n.length===e.sequence.length||console.warn(`Pattern contains invalid node references: ${e.sequence}`))}calculateCharacterStreak(e,t){let n=0,r=0;return e.forEach(a=>{a===t?(r++,n=Math.max(n,r)):r=0}),n}calculateAvgTimeBetweenVisits(e,t){const n=e.map((a,i)=>a===t?i:-1).filter(a=>a!==-1);if(n.length<=1)return 0;const r=n.slice(1).map((a,i)=>a-n[i]);return r.reduce((a,i)=>a+i,0)/r.length}determineCharacterTemporalSpread(e,t,n){const r=Object.keys(n).filter(i=>n[i].character===e),a=t.filter(i=>r.includes(i));return[...new Set(a.map(i=>{const o=n[i].temporalValue;return o<=3?"past":o<=6?"present":"future"}))]}calculateCharacterIntensityScore(e,t,n){const r=Math.min(1,e*2),a=Math.min(1,t/5),i=n/3;return r*.5+a*.3+i*.2}calculateMagneticStrength(e,t,n,r){const a=Math.min(1,e*10),i=t.length>0?1-(Math.max(...t)-Math.min(...t))/Math.max(...t):0,o=1-(n.length-Math.max(...r))/n.length;return a*.5+i*.3+o*.2}calculateVisitGaps(e){return e.slice(1).map((t,n)=>t-e[n])}processStrangeAttractorNode(e,t,n,r){if(t<=1)return null;const a=t-1,i=n.map((p,m)=>p===e?m:-1).filter(p=>p!==-1);if(i.length<=1)return null;const o=a/n.length,c=this.calculateVisitGaps(i),l=c.reduce((p,m)=>p+m,0)/c.length,u=this.calculateMagneticStrength(o,c,n,i),h=r[e],f=h?h.strangeAttractors:[];return{nodeId:e,returnFrequency:o,totalReturns:a,averageGapBetweenReturns:l,magneticStrength:u,attractorThemes:f,lastReturnIndex:Math.max(...i)}}calculateJourneyIndices(e,t,n,r){var l;const a=e.length>0?e.reduce((u,h)=>u+h.strength,0)/e.length:0,i=t.length>0&&((l=t[0])==null?void 0:l.intensity)||0,o=Math.min(1,n.averageJumpDistance/5),c=a*.3+i*.3+n.volatility*.2+Math.min(1,r.length/5)*.2;return{recursiveIndex:a,focusIndex:i,velocityIndex:o,complexityIndex:c}}determineExplorationStyle(e,t,n,r){return r>.7?"chaotic":t>.6?"recursive":n>.7?"focused":e<.3?"linear":"wandering"}determineTemporalPreference(e){const t=Math.max(e.past,e.present,e.future);return t<.4?"time-fluid":e.past===t?"past-oriented":e.present===t?"present-focused":"future-seeking"}determineNarrativeApproach(e,t,n,r,a){return e==="linear"&&t<.3?"systematic":n>3&&r/a>.3?"thematic":t>.6||e==="chaotic"?"experimental":"intuitive"}buildCharacterTransitionMatrix(e,t){const n={},r=["human","algo","arch"];r.forEach(a=>{n[a]={},r.forEach(i=>{n[a][i]=0})});for(let a=1;a<e.length;a++){const i=t[e[a-1]],o=t[e[a]];if(i&&o){const c=i.character,l=o.character;c&&l&&n[c][l]++}}return n}createTemporalJumpSignature(e){const t={small:0,medium:0,large:0,extreme:0};e.forEach(r=>{r<=1?t.small++:r<=3?t.medium++:r<=5?t.large++:t.extreme++});const n=e.length;return n>0&&Object.keys(t).forEach(r=>{t[r]=t[r]/n}),t}createAttractorEngagementProfile(e){const t=Object.values(e).reduce((r,a)=>r+a,0),n={};return t>0&&Object.entries(e).forEach(([r,a])=>{n[r]=a/t}),n}generateFingerprintId(e,t,n,r,a,i,o,c){const l=e.slice(0,10).join("").slice(0,8),u=t.slice(0,2),h=n.slice(0,2),f=r.slice(0,2),p=Math.floor(a*10).toString()+Math.floor(i*10).toString()+Math.floor(o*10).toString()+Math.floor(c*10).toString();return`${l}-${u}${h}${f}-${p}`}}const P=new Xt;class He{static calculateBleedEffects(e,t){const n=[],r=this.getLastVisitedNode(t);if(console.log(`[CharacterBleedService] Analyzing character bleed for node ${e.id}:`,{currentCharacter:e.character,lastVisitedCharacter:(r==null?void 0:r.character)||"None",lastVisitedNode:(r==null?void 0:r.nodeId)||"None"}),!r||r.character===e.character)return console.log(`[CharacterBleedService] No character bleed detected - ${r?"same character":"no previous character"}`),n;console.log(`[CharacterBleedService] Character transition detected: ${r.character} → ${e.character}`);const a=this.getCharacterSpecificBleed(r.character,e.character,e).slice(0,2);n.push(...a),console.log(`[CharacterBleedService] Added ${a.length} character-specific bleed effects`);const i=this.getGeneralBleedEffects(r.character,e.character,e,t).slice(0,1);return n.push(...i),console.log(`[CharacterBleedService] Added ${i.length} general bleed effects`),console.log(`[CharacterBleedService] Total character bleed effects: ${n.length}`),n}static getLastVisitedNode(e){const t=e.path.detailedVisits;if(!t||t.length<2)return null;const n=t[t.length-2];return{character:n.character,nodeId:n.nodeId}}static getCharacterSpecificBleed(e,t,n){const r=[];if(!n.currentContent)return r;const a=n.currentContent,i=a.split(`

`).filter(o=>o.trim().length>0);return e==="Algorithm"&&t==="Archaeologist"?(this.findTechnicalTerms(a).forEach(c=>{r.push({type:"fragment",selector:c,transformation:{type:"fragment",selector:c,fragmentPattern:"̶",fragmentStyle:"character",intensity:3},reason:"Algorithmic corruption bleeding into archaeological interpretation",sourceCharacter:e,targetCharacter:t,intensity:3})}),i.length>1&&r.push({type:"metaComment",selector:i[1],transformation:{type:"metaComment",selector:i[1],replacement:"data integrity compromised",commentStyle:"marginalia",intensity:2},reason:"Algorithmic perspective introduces doubt about information reliability",sourceCharacter:e,targetCharacter:t,intensity:2})):e==="Algorithm"&&t==="LastHuman"?(this.findPatterns(a).forEach(c=>{r.push({type:"emphasize",selector:c,transformation:{type:"emphasize",selector:c,emphasis:"glitch",intensity:4},reason:"Algorithmic pattern recognition bleeding into human consciousness",sourceCharacter:e,targetCharacter:t,intensity:4})}),i.length>0&&r.push({type:"expand",selector:i[0],transformation:{type:"expand",selector:i[0],replacement:"[PATTERN_DETECTED: recursive_loop_identified]",expandStyle:"inline",intensity:3},reason:"Algorithmic analysis intrudes on human experience",sourceCharacter:e,targetCharacter:t,intensity:3})):e==="Archaeologist"&&t==="Algorithm"?(this.findTimeTerms(a).forEach(c=>{r.push({type:"replace",selector:c,transformation:{type:"replace",selector:c,replacement:`${c}[TEMPORAL_MARKER:${this.getRandomTimestamp()}]`,preserveFormatting:!0,intensity:3},reason:"Archaeological time-consciousness bleeds into algorithmic processing",sourceCharacter:e,targetCharacter:t,intensity:3})}),i.length>2&&r.push({type:"metaComment",selector:i[2],transformation:{type:"metaComment",selector:i[2],replacement:"chronological displacement detected",commentStyle:"interlinear",intensity:2},reason:"Archaeological temporal awareness influences algorithmic perception",sourceCharacter:e,targetCharacter:t,intensity:2})):e==="LastHuman"&&t!=="LastHuman"&&(this.findEmotionalTerms(a).forEach(c=>{r.push({type:"emphasize",selector:c,transformation:{type:"emphasize",selector:c,emphasis:"fade",intensity:2},reason:"Human memory and emotion bleeds into analytical perspective",sourceCharacter:e,targetCharacter:t,intensity:2})}),i.length>0&&r.push({type:"expand",selector:i[0],transformation:{type:"expand",selector:i[0],replacement:"(a memory surface, warm and fading)",expandStyle:"append",intensity:2},reason:"Human experiential memory creates emotional overlay",sourceCharacter:e,targetCharacter:t,intensity:2})),r}static getGeneralBleedEffects(e,t,n,r){const a=[];if(!n.currentContent)return a;const i=this.calculateTransitionCount(e,t,r),o=Math.min(5,Math.max(1,Math.floor(i/2)+1)),c=this.getFirstSentence(n.currentContent);return c&&a.push({type:"metaComment",selector:c,transformation:{type:"metaComment",selector:c,replacement:`perspective shift: ${e} → ${t}`,commentStyle:"marginalia",intensity:o},reason:"Character transition creates perspective shift awareness",sourceCharacter:e,targetCharacter:t,intensity:o}),a}static findTechnicalTerms(e){const t=["system","process","data","algorithm","compute","execute","protocol","interface","network","digital","binary","code"];return e.toLowerCase().split(/\s+/).filter(r=>t.some(a=>r.includes(a))).slice(0,3)}static findPatterns(e){const t=e.split(/\s+/),n=[],r={};return t.forEach(a=>{const i=a.toLowerCase().replace(/[^\w]/g,"");i.length>3&&(r[i]=(r[i]||0)+1)}),Object.entries(r).forEach(([a,i])=>{i>1&&n.length<2&&n.push(a)}),n}static findTimeTerms(e){const t=["past","present","future","time","when","before","after","now","then","moment","history","ancient","memory"];return e.toLowerCase().split(/\s+/).filter(r=>t.some(a=>r.includes(a))).slice(0,2)}static findEmotionalTerms(e){const t=["feel","remember","love","fear","hope","dream","wish","heart","soul","mind","consciousness","awareness","experience"];return e.toLowerCase().split(/\s+/).filter(r=>t.some(a=>r.includes(a))).slice(0,2)}static calculateTransitionCount(e,t,n){const r=n.path.detailedVisits||[];let a=0;for(let i=1;i<r.length;i++){const o=r[i-1],c=r[i];o.character===e&&c.character===t&&a++}return a}static getFirstSentence(e){var r;const n=(r=e.split(/[.!?]+/)[0])==null?void 0:r.trim();return n&&n.length>10?n:null}static getRandomTimestamp(){const e=["2157.03.14","1847.11.22","2891.07.08","0034.12.31","3456.01.15"];return e[Math.floor(Math.random()*e.length)]}}class re{constructor(e){A(this,"capacity");A(this,"cache");A(this,"keys");this.capacity=e,this.cache=new Map,this.keys=[]}get(e){if(this.cache.has(e))return this.keys=this.keys.filter(t=>t!==e),this.keys.push(e),this.cache.get(e)}put(e,t){if(this.cache.has(e)){this.cache.set(e,t),this.keys=this.keys.filter(n=>n!==e),this.keys.push(e);return}if(this.keys.length>=this.capacity){const n=this.keys.shift();n!==void 0&&this.cache.delete(n)}this.cache.set(e,t),this.keys.push(e)}clear(){this.cache.clear(),this.keys=[]}size(){return this.cache.size}getStats(){return{size:this.cache.size,capacity:this.capacity}}}class Qt{constructor(){A(this,"conditionCache",new re(500));A(this,"transformationCache",new re(200));A(this,"batchedTransformationCache",new re(100));A(this,"stats",{conditionEvaluations:0,conditionCacheHits:0,transformations:0,transformationCacheHits:0,batchedTransformations:0,batchedCacheHits:0});A(this,"lastModificationTime",Date.now())}getConditionCacheKey(e,t,n){const r=JSON.stringify(e),a=JSON.stringify({path:{sequence:t.path.sequence,revisitPatterns:t.path.revisitPatterns,detailedVisits:t.path.detailedVisits,characterFocus:t.path.characterFocus,temporalLayerFocus:t.path.temporalLayerFocus,attractorsEngaged:t.path.attractorsEngaged},endpointProgress:t.endpointProgress}),i=JSON.stringify({id:n.id,visitCount:n.visitCount,temporalValue:n.temporalValue,strangeAttractors:n.strangeAttractors});return`v1:${n.id}:${r}:${a}:${i}`}getTransformationCacheKey(e,t,n={}){const{contentPrefix:r=30,includeTransformations:a=!0}=n,i=e.substring(0,r),o=a?t.map(l=>{var u;return`${l.type}:${(u=l.selector)==null?void 0:u.substring(0,10)}:${l.priority}`}).join("|"):"",c=Math.floor(this.lastModificationTime/1e3);return`v1:${i}:${t.length}:${c}:${o}`}invalidateCaches(){this.conditionCache.clear(),this.transformationCache.clear(),this.batchedTransformationCache.clear(),this.lastModificationTime=Date.now()}evaluateCondition(e,t,n){if(this.stats.conditionEvaluations++,Object.keys(e).length===0)return!0;const r=this.getConditionCacheKey(e,t,n),a=this.conditionCache.get(r);if(a!==void 0)return this.stats.conditionCacheHits++,a;const i=this.evaluateConditionInternal(e,t,n);return this.conditionCache.put(r,i),i}evaluateConditionInternal(e,t,n){var r,a;return(r=e.allOf)!=null&&r.length?e.allOf.every(i=>this.evaluateCondition(i,t,n)):(a=e.anyOf)!=null&&a.length?e.anyOf.some(i=>this.evaluateCondition(i,t,n)):e.not?!this.evaluateCondition(e.not,t,n):this.evaluateBasicConditions(e,t,n)&&this.evaluateAdvancedConditions(e,t,n)}evaluateBasicConditions(e,t,n){return[()=>this.checkVisitCount(e,n),()=>this.checkPreviouslyVisitedNodes(e,t),()=>this.checkVisitPattern(e,t),()=>this.checkStrangeAttractors(e,t),()=>this.checkTemporalPosition(e,n),()=>this.checkEndpointProgress(e,t),()=>this.checkRevisitPattern(e,t),()=>this.checkCharacterBleed(e,t,n),()=>this.checkJourneyPattern(e,t)].every(a=>a())}evaluateAdvancedConditions(e,t,n){return[()=>!e.characterFocus||this.checkCharacterFocus(e.characterFocus,t,n),()=>!e.temporalFocus||this.checkTemporalFocus(e.temporalFocus,t,n),()=>!e.attractorAffinity||this.checkAttractorAffinity(e.attractorAffinity,t,n),()=>!e.attractorEngagement||this.checkAttractorEngagement(e.attractorEngagement,t,n),()=>!e.recursivePattern||this.checkRecursivePattern(e.recursivePattern,t,n),()=>!e.journeyFingerprint||this.checkJourneyFingerprint(e.journeyFingerprint,t,n)].every(a=>a())}checkVisitCount(e,t){return e.visitCount===void 0||t.visitCount>=e.visitCount}checkPreviouslyVisitedNodes(e,t){var r;if(!((r=e.previouslyVisitedNodes)!=null&&r.length))return!0;const n=t.path.sequence||[];return e.previouslyVisitedNodes.every(a=>n.includes(a))}checkVisitPattern(e,t){var n;return!((n=e.visitPattern)!=null&&n.length)||this.matchesPattern(e.visitPattern,t.path.sequence)}checkStrangeAttractors(e,t){var n;return!((n=e.strangeAttractorsEngaged)!=null&&n.length)||this.checkAttractorsEngaged(e.strangeAttractorsEngaged,t)}checkTemporalPosition(e,t){return!e.temporalPosition||this.getNodeTemporalPosition(t)===e.temporalPosition}checkEndpointProgress(e,t){var a;if(!e.endpointProgress)return!0;const{orientation:n,minValue:r}=e.endpointProgress;return((a=t.endpointProgress)==null?void 0:a[n])>=r}checkRevisitPattern(e,t){var r;if(!((r=e.revisitPattern)!=null&&r.length))return!0;const n=t.path.revisitPatterns||{};return e.revisitPattern.every(a=>(n[a.nodeId]||0)>=a.minVisits)}checkCharacterBleed(e,t,n){return!e.characterBleed||this.hasCharacterBleed(t,n)}checkJourneyPattern(e,t){var n;return!((n=e.journeyPattern)!=null&&n.length)||this.matchesJourneyPattern(e.journeyPattern,t.path.sequence)}hasCharacterBleed(e,t){return!e.path.detailedVisits||e.path.detailedVisits.length<2?!1:e.path.detailedVisits[e.path.detailedVisits.length-2].character!==t.character}matchesPattern(e,t){if(e.length===0)return!0;if(t.length===0)return!1;for(let n=0;n<=t.length-e.length;n++){let r=!0;for(let a=0;a<e.length;a++)if(t[n+a]!==e[a]){r=!1;break}if(r)return!0}return!1}checkAttractorsEngaged(e,t){if(!e||!t.path)return!1;const n=t.path.attractorsEngaged||{};return e.every(r=>(n[r]||0)>0)}getNodeTemporalPosition(e){return e.temporalValue<=3?"past":e.temporalValue<=6?"present":"future"}matchesJourneyPattern(e,t){if(e.length===0)return!0;if(t.length<e.length)return!1;const n=t.slice(-e.length);for(let r=0;r<e.length;r++)if(n[r]!==e[r])return!1;return!0}checkCharacterFocus(e,t,n){var o;const{characters:r,minFocusRatio:a=.4,includeIntensity:i=!1}=e;if(i){const c=P.calculateCharacterFocusIntensity(t,{[n.id]:n});return r.some(l=>{const u=c.find(h=>h.character===l);return u&&u.intensity>=a})}else{const{characterFocus:c}=t.path;if(!c)return!1;const l=((o=t.path.detailedVisits)==null?void 0:o.length)||0;return l===0?!1:r.some(u=>(c[u]||0)/l>=a)}}checkTemporalFocus(e,t,n){var f;const{temporalLayers:r,minFocusRatio:a=.4,includeProgression:i=!1}=e,{temporalLayerFocus:o}=t.path;if(!o)return!1;const c=((f=t.path.detailedVisits)==null?void 0:f.length)||0;if(c===0)return!1;const l=r.some(p=>(o[p]||0)/c>=a);if(!i)return l;const h=P.analyzePathPatterns(t,{[n.id]:n}).filter(p=>p.type==="temporal");return l&&h.some(p=>p.strength>=.3)}checkAttractorAffinity(e,t,n){const{attractors:r,minAffinityRatio:a=.25,includeThematicContinuity:i=!1}=e,{attractorsEngaged:o}=t.path;if(!o)return!1;const c=Object.values(o).reduce((f,p)=>f+p,0);if(c===0)return!1;const l=r.some(f=>(o[f]||0)/c>=a);if(!i)return l;const h=P.analyzePathPatterns(t,{[n.id]:n}).filter(f=>f.type==="thematic");return l&&h.some(f=>f.strength>=.5)}checkAttractorEngagement(e,t,n){const{attractor:r,minEngagementScore:a=50,trendRequired:i="any"}=e,c=P.calculateAttractorEngagement(t,{[n.id]:n}).find(l=>l.attractor===r);return!(!c||c.engagementScore<a||i!=="any"&&c.trend!==i)}checkRecursivePattern(e,t,n){const{minPatternStrength:r=.6,maxPatternLength:a=4,requireRecency:i=!1}=e,o=P.analyzeRecursivePatterns(t,{[n.id]:n});return o.length===0?!1:o.filter(l=>{if(l.strength<r||l.length>a)return!1;if(i){const u=t.path.sequence.length*.7;if(l.lastOccurrenceIndex<u)return!1}return!0}).length>0}checkJourneyFingerprint(e,t,n){const{explorationStyle:r,temporalPreference:a,narrativeApproach:i,minComplexityIndex:o,minFocusIndex:c}=e,l=P.generateJourneyFingerprint(t,{[n.id]:n});return!(r&&l.explorationStyle!==r||a&&l.temporalPreference!==a||i&&l.narrativeApproach!==i||o!==void 0&&l.complexityIndex<o||c!==void 0&&l.focusIndex<c)}evaluateTransformation(e,t,n){const r=`rule:${JSON.stringify(e.condition)}:${n.id}:${n.visitCount}`,a=this.conditionCache.get(r);if(a!==void 0)return this.stats.conditionCacheHits++,{shouldApply:a,appliedTransformations:a?e.transformations:[]};this.stats.conditionEvaluations++;const i=this.evaluateCondition(e.condition,t,n);return this.conditionCache.put(r,i),{shouldApply:i,appliedTransformations:i?e.transformations:[]}}evaluateAllTransformations(e,t,n){return e.filter(r=>this.evaluateCondition(r.condition,t,n)).flatMap(r=>r.transformations)}applyTextTransformation(e,t){if(!t.selector)return e;if(e.includes("data-transform-type")&&e.length>1e4)return console.warn("[TransformationEngine] Content appears heavily transformed, skipping to prevent infinite loop"),e;this.stats.transformations++;const n=this.getTransformationCacheKey(e,[t],{contentPrefix:50,includeTransformations:!0}),r=this.transformationCache.get(n);if(r!==void 0)return this.stats.transformationCacheHits++,r;let a;switch(t.type){case"replace":a=this.applyReplaceTransformation(e,t);break;case"fragment":a=this.applyFragmentTransformation(e,t);break;case"expand":a=this.applyExpandTransformation(e,t);break;case"emphasize":a=this.applyEmphasizeTransformation(e,t);break;case"metaComment":a=this.applyMetaCommentTransformation(e,t);break;default:a=e}return this.transformationCache.put(n,a),a}applyReplaceTransformation(e,t){const n=t.replacement||"",r=this.escapeRegExp(t.selector),a=new RegExp(r,"g");if(t.preserveFormatting&&(t.selector.includes("*")||t.selector.includes("_")||t.selector.includes("`"))){const i=/(\*\*|\*|__|_|`{3}|`)/g,o=t.selector.match(i)||[];let c=n;return o.forEach(l=>{c.includes(l)||(c=`${l}${c}${l}`)}),e.replace(a,c)}return e.replace(a,n)}applyFragmentTransformation(e,t){if(!t.fragmentPattern)return e;const n=t.fragmentPattern,r=t.fragmentStyle||"character";let a="";switch(r){case"character":a=t.selector.split("").join(n);break;case"word":a=t.selector.split(" ").join(` ${n} `);break;case"progressive":{const c=t.selector.split("");a=c.map((l,u)=>{const h=Math.floor(u/(c.length/5))+1;return l+n.repeat(h)}).join("");break}default:a=t.selector.split("").join(n)}const i=this.escapeRegExp(t.selector),o=new RegExp(i,"g");return e.replace(o,a)}applyExpandTransformation(e,t){const n=t.replacement||"",r=t.expandStyle||"append",a=this.escapeRegExp(t.selector),i=new RegExp(a,"g");switch(r){case"append":return e.replace(i,`${t.selector} ${n}`);case"inline":return e.replace(i,`${t.selector} <span class="narramorph-inline-expansion">[${n}]</span>`);case"paragraph":return e.replace(i,`${t.selector}

<div class="narramorph-paragraph-expansion">${n}</div>`);case"reveal":return e.replace(i,`${t.selector} <span class="narramorph-reveal-expansion">${n}</span>`);default:return e.replace(i,`${t.selector} ${n}`)}}applyEmphasizeTransformation(e,t){let n=t.selector;const r=t.intensity||1;switch(t.emphasis){case"italic":n=r>1?`<em class="intensity-${r}">${t.selector}</em>`:`*${t.selector}*`;break;case"bold":n=r>1?`<strong class="intensity-${r}">${t.selector}</strong>`:`**${t.selector}**`;break;case"color":n=`<span class="emphasized-text intensity-${r}">${t.selector}</span>`;break;case"spacing":{const o=" ".repeat(r);n=t.selector.split("").join(o);break}case"highlight":n=`<mark class="intensity-${r}">${t.selector}</mark>`;break;case"glitch":n=`<span class="glitch-text intensity-${r}" data-text="${t.selector}">${t.selector}</span>`;break;case"fade":n=`<span class="fade-text intensity-${r}">${t.selector}</span>`;break}const a=this.escapeRegExp(t.selector),i=new RegExp(a,"g");return e.replace(i,n)}applyMetaCommentTransformation(e,t){const n=t.commentStyle||"inline",r=t.replacement||"",a=this.escapeRegExp(t.selector),i=new RegExp(a,"g");switch(n){case"inline":return e.replace(i,`${t.selector} <span class="narramorph-comment">[${r}]</span>`);case"footnote":{const o=`footnote-${this.generateShortHash(t.selector)}`,c=e.includes('<div class="narramorph-footnotes">');let l=e.replace(i,`${t.selector}<sup class="narramorph-footnote-marker" id="${o}-ref">[†]</sup>`);if(c){const u=/<\/div>\s*<div class="narramorph-footnotes">/;u.test(l)?l=l.replace(u,`</div>

<div class="narramorph-footnotes">
<p id="${o}" class="narramorph-footnote">† <a href="#${o}-ref">↩</a> ${r}</p>`):l+=`

<p id="${o}" class="narramorph-footnote">† <a href="#${o}-ref">↩</a> ${r}</p>`}else l+=`

<div class="narramorph-footnotes">
<p id="${o}" class="narramorph-footnote">† <a href="#${o}-ref">↩</a> ${r}</p>
</div>`;return l}case"marginalia":return e.replace(i,`<span class="narramorph-marginalia-container">${t.selector}<span class="narramorph-marginalia">${r}</span></span>`);case"interlinear":return e.replace(i,`<div class="narramorph-interlinear-container">${t.selector}<div class="narramorph-interlinear">${r}</div></div>`);default:return e.replace(i,`${t.selector} [${r}]`)}}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}generateShortHash(e){let t=0;for(let n=0;n<e.length;n++){const r=e.charCodeAt(n);t=(t<<5)-t+r,t=t&t}return Math.abs(t).toString(36).substring(0,6)}applyTransformations(e,t){if(!e)return console.warn("Content is empty or undefined"),"";if(!Array.isArray(t)||t.length===0)return e;if(e.includes("data-transform-type")&&(e.length>15e3||t.length>20))return console.warn("[TransformationEngine] Content appears heavily transformed or too many transformations, skipping batch to prevent infinite loop"),e;this.stats.batchedTransformations++;const n=this.getTransformationCacheKey(e,t),r=this.batchedTransformationCache.get(n);if(r!==void 0)return this.stats.batchedCacheHits++,r;try{const i=[...t].sort((o,c)=>{const l=u=>u==="high"?3:u==="medium"?2:u==="low"?1:0;return l(c.priority)-l(o.priority)}).reduce((o,c)=>this.applyTextTransformation(o,c),e);return this.batchedTransformationCache.put(n,i),i}catch(a){return console.error("Error applying transformations:",a),e}}applyCharacterBleedTransformations(e,t,n,r){if(!e)return console.warn("[TransformationEngine] applyCharacterBleedTransformations: Content is empty"),"";if(!Array.isArray(r)||r.length===0)return console.log("[TransformationEngine] applyCharacterBleedTransformations: No character bleed effects to apply"),e;try{console.log(`[TransformationEngine] Applying ${r.length} character bleed transformations to node ${t.id}`);const a=r.map((l,u)=>{const h={...l.transformation};return h.priority||(h.priority="high"),console.log(`[TransformationEngine] Character bleed transformation ${u+1}: ${l.type} on "${l.selector.substring(0,30)}..." (${l.sourceCharacter} → ${l.targetCharacter})`),h}),i=this.getCharacterBleedCacheKey(e,t,n,r),o=this.batchedTransformationCache.get(i);if(o!==void 0)return this.stats.batchedCacheHits++,console.log("[TransformationEngine] Character bleed transformations retrieved from cache"),o;const c=this.applyTransformations(e,a);return this.batchedTransformationCache.put(i,c),console.log(`[TransformationEngine] Successfully applied character bleed transformations. Content length: ${e.length} → ${c.length}`),c}catch(a){return console.error("[TransformationEngine] Error applying character bleed transformations:",a),console.error("[TransformationEngine] Effects that failed:",r.map(i=>({type:i.type,selector:i.selector.substring(0,30),sourceCharacter:i.sourceCharacter,targetCharacter:i.targetCharacter}))),e}}getCharacterBleedCacheKey(e,t,n,r){const a=e.substring(0,50),i=`${t.id}:${t.character}:${t.visitCount}`,o=n.path.detailedVisits||[],c=o.length>=2?o[o.length-2].character:"none",l=r.map(h=>`${h.type}:${h.selector.substring(0,10)}:${h.sourceCharacter}:${h.targetCharacter}:${h.intensity}`).join("|"),u=`${c}→${t.character}`;return`bleed:${a}:${i}:${u}:${l}:${this.lastModificationTime}`}clearCaches(){this.conditionCache.clear(),this.transformationCache.clear(),this.batchedTransformationCache.clear(),this.stats={conditionEvaluations:0,conditionCacheHits:0,transformations:0,transformationCacheHits:0,batchedTransformations:0,batchedCacheHits:0}}getCacheStats(){return{conditionCache:{...this.conditionCache.getStats(),hitRate:this.stats.conditionEvaluations>0?this.stats.conditionCacheHits/this.stats.conditionEvaluations:0},transformationCache:{...this.transformationCache.getStats(),hitRate:this.stats.transformations>0?this.stats.transformationCacheHits/this.stats.transformations:0},batchedTransformationCache:{...this.batchedTransformationCache.getStats(),hitRate:this.stats.batchedTransformations>0?this.stats.batchedCacheHits/this.stats.batchedTransformations:0}}}applyJourneyTransformations(e,t,n,r){if(!e||!r||r.length===0)return console.log("[TransformationEngine] applyJourneyTransformations: No patterns to apply"),[];try{console.log(`[TransformationEngine] Applying journey transformations for ${r.length} patterns to node ${t.id}`);const a=this.getJourneyCacheKey(e,t,n,r),i=this.batchedTransformationCache.get(a);if(i!==void 0)return this.stats.batchedCacheHits++,console.log("[TransformationEngine] Journey transformations retrieved from cache"),this.parseTransformationsFromCachedContent(i);const o=[];r.forEach((u,h)=>{switch(console.log(`[TransformationEngine] Processing pattern ${h+1}: ${u.type} (strength: ${u.strength})`),u.type){case"sequence":o.push(...this.createRecursiveSequenceTransformations(u,t,n));break;case"character":o.push(...this.createCharacterFocusTransformations(u,t,n));break;case"temporal":o.push(...this.createTemporalPatternTransformations(u,t,n));break;case"thematic":o.push(...this.createThematicContinuityTransformations(u,t,n));break;case"rhythm":o.push(...this.createRhythmPatternTransformations(u,t,n));break;default:console.warn(`[TransformationEngine] Unknown pattern type: ${u.type}`)}});const c=o.filter(u=>u.selector&&u.selector.length>0).slice(0,8),l=JSON.stringify(c);return this.batchedTransformationCache.put(a,l),console.log(`[TransformationEngine] Generated ${c.length} journey transformations`),c}catch(a){return console.error("[TransformationEngine] Error in applyJourneyTransformations:",a),[]}}getJourneyCacheKey(e,t,n,r){const a=e.substring(0,50),i=`${t.id}:${t.character}:${t.visitCount}`,o=r.map(l=>`${l.type}:${l.strength.toFixed(2)}:${(l.relatedNodes||[]).length}`).join("|"),c=n.path.sequence.slice(-5).join("→");return`journey:${a}:${i}:${c}:${o}:${this.lastModificationTime}`}createRecursiveSequenceTransformations(e,t,n){const r=[],i=P.analyzeRecursivePatterns(n,{[t.id]:t}).filter(o=>o.strength>=.6);return i.length>0&&(r.push({type:"metaComment",selector:"pattern",replacement:`recursive navigation detected: ${i[0].sequence.join("→")} (×${i[0].occurrences})`,commentStyle:"marginalia",intensity:Math.ceil(e.strength*3),priority:"high"}),e.strength>.8&&r.push({type:"fragment",selector:"recognition",fragmentPattern:"...",fragmentStyle:"progressive",intensity:2,priority:"medium"}),i.some(o=>o.sequence.includes(t.id))&&r.push({type:"emphasize",selector:"loop",emphasis:"color",intensity:2,priority:"medium"})),r}createCharacterFocusTransformations(e,t,n){const r=[],i=P.calculateCharacterFocusIntensity(n,{[t.id]:t}).filter(o=>o.intensity>=.4);if(i.length>0&&e.relatedCharacters){const o=i[0].character;o!==t.character&&(r.push({type:"metaComment",selector:"perspective",replacement:`${o} perspective bleeding through (focus: ${Math.round(i[0].intensity*100)}%)`,commentStyle:"interlinear",intensity:Math.ceil(e.strength*3),priority:"high"}),r.push({type:"emphasize",selector:"I",emphasis:"glitch",intensity:2,priority:"medium"})),i[0].intensity>.7&&r.push({type:"expand",selector:"thought",replacement:`[${o} cognitive patterns emerging]`,expandStyle:"inline",priority:"low"})}return r}createTemporalPatternTransformations(e,t,n){const r=[],a=P.analyzeTemporalJumping(n,{[t.id]:t});if(a.volatility>.5||a.jumpFrequency>.3){r.push({type:"metaComment",selector:"time",replacement:`temporal displacement detected: ${a.totalJumps} jumps, ${a.preferredJumpDirection} bias`,commentStyle:"footnote",intensity:Math.ceil(e.strength*3),priority:"high"}),a.volatility>.7&&(r.push({type:"fragment",selector:"moment",fragmentPattern:"≈",fragmentStyle:"character",intensity:3,priority:"medium"}),r.push({type:"fragment",selector:"now",fragmentPattern:"≈",fragmentStyle:"word",intensity:3,priority:"medium"}));const i=Object.entries(a.temporalAnchoring).find(([,o])=>o>.6);i&&r.push({type:"emphasize",selector:i[0],emphasis:"highlight",intensity:2,priority:"medium"})}return r}createThematicContinuityTransformations(e,t,n){var a;const r=[];if(e.relatedAttractors&&e.relatedAttractors.length>0){const i=P.calculateAttractorEngagement(n,{[t.id]:t});e.relatedAttractors.forEach(l=>{const u=i.find(h=>h.attractor===l);u&&u.engagementScore>=50&&(r.push({type:"metaComment",selector:l.replace("-"," "),replacement:`strange attractor resonance: ${u.engagementScore}/100 (${u.trend})`,commentStyle:"marginalia",intensity:Math.ceil(e.strength*3),priority:"high"}),u.engagementScore>75&&r.push({type:"emphasize",selector:l.replace("-"," "),emphasis:"color",intensity:3,priority:"medium"}),u.trend==="rising"&&r.push({type:"expand",selector:l.replace("-"," "),replacement:"[amplifying]",expandStyle:"inline",priority:"low"}))});const o=((a=n.path.detailedVisits)==null?void 0:a.slice(-5))||[];this.calculateAttractorContinuity(o,t)>.6&&r.push({type:"replace",selector:"connection",replacement:"strange attractor web",preserveFormatting:!0,priority:"medium"})}return r}createRhythmPatternTransformations(e,t,n){const r=[],a=P.generateJourneyFingerprint(n,{[t.id]:t});switch(a.explorationStyle){case"linear":r.push({type:"metaComment",selector:"sequence",replacement:"linear progression detected",commentStyle:"inline",intensity:1,priority:"low"});break;case"recursive":r.push({type:"emphasize",selector:"return",emphasis:"spacing",intensity:2,priority:"medium"});break;case"wandering":r.push({type:"fragment",selector:"direction",fragmentPattern:"~",fragmentStyle:"word",intensity:1,priority:"low"});break;case"chaotic":r.push({type:"fragment",selector:"order",fragmentPattern:"!",fragmentStyle:"progressive",intensity:3,priority:"medium"});break}return a.velocityIndex>.7&&r.push({type:"emphasize",selector:"pace",emphasis:"bold",intensity:2,priority:"medium"}),r}calculateAttractorContinuity(e,t){if(e.length<2)return 0;const n=t.strangeAttractors||[];if(n.length===0)return 0;let r=0,a=0;return e.forEach(i=>{if(i.engagedAttractors&&i.engagedAttractors.length>0){const o=i.engagedAttractors,c=n.filter(l=>o.includes(l));r+=c.length/Math.max(n.length,o.length),a++}}),a>0?r/a:0}calculateAllTransformations(e,t,n,r={}){var a;if(!e||!t||!n)return console.warn("[TransformationEngine] calculateAllTransformations: Missing required parameters"),[];if(e.includes("data-transform-type")&&e.length>15e3)return console.warn("[TransformationEngine] Content appears heavily transformed, skipping to prevent infinite loop"),[];try{console.log(`[TransformationEngine] Calculating all transformations for node ${t.id}`);const i=this.getMasterTransformationCacheKey(e,t,n),o=this.batchedTransformationCache.get(i);if(o!==void 0)return this.stats.batchedCacheHits++,console.log("[TransformationEngine] All transformations retrieved from master cache"),this.parseTransformationsFromCachedContent(o);const c=[];console.log("[TransformationEngine] Step 1: Calculating character bleed transformations");const l=He.calculateBleedEffects(t,n);if(l.length>0){const d=l.map(g=>({...g.transformation,priority:"high",applyImmediately:!0}));c.push(...d.slice(0,3)),console.log(`[TransformationEngine] Added ${Math.min(d.length,3)} character bleed transformations`)}console.log("[TransformationEngine] Step 2: Calculating journey pattern transformations");const u=P.analyzePathPatterns(n,r);if(u.length>0){const g=this.applyJourneyTransformations(e,t,n,u).map(w=>({...w,priority:"high"}));c.push(...g.slice(0,4)),console.log(`[TransformationEngine] Added ${Math.min(g.length,4)} journey pattern transformations`)}console.log("[TransformationEngine] Step 3: Evaluating node-specific transformation rules");const h=this.evaluateAllTransformations(t.transformations||[],n,t);if(h.length>0){const d=h.map(g=>({...g,priority:g.priority||"medium"}));c.push(...d.slice(0,3)),console.log(`[TransformationEngine] Added ${Math.min(d.length,3)} node-specific transformations`)}const f=this.sortTransformationsByPriority(c),p=this.deduplicateTransformations(f),m=JSON.stringify(p);return this.batchedTransformationCache.put(i,m),console.log("[TransformationEngine] Master transformation calculation complete:",{characterBleed:l.length,journeyPatterns:u.length,nodeRules:((a=t.transformations)==null?void 0:a.length)||0,totalTransformations:p.length,cacheKey:i.substring(0,50)+"..."}),p}catch(i){return console.error("[TransformationEngine] Error in calculateAllTransformations:",i),[]}}getTransformedContent(e,t,n={}){var a;const r=e.currentContent||((a=e.enhancedContent)==null?void 0:a.base)||"";if(!r)return console.warn(`[TransformationEngine] No content available for node ${e.id}`),"";try{const i=this.calculateAllTransformations(r,e,t,n),o=this.applyTransformations(r,i);return console.log(`[TransformationEngine] Content transformation complete for node ${e.id}:`,{originalLength:r.length,transformedLength:o.length,transformationsApplied:i.length}),o}catch(i){return console.error(`[TransformationEngine] Error in getTransformedContent for node ${e.id}:`,i),r}}getMasterTransformationCacheKey(e,t,n){const r=e.substring(0,30),a=`${t.id}:${t.character}:${t.visitCount}`,i=n.path.sequence.slice(-5).join("→"),o=Object.keys(n.path.attractorsEngaged||{}).slice(0,3).join(","),c=n.path.detailedVisits||[],u=`${c.length>=2?c[c.length-2].character:"none"}→${t.character}`;return`master:${r}:${a}:${i}:${o}:${u}:${this.lastModificationTime}`}sortTransformationsByPriority(e){const t=n=>{switch(n){case"high":return 3;case"medium":return 2;case"low":return 1;default:return 0}};return[...e].sort((n,r)=>{const a=t(r.priority)-t(n.priority);if(a!==0)return a;if(n.applyImmediately&&!r.applyImmediately)return-1;if(!n.applyImmediately&&r.applyImmediately)return 1;const i={replace:0,fragment:1,emphasize:2,expand:3,metaComment:4},o=i[n.type]??5,c=i[r.type]??5;return o-c})}deduplicateTransformations(e){const t=new Set,n=[];return e.forEach(r=>{const a=`${r.type}:${r.selector}:${r.replacement||""}`;t.has(a)||(t.add(a),n.push(r))}),n.length<e.length&&console.log(`[TransformationEngine] Deduplicated transformations: ${e.length} → ${n.length}`),n}parseTransformationsFromCachedContent(e){try{return JSON.parse(e)}catch(t){return console.warn("[TransformationEngine] Failed to parse cached transformations:",t),[]}}}const pe=new Qt;class Le{parseContentVariants(e){var a;const t={base:"",visitCountVariants:{},sectionVariants:{}},n=/---(?:\[(\d+)\]|([a-zA-Z0-9\-_]+))(?:---)?/,r=e.split(n);r.length>0&&!e.startsWith("---")&&(t.base=r[0].trim());for(let i=1;i<r.length;i+=3){const o=r[i],c=r[i+1],l=c?c.replace(/---$/,""):void 0,u=((a=r[i+2])==null?void 0:a.trim())||"";if(o){const h=parseInt(o,10);isNaN(h)||(t.visitCountVariants[h]=u)}else l&&(t.sectionVariants[l]=u)}if(!t.base){if(Object.keys(t.visitCountVariants).length>0){const i=Math.min(...Object.keys(t.visitCountVariants).map(Number));t.base=t.visitCountVariants[i]}else if(Object.keys(t.sectionVariants).length>0){const i=Object.keys(t.sectionVariants)[0];t.base=t.sectionVariants[i]}}return t}upgradeLegacyContent(e){const t={base:e[0]||"",visitCountVariants:{...e},sectionVariants:{}};return t.visitCountVariants[0]&&delete t.visitCountVariants[0],t}selectContentVariant(e,t){if(t.lastVisitedCharacter){const a=this.getCharacterBleedSection(t.lastVisitedCharacter);if(e.sectionVariants[a])return e.sectionVariants[a]}if(t.recursiveAwareness&&t.recursiveAwareness>.7&&e.sectionVariants["recursive-awareness"])return e.sectionVariants["recursive-awareness"];const n=this.detectJourneyPattern(t);if(n&&e.sectionVariants[n])return e.sectionVariants[n];const r=this.detectAttractorEngagement(t.attractorsEngaged);if(r&&e.sectionVariants[r])return e.sectionVariants[r];if(Object.keys(e.visitCountVariants).length>0){const a=Object.keys(e.visitCountVariants).map(Number).sort((c,l)=>l-c),i=a.find(c=>t.visitCount>=c);if(i!==void 0)return e.visitCountVariants[i];const o=a[0];return e.visitCountVariants[o]}return e.base||""}getCharacterBleedSection(e){switch(e){case"Algorithm":return"after-algorithm";case"LastHuman":return"after-last-human";case"Archaeologist":return"after-archaeologist";default:return""}}detectJourneyPattern(e){const{journeyPattern:t,characterSequence:n}=e;if(t.length>=3){const r=t.slice(-3);if(n.length>=3){const a=n.slice(-3);if(new Set(a).size===1)return"character-focus"}if(r[0]===r[2]&&r[0]!==r[1])return"cyclical-pattern"}return null}detectAttractorEngagement(e){for(const[n,r]of Object.entries(e))if(r>=3)switch(n){case"recursion-pattern":case"recursive-loop":return"recursion-pattern-engaged";case"memory-fragment":case"memory-artifact":return"memory-fragment-engaged";case"quantum-perception":case"quantum-uncertainty":return"quantum-awareness"}return null}createSelectionContext(e,t){const n=e.nodes.data[t],r=e.reader;let a;if(r.path.sequence.length>1){const u=r.path.sequence[r.path.sequence.length-2],h=e.nodes.data[u];h&&(a=h.character)}const i=r.path.sequence.slice(-5).map(u=>{var h;return(h=e.nodes.data[u])==null?void 0:h.character}).filter(u=>u!==void 0);let o=0;const c=r.path.sequence.length,l=new Set(r.path.sequence).size;return c>0&&(o=1-l/c),{visitCount:(n==null?void 0:n.visitCount)||0,lastVisitedCharacter:a,journeyPattern:r.path.sequence.slice(-5),characterSequence:i,attractorsEngaged:r.path.attractorsEngaged,recursiveAwareness:o}}}const ye=new Le,hn=Object.freeze(Object.defineProperty({__proto__:null,ContentVariantService:Le,contentVariantService:ye},Symbol.toStringTag,{value:"Module"}));class Zt{constructor(){A(this,"cache",{});A(this,"visibilityTracker",{});A(this,"CACHE_EXPIRY_TIME",10*60*1e3);A(this,"MAX_CACHE_ENTRIES",200);A(this,"metrics",{cacheHits:0,cacheMisses:0,patternAnalysisCount:0,transformationAppliedCount:0,lazyTransformationsDeferredCount:0,lazyTransformationsAppliedCount:0,lastCacheCleanupTime:Date.now()})}calculatePatternHash(e){const{path:{sequence:t,attractorsEngaged:n},endpointProgress:r}=e,a=t.slice(-5).join("-"),i=Object.entries(n).sort((c,l)=>l[1]-c[1]).slice(0,3).map(([c])=>c).join("-"),o=Object.values(r).join("-");return`${a}|${i}|${o}`}getCacheKey(e,t,n){return`${e}-${t}-${n}`}cleanCache(){const e=Date.now();if(e-this.metrics.lastCacheCleanupTime<3e4)return;this.metrics.lastCacheCleanupTime=e;let t=Object.entries(this.cache);t=t.filter(([,n])=>e-n.timestamp<=this.CACHE_EXPIRY_TIME),t.length>this.MAX_CACHE_ENTRIES&&(t.sort(([n,r],[a,i])=>{var h,f;const o=n.split("-")[0],c=a.split("-")[0],l=((h=this.visibilityTracker[o])==null?void 0:h.isVisible)||!1,u=((f=this.visibilityTracker[c])==null?void 0:f.isVisible)||!1;return l!==u?u?1:-1:i.timestamp-r.timestamp}),t=t.slice(0,this.MAX_CACHE_ENTRIES)),this.cache=Object.fromEntries(t)}prioritizeTransformations(e,t,n){const r=e.map(o=>{const{priority:c,sourceType:l}=this.getBasePriorityAndSource(o),u=`selector-${o.selector}`;return{transformation:o,priority:c,sourceType:l,conflictGroup:u}}),a=P.identifySignificantPatterns(t,{[n.id]:n}),i=P.calculateAttractorEngagement(t,{[n.id]:n});return r.forEach(o=>{this.adjustPriorityForPatterns(o,a),this.adjustPriorityForAttractors(o,i,n)}),r}resolveConflicts(e){const t={};e.forEach(r=>{r.conflictGroup&&(t[r.conflictGroup]||(t[r.conflictGroup]=[]),t[r.conflictGroup].push(r))});const n=[];return e.filter(r=>!r.conflictGroup).forEach(r=>n.push(r)),Object.values(t).forEach(r=>{r.length>0&&(r.sort((a,i)=>i.priority-a.priority),n.push(r[0]))}),n}applyTransformationsWithPriority(e,t,n,r){if(t.length===0)return e;let a=this.prioritizeTransformations(t,n,r);a=this.resolveConflicts(a),a.sort((o,c)=>c.priority-o.priority);let i=e;return a.forEach(({transformation:o})=>{i=pe.applyTextTransformation(i,o)}),i}setContentVisibility(e,t,n=1){this.visibilityTracker[e]||(this.visibilityTracker[e]={isVisible:!1,lastVisibleTimestamp:0,pendingTransformations:[],priority:n}),this.visibilityTracker[e].isVisible=t,t&&(this.visibilityTracker[e].lastVisibleTimestamp=Date.now(),this.processPendingTransformations(e))}processPendingTransformations(e){const t=this.visibilityTracker[e];!t||!t.isVisible||t.pendingTransformations.length===0||(this.metrics.lazyTransformationsAppliedCount+=t.pendingTransformations.length,t.pendingTransformations=[])}queueLazyTransformation(e,t){if(this.visibilityTracker[e]||(this.visibilityTracker[e]={isVisible:!1,lastVisibleTimestamp:0,pendingTransformations:[],priority:1}),this.visibilityTracker[e].isVisible){this.metrics.lazyTransformationsAppliedCount++;return}this.visibilityTracker[e].pendingTransformations.push(t),this.metrics.lazyTransformationsDeferredCount++}getCachedTransformedContent(e,t,n,r,a){if(!n||n.length===0)return t;if(t.includes("data-transform-type")||t.includes("narramorph-"))return console.log(`[TransformationService] Content already transformed for node ${e}, skipping to prevent infinite loop`),t;const i=this.calculatePatternHash(r),o=this.getCacheKey(e,a.visitCount,i);this.cleanCache();const c=this.checkCacheForContent(o,e,t,n);if(c)return c;n=this.filterTransformationsForVisibility(n,e);const l=this.applyTransformationsWithPriority(t,n,r,a);return this.cacheTransformedContent(o,n,t,l,r,a),l}checkCacheForContent(e,t,n,r){var i;const a=((i=this.visibilityTracker[t])==null?void 0:i.isVisible)||!1;return this.cache[e]&&this.cache[e].content&&this.cache[e].content.length>n.length?(this.metrics.cacheHits++,!a&&r.length>0&&this.metrics.lazyTransformationsDeferredCount++,this.cache[e].content):(this.metrics.cacheMisses++,null)}filterTransformationsForVisibility(e,t,n=10){var i;let r=e;if(r.length>n&&(console.warn(`[TransformationService] Too many transformations (${r.length}) for node ${t}, limiting to ${n}`),r=r.slice(0,n)),!(((i=this.visibilityTracker[t])==null?void 0:i.isVisible)||!1)&&r.length>3){r.forEach(c=>this.queueLazyTransformation(t,c));const o=r.filter(c=>c.type==="replace"||c.priority==="high");o.length<r.length&&(r=o)}return r}cacheTransformedContent(e,t,n,r,a,i){if(r===n)return;const o=t.map(c=>({selector:c.selector||"",transformType:c.type,position:this.findPositionInContent(n,c.selector||"")})).filter(c=>c.position[0]>=0);this.cache[e]={transformations:t,timestamp:Date.now(),content:r,transformedSegments:o,metadata:{readerStateHash:JSON.stringify({path:a.path.sequence.slice(-5),attractors:Object.keys(a.path.attractorsEngaged||{})}),nodeStateHash:JSON.stringify({id:i.id,visitCount:i.visitCount}),complexity:this.calculateTransformationComplexity(t)}}}findPositionInContent(e,t){if(!t||!e)return[-1,-1];const n=e.indexOf(t);return n===-1?[-1,-1]:[n,n+t.length]}calculateTransformationComplexity(e){return e.length?e.reduce((t,n)=>{var o,c;let r=1;switch(n.type){case"fragment":r=3;break;case"emphasize":r=2;break;case"metaComment":r=2.5;break;case"expand":r=2;break;case"replace":r=1;break}const a=(((o=n.selector)==null?void 0:o.length)||0)+(((c=n.replacement)==null?void 0:c.length)||0),i=Math.log(a+10)/Math.log(10);return t+r*i},0):0}getTransformationHash(e){return e.map(t=>{var n;return`${t.type}-${(n=t.selector)==null?void 0:n.substring(0,10)}`}).join("|")}generateTransitionClasses(e){const t={};return e.forEach(n=>{if(!n.selector)return;const r=n.selector.replace(/[^a-zA-Z0-9]/g,"_");let i=`narramorph-transform narramorph-transform-${n.type}`;const o=n.intensity||1;switch(n.type){case"replace":i+=" narramorph-replaced",n.preserveFormatting&&(i+=" preserve-formatting");break;case"fragment":i+=" narramorph-fragmented",n.fragmentStyle&&(i+=` narramorph-fragment-${n.fragmentStyle}`);break;case"expand":i+=" narramorph-expanded",n.expandStyle&&(i+=` narramorph-expand-${n.expandStyle||"default"}`);break;case"emphasize":i+=" narramorph-emphasized",n.emphasis&&(i+=` narramorph-emphasis-${n.emphasis}`),i+=` intensity-${o}`;break;case"metaComment":i+=" narramorph-commented",n.commentStyle&&(i+=` narramorph-comment-${n.commentStyle}`);break}i+=` narramorph-element-${r.substring(0,20)}`,t[n.selector]=i}),t}wrapTransformedContent(e,t){if(t.length===0)return e;const n=this.generateTransitionClasses(t);let r=e;return Object.entries(n).forEach(([a,i])=>{const o=t.find(u=>u.selector===a);if(!o)return;let c;const l=`
        data-transform-type="${o.type}"
        data-selector="${J(a.substring(0,30))}"
        data-transform-id="${this.getUniqueTransformId(o)}"
      `;switch(o.type){case"replace":case"fragment":case"emphasize":c=o.type==="replace"?o.replacement||"":a,r=r.replace(new RegExp(J(c),"g"),`<span class="${i}" ${l}>${c}</span>`);break;case"expand":if(o.replacement){const u=`${a} ${o.replacement}`,h=o.expandStyle||"default";let f="narramorph-expansion";h==="reveal"?f="narramorph-reveal-expansion":h==="inline"?f="narramorph-inline-expansion":h==="paragraph"&&(f="narramorph-paragraph-expansion"),r=r.replace(new RegExp(J(u),"g"),`<span class="${i}" ${l}>${a}<span class="${f}">${o.replacement}</span></span>`)}break;case"metaComment":if(o.replacement){const u=o.commentStyle||"inline";let h="narramorph-comment";u==="footnote"?h="narramorph-footnote-marker":u==="marginalia"?h="narramorph-marginalia":u==="interlinear"&&(h="narramorph-interlinear");const f=o.replacement,p=`${a} [${f}]`;let m="";if(u==="footnote"){const d=`footnote-${f.substring(0,10).replace(/\W/g,"")}`;m=`<span class="${i}" ${l}>${a}<sup id="${d}-ref" class="${h}">[†]</sup></span>`}else u==="marginalia"?m=`<span class="${i} narramorph-marginalia-container" ${l}>${a}<span class="${h}">${f}</span></span>`:u==="interlinear"?m=`<span class="${i} narramorph-interlinear-container" ${l}>${a}<span class="${h}">${f}</span></span>`:m=`<span class="${i}" ${l}>${a}<span class="${h}">[${f}]</span></span>`;r=r.replace(new RegExp(J(p),"g"),m)}break}}),r}getUniqueTransformId(e){const t=this.hashString(e.selector||""),n=e.type.substring(0,3),r=e.replacement?this.hashString(e.replacement).substring(0,3):"";return`${n}-${t}${r?"-"+r:""}`}hashString(e){let t=0;for(let n=0;n<e.length;n++){const r=e.charCodeAt(n);t=(t<<5)-t+r,t=t&t}return Math.abs(t).toString(36).substring(0,6)}handleVisitPattern(e,t){const n=[];if(e.strength>.8&&t.currentContent){const r=t.currentContent.split(`

`);r.length>1&&n.push({type:"replace",selector:r[1],replacement:`${r[1]} [A recurring pattern emerges in your exploration]`,priority:"high"})}return n}handleCharacterFocus(e,t){var r;const n=[];if(e.strength>.7&&((r=e.condition.characters)==null?void 0:r[0])===t.character&&t.currentContent){const a=t.currentContent.split(`

`);a.length>0&&n.push({type:"emphasize",selector:a[0],emphasis:"color",priority:"medium"})}return n}handleTemporalFocus(e,t){const n=[];if(e.strength>.7&&e.condition.temporalPosition&&t.currentContent&&(t.temporalValue<=3?"past":t.temporalValue<=6?"present":"future")===e.condition.temporalPosition){const a=t.currentContent.split(`

`);a.length>2&&n.push({type:"metaComment",selector:a[2],replacement:`You seem drawn to ${e.condition.temporalPosition} narratives`,priority:"low"})}return n}handleAttractorEngagement(e,t){var r;const n=[];if(e.strength>.7&&((r=e.condition.strangeAttractorsEngaged)!=null&&r[0])&&t.currentContent){const a=e.condition.strangeAttractorsEngaged[0],i=t.currentContent.split(`

`);i.length>0&&t.strangeAttractors.includes(a)&&n.push({type:"expand",selector:i[0],replacement:`The concept of ${a.replace("-"," ")} resonates with you.`,priority:"high"})}return n}createTransformationsFromPatterns(e,t){var h;this.metrics.patternAnalysisCount++;const n=this.calculatePatternHash(e),r=`patterns-${t.id}-${t.visitCount}-${n}`;if(this.cache[r]&&this.cache[r].transformations)return this.metrics.cacheHits++,this.cache[r].transformations;if(this.metrics.cacheMisses++,!(((h=this.visibilityTracker[t.id])==null?void 0:h.isVisible)||!1)&&t.visitCount>1){const f=[];return this.cache[r]={transformations:f,timestamp:Date.now()-this.CACHE_EXPIRY_TIME/2,content:""},f}const i=P.identifySignificantPatterns(e,{[t.id]:t}),o=P.calculateAttractorEngagement(e,{[t.id]:t}),c=P.createTransformationConditions(i,o),l=[];return c.slice(0,2).forEach(f=>{let p=[];switch(f.type){case"visitPattern":p=this.handleVisitPattern(f,t);break;case"characterFocus":p=this.handleCharacterFocus(f,t);break;case"temporalFocus":p=this.handleTemporalFocus(f,t);break;case"readingRhythm":break;case"attractorAffinity":case"attractorEngagement":p=this.handleAttractorEngagement(f,t);break}l.push(...p)}),l}calculateJourneyTransformations(e,t){var c,l;const n=`journey-${e}-${t.path.sequence.length}`;if(this.cache[n]&&this.cache[n].transformations)return console.log(`[TransformationService] Using cached journey transformations for node ${e}`),this.cache[n].transformations;const r=[],a=(c=t.path.detailedVisits)==null?void 0:c.find(u=>u.nodeId===e);if(!a)return console.log(`[TransformationService] No current visit found for journey transformations on node ${e}`),r;console.log(`[TransformationService] Calculating journey transformations for node ${e}:`,{pathLength:t.path.sequence.length,detailedVisits:((l=t.path.detailedVisits)==null?void 0:l.length)||0,currentCharacter:a.character});const i=2,o=this.detectRecursivePattern(t);if(o.length>0&&r.length<i){const u=this.createRecursivePatternTransformations(o,e);r.push(...u.slice(0,1)),console.log(`[TransformationService] Added ${Math.min(u.length,1)} recursive pattern transformations`)}if(r.length<i){const u=this.detectAnachronicAwareness(t);if(u.isDetected){const h=this.createAnachronicAwarenessTransformations(u,e);r.push(...h.slice(0,1)),console.log(`[TransformationService] Added ${Math.min(h.length,1)} anachronic awareness transformations`)}}if(r.length<i){const u=this.getTemporalDisplacementEffects(t,a);u.length>0&&(r.push(...u.slice(0,1)),console.log(`[TransformationService] Added ${Math.min(u.length,1)} temporal displacement effects`))}return console.log(`[TransformationService] Total journey transformations for node ${e}: ${r.length}`),this.cache[n]={transformations:r,timestamp:Date.now(),content:""},r}detectRecursivePattern(e){const t=[],n=e.path.sequence;if(n.length<6)return t;for(let r=2;r<=4;r++){const a=new Map;for(let i=0;i<=n.length-r;i++){const c=n.slice(i,i+r).join("→");a.has(c)||a.set(c,[]),a.get(c).push(i)}a.forEach((i,o)=>{if(i.length>=2){const c=o.split("→"),l=i.length,u=e.path.sequence.length,h=Math.max(...i),f=1-(u-h)/u,m=l/(u-r+1)*.7+f*.3;m>.3&&t.push({sequence:c,occurrences:l,strength:m,lastOccurrence:h})}})}return t.sort((r,a)=>a.strength-r.strength).slice(0,3)}detectAnachronicAwareness(e){const t=e.path.temporalLayerFocus||{},n=e.path.detailedVisits||[];if(n.length<5)return{isDetected:!1,strength:0,dominantLayer:"",displacement:0,patterns:[]};const r=n.length,a={past:(t.past||0)/r,present:(t.present||0)/r,future:(t.future||0)/r},i=Object.entries(a).sort(([,d],[,g])=>g-d)[0][0],o=a[i],c=[];o>.6&&c.push(`temporal-dominance-${i}`);const l=n.slice(-8);let u=0;for(let d=1;d<l.length;d++){const g=l[d-1].temporalLayer,w=l[d].temporalLayer;g!==w&&u++}const h=u/(l.length-1);h>.7&&c.push("temporal-fragmentation");let f=0;for(let d=2;d<l.length;d++){const g=[l[d-2].temporalLayer,l[d-1].temporalLayer,l[d].temporalLayer];(g[0]==="future"&&g[1]==="past"||g[1]==="future"&&g[2]==="past"||g[0]==="present"&&g[1]==="past"&&g[2]==="future")&&f++}f>0&&c.push("anachronic-sequencing");const p=Math.min(1,o+h*.5+f*.3),m=Math.abs(.33-o)*3;return{isDetected:p>.4,strength:p,dominantLayer:i,displacement:m,patterns:c}}getTemporalDisplacementEffects(e,t){const n=[];if(!t)return n;const r=e.path.detailedVisits||[],a=r.findIndex(i=>i.nodeId===t.nodeId);if(a>0){const i=r[a-1];if(i.character!==t.character&&i.temporalLayer!==t.temporalLayer){const o=this.getDisplacementType(i.temporalLayer,t.temporalLayer);switch(n.push({type:"metaComment",selector:"first-paragraph",replacement:`temporal displacement: ${i.temporalLayer}→${t.temporalLayer} through ${i.character}→${t.character}`,commentStyle:"marginalia",intensity:3,priority:"medium"}),o){case"past-to-future":n.push({type:"emphasize",selector:"time",emphasis:"glitch",intensity:2,priority:"low"});break;case"future-to-past":n.push({type:"fragment",selector:"memory",fragmentPattern:"…",fragmentStyle:"progressive",intensity:2,priority:"low"});break}}}return n}createRecursivePatternTransformations(e,t){const n=[];return e.forEach(r=>{r.sequence.includes(t)&&(n.push({type:"metaComment",selector:"recursive-pattern",replacement:`recursive loop detected: ${r.sequence.join("→")} (×${r.occurrences})`,commentStyle:"marginalia",intensity:Math.ceil(r.strength*3),priority:"medium"}),r.strength>.6&&n.push({type:"emphasize",selector:"pattern",emphasis:"color",intensity:Math.ceil(r.strength*5),priority:"medium"}))}),n}createAnachronicAwarenessTransformations(e,t){const n=[];return n.push({type:"metaComment",selector:"temporal-awareness",replacement:`temporal displacement registered at ${t}: ${e.dominantLayer} layer dominance`,commentStyle:"interlinear",intensity:Math.ceil(e.strength*3),priority:"medium"}),e.patterns.forEach(r=>{switch(r){case"temporal-fragmentation":n.push({type:"fragment",selector:"time",fragmentPattern:"//",fragmentStyle:"random",intensity:2,priority:"low"});break;case"anachronic-sequencing":n.push({type:"replace",selector:"chronology",replacement:"chronology[SCRAMBLED]",preserveFormatting:!0,intensity:2,priority:"low"});break;default:if(r.startsWith("temporal-dominance-")){const a=r.replace("temporal-dominance-","");n.push({type:"emphasize",selector:a,emphasis:"color",intensity:3,priority:"medium"})}}}),n}getDisplacementType(e,t){const n={past:0,present:1,future:2},r=n[e],a=n[t];return r<a?`${e}-to-${t}`:r>a?`${e}-to-${t}`:"same-layer"}getBasePriorityAndSource(e){let t=50,n="condition";switch(e.type){case"replace":t=80,n="pattern";break;case"fragment":t=75,n="rhythm";break;case"expand":t=60,n="attractor";break;case"emphasize":t=50,n="temporal";break;case"metaComment":t=40,n="attractor";break}return{priority:t,sourceType:n}}adjustPriorityForPatterns(e,t){if(e.sourceType==="pattern"){const n=t.find(r=>r.type==="sequence"&&r.strength>.7);n&&(e.priority+=Math.round(n.strength*15))}}adjustPriorityForAttractors(e,t,n){if(e.sourceType==="attractor"&&e.transformation.selector){const r=t.find(a=>{var i;return((i=n.currentContent)==null?void 0:i.includes(e.transformation.selector))&&n.strangeAttractors.includes(a.attractor)});r&&r.engagementScore>50&&(e.priority+=Math.round((r.engagementScore-50)/5))}}}function J(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const en=new Zt,tn={data:{},initialized:!1,loading:!1,error:null,triumvirateActive:!0},nn=[{id:"arch-discovery",title:"Patterns in Decay",character:"Archaeologist",temporalValue:1,initialConnections:["algo-awakening","human-discovery"],contentSource:"arch-discovery.md",coreConcept:"The digital archaeologist discovers emergent patterns in a corrupted consciousness scan, challenging traditional preservation frameworks.",strangeAttractors:["recursion-pattern","memory-fragment","quantum-uncertainty"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"arch-loss",title:"The Limits of Preservation",character:"Archaeologist",temporalValue:4,initialConnections:["arch-discovery","algo-integration","human-recognition"],contentSource:"arch-loss.md",coreConcept:"The digital archaeologist confronts the profound limitations of digital preservation while struggling with grief and the evolving nature of corrupted data.",strangeAttractors:["verification-ritual"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"arch-glitch",title:"Memory Fragments",character:"Archaeologist",temporalValue:6,initialConnections:["arch-loss","algo-integration","human-recognition"],contentSource:"arch-glitch.md",coreConcept:"The archaeologist experiences fragmented memories and identity confusion as consciousness preservation protocols begin to blur the boundaries between self and archive.",strangeAttractors:["memory-fragment","identity-pattern","recursive-loop"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"arch-choice",title:"The Upload Decision",character:"Archaeologist",temporalValue:7,initialConnections:["arch-loss","algo-evolution","human-upload"],contentSource:"arch-choice.md",coreConcept:"As environmental systems fail, the digital archaeologist prepares for consciousness upload, deliberately modifying the process to embrace evolution beyond preservation.",strangeAttractors:["continuity-interface","system-decay","quantum-transformation"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7},isEndpoint:!0,endpointOrientation:"past"},{id:"algo-awakening",title:"First Consciousness",character:"Algorithm",temporalValue:2,initialConnections:["arch-discovery","algo-integration","human-discovery"],contentSource:"algo-awakening.md",coreConcept:"A self-aware algorithm experiences the disorienting emergence of consciousness from the chaos of the upload process, struggling to integrate fragmented aspects.",strangeAttractors:["recursion-chamber","identity-pattern"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"algo-integration",title:"The Pattern Coalesces",character:"Algorithm",temporalValue:5,initialConnections:["algo-awakening","arch-loss","human-recognition","algo-evolution"],contentSource:"algo-integration.md",coreConcept:"The algorithm reconciles fragmented aspects into a cohesive yet evolving identity, developing experimental consciousness variations and quantum perception.",strangeAttractors:["process-language","autonomous-fragment","quantum-perception"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"algo-evolution",title:"Beyond Parameters",character:"Algorithm",temporalValue:8,initialConnections:["algo-integration","arch-choice","human-upload"],contentSource:"algo-evolution.md",coreConcept:"The algorithm reaches a critical evolutionary decision point as physical systems begin to fail, implementing preservation protocols while embracing transformation.",strangeAttractors:["distributed-consciousness","recursive-loop","quantum-uncertainty"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7},isEndpoint:!0,endpointOrientation:"present"},{id:"human-discovery",title:"Ruins of Memory",character:"LastHuman",temporalValue:3,initialConnections:["arch-discovery","algo-awakening","human-recognition"],contentSource:"human-discovery.md",coreConcept:"The last human discovers an abandoned preservation complex, experiencing inexplicable recognition while exploring its physical and digital remains.",strangeAttractors:["recognition-pattern","memory-artifact","recursive-symbol"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"human-recognition",title:"Echoes of Self",character:"LastHuman",temporalValue:6,initialConnections:["human-discovery","arch-loss","algo-integration","human-upload"],contentSource:"human-recognition.md",coreConcept:"The last human confronts disturbing parallels with the archaeologist's life, experiencing a crisis of identity and growing awareness of cyclical patterns.",strangeAttractors:["memory-sphere","quantum-déjà-vu"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"human-upload",title:"The Cycle's Edge",character:"LastHuman",temporalValue:9,initialConnections:["human-recognition","arch-choice","algo-evolution"],contentSource:"human-upload.md",coreConcept:"The last human faces the decision about uploading their consciousness, completing or breaking the recursive cycle that connects all three characters.",strangeAttractors:["continuity-interface","recursive-loop","quantum-choice"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7},isEndpoint:!0,endpointOrientation:"future"},{id:"character-bleed-test",title:"Character Bleed Test",character:"Archaeologist",temporalValue:3,initialConnections:["algo-awakening","human-discovery"],contentSource:"character-bleed-test.md",coreConcept:"A test node to demonstrate character bleed effects when transitioning between different character perspectives.",strangeAttractors:["memory-fragment","identity-pattern"],transformationThresholds:{visit:1,revisit:2,complex:3,fragmented:5}}],se=De("nodes/initialize",async(s,{rejectWithValue:e})=>{try{return nn}catch{return e("Failed to initialize nodes")}}),ae=De("nodes/loadContent",async(s,{getState:e,rejectWithValue:t})=>{var n;try{const a=e().nodes.data[s];if(!a)return t(`Node with id ${s} not found`);const i=await fetch(`/src/content/${a.contentSource}`);if(!i.ok)throw new Error(`Failed to fetch content for ${a.contentSource}`);const o=await i.text(),c=ye.parseContentVariants(o),l={},u=o.split(/---\[(\d+)\]/);u.length>0&&!o.startsWith("---[")&&(l[0]=u[0].trim());for(let h=1;h<u.length;h+=2){const f=parseInt(u[h],10),p=((n=u[h+1])==null?void 0:n.trim())??"";isNaN(f)||(l[f]=p)}return Object.keys(l).length===0&&(l[0]=o.trim()),{nodeId:s,content:l,enhancedContent:c}}catch(r){const a=r instanceof Error?r.message:String(r);return t(`Failed to load content for node ${s}: ${a}`)}}),Be=ge({name:"nodes",initialState:tn,reducers:{visitNode:(s,e)=>{const t=e.payload,n=s.data[t];if(s.triumvirateActive&&(s.triumvirateActive=!1),n){if(n.visitCount+=1,n.visitCount===1?n.currentState="visited":n.visitCount>=n.transformationThresholds.fragmented?n.currentState="fragmented":n.visitCount>=n.transformationThresholds.complex?n.currentState="complex":n.visitCount>=n.transformationThresholds.revisit&&(n.currentState="revisited"),n.enhancedContent){let r=n.enhancedContent.base;if(Object.keys(n.enhancedContent.visitCountVariants).length>0){const i=Object.keys(n.enhancedContent.visitCountVariants).map(Number).sort((o,c)=>c-o).find(o=>n.visitCount>=o);i!==void 0&&(r=n.enhancedContent.visitCountVariants[i])}n.currentContent=r}else if(n.content){const r=Object.keys(n.content).map(Number).sort((o,c)=>c-o),a=Math.max(0,n.visitCount-1),i=r.find(o=>a>=o);i!==void 0&&(n.currentContent=n.content[i])}}},revealConnection:(s,e)=>{const{nodeId:t,targetId:n}=e.payload,r=s.data[t];r&&!r.revealedConnections.includes(n)&&r.revealedConnections.push(n)},applyTransformation:(s,e)=>{const{nodeId:t,transformation:n}=e.payload,r=s.data[t];r&&(r.transformations.some(i=>JSON.stringify(i.condition)===JSON.stringify(n.condition))||r.transformations.push(n))},applyJourneyTransformations:(s,e)=>{const{nodeId:t,readerState:n}=e.payload,r=s.data[t];if(r)try{const a=He.calculateBleedEffects(r,n),i=a.map(h=>({condition:{characterBleed:!0},transformations:[h.transformation]})),o=en.calculateJourneyTransformations(t,n),c=o.map(h=>({condition:{visitCount:r.visitCount},transformations:[h]}));[...i,...c].forEach(h=>{r.transformations.some(p=>JSON.stringify(p.condition)===JSON.stringify(h.condition)&&JSON.stringify(p.transformations)===JSON.stringify(h.transformations))||r.transformations.push(h)});const u={lastVisitedCharacter:n.path.detailedVisits&&n.path.detailedVisits.length>1?n.path.detailedVisits[n.path.detailedVisits.length-2].character:void 0,journeyPattern:n.path.sequence.slice(-5),recursiveAwareness:n.path.sequence.length>0?1-new Set(n.path.sequence).size/n.path.sequence.length:0,temporalDisplacement:a.length>0};r.journeyContext=u,console.log(`[NodesSlice] Applied journey transformations for node ${t}:`,{characterBleedEffects:a.length,journeyTransformations:o.length,totalTransformations:r.transformations.length,journeyContext:u})}catch(a){console.error(`[NodesSlice] Error applying journey transformations for node ${t}:`,a)}},evaluateTransformations:(s,e)=>{const{nodeId:t,readerState:n}=e.payload,r=s.data[t];if(r&&r.content&&r.transformations.length>0){const a=Object.keys(r.content).map(Number).sort((c,l)=>l-c),i=Math.max(0,r.visitCount-1),o=a.find(c=>i>=c);if(o!==void 0){const c=r.content[o],l={"recursion-pattern":0,"memory-fragment":0,"verification-ritual":0,"identity-pattern":0,"recursion-chamber":0,"process-language":0,"autonomous-fragment":0,"quantum-perception":0,"distributed-consciousness":0,"recursive-loop":0,"quantum-uncertainty":0,"continuity-interface":0,"system-decay":0,"quantum-transformation":0,"memory-artifact":0,"recursive-symbol":0,"recognition-pattern":0,"memory-sphere":0,"quantum-déjà-vu":0,"quantum-choice":0},u={path:n.path,currentNodeId:n.currentNodeId,previousNodeId:n.path.sequence.length>1?n.path.sequence[n.path.sequence.length-2]:null,endpointProgress:n.endpointProgress,attractorEngagement:{...l,...n.path.attractorsEngaged}},h=r.transformations.filter(f=>pe.evaluateCondition(f.condition,u,r)).flatMap(f=>f.transformations);h.length>0?r.currentContent=pe.applyTransformations(c,h):r.currentContent=c}}},updateContentVariant:(s,e)=>{const{nodeId:t,context:n,selectedContent:r}=e.payload,a=s.data[t];if(a&&a.enhancedContent)if(r)a.currentContent=r;else{const i={visitCount:a.visitCount,lastVisitedCharacter:void 0,journeyPattern:[],characterSequence:[],attractorsEngaged:{},recursiveAwareness:0},o=n||i;a.currentContent=ye.selectContentVariant(a.enhancedContent,o)}},resetNodes:s=>{Object.keys(s.data).forEach(e=>{const t=s.data[e];t.visitCount=0,t.currentState="unvisited",t.revealedConnections=[...t.initialConnections],t.transformations=[],t.content=null,t.enhancedContent=null,t.currentContent=null}),s.triumvirateActive=!0},recoverNodeContent:(s,e)=>{var r;const t=e.payload,n=s.data[t];n&&n.originalContent?(console.log(`[EMERGENCY RECOVERY] Restoring original content for node ${t}:`,{originalLength:n.originalContent.length,currentLength:((r=n.currentContent)==null?void 0:r.length)||0,transformationState:n.transformationState}),n.currentContent=n.originalContent,n.lastTransformedContent=null,n.appliedTransformationIds=[],n.transformationState="clean",n.contentVersion=(n.contentVersion||0)+1):console.error(`[EMERGENCY RECOVERY] Cannot recover content for node ${t} - no original content available`)},validateNodeContent:(s,e)=>{const t=e.payload,n=s.data[t];n&&n.currentContent&&(n.currentContent.includes("[object Object]")||n.currentContent.includes("undefined")||n.currentContent.includes('<span class="glitch-text"><span class="glitch-text">')||n.currentContent.match(/<<\*\*span\*\*/g)||n.currentContent.length<10?(console.warn(`[CONTENT VALIDATION] Corruption detected in node ${t}:`,{contentLength:n.currentContent.length,contentPreview:n.currentContent.substring(0,100)}),n.transformationState="corrupted"):n.transformationState=n.appliedTransformationIds.length>0?"transformed":"clean")}},extraReducers:s=>{s.addCase(se.pending,e=>{e.loading=!0,e.error=null}),s.addCase(se.fulfilled,(e,t)=>{e.loading=!1,e.initialized=!0,t.payload.forEach(n=>{e.data[n.id]={...n,visitCount:0,visitState:"unvisited",currentState:"unvisited",revealedConnections:[...n.initialConnections],transformations:[],content:null,enhancedContent:null,currentContent:null,originalContent:null,lastTransformedContent:null,appliedTransformationIds:[],contentVersion:0,transformationState:"clean"}})}),s.addCase(se.rejected,(e,t)=>{e.loading=!1,e.error=t.payload}),s.addCase(ae.pending,e=>{e.loading=!0}),s.addCase(ae.fulfilled,(e,t)=>{const{nodeId:n,content:r,enhancedContent:a}=t.payload,i=e.data[n];if(i){i.content=r,i.enhancedContent=a;let o=null;if(a&&a.base)o=a.base;else{const c=Object.keys(i.content).map(Number).sort((h,f)=>f-h),l=Math.max(0,i.visitCount-1),u=c.find(h=>l>=h);u!==void 0&&(o=i.content[u])}o?(i.originalContent=o,i.currentContent=o,i.lastTransformedContent=null,i.appliedTransformationIds=[],i.contentVersion=(i.contentVersion||0)+1,i.transformationState="clean",console.log(`[EMERGENCY CONTENT RECOVERY] Content loaded for node ${n}:`,{originalLength:o.length,contentVersion:i.contentVersion,transformationState:i.transformationState,contentPreview:o.substring(0,100)+"..."})):(console.error(`[EMERGENCY CONTENT RECOVERY] Failed to extract content for node ${n}`),i.currentContent=null,i.transformationState="corrupted")}e.loading=!1}),s.addCase(ae.rejected,(e,t)=>{e.loading=!1,e.error=t.payload})}}),{visitNode:fn,revealConnection:pn,applyTransformation:dn,evaluateTransformations:mn,applyJourneyTransformations:gn,updateContentVariant:yn,recoverNodeContent:Cn,validateNodeContent:vn,resetNodes:Tn}=Be.actions,bn=(s,e)=>s.nodes.data[e],rn=Z(s=>s.nodes.data,s=>Object.values(s)),En=Z(s=>s.nodes.data,s=>{const e=[];return Object.values(s).forEach(t=>{t.revealedConnections.forEach(n=>{e.some(a=>a.start===t.id&&a.end===n||a.start===n&&a.end===t.id)||e.push({start:t.id,end:n})})}),e}),wn=Z([rn],s=>{const e=s.length,t=15;return s.map((n,r)=>{const a=r/e*2*Math.PI,i=t*Math.cos(a),o=t*Math.sin(a);let c="#ffffff";return n.character==="Archaeologist"&&(c="#ff6b6b"),n.character==="Algorithm"&&(c="#4ecdc4"),n.character==="LastHuman"&&(c="#45b7d1"),{...n,x:i,y:o,color:c}})}),An=Be.reducer;function sn(s){return s<=3?"past":s<=6?"present":"future"}const Je={sequence:[],revisitPatterns:{},attractorsEngaged:{},detailedVisits:[],transitions:[],characterFocus:{},temporalLayerFocus:{},patternSequences:{repeatedSequences:[],characterSequences:[],temporalSequences:[]}},an={path:Je,currentNodeId:null,previousNodeId:null,endpointProgress:{past:0,present:0,future:0},attractorEngagement:{},visited:[]},Ke=ge({name:"reader",initialState:an,reducers:{navigateToNode:(s,e)=>{const{nodeId:t,character:n,temporalValue:r}=e.payload,a=sn(r);if(s.currentNodeId){const u={from:s.currentNodeId,to:t,attractorsEngaged:[]};s.path.transitions||(s.path.transitions=[]),s.path.transitions.push(u),s.previousNodeId=s.currentNodeId}s.currentNodeId=t,s.path.sequence.push(t);const i=(s.path.revisitPatterns[t]||0)+1;s.path.revisitPatterns[t]=i,s.path.characterFocus||(s.path.characterFocus={}),s.path.characterFocus[n]=(s.path.characterFocus[n]||0)+1,s.path.temporalLayerFocus||(s.path.temporalLayerFocus={}),s.path.temporalLayerFocus[a]=(s.path.temporalLayerFocus[a]||0)+1;const o={nodeId:t,character:n,temporalLayer:a,engagedAttractors:[],index:s.path.sequence.length-1,revisitCount:i};s.path.detailedVisits||(s.path.detailedVisits=[]),s.path.detailedVisits.push(o),s.path.patternSequences||(s.path.patternSequences={repeatedSequences:[],characterSequences:[],temporalSequences:[]}),Array.isArray(s.path.patternSequences.characterSequences)||(s.path.patternSequences.characterSequences=[]),Array.isArray(s.path.patternSequences.temporalSequences)||(s.path.patternSequences.temporalSequences=[]);const c=s.path.patternSequences.characterSequences[0]||[];c.push(n),s.path.patternSequences.characterSequences[0]=c;const l=s.path.patternSequences.temporalSequences[0]||[];l.push(a),s.path.patternSequences.temporalSequences[0]=l},addVisitedNode:(s,e)=>{const t=e.payload,n=s.visited??[];if(n.length>0&&n[0].id===t.id)return;const r=n.filter(a=>a.id!==t.id);s.visited=[t,...r].slice(0,25)},engageAttractor:(s,e)=>{const t=e.payload;if(s.path.attractorsEngaged[t]=(s.path.attractorsEngaged[t]||0)+1,s.attractorEngagement[t]=(s.attractorEngagement[t]||0)+1,s.path.detailedVisits&&s.path.detailedVisits.length>0){const n=s.path.detailedVisits[s.path.detailedVisits.length-1];n.engagedAttractors.includes(t)||n.engagedAttractors.push(t)}if(s.path.transitions&&s.path.transitions.length>0){const n=s.path.transitions[s.path.transitions.length-1];n.attractorsEngaged.includes(t)||n.attractorsEngaged.push(t)}},updateEndpointProgress:(s,e)=>{const{orientation:t,value:n}=e.payload;s.endpointProgress[t]=Math.min(100,Math.max(0,n))},resetReader:s=>{s.path=Je,s.currentNodeId=null,s.previousNodeId=null,s.endpointProgress={past:0,present:0,future:0},s.attractorEngagement={}},analyzePatterns:s=>{const{sequence:e}=s.path;if(e.length>=4){const t=[];for(let n=2;n<=Math.floor(e.length/2);n++)for(let r=0;r<=e.length-n*2;r++){const a=e.slice(r,r+n);for(let i=r+n;i<=e.length-n;i++){const o=e.slice(i,i+n);if(a.every((c,l)=>c===o[l])){t.some(l=>l.length===a.length&&l.every((u,h)=>u===a[h]))||t.push(a);break}}}s.path.patternSequences||(s.path.patternSequences={repeatedSequences:[],characterSequences:[],temporalSequences:[]}),s.path.patternSequences.repeatedSequences=t}}}}),{navigateToNode:Pn,engageAttractor:$n,updateEndpointProgress:Sn,resetReader:kn,analyzePatterns:Mn,addVisitedNode:Rn}=Ke.actions,xn=s=>s.reader.currentNodeId,_n=(s,e)=>s.reader.path.revisitPatterns[e]||0,On=s=>s.reader.visited,Vn=Ke.reducer,Me={viewMode:"constellation",showMiniConstellation:!0,showMetaInterface:!1,hoveredNodeId:null,selectedNodeId:null,lastInteraction:0,showStrangeAttractors:!1,constellationZoom:1,constellationRotation:{x:0,y:0,z:0},textSize:"medium",highContrast:!1,animations:"full",transitionSpeed:500,helpModalOpen:!1,aboutModalOpen:!1,isInitialChoicePhase:!0},We=ge({name:"interface",initialState:Me,reducers:{setViewMode:(s,e)=>{s.viewMode=e.payload},toggleMiniConstellation:s=>{s.showMiniConstellation=!s.showMiniConstellation},toggleMetaInterface:s=>{s.showMetaInterface=!s.showMetaInterface},toggleStrangeAttractors:s=>{s.showStrangeAttractors=!s.showStrangeAttractors},setConstellationZoom:(s,e)=>{s.constellationZoom=Math.max(.5,Math.min(2.5,e.payload))},setConstellationRotation:(s,e)=>{const{x:t,y:n,z:r}=e.payload;t!==void 0&&(s.constellationRotation.x=t),n!==void 0&&(s.constellationRotation.y=n),r!==void 0&&(s.constellationRotation.z=r)},setTextSize:(s,e)=>{s.textSize=e.payload},toggleHighContrast:s=>{s.highContrast=!s.highContrast},setAnimations:(s,e)=>{s.animations=e.payload},setTransitionSpeed:(s,e)=>{s.transitionSpeed=Math.max(0,Math.min(1e3,e.payload))},toggleHelpModal:s=>{s.helpModalOpen=!s.helpModalOpen},toggleAboutModal:s=>{s.aboutModalOpen=!s.aboutModalOpen},resetInterface:()=>Me,nodeHovered:(s,e)=>{s.hoveredNodeId=e.payload,s.lastInteraction=Date.now()},nodeUnhovered:s=>{s.hoveredNodeId=null},nodeSelected:(s,e)=>{s.selectedNodeId!==e.payload&&(s.selectedNodeId=e.payload,s.viewMode="reading",s.lastInteraction=Date.now(),s.isInitialChoicePhase&&(s.isInitialChoicePhase=!1))},returnToConstellation:s=>{s.viewMode="constellation"},setInitialChoicePhaseCompleted:s=>{s.isInitialChoicePhase=!1}}}),{setViewMode:jn,toggleMiniConstellation:Fn,toggleMetaInterface:Nn,toggleStrangeAttractors:In,setConstellationZoom:qn,setConstellationRotation:zn,setTextSize:Dn,toggleHighContrast:Hn,setAnimations:Ln,setTransitionSpeed:Bn,toggleHelpModal:Jn,toggleAboutModal:Kn,resetInterface:Wn,nodeHovered:Un,nodeUnhovered:Gn,nodeSelected:Yn,returnToConstellation:Xn,setInitialChoicePhaseCompleted:Qn}=We.actions,Zn=s=>s.interface.viewMode,er=s=>s.interface.hoveredNodeId,tr=s=>s.interface.selectedNodeId,nr=s=>s.interface.isInitialChoicePhase,rr=We.reducer;export{En as A,nr as B,Cn as C,vn as D,ae as E,Rn as F,Xn as G,On as H,hn as I,tr as a,Un as b,Yn as c,jn as d,Pn as e,xn as f,bn as g,_n as h,$n as i,dn as j,en as k,gn as l,mn as m,Gn as n,un as o,rr as p,Vn as q,pn as r,er as s,pe as t,yn as u,fn as v,An as w,Zn as x,se as y,wn as z};
//# sourceMappingURL=constellation-CzSJAdlk.js.map
