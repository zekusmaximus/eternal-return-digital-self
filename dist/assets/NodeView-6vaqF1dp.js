const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/markdown-vendor-Bfyu7to_.js","assets/three-vendor-rJ5vKMTC.js","assets/react-vendor-DaKsb8LL.js","assets/MiniConstellation-B21NH0sn.js","assets/constellation-CzSJAdlk.js","assets/node-view-XdiLjT_l.js","assets/node-view-CrwFC8Ay.css","assets/MarginaliaSidebar-CTlZkFAr.js","assets/NarramorphRenderer-CE8Mlc4A.js","assets/narramorph-Cw55D6_f.js","assets/narramorph-DivzNTyX.css"])))=>i.map(i=>d[i]);
import{j as t,_ as L}from"./three-vendor-rJ5vKMTC.js";import{b as r,u as K,j as k}from"./react-vendor-DaKsb8LL.js";import{u as Q}from"./narramorph-Cw55D6_f.js";import{C as A,D as J,a as X,x as Y,g as Z,E as ee,v as te,F as ne,G as re}from"./constellation-CzSJAdlk.js";import{v as ie}from"./app-Blk9s7Pp.js";import{u as se}from"./node-view-XdiLjT_l.js";class oe extends r.Component{constructor(n){super(n),this.state={hasError:!1,error:null}}static getDerivedStateFromError(n){return{hasError:!0,error:n}}componentDidCatch(n,a){console.error("ErrorBoundary caught an error:",n),console.error("Component stack:",a.componentStack)}render(){return this.state.hasError?this.props.fallback:this.props.children}}function ae(s){return s?[s.includes("[object Object]"),s.includes("undefined"),s.includes('<span class="glitch-text"><span class="glitch-text">'),s.match(/<<\*\*span\*\*/g),s.length<10,s.split("<span").length>10].some(a=>a):!0}function le(s){if(!s)return"";try{let n=s;return n=n.replace(/\*#\s*/g,""),n=n.replace(/\s{2,}/g," "),n=n.split(`
`).map(a=>a.trim()).join(`
`),n=n.replace(/\n\s*\n\s*\n/g,`

`),n.trim()}catch(n){return console.error("[ContentSanitizer] Error sanitizing display content:",n),s}}const ce=({children:s,transformations:n,nodeId:a})=>{const[e,C]=r.useState(0),[g,y]=r.useState(!1),[v,N]=r.useState("");r.useEffect(()=>{const c=n.map(i=>`${i.type}-${i.selector||"no-selector"}-${JSON.stringify(i)}`).sort().join("|");if(c!==v)if(n.length>e){y(!0);const i=setTimeout(()=>{y(!1)},2e3);return C(n.length),N(c),()=>clearTimeout(i)}else C(n.length),N(c)},[n,v,e]);const S=()=>{if(n.length===0)return"";const c={};n.forEach(f=>{c[f.type]=(c[f.type]||0)+1});const i=[];return c.replace&&i.push(`${c.replace} replacements`),c.emphasize&&i.push(`${c.emphasize} emphasis`),c.expand&&i.push(`${c.expand} expansions`),c.fragment&&i.push(`${c.fragment} fragmentations`),c.metaComment&&i.push(`${c.metaComment} comments`),i.join(", ")};return t.jsxs("div",{className:`simple-transformation-container ${g?"newly-transformed":""}`,"data-transformation-count":n.length,"data-node-id":a,children:[n.length>0&&t.jsxs("div",{className:`transformation-indicator ${g?"active":""}`,title:S(),children:[t.jsx("span",{className:"transformation-count",children:n.length}),g&&n.length>e&&t.jsxs("span",{className:"transformation-change",children:["+",n.length-e]})]}),t.jsx("div",{className:"simple-transformation-content",children:s}),g&&t.jsx("div",{className:"transformation-overlay","aria-hidden":"true"})]})};function de({nodeId:s,onRenderComplete:n,onVisibilityChange:a}){const{node:e,transformedContent:C,appliedTransformations:g}=Q(s),[y,v]=r.useState(""),[N,S]=r.useState(!0),[c,i]=r.useState(!0),[f,b]=r.useState(!1),[R,T]=r.useState(0),p=r.useRef(null),w=r.useRef(!1),j=K();return k(h=>h.reader.path),r.useEffect(()=>{w.current=!1},[e==null?void 0:e.id]),r.useEffect(()=>{if(e!=null&&e.currentContent||e!=null&&e.originalContent){i(!0),b(!1);try{const h=e.originalContent||e.currentContent||"";if(ae(h))if(b(!0),e.originalContent&&e.originalContent!==h){j(A(e.id));return}else{v("⚠️ Content temporarily unavailable. Please refresh to restore."),i(!1);return}const V=le(C||h);v(V),j(J(e.id)),T(m=>m+1),i(!1),S(!0),w.current||(w.current=!0,n&&setTimeout(n,10),a&&a(!0))}catch(h){console.error("[SimpleTextRenderer] Error processing content:",h),b(!0),v("❌ Content processing error. Please refresh to restore."),i(!1)}}},[e==null?void 0:e.currentContent,e==null?void 0:e.originalContent,e==null?void 0:e.id,C,j,n,a]),!e||!e.currentContent?t.jsx("div",{className:"simple-renderer-loading",children:"Loading narrative content..."}):t.jsxs("div",{className:`simple-renderer-container ${N?"is-visible":""}`,"data-node-id":e.id,"data-render-count":R,style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px"},children:[t.jsxs(ce,{transformations:g,nodeId:e.id,children:[c&&t.jsxs("div",{className:"simple-renderer-loading",style:{padding:"20px 0"},children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Preparing narrative content..."})]}),f&&t.jsxs("div",{className:"content-corruption-warning",style:{padding:"15px",margin:"10px 0",backgroundColor:"#fff3cd",border:"1px solid #ffeeba",borderRadius:"4px",color:"#856404"},children:[t.jsx("strong",{children:"⚠️ Content Recovery Mode"}),t.jsx("p",{children:"Content corruption detected. Attempting recovery..."})]}),t.jsx("div",{ref:p,className:"simple-renderer-content","data-transformations-count":g.length,"data-corruption-detected":f,style:{display:"block",visibility:"visible",opacity:f?.7:1},children:t.jsx("div",{dangerouslySetInnerHTML:{__html:y},className:"content-inner"})})]}),!1]})}function I(s){return"memory"in s}const H=r.lazy(()=>(console.log("[NodeView] Loading ReactMarkdown component"),L(()=>import("./markdown-vendor-Bfyu7to_.js").then(s=>s.i),__vite__mapDeps([0,1,2])).then(s=>(console.log("[NodeView] ReactMarkdown component loaded"),s)))),ue=r.lazy(()=>L(()=>import("./MiniConstellation-B21NH0sn.js"),__vite__mapDeps([3,1,2,4,5,6]))),pe=r.lazy(()=>L(()=>import("./MarginaliaSidebar-CTlZkFAr.js"),__vite__mapDeps([7,1,2,4,5,6]))),O=L(()=>import("./NarramorphRenderer-CE8Mlc4A.js"),__vite__mapDeps([8,1,2,9,4,10])),me=r.lazy(()=>(console.log("[NodeView] Loading NarramorphRenderer component"),O.then(s=>(console.log("[NodeView] NarramorphRenderer component loaded"),s)))),P=L(()=>import("./markdown-vendor-Bfyu7to_.js").then(s=>s.a),__vite__mapDeps([0,1,2])).then(s=>(console.log("[NodeView] remark-gfm plugin loaded"),s.default)),fe=()=>t.jsxs("div",{className:"content-loading",children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Loading content..."})]}),D=()=>t.jsx("div",{className:"side-component-loading"}),xe=()=>{var _;const s=se(),n=k(X),a=k(Y),e=k(o=>n?Z(o,n):null),C=r.useMemo(()=>ie.getUniqueViewKey(),[]),[g,y]=r.useState(!1),[v,N]=r.useState(!1),[S,c]=r.useState(!0),i=r.useRef(null),f=r.useRef(!1),b=r.useRef(null),R=r.useRef(!1),T=r.useRef(null),[p,w]=r.useState({transitionTime:Date.now(),lastViewMode:a,transitionCount:0,renderCount:0}),[j,h]=r.useState({jsHeapSizeLimit:0,totalJSHeapSize:0,usedJSHeapSize:0,timestamp:0}),z=r.useCallback(o=>{if(console.log(`[NodeView] Content visibility changed to: ${o?"visible":"hidden"}`),!o&&i.current){console.warn("[NodeView] Forcing content visibility after hidden state detected"),i.current.style.display="block",i.current.style.visibility="visible",i.current.style.opacity="1";return}},[]),[V,m]=r.useState({loadStarted:!1,contentLoaded:!1,renderStarted:!1,narramorphActivated:!1,visibilityIssue:!1,errorOccurred:!1}),B=r.useCallback(()=>{if(f.current){console.log("[NodeView] Skipping duplicate onRenderComplete call");return}f.current=!0,console.log("[NodeView] SimpleTextRenderer completed rendering"),i.current&&(console.log("[NodeView] Forcing container visibility after render complete"),i.current.style.display="block",i.current.style.visibility="visible",i.current.style.opacity="1"),m(o=>({...o,visibilityIssue:!1})),setTimeout(()=>{if(i.current){const o=i.current.offsetParent!==null&&window.getComputedStyle(i.current).display!=="none"&&window.getComputedStyle(i.current).visibility!=="hidden";console.log(`[NodeView] Post-render visibility check: ${o?"visible":"not visible"}`),o||(console.warn("[NodeView] Content became invisible after render - forcing visibility"),i.current.style.display="block",i.current.style.visibility="visible",i.current.style.opacity="1")}},500)},[]);r.useEffect(()=>{n!==b.current&&(f.current=!1,b.current=n,R.current=!1)},[n]),r.useEffect(()=>{if(p.lastViewMode!==a){const o=Date.now();if(console.log(`[NodeView] View transition: ${p.lastViewMode} -> ${a} at ${o}`),w(l=>({...l,lastViewMode:a,transitionTime:o,transitionCount:l.transitionCount+1,renderCount:l.renderCount+1})),m({loadStarted:!1,contentLoaded:!1,renderStarted:!1,narramorphActivated:!1,visibilityIssue:!1,errorOccurred:!1}),I(performance)&&performance.memory){const l=performance.memory;h({jsHeapSizeLimit:l.jsHeapSizeLimit,totalJSHeapSize:l.totalJSHeapSize,usedJSHeapSize:l.usedJSHeapSize,timestamp:o})}}else w(o=>({...o,renderCount:o.renderCount+1}))},[a,p.lastViewMode]),r.useEffect(()=>{n&&!(e!=null&&e.content)&&(console.log(`[NodeView] Loading content for node: ${n}`,{viewMode:a}),m(l=>({...l,loadStarted:!0})),s(ee(n)))},[n,s,a,e==null?void 0:e.content]);const x=((_=e==null?void 0:e.currentContent)==null?void 0:_.length)||0,M=r.useMemo(()=>e!=null&&e.currentContent?e.currentContent.includes("[object Object]")||e.currentContent.includes("undefined")||e.currentContent.length<10:!1,[e==null?void 0:e.currentContent]),$=r.useMemo(()=>{var o;return((o=e==null?void 0:e.currentContent)==null?void 0:o.substring(0,50))||"NO CONTENT"},[e==null?void 0:e.currentContent]);r.useEffect(()=>{if(e!=null&&e.id&&b.current===n){const o=x>0;console.log(`[NodeView] Content processed for node: ${n}`,{hasContent:o,visitCount:e.visitCount,contentLength:x,contentPreview:$,enhancedContentExists:!!e.enhancedContent,contentExists:!!e.content}),m(l=>({...l,contentLoaded:o})),o&&M&&console.error("[NodeView] Possible content corruption detected:",{contentStart:$,contentLength:x})}},[n,e==null?void 0:e.id,e==null?void 0:e.visitCount,e==null?void 0:e.content,e==null?void 0:e.enhancedContent,x,$,M]),r.useEffect(()=>{if(e!=null&&e.id&&x>0&&!R.current){console.log(`[NodeView] Preparing to activate Narramorph for node: ${e.id}`,{viewMode:a,hasContent:x>0}),m(d=>({...d,renderStarted:!0})),R.current=!0;let o=!1;console.log("[NodeView] Preloading NarramorphRenderer component"),O.then(()=>{if(o=!0,console.log("[NodeView] NarramorphRenderer preload complete"),e!=null&&e.id&&(console.log(`[NodeView] Activating Narramorph renderer for node: ${e.id} after preload`),y(!0),m(d=>({...d,narramorphActivated:!0})),i.current)){const d=i.current.getBoundingClientRect();console.log("[NodeView] Post-preload container dimensions:",{width:d.width,height:d.height,display:window.getComputedStyle(i.current).display,visibility:window.getComputedStyle(i.current).visibility})}}).catch(d=>{console.error("[NodeView] Error preloading NarramorphRenderer:",d),c(!0)});const l=setTimeout(()=>{if(i.current){console.log("[NodeView] Force checking content visibility");const d=i.current.offsetParent!==null,u=i.current.getBoundingClientRect(),E=window.getComputedStyle(i.current);console.log("[NodeView] Content visibility check:",{isVisible:d,width:u.width,height:u.height,display:E.display,visibility:E.visibility,zIndex:E.zIndex,position:E.position,opacity:E.opacity,componentLoaded:o}),(!d||u.width===0||u.height===0)&&(console.warn("[NodeView] Content invisible after rendering - forcing simple renderer"),c(!0),m(q=>({...q,visibilityIssue:!0})))}},1500);return()=>clearTimeout(l)}},[x,e==null?void 0:e.id,a]),r.useEffect(()=>{if(!(e!=null&&e.id)||e.id===T.current)return;s(te(e.id));const o=e.currentContent??"",l=e.title??"",d=o.replace(/<[^>]*>/g,"").replace(/\s+/g," ").trim().slice(0,100);s(ne({id:e.id,title:l,synopsis:d})),T.current=e.id},[s,e==null?void 0:e.id]),r.useEffect(()=>{e!=null&&e.id&&(e!=null&&e.currentContent)&&(s(J(e.id)),e.transformationState==="corrupted"&&e.originalContent&&(console.warn(`[NodeView] Content corruption detected for node ${e.id}, initiating recovery`),s(A(e.id))))},[e==null?void 0:e.id,e==null?void 0:e.currentContent,e==null?void 0:e.transformationState,e==null?void 0:e.originalContent,s]),r.useEffect(()=>{const o=l=>{var d;if(l.message&&(l.message.includes("WebGL context lost")||l.message.includes("THREE.WebGLRenderer"))&&(console.error("[NodeView] WebGL context loss detected!",{message:l.message,stack:((d=l.error)==null?void 0:d.stack)||"No stack trace",viewMode:a,timeElapsed:Date.now()-p.transitionTime+"ms",renderCount:p.renderCount}),N(!0),y(!1),m(u=>({...u,errorOccurred:!0})),I(performance)&&performance.memory)){const u=performance.memory;h({jsHeapSizeLimit:u.jsHeapSizeLimit,totalJSHeapSize:u.totalJSHeapSize,usedJSHeapSize:u.usedJSHeapSize,timestamp:Date.now()}),console.log("[NodeView] Memory usage at WebGL error:",{usedHeap:Math.round(u.usedJSHeapSize/1048576)+"MB",totalHeap:Math.round(u.totalJSHeapSize/1048576)+"MB",limit:Math.round(u.jsHeapSizeLimit/1048576)+"MB"})}};return window.addEventListener("error",o),()=>{window.removeEventListener("error",o)}},[a,p.renderCount,p.transitionTime]);const G=()=>{s(re())};if(a!=="reading"||!e)return null;const F=`${e.character.toLowerCase()}-theme`,W=()=>e.temporalValue<=3?"past-indicator":e.temporalValue<=6?"present-indicator":"future-indicator",U=()=>e.currentContent?t.jsxs("div",{ref:i,className:`content-container ${e.currentState}`,"data-content-loaded":"true","data-node-id":e.id,"data-visit-count":e.visitCount,style:{position:"relative",visibility:"visible",display:"block"},children:[S?t.jsx("div",{className:"simple-renderer-wrapper",style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px",opacity:1,zIndex:5},children:t.jsx(de,{nodeId:e.id,onRenderComplete:B,onVisibilityChange:z},`simple-${e.id}-${e.visitCount}`)}):t.jsx(r.Suspense,{fallback:t.jsx(fe,{}),children:g&&!v?t.jsx(oe,{fallback:t.jsxs("div",{className:"fallback-content",style:{visibility:"visible",display:"block"},children:[t.jsx("p",{className:"error-notice",children:"Advanced rendering unavailable - showing basic content"}),t.jsx(H,{remarkPlugins:[()=>P],children:e.currentContent})]}),children:t.jsx("div",{style:{minHeight:"200px",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(me,{nodeId:e.id,onVisibilityChange:o=>{console.log(`[NodeView] Content visibility changed to: ${o?"visible":"hidden"}`);const l=setTimeout(()=>{i.current&&(m(d=>({...d,visibilityIssue:!o})),o||c(!0))},1e3);return()=>clearTimeout(l)}},`narramorph-${e.id}-${e.visitCount}`)})}):t.jsxs("div",{style:{visibility:"visible",display:"block",position:"relative",minHeight:"100px"},children:[t.jsxs("div",{className:"content-loading",style:{marginBottom:"10px"},children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Preparing content..."})]}),t.jsx(H,{remarkPlugins:[()=>P],children:e.currentContent},`markdown-${e.id}-${e.visitCount}`)]})}),t.jsxs("div",{className:"debug-indicator",children:[t.jsx("div",{className:`status-dot ${V.contentLoaded?"status-green":"status-red"}`,title:"Content loaded"}),t.jsx("div",{className:`status-dot ${V.narramorphActivated?"status-green":"status-yellow"}`,title:"Narramorph active"}),t.jsx("div",{className:`status-dot ${V.errorOccurred?"status-red":"status-green"}`,title:"No errors"}),t.jsx("div",{className:`status-dot ${V.visibilityIssue?"status-red":"status-green"}`,title:"Content visible"}),t.jsx("div",{className:`status-dot ${S?"status-blue":"status-yellow"}`,title:"Simple renderer"}),t.jsx("div",{className:"status-dot status-green",title:"WebGL available"}),t.jsxs("div",{className:"debug-metrics",children:[t.jsxs("span",{title:"View transition count",children:["T:",p.transitionCount]}),t.jsxs("span",{title:"Render count",children:["R:",p.renderCount]}),j.usedJSHeapSize>0&&t.jsxs("span",{title:"Memory usage",children:["M:",Math.round(j.usedJSHeapSize/(1024*1024)),"MB"]})]})]})]}):t.jsx("div",{className:"node-loading",children:t.jsx("span",{children:"Loading narrative fragment..."})});return t.jsxs("div",{className:`node-view-container ${F}`,children:[t.jsx("div",{className:`temporal-indicator ${W()}`}),t.jsxs("div",{className:"node-header",children:[t.jsx("h1",{children:e.title}),t.jsxs("div",{className:"node-metadata",children:[t.jsx("span",{className:"node-character",children:e.character}),t.jsx("span",{className:"node-state",children:e.currentState}),t.jsxs("span",{className:"node-visits",children:["Visits: ",e.visitCount]})]})]}),t.jsx("div",{className:"node-content force-visible",style:{position:"relative"},children:U()}),t.jsx("div",{className:"node-navigation",children:t.jsx("button",{onClick:G,className:"navigation-button",children:"Return to Constellation"})}),t.jsx("div",{style:{position:"absolute",bottom:"20px",right:"20px",width:"300px",height:"300px",pointerEvents:"auto"},children:t.jsx(r.Suspense,{fallback:t.jsx(D,{}),children:t.jsx(ue,{})})}),t.jsx(r.Suspense,{fallback:t.jsx(D,{}),children:t.jsx(pe,{nodeId:e.id,strangeAttractors:e.strangeAttractors})})]},C)};export{xe as default};
//# sourceMappingURL=NodeView-6vaqF1dp.js.map
