import{u as M,b as a,j as S}from"./react-vendor-DaKsb8LL.js";import{f as z,g as D,h as V,e as I,v as O,d as B,r as F,i as J,j as H,t as R,k,l as K,m as L}from"./constellation-C0uHALRD.js";import{j as g}from"./three-vendor-B0HHzWfL.js";const G=x=>{const n=M(),[m,f]=a.useState([]),[p,N]=a.useState(!1),i=a.useRef(new Set),C=a.useRef(0),T=S(z),s=x||T,e=S(t=>s?D(t,s):null),$=S(t=>t.nodes.data),j=S(t=>s?V(t,s):0),l=S(t=>t.reader),h=a.useCallback(t=>{const r=$[t];r?(n(I({nodeId:t,character:r.character,temporalValue:r.temporalValue,attractors:r.strangeAttractors})),n(O(t)),n(B("reading")),console.log(`Navigating to node: ${t}`)):console.error(`Could not navigate to node: ${t} - node data not found`)},[n,$]),A=a.useCallback((t,r)=>{n(F({nodeId:t,targetId:r}))},[n]),E=a.useCallback(t=>{n(J(t))},[n]),v=a.useCallback((t,r)=>{n(H({nodeId:t,transformation:r}))},[n]),w=a.useMemo(()=>e?e.revealedConnections:[],[e]),o=a.useMemo(()=>{if(!(e!=null&&e.currentContent))return[];try{const t={},r=R.calculateAllTransformations(e.currentContent,e,l,t);return console.log(`[useNodeState] Master transformation integration calculated ${r.length} transformations for node ${e.id}`),r}catch(t){return console.error(`[useNodeState] Error in master transformation calculation for node ${e.id}:`,t),[]}},[e,l]),c=a.useMemo(()=>{if(!(e!=null&&e.currentContent))return(e==null?void 0:e.currentContent)||null;try{const t={},r=R.getTransformedContent(e,l,t);return r!==e.currentContent&&o.length>0?k.wrapTransformedContent(r,o):r}catch(t){return console.error(`[useNodeState] Error in master content transformation for node ${e.id}:`,t),(e==null?void 0:e.currentContent)||null}},[e,l,o]);a.useEffect(()=>{if(!e||o.length===0)return;JSON.stringify(m)!==JSON.stringify(o)&&(f(o),N(!0))},[e,o,m]),a.useEffect(()=>{if(p){const t=setTimeout(()=>{N(!1)},2e3);return()=>clearTimeout(t)}},[p]),a.useEffect(()=>{if(!e||!s)return;const t=Date.now();if(t-C.current<500)return;if(e.currentContent&&(e.currentContent.includes("data-transform-type")||e.currentContent.includes("narramorph-")||e.currentContent.includes("[TransformationService]")||e.currentContent.includes("recursive loop detected")||e.currentContent.includes("temporal displacement"))){console.log(`[useNodeState] Content already transformed for node ${s}, skipping to prevent infinite loop`);return}const r=`${s}-${e.visitCount}`;if(i.current.has(r)){console.log(`[useNodeState] Skipping already applied transformations for ${r}`);return}if(console.log(`[useNodeState] Applying transformations for node ${s} (visitCount: ${e.visitCount})`),C.current=t,i.current.add(r),i.current.size>50){const y=Array.from(i.current).slice(-25);i.current.clear(),y.forEach(b=>i.current.add(b))}if(n(K({nodeId:s,readerState:l})),e.visitCount===1&&v(s,{condition:{visitCount:1},transformations:[{type:"emphasize",selector:"first-paragraph",emphasis:"italic"}]}),e.visitCount>=2&&e.visitCount<=5){const d=k.createTransformationsFromPatterns(l,e);if(d.length>0&&d.length<=3){const y={condition:{visitCount:e.visitCount},transformations:d};v(s,y)}}n(L({nodeId:s,readerState:l}))},[s,e,n,v,l]);const u=a.useCallback(t=>e?R.evaluateCondition(t,l,e):!1,[e,l]);return{node:e,navigateTo:h,revealNodeConnection:A,engageWithAttractor:E,applyNodeTransformation:v,evaluateCondition:u,neighbors:w,revisitCount:j,transformedContent:c,newlyTransformed:p,appliedTransformations:m}},Q=({children:x,transformations:n,isNewlyTransformed:m,nodeId:f})=>{const p=a.useRef(null),N=a.useRef(null),[i,C]=a.useState("idle"),[T,s]=a.useState(n.length),[e,$]=a.useState(0),[j,l]=a.useState(null),[h,A]=a.useState(!0);a.useEffect(()=>{if(e<3){const o=setTimeout(()=>{$(c=>c+1),console.log(`[AnimationContainer] Forced re-render for node: ${f}, attempt: ${e+1}`)},100);return()=>clearTimeout(o)}},[f,e]),a.useEffect(()=>{if(m){C("entering");const o=setTimeout(()=>{C("active")},1e3);return()=>clearTimeout(o)}},[m,n]),a.useEffect(()=>{C("idle"),s(n.length),console.log(`[AnimationContainer] Node changed to: ${f}, transformations: ${n.length}`)},[f,n.length]),a.useLayoutEffect(()=>{if(!p.current)return;const o=()=>{if(!p.current)return;const r=window.getComputedStyle(p.current),d=p.current.getBoundingClientRect(),y={width:d.width,height:d.height,visibility:r.visibility,display:r.display,opacity:r.opacity,position:r.position,zIndex:r.zIndex,overflow:r.overflow};l(y);const b=d.width>0&&d.height>0&&r.visibility!=="hidden"&&r.display!=="none"&&parseFloat(r.opacity)>0;A(b),h!==b&&console.log(`[AnimationContainer] Content visibility changed to: ${b?"visible":"hidden"}`,{nodeId:f,transformations:n.length,animationState:i,measurements:y})};o();const c=setTimeout(o,1100);let u=null;const t=new MutationObserver(r=>{r.length>2&&console.log(`[AnimationContainer] DOM mutations detected: ${r.length}`),u&&clearTimeout(u),u=window.setTimeout(()=>{o(),u=null},500)});return t.observe(p.current,{attributes:!0,childList:!0,subtree:!1}),()=>{clearTimeout(c),t.disconnect()}},[f,n,i,h]);const E=()=>{if(i==="idle")return"";const o=n.some(t=>t.type==="replace"),c=n.some(t=>t.type==="emphasize"),u=n.some(t=>t.type==="expand");return i==="entering"?o?"narramorph-container-replace-active":c?"narramorph-container-emphasis-active":u?"narramorph-container-expand-active":"narramorph-container-transform-active":"narramorph-container-active"},v=()=>{if(n.length===0)return"";const o={};n.forEach(u=>{o[u.type]=(o[u.type]||0)+1});const c=[];return o.replace&&c.push(`${o.replace} replacements`),o.emphasize&&c.push(`${o.emphasize} emphasis`),o.expand&&c.push(`${o.expand} expansions`),o.fragment&&c.push(`${o.fragment} fragmentations`),o.metaComment&&c.push(`${o.metaComment} comments`),c.join(", ")},w=n.length!==T;return a.useEffect(()=>{m&&console.log(`[AnimationContainer] Animation started for node: ${f}`,{transformations:n.length,animationState:i,contentVisible:h})},[m,f,n.length,i,h]),g.jsxs("div",{ref:p,className:`narramorph-animation-container ${E()}`,"data-transformation-count":n.length,"data-newly-transformed":m,"data-animation-state":i,"data-visible":h,"data-render-attempt":e,style:{overflow:"visible",minHeight:"150px",position:"relative",visibility:"visible",display:"block",opacity:1},children:[n.length>0&&g.jsxs("div",{className:`narramorph-transformation-indicator ${m?"active":""}`,title:v(),children:[g.jsx("span",{className:"transformation-count",children:n.length}),w&&g.jsxs("span",{className:"transformation-change-indicator",children:[n.length>T?"+":"",n.length-T]})]}),g.jsx("div",{ref:N,className:"narramorph-animation-content",style:{position:"relative",visibility:"visible",display:"block",opacity:1,minHeight:"100px"},children:e===0?g.jsx("div",{className:"animation-placeholder",style:{padding:"20px",textAlign:"center"},children:g.jsx("p",{children:"Preparing narrative..."})}):x}),!1]})};export{Q as T,G as u};
//# sourceMappingURL=narramorph-O3OmklI8.js.map
