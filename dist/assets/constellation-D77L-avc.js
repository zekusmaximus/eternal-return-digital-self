var Qe=Object.defineProperty;var Ze=(n,e,t)=>e in n?Qe(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var $=(n,e,t)=>Ze(n,typeof e!="symbol"?e+"":e,t);import"./three-vendor-B0HHzWfL.js";import{i as Ye,c as et,d as tt,e as ue,f as nt,h as rt}from"./react-vendor-DaKsb8LL.js";var Oe=Symbol.for("immer-nothing"),we=Symbol.for("immer-draftable"),M=Symbol.for("immer-state");function R(n,...e){throw new Error(`[Immer] minified error nr: ${n}. Full error at: https://bit.ly/3cXEKWf`)}var z=Object.getPrototypeOf;function j(n){return!!n&&!!n[M]}function O(n){var e;return n?Ve(n)||Array.isArray(n)||!!n[we]||!!((e=n.constructor)!=null&&e[we])||Y(n)||ee(n):!1}var st=Object.prototype.constructor.toString();function Ve(n){if(!n||typeof n!="object")return!1;const e=z(n);if(e===null)return!0;const t=Object.hasOwnProperty.call(e,"constructor")&&e.constructor;return t===Object?!0:typeof t=="function"&&Function.toString.call(t)===st}function G(n,e){Z(n)===0?Reflect.ownKeys(n).forEach(t=>{e(t,n[t],n)}):n.forEach((t,r)=>e(r,t,n))}function Z(n){const e=n[M];return e?e.type_:Array.isArray(n)?1:Y(n)?2:ee(n)?3:0}function he(n,e){return Z(n)===2?n.has(e):Object.prototype.hasOwnProperty.call(n,e)}function je(n,e,t){const r=Z(n);r===2?n.set(e,t):r===3?n.add(t):n[e]=t}function at(n,e){return n===e?n!==0||1/n===1/e:n!==n&&e!==e}function Y(n){return n instanceof Map}function ee(n){return n instanceof Set}function V(n){return n.copy_||n.base_}function fe(n,e){if(Y(n))return new Map(n);if(ee(n))return new Set(n);if(Array.isArray(n))return Array.prototype.slice.call(n);const t=Ve(n);if(e===!0||e==="class_only"&&!t){const r=Object.getOwnPropertyDescriptors(n);delete r[M];let s=Reflect.ownKeys(r);for(let i=0;i<s.length;i++){const a=s[i],o=r[a];o.writable===!1&&(o.writable=!0,o.configurable=!0),(o.get||o.set)&&(r[a]={configurable:!0,writable:!0,enumerable:o.enumerable,value:n[a]})}return Object.create(z(n),r)}else{const r=z(n);if(r!==null&&t)return{...n};const s=Object.create(r);return Object.assign(s,n)}}function ve(n,e=!1){return te(n)||j(n)||!O(n)||(Z(n)>1&&(n.set=n.add=n.clear=n.delete=it),Object.freeze(n),e&&Object.entries(n).forEach(([t,r])=>ve(r,!0))),n}function it(){R(2)}function te(n){return Object.isFrozen(n)}var ot={};function N(n){const e=ot[n];return e||R(0,n),e}var H;function Ne(){return H}function ct(n,e){return{drafts_:[],parent_:n,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function Ee(n,e){e&&(N("Patches"),n.patches_=[],n.inversePatches_=[],n.patchListener_=e)}function pe(n){de(n),n.drafts_.forEach(lt),n.drafts_=null}function de(n){n===H&&(H=n.parent_)}function Ae(n){return H=ct(H,n)}function lt(n){const e=n[M];e.type_===0||e.type_===1?e.revoke_():e.revoked_=!0}function Se(n,e){e.unfinalizedDrafts_=e.drafts_.length;const t=e.drafts_[0];return n!==void 0&&n!==t?(t[M].modified_&&(pe(e),R(4)),O(n)&&(n=X(e,n),e.parent_||Q(e,n)),e.patches_&&N("Patches").generateReplacementPatches_(t[M].base_,n,e.patches_,e.inversePatches_)):n=X(e,t,[]),pe(e),e.patches_&&e.patchListener_(e.patches_,e.inversePatches_),n!==Oe?n:void 0}function X(n,e,t){if(te(e))return e;const r=e[M];if(!r)return G(e,(s,i)=>Pe(n,r,e,s,i,t)),e;if(r.scope_!==n)return e;if(!r.modified_)return Q(n,r.base_,!0),r.base_;if(!r.finalized_){r.finalized_=!0,r.scope_.unfinalizedDrafts_--;const s=r.copy_;let i=s,a=!1;r.type_===3&&(i=new Set(s),s.clear(),a=!0),G(i,(o,c)=>Pe(n,r,s,o,c,t,a)),Q(n,s,!1),t&&n.patches_&&N("Patches").generatePatches_(r,t,n.patches_,n.inversePatches_)}return r.copy_}function Pe(n,e,t,r,s,i,a){if(j(s)){const o=i&&e&&e.type_!==3&&!he(e.assigned_,r)?i.concat(r):void 0,c=X(n,s,o);if(je(t,r,c),j(c))n.canAutoFreeze_=!1;else return}else a&&t.add(s);if(O(s)&&!te(s)){if(!n.immer_.autoFreeze_&&n.unfinalizedDrafts_<1)return;X(n,s),(!e||!e.scope_.parent_)&&typeof r!="symbol"&&Object.prototype.propertyIsEnumerable.call(t,r)&&Q(n,s)}}function Q(n,e,t=!1){!n.parent_&&n.immer_.autoFreeze_&&n.canAutoFreeze_&&ve(e,t)}function ut(n,e){const t=Array.isArray(n),r={type_:t?1:0,scope_:e?e.scope_:Ne(),modified_:!1,finalized_:!1,assigned_:{},parent_:e,base_:n,draft_:null,copy_:null,revoke_:null,isManual_:!1};let s=r,i=Ce;t&&(s=[r],i=L);const{revoke:a,proxy:o}=Proxy.revocable(s,i);return r.draft_=o,r.revoke_=a,o}var Ce={get(n,e){if(e===M)return n;const t=V(n);if(!he(t,e))return ht(n,t,e);const r=t[e];return n.finalized_||!O(r)?r:r===se(n.base_,e)?(ae(n),n.copy_[e]=ge(r,n)):r},has(n,e){return e in V(n)},ownKeys(n){return Reflect.ownKeys(V(n))},set(n,e,t){const r=ze(V(n),e);if(r!=null&&r.set)return r.set.call(n.draft_,t),!0;if(!n.modified_){const s=se(V(n),e),i=s==null?void 0:s[M];if(i&&i.base_===t)return n.copy_[e]=t,n.assigned_[e]=!1,!0;if(at(t,s)&&(t!==void 0||he(n.base_,e)))return!0;ae(n),me(n)}return n.copy_[e]===t&&(t!==void 0||e in n.copy_)||Number.isNaN(t)&&Number.isNaN(n.copy_[e])||(n.copy_[e]=t,n.assigned_[e]=!0),!0},deleteProperty(n,e){return se(n.base_,e)!==void 0||e in n.base_?(n.assigned_[e]=!1,ae(n),me(n)):delete n.assigned_[e],n.copy_&&delete n.copy_[e],!0},getOwnPropertyDescriptor(n,e){const t=V(n),r=Reflect.getOwnPropertyDescriptor(t,e);return r&&{writable:!0,configurable:n.type_!==1||e!=="length",enumerable:r.enumerable,value:t[e]}},defineProperty(){R(11)},getPrototypeOf(n){return z(n.base_)},setPrototypeOf(){R(12)}},L={};G(Ce,(n,e)=>{L[n]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}});L.deleteProperty=function(n,e){return L.set.call(this,n,e,void 0)};L.set=function(n,e,t){return Ce.set.call(this,n[0],e,t,n[0])};function se(n,e){const t=n[M];return(t?V(t):n)[e]}function ht(n,e,t){var s;const r=ze(e,t);return r?"value"in r?r.value:(s=r.get)==null?void 0:s.call(n.draft_):void 0}function ze(n,e){if(!(e in n))return;let t=z(n);for(;t;){const r=Object.getOwnPropertyDescriptor(t,e);if(r)return r;t=z(t)}}function me(n){n.modified_||(n.modified_=!0,n.parent_&&me(n.parent_))}function ae(n){n.copy_||(n.copy_=fe(n.base_,n.scope_.immer_.useStrictShallowCopy_))}var ft=class{constructor(n){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(e,t,r)=>{if(typeof e=="function"&&typeof t!="function"){const i=t;t=e;const a=this;return function(c=i,...u){return a.produce(c,l=>t.call(this,l,...u))}}typeof t!="function"&&R(6),r!==void 0&&typeof r!="function"&&R(7);let s;if(O(e)){const i=Ae(this),a=ge(e,void 0);let o=!0;try{s=t(a),o=!1}finally{o?pe(i):de(i)}return Ee(i,r),Se(s,i)}else if(!e||typeof e!="object"){if(s=t(e),s===void 0&&(s=e),s===Oe&&(s=void 0),this.autoFreeze_&&ve(s,!0),r){const i=[],a=[];N("Patches").generateReplacementPatches_(e,s,i,a),r(i,a)}return s}else R(1,e)},this.produceWithPatches=(e,t)=>{if(typeof e=="function")return(a,...o)=>this.produceWithPatches(a,c=>e(c,...o));let r,s;return[this.produce(e,t,(a,o)=>{r=a,s=o}),r,s]},typeof(n==null?void 0:n.autoFreeze)=="boolean"&&this.setAutoFreeze(n.autoFreeze),typeof(n==null?void 0:n.useStrictShallowCopy)=="boolean"&&this.setUseStrictShallowCopy(n.useStrictShallowCopy)}createDraft(n){O(n)||R(8),j(n)&&(n=pt(n));const e=Ae(this),t=ge(n,void 0);return t[M].isManual_=!0,de(e),t}finishDraft(n,e){const t=n&&n[M];(!t||!t.isManual_)&&R(9);const{scope_:r}=t;return Ee(r,e),Se(void 0,r)}setAutoFreeze(n){this.autoFreeze_=n}setUseStrictShallowCopy(n){this.useStrictShallowCopy_=n}applyPatches(n,e){let t;for(t=e.length-1;t>=0;t--){const s=e[t];if(s.path.length===0&&s.op==="replace"){n=s.value;break}}t>-1&&(e=e.slice(t+1));const r=N("Patches").applyPatches_;return j(n)?r(n,e):this.produce(n,s=>r(s,e))}};function ge(n,e){const t=Y(n)?N("MapSet").proxyMap_(n,e):ee(n)?N("MapSet").proxySet_(n,e):ut(n,e);return(e?e.scope_:Ne()).drafts_.push(t),t}function pt(n){return j(n)||R(10,n),Ie(n)}function Ie(n){if(!O(n)||te(n))return n;const e=n[M];let t;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,t=fe(n,e.scope_.immer_.useStrictShallowCopy_)}else t=fe(n,!0);return G(t,(r,s)=>{je(t,r,Ie(s))}),e&&(e.finalized_=!1),t}var x=new ft,Fe=x.produce;x.produceWithPatches.bind(x);x.setAutoFreeze.bind(x);x.setUseStrictShallowCopy.bind(x);x.applyPatches.bind(x);x.createDraft.bind(x);x.finishDraft.bind(x);function dt(n,e=`expected a function, instead received ${typeof n}`){if(typeof n!="function")throw new TypeError(e)}function mt(n,e=`expected an object, instead received ${typeof n}`){if(typeof n!="object")throw new TypeError(e)}function gt(n,e="expected all items to be functions, instead received the following types: "){if(!n.every(t=>typeof t=="function")){const t=n.map(r=>typeof r=="function"?`function ${r.name||"unnamed"}()`:typeof r).join(", ");throw new TypeError(`${e}[${t}]`)}}var $e=n=>Array.isArray(n)?n:[n];function yt(n){const e=Array.isArray(n[0])?n[0]:n;return gt(e,"createSelector expects all input-selectors to be functions, but received the following types: "),e}function vt(n,e){const t=[],{length:r}=n;for(let s=0;s<r;s++)t.push(n[s].apply(null,e));return t}var Ct=class{constructor(n){this.value=n}deref(){return this.value}},bt=typeof WeakRef<"u"?WeakRef:Ct,Tt=0,_e=1;function J(){return{s:Tt,v:void 0,o:null,p:null}}function De(n,e={}){let t=J();const{resultEqualityCheck:r}=e;let s,i=0;function a(){var h;let o=t;const{length:c}=arguments;for(let f=0,p=c;f<p;f++){const m=arguments[f];if(typeof m=="function"||typeof m=="object"&&m!==null){let d=o.o;d===null&&(o.o=d=new WeakMap);const g=d.get(m);g===void 0?(o=J(),d.set(m,o)):o=g}else{let d=o.p;d===null&&(o.p=d=new Map);const g=d.get(m);g===void 0?(o=J(),d.set(m,o)):o=g}}const u=o;let l;if(o.s===_e)l=o.v;else if(l=n.apply(null,arguments),i++,r){const f=((h=s==null?void 0:s.deref)==null?void 0:h.call(s))??s;f!=null&&r(f,l)&&(l=f,i!==0&&i--),s=typeof l=="object"&&l!==null||typeof l=="function"?new bt(l):l}return u.s=_e,u.v=l,l}return a.clearCache=()=>{t=J(),a.resetResultsCount()},a.resultsCount=()=>i,a.resetResultsCount=()=>{i=0},a}function wt(n,...e){const t=typeof n=="function"?{memoize:n,memoizeOptions:e}:n,r=(...s)=>{let i=0,a=0,o,c={},u=s.pop();typeof u=="object"&&(c=u,u=s.pop()),dt(u,`createSelector expects an output function after the inputs, but received: [${typeof u}]`);const l={...t,...c},{memoize:h,memoizeOptions:f=[],argsMemoize:p=De,argsMemoizeOptions:m=[]}=l,d=$e(f),g=$e(m),b=yt(s),E=h(function(){return i++,u.apply(null,arguments)},...d),v=p(function(){a++;const T=vt(b,arguments);return o=E.apply(null,T),o},...g);return Object.assign(v,{resultFunc:u,memoizedResultFunc:E,dependencies:b,dependencyRecomputations:()=>a,resetDependencyRecomputations:()=>{a=0},lastResult:()=>o,recomputations:()=>i,resetRecomputations:()=>{i=0},memoize:h,argsMemoize:p})};return Object.assign(r,{withTypes:()=>r}),r}var ne=wt(De),Et=Object.assign((n,e=ne)=>{mt(n,`createStructuredSelector expects first argument to be an object where each property is a selector, instead received a ${typeof n}`);const t=Object.keys(n),r=t.map(i=>n[i]);return e(r,(...i)=>i.reduce((a,o,c)=>(a[t[c]]=o,a),{}))},{withTypes:()=>Et});function He(n){return({dispatch:t,getState:r})=>s=>i=>typeof i=="function"?i(t,r,n):s(i)}var At=He(),St=He,Pt=typeof window<"u"&&window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__?window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__:function(){if(arguments.length!==0)return typeof arguments[0]=="object"?ue:ue.apply(null,arguments)},$t=n=>n&&typeof n.match=="function";function D(n,e){function t(...r){if(e){let s=e(...r);if(!s)throw new Error(q(0));return{type:n,payload:s.payload,..."meta"in s&&{meta:s.meta},..."error"in s&&{error:s.error}}}return{type:n,payload:r[0]}}return t.toString=()=>`${n}`,t.type=n,t.match=r=>rt(r)&&r.type===n,t}var Le=class F extends Array{constructor(...e){super(...e),Object.setPrototypeOf(this,F.prototype)}static get[Symbol.species](){return F}concat(...e){return super.concat.apply(this,e)}prepend(...e){return e.length===1&&Array.isArray(e[0])?new F(...e[0].concat(this)):new F(...e.concat(this))}};function Me(n){return O(n)?Fe(n,()=>{}):n}function W(n,e,t){return n.has(e)?n.get(e):n.set(e,t(e)).get(e)}function _t(n){return typeof n=="boolean"}var Mt=()=>function(e){const{thunk:t=!0,immutableCheck:r=!0,serializableCheck:s=!0,actionCreatorCheck:i=!0}=e??{};let a=new Le;return t&&(_t(t)?a.push(At):a.push(St(t.extraArgument))),a},xt="RTK_autoBatch",xe=n=>e=>{setTimeout(e,n)},kt=(n={type:"raf"})=>e=>(...t)=>{const r=e(...t);let s=!0,i=!1,a=!1;const o=new Set,c=n.type==="tick"?queueMicrotask:n.type==="raf"?typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame:xe(10):n.type==="callback"?n.queueNotification:xe(n.timeout),u=()=>{a=!1,i&&(i=!1,o.forEach(l=>l()))};return Object.assign({},r,{subscribe(l){const h=()=>s&&l(),f=r.subscribe(h);return o.add(l),()=>{f(),o.delete(l)}},dispatch(l){var h;try{return s=!((h=l==null?void 0:l.meta)!=null&&h[xt]),i=!s,i&&(a||(a=!0,c(u))),r.dispatch(l)}finally{s=!0}}})},Rt=n=>function(t){const{autoBatch:r=!0}=t??{};let s=new Le(n);return r&&s.push(kt(typeof r=="object"?r:void 0)),s};function dn(n){const e=Mt(),{reducer:t=void 0,middleware:r,devTools:s=!0,preloadedState:i=void 0,enhancers:a=void 0}=n||{};let o;if(typeof t=="function")o=t;else if(Ye(t))o=et(t);else throw new Error(q(1));let c;typeof r=="function"?c=r(e):c=e();let u=ue;s&&(u=Pt({trace:!1,...typeof s=="object"&&s}));const l=tt(...c),h=Rt(l);let f=typeof a=="function"?a(h):h();const p=u(...f);return nt(o,i,p)}function Be(n){const e={},t=[];let r;const s={addCase(i,a){const o=typeof i=="string"?i:i.type;if(!o)throw new Error(q(28));if(o in e)throw new Error(q(29));return e[o]=a,s},addMatcher(i,a){return t.push({matcher:i,reducer:a}),s},addDefaultCase(i){return r=i,s}};return n(s),[e,t,r]}function qt(n){return typeof n=="function"}function Ot(n,e){let[t,r,s]=Be(e),i;if(qt(n))i=()=>Me(n());else{const o=Me(n);i=()=>o}function a(o=i(),c){let u=[t[c.type],...r.filter(({matcher:l})=>l(c)).map(({reducer:l})=>l)];return u.filter(l=>!!l).length===0&&(u=[s]),u.reduce((l,h)=>{if(h)if(j(l)){const p=h(l,c);return p===void 0?l:p}else{if(O(l))return Fe(l,f=>h(f,c));{const f=h(l,c);if(f===void 0){if(l===null)return l;throw Error("A case reducer on a non-draftable value must not return undefined")}return f}}return l},o)}return a.getInitialState=i,a}var Vt=(n,e)=>$t(n)?n.match(e):n(e);function jt(...n){return e=>n.some(t=>Vt(t,e))}var Nt="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW",zt=(n=21)=>{let e="",t=n;for(;t--;)e+=Nt[Math.random()*64|0];return e},It=["name","message","stack","code"],ie=class{constructor(n,e){$(this,"_type");this.payload=n,this.meta=e}},ke=class{constructor(n,e){$(this,"_type");this.payload=n,this.meta=e}},Ft=n=>{if(typeof n=="object"&&n!==null){const e={};for(const t of It)typeof n[t]=="string"&&(e[t]=n[t]);return e}return{message:String(n)}},Re="External signal was aborted",Je=(()=>{function n(e,t,r){const s=D(e+"/fulfilled",(c,u,l,h)=>({payload:c,meta:{...h||{},arg:l,requestId:u,requestStatus:"fulfilled"}})),i=D(e+"/pending",(c,u,l)=>({payload:void 0,meta:{...l||{},arg:u,requestId:c,requestStatus:"pending"}})),a=D(e+"/rejected",(c,u,l,h,f)=>({payload:h,error:(r&&r.serializeError||Ft)(c||"Rejected"),meta:{...f||{},arg:l,requestId:u,rejectedWithValue:!!h,requestStatus:"rejected",aborted:(c==null?void 0:c.name)==="AbortError",condition:(c==null?void 0:c.name)==="ConditionError"}}));function o(c,{signal:u}={}){return(l,h,f)=>{const p=r!=null&&r.idGenerator?r.idGenerator(c):zt(),m=new AbortController;let d,g;function b(v){g=v,m.abort()}u&&(u.aborted?b(Re):u.addEventListener("abort",()=>b(Re),{once:!0}));const E=async function(){var T,A;let v;try{let C=(T=r==null?void 0:r.condition)==null?void 0:T.call(r,c,{getState:h,extra:f});if(Ht(C)&&(C=await C),C===!1||m.signal.aborted)throw{name:"ConditionError",message:"Aborted due to condition callback returning false."};const S=new Promise((w,k)=>{d=()=>{k({name:"AbortError",message:g||"Aborted"})},m.signal.addEventListener("abort",d)});l(i(p,c,(A=r==null?void 0:r.getPendingMeta)==null?void 0:A.call(r,{requestId:p,arg:c},{getState:h,extra:f}))),v=await Promise.race([S,Promise.resolve(t(c,{dispatch:l,getState:h,extra:f,requestId:p,signal:m.signal,abort:b,rejectWithValue:(w,k)=>new ie(w,k),fulfillWithValue:(w,k)=>new ke(w,k)})).then(w=>{if(w instanceof ie)throw w;return w instanceof ke?s(w.payload,p,c,w.meta):s(w,p,c)})])}catch(C){v=C instanceof ie?a(null,p,c,C.payload,C.meta):a(C,p,c)}finally{d&&m.signal.removeEventListener("abort",d)}return r&&!r.dispatchConditionRejection&&a.match(v)&&v.meta.condition||l(v),v}();return Object.assign(E,{abort:b,requestId:p,arg:c,unwrap(){return E.then(Dt)}})}}return Object.assign(o,{pending:i,rejected:a,fulfilled:s,settled:jt(a,s),typePrefix:e})}return n.withTypes=()=>n,n})();function Dt(n){if(n.meta&&n.meta.rejectedWithValue)throw n.payload;if(n.error)throw n.error;return n.payload}function Ht(n){return n!==null&&typeof n=="object"&&typeof n.then=="function"}var Lt=Symbol.for("rtk-slice-createasyncthunk");function Bt(n,e){return`${n}/${e}`}function Jt({creators:n}={}){var t;const e=(t=n==null?void 0:n.asyncThunk)==null?void 0:t[Lt];return function(s){const{name:i,reducerPath:a=i}=s;if(!i)throw new Error(q(11));const o=(typeof s.reducers=="function"?s.reducers(Ut()):s.reducers)||{},c=Object.keys(o),u={sliceCaseReducersByName:{},sliceCaseReducersByType:{},actionCreators:{},sliceMatchers:[]},l={addCase(y,T){const A=typeof y=="string"?y:y.type;if(!A)throw new Error(q(12));if(A in u.sliceCaseReducersByType)throw new Error(q(13));return u.sliceCaseReducersByType[A]=T,l},addMatcher(y,T){return u.sliceMatchers.push({matcher:y,reducer:T}),l},exposeAction(y,T){return u.actionCreators[y]=T,l},exposeCaseReducer(y,T){return u.sliceCaseReducersByName[y]=T,l}};c.forEach(y=>{const T=o[y],A={reducerName:y,type:Bt(i,y),createNotation:typeof s.reducers=="function"};Gt(T)?Qt(A,T,l,e):Kt(A,T,l)});function h(){const[y={},T=[],A=void 0]=typeof s.extraReducers=="function"?Be(s.extraReducers):[s.extraReducers],C={...y,...u.sliceCaseReducersByType};return Ot(s.initialState,S=>{for(let w in C)S.addCase(w,C[w]);for(let w of u.sliceMatchers)S.addMatcher(w.matcher,w.reducer);for(let w of T)S.addMatcher(w.matcher,w.reducer);A&&S.addDefaultCase(A)})}const f=y=>y,p=new Map,m=new WeakMap;let d;function g(y,T){return d||(d=h()),d(y,T)}function b(){return d||(d=h()),d.getInitialState()}function E(y,T=!1){function A(S){let w=S[y];return typeof w>"u"&&T&&(w=W(m,A,b)),w}function C(S=f){const w=W(p,T,()=>new WeakMap);return W(w,S,()=>{const k={};for(const[B,re]of Object.entries(s.selectors??{}))k[B]=Wt(re,S,()=>W(m,S,b),T);return k})}return{reducerPath:y,getSelectors:C,get selectors(){return C(A)},selectSlice:A}}const v={name:i,reducer:g,actions:u.actionCreators,caseReducers:u.sliceCaseReducersByName,getInitialState:b,...E(a),injectInto(y,{reducerPath:T,...A}={}){const C=T??a;return y.inject({reducerPath:C,reducer:g},A),{...v,...E(C,!0)}}};return v}}function Wt(n,e,t,r){function s(i,...a){let o=e(i);return typeof o>"u"&&r&&(o=t()),n(o,...a)}return s.unwrapped=n,s}var be=Jt();function Ut(){function n(e,t){return{_reducerDefinitionType:"asyncThunk",payloadCreator:e,...t}}return n.withTypes=()=>n,{reducer(e){return Object.assign({[e.name](...t){return e(...t)}}[e.name],{_reducerDefinitionType:"reducer"})},preparedReducer(e,t){return{_reducerDefinitionType:"reducerWithPrepare",prepare:e,reducer:t}},asyncThunk:n}}function Kt({type:n,reducerName:e,createNotation:t},r,s){let i,a;if("reducer"in r){if(t&&!Xt(r))throw new Error(q(17));i=r.reducer,a=r.prepare}else i=r;s.addCase(n,i).exposeCaseReducer(e,i).exposeAction(e,a?D(n,a):D(n))}function Gt(n){return n._reducerDefinitionType==="asyncThunk"}function Xt(n){return n._reducerDefinitionType==="reducerWithPrepare"}function Qt({type:n,reducerName:e},t,r,s){if(!s)throw new Error(q(18));const{payloadCreator:i,fulfilled:a,pending:o,rejected:c,settled:u,options:l}=t,h=s(n,i,l);r.exposeAction(e,h),a&&r.addCase(h.fulfilled,a),o&&r.addCase(h.pending,o),c&&r.addCase(h.rejected,c),u&&r.addMatcher(h.settled,u),r.exposeCaseReducer(e,{fulfilled:a||U,pending:o||U,rejected:c||U,settled:u||U})}function U(){}function q(n){return`Minified Redux Toolkit error #${n}; visit https://redux-toolkit.js.org/Errors?code=${n} for the full message or use the non-minified dev environment for full errors. `}class oe{constructor(e){$(this,"capacity");$(this,"cache");$(this,"keys");this.capacity=e,this.cache=new Map,this.keys=[]}get(e){if(this.cache.has(e))return this.keys=this.keys.filter(t=>t!==e),this.keys.push(e),this.cache.get(e)}put(e,t){if(this.cache.has(e)){this.cache.set(e,t),this.keys=this.keys.filter(r=>r!==e),this.keys.push(e);return}if(this.keys.length>=this.capacity){const r=this.keys.shift();r!==void 0&&this.cache.delete(r)}this.cache.set(e,t),this.keys.push(e)}clear(){this.cache.clear(),this.keys=[]}size(){return this.cache.size}getStats(){return{size:this.cache.size,capacity:this.capacity}}}class Zt{constructor(){$(this,"conditionCache",new oe(500));$(this,"transformationCache",new oe(200));$(this,"batchedTransformationCache",new oe(100));$(this,"stats",{conditionEvaluations:0,conditionCacheHits:0,transformations:0,transformationCacheHits:0,batchedTransformations:0,batchedCacheHits:0});$(this,"lastModificationTime",Date.now())}getConditionCacheKey(e,t,r){const s=JSON.stringify(e),i=JSON.stringify({path:{sequence:t.path.sequence,revisitPatterns:t.path.revisitPatterns,detailedVisits:t.path.detailedVisits},endpointProgress:t.endpointProgress}),a=JSON.stringify({id:r.id,visitCount:r.visitCount,temporalValue:r.temporalValue,strangeAttractors:r.strangeAttractors});return`v1:${r.id}:${s}:${i}:${a}`}getTransformationCacheKey(e,t,r={}){const{contentPrefix:s=30,includeTransformations:i=!0}=r,a=e.substring(0,s),o=i?t.map(u=>{var l;return`${u.type}:${(l=u.selector)==null?void 0:l.substring(0,10)}:${u.priority}`}).join("|"):"",c=Math.floor(this.lastModificationTime/1e3);return`v1:${a}:${t.length}:${c}:${o}`}invalidateCaches(){this.conditionCache.clear(),this.transformationCache.clear(),this.batchedTransformationCache.clear(),this.lastModificationTime=Date.now()}evaluateCondition(e,t,r){var a,o,c,u,l,h,f;if(this.stats.conditionEvaluations++,Object.keys(e).length===0)return!0;const s=this.getConditionCacheKey(e,t,r),i=this.conditionCache.get(s);if(i!==void 0)return this.stats.conditionCacheHits++,i;if((a=e.allOf)!=null&&a.length)return e.allOf.every(p=>this.evaluateCondition(p,t,r));if((o=e.anyOf)!=null&&o.length)return e.anyOf.some(p=>this.evaluateCondition(p,t,r));if(e.not)return!this.evaluateCondition(e.not,t,r);if(e.visitCount!==void 0&&r.visitCount<e.visitCount)return!1;if((c=e.previouslyVisitedNodes)!=null&&c.length){const p=t.path.sequence||[];if(!e.previouslyVisitedNodes.every(m=>p.includes(m)))return!1}if((u=e.visitPattern)!=null&&u.length&&!this.matchesPattern(e.visitPattern,t.path.sequence)||(l=e.strangeAttractorsEngaged)!=null&&l.length&&!this.checkAttractorsEngaged(e.strangeAttractorsEngaged,t)||e.temporalPosition&&this.getNodeTemporalPosition(r)!==e.temporalPosition)return!1;if(e.endpointProgress){const{orientation:p,minValue:m}=e.endpointProgress;if(!t.endpointProgress||t.endpointProgress[p]<m)return!1}if((h=e.revisitPattern)!=null&&h.length){for(const p of e.revisitPattern)if(((t.path.revisitPatterns||{})[p.nodeId]||0)<p.minVisits)return!1}return!(e.characterBleed&&!this.checkCharacterBleed(t,r)||(f=e.journeyPattern)!=null&&f.length&&!this.matchesJourneyPattern(e.journeyPattern,t.path.sequence))}matchesPattern(e,t){if(e.length===0)return!0;if(t.length===0)return!1;for(let r=0;r<=t.length-e.length;r++){let s=!0;for(let i=0;i<e.length;i++)if(t[r+i]!==e[i]){s=!1;break}if(s)return!0}return!1}checkAttractorsEngaged(e,t){if(!e||!t.path)return!1;const r=t.path.attractorsEngaged||{};return e.every(s=>(r[s]||0)>0)}getNodeTemporalPosition(e){return e.temporalValue<=3?"past":e.temporalValue<=6?"present":"future"}checkCharacterBleed(e,t){return!e.path.detailedVisits||e.path.detailedVisits.length<2?!1:e.path.detailedVisits[e.path.detailedVisits.length-2].character!==t.character}matchesJourneyPattern(e,t){if(e.length===0)return!0;if(t.length<e.length)return!1;const r=t.slice(-e.length);for(let s=0;s<e.length;s++)if(r[s]!==e[s])return!1;return!0}evaluateTransformation(e,t,r){const s=`rule:${JSON.stringify(e.condition)}:${r.id}:${r.visitCount}`,i=this.conditionCache.get(s);if(i!==void 0)return this.stats.conditionCacheHits++,{shouldApply:i,appliedTransformations:i?e.transformations:[]};this.stats.conditionEvaluations++;const a=this.evaluateCondition(e.condition,t,r);return this.conditionCache.put(s,a),{shouldApply:a,appliedTransformations:a?e.transformations:[]}}evaluateAllTransformations(e,t,r){return e.filter(s=>this.evaluateCondition(s.condition,t,r)).flatMap(s=>s.transformations)}applyTextTransformation(e,t){if(!t.selector)return e;if(e.includes("data-transform-type")&&e.length>1e4)return console.warn("[TransformationEngine] Content appears heavily transformed, skipping to prevent infinite loop"),e;this.stats.transformations++;const r=this.getTransformationCacheKey(e,[t],{contentPrefix:50,includeTransformations:!0}),s=this.transformationCache.get(r);if(s!==void 0)return this.stats.transformationCacheHits++,s;const i=this.escapeRegExp(t.selector),a=new RegExp(i,"g");switch(t.type){case"replace":{const o=t.replacement||"";if(t.preserveFormatting&&(t.selector.includes("*")||t.selector.includes("_")||t.selector.includes("`"))){const c=/(\*\*|\*|__|_|`{3}|`)/g,u=t.selector.match(c)||[];let l=o;return u.forEach(h=>{l.includes(h)||(l=`${h}${l}${h}`)}),e.replace(a,l)}return e.replace(a,o)}case"fragment":{if(!t.fragmentPattern)return e;const o=t.fragmentPattern,c=t.fragmentStyle||"character";let u="";switch(c){case"character":{u=t.selector.split("").join(o);break}case"word":{u=t.selector.split(" ").join(` ${o} `);break}case"progressive":{const l=t.selector.split("");u=l.map((h,f)=>{const p=Math.floor(f/(l.length/5))+1;return h+o.repeat(p)}).join("");break}default:u=t.selector.split("").join(o)}return e.replace(a,u)}case"expand":{const o=t.replacement||"";switch(t.expandStyle||"append"){case"append":return e.replace(a,`${t.selector} ${o}`);case"inline":return e.replace(a,`${t.selector} <span class="narramorph-inline-expansion">[${o}]</span>`);case"paragraph":return e.replace(a,`${t.selector}

<div class="narramorph-paragraph-expansion">${o}</div>`);case"reveal":return e.replace(a,`${t.selector} <span class="narramorph-reveal-expansion">${o}</span>`);default:return e.replace(a,`${t.selector} ${o}`)}}case"emphasize":{let o=t.selector;const c=t.intensity||1;switch(t.emphasis){case"italic":o=`*${t.selector}*`,c>1&&(o=`<em class="intensity-${c}">${t.selector}</em>`);break;case"bold":o=`**${t.selector}**`,c>1&&(o=`<strong class="intensity-${c}">${t.selector}</strong>`);break;case"color":o=`<span class="emphasized-text intensity-${c}">${t.selector}</span>`;break;case"spacing":{const u=" ".repeat(c);o=t.selector.split("").join(u);break}case"highlight":o=`<mark class="intensity-${c}">${t.selector}</mark>`;break;case"glitch":o=`<span class="glitch-text intensity-${c}" data-text="${t.selector}">${t.selector}</span>`;break;case"fade":o=`<span class="fade-text intensity-${c}">${t.selector}</span>`;break}return e.replace(a,o)}case"metaComment":{const o=t.commentStyle||"inline",c=t.replacement||"";switch(o){case"inline":return e.replace(a,`${t.selector} <span class="narramorph-comment">[${c}]</span>`);case"footnote":{const u=`footnote-${this.generateShortHash(t.selector)}`,l=e.includes('<div class="narramorph-footnotes">');let h=e.replace(a,`${t.selector}<sup class="narramorph-footnote-marker" id="${u}-ref">[†]</sup>`);if(l){const f=/<\/div>\s*<div class="narramorph-footnotes">/;f.test(h)?h=h.replace(f,`</div>

<div class="narramorph-footnotes">
<p id="${u}" class="narramorph-footnote">† <a href="#${u}-ref">↩</a> ${c}</p>`):h+=`

<p id="${u}" class="narramorph-footnote">† <a href="#${u}-ref">↩</a> ${c}</p>`}else h+=`

<div class="narramorph-footnotes">
<p id="${u}" class="narramorph-footnote">† <a href="#${u}-ref">↩</a> ${c}</p>
</div>`;return h}case"marginalia":return e.replace(a,`<span class="narramorph-marginalia-container">${t.selector}<span class="narramorph-marginalia">${c}</span></span>`);case"interlinear":return e.replace(a,`<div class="narramorph-interlinear-container">${t.selector}<div class="narramorph-interlinear">${c}</div></div>`);default:return e.replace(a,`${t.selector} [${c}]`)}}default:return e}}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}generateShortHash(e){let t=0;for(let r=0;r<e.length;r++){const s=e.charCodeAt(r);t=(t<<5)-t+s,t=t&t}return Math.abs(t).toString(36).substring(0,6)}applyTransformations(e,t){if(!e)return console.warn("Content is empty or undefined"),"";if(!Array.isArray(t)||t.length===0)return e;if(e.includes("data-transform-type")&&(e.length>15e3||t.length>20))return console.warn("[TransformationEngine] Content appears heavily transformed or too many transformations, skipping batch to prevent infinite loop"),e;this.stats.batchedTransformations++;const r=this.getTransformationCacheKey(e,t),s=this.batchedTransformationCache.get(r);if(s!==void 0)return this.stats.batchedCacheHits++,s;try{const a=[...t].sort((o,c)=>{const u=l=>l==="high"?3:l==="medium"?2:l==="low"?1:0;return u(c.priority)-u(o.priority)}).reduce((o,c)=>this.applyTextTransformation(o,c),e);return this.batchedTransformationCache.put(r,a),a}catch(i){return console.error("Error applying transformations:",i),e}}clearCaches(){this.conditionCache.clear(),this.transformationCache.clear(),this.batchedTransformationCache.clear(),this.stats={conditionEvaluations:0,conditionCacheHits:0,transformations:0,transformationCacheHits:0,batchedTransformations:0,batchedCacheHits:0}}getCacheStats(){return{conditionCache:{...this.conditionCache.getStats(),hitRate:this.stats.conditionEvaluations>0?this.stats.conditionCacheHits/this.stats.conditionEvaluations:0},transformationCache:{...this.transformationCache.getStats(),hitRate:this.stats.transformations>0?this.stats.transformationCacheHits/this.stats.transformations:0},batchedTransformationCache:{...this.batchedTransformationCache.getStats(),hitRate:this.stats.batchedTransformations>0?this.stats.batchedCacheHits/this.stats.batchedTransformations:0}}}}const ye=new Zt;class Yt{parseContentVariants(e){var i;const t={base:"",visitCountVariants:{},sectionVariants:{}},r=/---(\[(\d+)\]|([a-zA-Z0-9\-_]+))---/,s=e.split(r);s.length>0&&!e.startsWith("---")&&(t.base=s[0].trim());for(let a=1;a<s.length;a+=4){const o=s[a+1],c=s[a+2],u=((i=s[a+3])==null?void 0:i.trim())||"";if(o){const l=parseInt(o,10);isNaN(l)||(t.visitCountVariants[l]=u)}else c&&(t.sectionVariants[c]=u)}if(!t.base){if(Object.keys(t.visitCountVariants).length>0){const a=Math.min(...Object.keys(t.visitCountVariants).map(Number));t.base=t.visitCountVariants[a]}else if(Object.keys(t.sectionVariants).length>0){const a=Object.keys(t.sectionVariants)[0];t.base=t.sectionVariants[a]}}return t}upgradeLegacyContent(e){const t={base:e[0]||"",visitCountVariants:{...e},sectionVariants:{}};return t.visitCountVariants[0]&&delete t.visitCountVariants[0],t}selectContentVariant(e,t){if(t.lastVisitedCharacter){const i=this.getCharacterBleedSection(t.lastVisitedCharacter);if(e.sectionVariants[i])return e.sectionVariants[i]}if(t.recursiveAwareness&&t.recursiveAwareness>.7&&e.sectionVariants["recursive-awareness"])return e.sectionVariants["recursive-awareness"];const r=this.detectJourneyPattern(t);if(r&&e.sectionVariants[r])return e.sectionVariants[r];const s=this.detectAttractorEngagement(t.attractorsEngaged);if(s&&e.sectionVariants[s])return e.sectionVariants[s];if(Object.keys(e.visitCountVariants).length>0){const a=Object.keys(e.visitCountVariants).map(Number).sort((o,c)=>c-o).find(o=>t.visitCount>=o);if(a!==void 0)return e.visitCountVariants[a]}return e.base}getCharacterBleedSection(e){switch(e){case"Algorithm":return"after-algorithm";case"LastHuman":return"after-last-human";case"Archaeologist":return"after-archaeologist";default:return""}}detectJourneyPattern(e){const{journeyPattern:t,characterSequence:r}=e;if(t.length>=3){const s=t.slice(-3);if(r.length>=3){const i=r.slice(-3);if(new Set(i).size===1)return"character-focus"}if(s[0]===s[2]&&s[0]!==s[1])return"cyclical-pattern"}return null}detectAttractorEngagement(e){for(const[r,s]of Object.entries(e))if(s>=3)switch(r){case"recursion-pattern":case"recursive-loop":return"recursion-pattern-engaged";case"memory-fragment":case"memory-artifact":return"memory-fragment-engaged";case"quantum-perception":case"quantum-uncertainty":return"quantum-awareness"}return null}createSelectionContext(e,t){const r=e.nodes.data[t],s=e.reader;let i;if(s.path.sequence.length>1){const l=s.path.sequence[s.path.sequence.length-2],h=e.nodes.data[l];h&&(i=h.character)}const a=s.path.sequence.slice(-5).map(l=>{var h;return(h=e.nodes.data[l])==null?void 0:h.character}).filter(l=>l!==void 0);let o=0;const c=s.path.sequence.length,u=new Set(s.path.sequence).size;return c>0&&(o=1-u/c),{visitCount:(r==null?void 0:r.visitCount)||0,lastVisitedCharacter:i,journeyPattern:s.path.sequence.slice(-5),characterSequence:a,attractorsEngaged:s.path.attractorsEngaged,recursiveAwareness:o}}}const We=new Yt;class en{static calculateBleedEffects(e,t){const r=[],s=this.getLastVisitedNode(t);if(console.log(`[CharacterBleedService] Analyzing character bleed for node ${e.id}:`,{currentCharacter:e.character,lastVisitedCharacter:(s==null?void 0:s.character)||"None",lastVisitedNode:(s==null?void 0:s.nodeId)||"None"}),!s||s.character===e.character)return console.log(`[CharacterBleedService] No character bleed detected - ${s?"same character":"no previous character"}`),r;console.log(`[CharacterBleedService] Character transition detected: ${s.character} → ${e.character}`);const i=this.getCharacterSpecificBleed(s.character,e.character,e).slice(0,2);r.push(...i),console.log(`[CharacterBleedService] Added ${i.length} character-specific bleed effects`);const a=this.getGeneralBleedEffects(s.character,e.character,e,t).slice(0,1);return r.push(...a),console.log(`[CharacterBleedService] Added ${a.length} general bleed effects`),console.log(`[CharacterBleedService] Total character bleed effects: ${r.length}`),r}static getLastVisitedNode(e){const t=e.path.detailedVisits;if(!t||t.length<2)return null;const r=t[t.length-2];return{character:r.character,nodeId:r.nodeId}}static getCharacterSpecificBleed(e,t,r){const s=[];if(!r.currentContent)return s;const i=r.currentContent,a=i.split(`

`).filter(o=>o.trim().length>0);return e==="Algorithm"&&t==="Archaeologist"?(this.findTechnicalTerms(i).forEach(c=>{s.push({type:"fragment",selector:c,transformation:{type:"fragment",selector:c,fragmentPattern:"̶",fragmentStyle:"character",intensity:3},reason:"Algorithmic corruption bleeding into archaeological interpretation",sourceCharacter:e,targetCharacter:t,intensity:3})}),a.length>1&&s.push({type:"metaComment",selector:a[1],transformation:{type:"metaComment",selector:a[1],replacement:"data integrity compromised",commentStyle:"marginalia",intensity:2},reason:"Algorithmic perspective introduces doubt about information reliability",sourceCharacter:e,targetCharacter:t,intensity:2})):e==="Algorithm"&&t==="LastHuman"?(this.findPatterns(i).forEach(c=>{s.push({type:"emphasize",selector:c,transformation:{type:"emphasize",selector:c,emphasis:"glitch",intensity:4},reason:"Algorithmic pattern recognition bleeding into human consciousness",sourceCharacter:e,targetCharacter:t,intensity:4})}),a.length>0&&s.push({type:"expand",selector:a[0],transformation:{type:"expand",selector:a[0],replacement:"[PATTERN_DETECTED: recursive_loop_identified]",expandStyle:"inline",intensity:3},reason:"Algorithmic analysis intrudes on human experience",sourceCharacter:e,targetCharacter:t,intensity:3})):e==="Archaeologist"&&t==="Algorithm"?(this.findTimeTerms(i).forEach(c=>{s.push({type:"replace",selector:c,transformation:{type:"replace",selector:c,replacement:`${c}[TEMPORAL_MARKER:${this.getRandomTimestamp()}]`,preserveFormatting:!0,intensity:3},reason:"Archaeological time-consciousness bleeds into algorithmic processing",sourceCharacter:e,targetCharacter:t,intensity:3})}),a.length>2&&s.push({type:"metaComment",selector:a[2],transformation:{type:"metaComment",selector:a[2],replacement:"chronological displacement detected",commentStyle:"interlinear",intensity:2},reason:"Archaeological temporal awareness influences algorithmic perception",sourceCharacter:e,targetCharacter:t,intensity:2})):e==="LastHuman"&&t!=="LastHuman"&&(this.findEmotionalTerms(i).forEach(c=>{s.push({type:"emphasize",selector:c,transformation:{type:"emphasize",selector:c,emphasis:"fade",intensity:2},reason:"Human memory and emotion bleeds into analytical perspective",sourceCharacter:e,targetCharacter:t,intensity:2})}),a.length>0&&s.push({type:"expand",selector:a[0],transformation:{type:"expand",selector:a[0],replacement:"(a memory surface, warm and fading)",expandStyle:"append",intensity:2},reason:"Human experiential memory creates emotional overlay",sourceCharacter:e,targetCharacter:t,intensity:2})),s}static getGeneralBleedEffects(e,t,r,s){const i=[];if(!r.currentContent)return i;const a=this.calculateTransitionCount(e,t,s),o=Math.min(5,Math.max(1,Math.floor(a/2)+1)),c=this.getFirstSentence(r.currentContent);return c&&i.push({type:"metaComment",selector:c,transformation:{type:"metaComment",selector:c,replacement:`perspective shift: ${e} → ${t}`,commentStyle:"marginalia",intensity:o},reason:"Character transition creates perspective shift awareness",sourceCharacter:e,targetCharacter:t,intensity:o}),i}static findTechnicalTerms(e){const t=["system","process","data","algorithm","compute","execute","protocol","interface","network","digital","binary","code"];return e.toLowerCase().split(/\s+/).filter(s=>t.some(i=>s.includes(i))).slice(0,3)}static findPatterns(e){const t=e.split(/\s+/),r=[],s={};return t.forEach(i=>{const a=i.toLowerCase().replace(/[^\w]/g,"");a.length>3&&(s[a]=(s[a]||0)+1)}),Object.entries(s).forEach(([i,a])=>{a>1&&r.length<2&&r.push(i)}),r}static findTimeTerms(e){const t=["past","present","future","time","when","before","after","now","then","moment","history","ancient","memory"];return e.toLowerCase().split(/\s+/).filter(s=>t.some(i=>s.includes(i))).slice(0,2)}static findEmotionalTerms(e){const t=["feel","remember","love","fear","hope","dream","wish","heart","soul","mind","consciousness","awareness","experience"];return e.toLowerCase().split(/\s+/).filter(s=>t.some(i=>s.includes(i))).slice(0,2)}static calculateTransitionCount(e,t,r){const s=r.path.detailedVisits||[];let i=0;for(let a=1;a<s.length;a++){const o=s[a-1],c=s[a];o.character===e&&c.character===t&&i++}return i}static getFirstSentence(e){var s;const r=(s=e.split(/[.!?]+/)[0])==null?void 0:s.trim();return r&&r.length>10?r:null}static getRandomTimestamp(){const e=["2157.03.14","1847.11.22","2891.07.08","0034.12.31","3456.01.15"];return e[Math.floor(Math.random()*e.length)]}}class tn{constructor(){$(this,"MIN_SEQUENCE_LENGTH",2);$(this,"SEQUENCE_REPETITION_THRESHOLD",2);$(this,"CHARACTER_FOCUS_THRESHOLD",.4);$(this,"TEMPORAL_FOCUS_THRESHOLD",.4)}analyzePathPatterns(e,t){const r=[];return e.path.sequence.length<this.MIN_SEQUENCE_LENGTH||(r.push(...this.identifyRepeatedSequences(e.path)),r.push(...this.identifyCharacterFocusPatterns(e.path)),r.push(...this.identifyTemporalLayerPatterns(e.path)),r.push(...this.identifyReadingRhythmPatterns()),r.push(...this.identifyAttractorAffinityPatterns(e.path,t))),r}identifyRepeatedSequences(e){var s;const t=[],r=(s=e.patternSequences)==null?void 0:s.repeatedSequences;return!r||r.length===0||r.forEach(i=>{if(i.length>=this.MIN_SEQUENCE_LENGTH){const a=i.length,o=Math.floor(e.sequence.length/2),c=a/o;let u=0;for(let p=0;p<=e.sequence.length-a;p++)e.sequence.slice(p,p+a).every((d,g)=>d===i[g])&&u++;const l=Math.floor(e.sequence.length/a),h=Math.min(1,u/l),f=c*.4+h*.6;u>=this.SEQUENCE_REPETITION_THRESHOLD&&t.push({type:"sequence",strength:f,description:`Repeated sequence of ${a} nodes visited ${u} times`,relatedNodes:i})}}),t}identifyCharacterFocusPatterns(e){var o;const t=[],r=e.characterFocus;if(!r)return t;const i=(e.detailedVisits||[]).length;if(i===0)return t;Object.entries(r).forEach(([c,u])=>{const l=u/i;if(l>=this.CHARACTER_FOCUS_THRESHOLD){const f=.5+.5*((l-this.CHARACTER_FOCUS_THRESHOLD)/(1-this.CHARACTER_FOCUS_THRESHOLD));t.push({type:"character",strength:f,description:`Strong focus on ${c} perspective (${Math.round(l*100)}% of visits)`,relatedCharacters:[c]})}});const a=(o=e.patternSequences)==null?void 0:o.characterSequences;if(a&&a.length>0){const c=a[0];if(c.length>=4){let u=0;for(let f=0;f<c.length-3;f++){const p=c[f],m=c[f+1];p!==m&&c[f+2]===p&&c[f+3]===m&&u++}const l=Math.floor((c.length-3)/2),h=u/l;h>=.3&&t.push({type:"character",strength:h,description:"Pattern of alternating between character perspectives",relatedCharacters:Array.from(new Set(c))})}}return t}identifyTemporalLayerPatterns(e){var o;const t=[],r=e.temporalLayerFocus;if(!r)return t;const i=(e.detailedVisits||[]).length;if(i===0)return t;Object.entries(r).forEach(([c,u])=>{const l=u/i;if(l>=this.TEMPORAL_FOCUS_THRESHOLD){const f=.5+.5*((l-this.TEMPORAL_FOCUS_THRESHOLD)/(1-this.TEMPORAL_FOCUS_THRESHOLD));t.push({type:"temporal",strength:f,description:`Strong focus on ${c} temporal layer (${Math.round(l*100)}% of visits)`,relatedTemporalLayers:[c]})}});const a=(o=e.patternSequences)==null?void 0:o.temporalSequences;if(a&&a.length>0){const c=a[0];if(c.length>=5){let u=0;for(let m=0;m<c.length-2;m++){const d=c[m],g=c[m+1],b=c[m+2];(d==="past"&&g==="present"&&b==="future"||d==="past"&&g==="present"||g==="present"&&b==="future")&&u++}const l=c.length-2,h=u/l;h>=.3&&t.push({type:"temporal",strength:h,description:"Pattern of chronological progression through time",relatedTemporalLayers:["past","present","future"]});let f=0;for(let m=0;m<c.length-2;m++){const d=c[m],g=c[m+1],b=c[m+2];(d==="future"&&g==="present"&&b==="past"||d==="future"&&g==="present"||g==="present"&&b==="past")&&f++}const p=f/l;p>=.3&&t.push({type:"temporal",strength:p,description:"Pattern of reverse chronological movement through time",relatedTemporalLayers:["future","present","past"]})}}return t}identifyReadingRhythmPatterns(){return[]}identifyAttractorAffinityPatterns(e,t){const r=[],s=e.attractorsEngaged,i=e.detailedVisits||[];if(!s||Object.keys(s).length===0)return r;const a=Object.values(s).reduce((o,c)=>o+c,0);if(a===0)return r;if(Object.entries(s).forEach(([o,c])=>{const u=c/a;if(u>=.25){const l=Object.values(t).filter(p=>p.strangeAttractors.includes(o)).map(p=>p.id);let h=0;l.length>0&&(h=i.filter(m=>l.includes(m.nodeId)).length/i.length);const f=u*.7+h*.3;r.push({type:"thematic",strength:f,description:`Strong affinity for "${o}" concept/theme`,relatedAttractors:[o],relatedNodes:l})}}),i.length>=3){const o={};Object.values(t).forEach(h=>{o[h.id]=h.strangeAttractors});const c=i.slice(-Math.min(10,i.length));let u=0;for(let h=1;h<c.length;h++){const f=c[h-1].nodeId,p=c[h].nodeId,m=o[f]||[],d=o[p]||[];m.filter(b=>d.includes(b)).length>0&&u++}const l=u/(c.length-1);l>=.5&&r.push({type:"thematic",strength:l,description:"Pattern of following thematic connections between nodes"})}return r}calculateAttractorEngagement(e,t){const{path:r}=e,s=r.attractorsEngaged,i=r.detailedVisits||[];if(!s||Object.keys(s).length===0)return[];const a=[];return Object.entries(s).forEach(([o,c])=>{const u=o;if(c===0)return;const l=Object.values(t).filter(E=>E.strangeAttractors.includes(u)).map(E=>E.id),h=i.filter(E=>E.engagedAttractors.includes(u));if(h.length===0)return;let f="stable";if(h.length>=3){const E=Math.floor(h.length/2),v=h.slice(0,E),y=h.slice(E);y.length>v.length*1.2?f="rising":y.length<v.length*.8&&(f="falling")}const p=Object.values(s).reduce((E,v)=>E+v,0),m=c/p*100,d=i.indexOf(h[h.length-1])>i.length*.7?.8:.4,g=h.length>c*.5?.7:.3,b=Math.min(100,m*.6+d*20+g*20);a.push({attractor:u,engagementScore:b,totalEngagements:c,relatedNodes:l,trend:f})}),a.sort((o,c)=>c.engagementScore-o.engagementScore)}identifySignificantPatterns(e,t){return this.analyzePathPatterns(e,t).sort((i,a)=>a.strength-i.strength).filter(i=>i.strength>=.6).slice(0,5)}createTransformationConditions(e,t){const r=[];return e.forEach(s=>{switch(s.type){case"sequence":s.relatedNodes&&s.relatedNodes.length>=2&&r.push({type:"visitPattern",condition:{visitPattern:s.relatedNodes},strength:s.strength});break;case"character":s.relatedCharacters&&s.relatedCharacters.length>0&&r.push({type:"characterFocus",condition:{characters:s.relatedCharacters},strength:s.strength});break;case"temporal":s.relatedTemporalLayers&&s.relatedTemporalLayers.length>0&&r.push({type:"temporalFocus",condition:{temporalPosition:s.relatedTemporalLayers[0]},strength:s.strength});break;case"rhythm":break;case"thematic":s.relatedAttractors&&s.relatedAttractors.length>0&&r.push({type:"attractorAffinity",condition:{strangeAttractorsEngaged:s.relatedAttractors},strength:s.strength});break}}),t.filter(s=>s.engagementScore>=50).forEach(s=>{r.push({type:"attractorEngagement",condition:{strangeAttractorsEngaged:[s.attractor]},strength:s.engagementScore/100})}),r}analyzeRecursivePatterns(e,t){const{sequence:r}=e.path,s=[];if(r.length<4)return s;for(let i=2;i<=4;i++){const a=new Map;for(let o=0;o<=r.length-i;o++){const c=r.slice(o,o+i),u=c.join("->");a.has(u)||a.set(u,{sequence:c,length:i,occurrences:0,lastOccurrenceIndex:o,strength:0,temporalSpread:0});const l=a.get(u);l.occurrences++,l.lastOccurrenceIndex=Math.max(l.lastOccurrenceIndex,o)}a.forEach(o=>{if(o.occurrences>=2){const c=Math.min(1,o.occurrences/(r.length/i)),u=1-(r.length-o.lastOccurrenceIndex)/r.length;o.strength=c*.7+u*.3;const l=[];for(let f=0;f<=r.length-i;f++)r.slice(f,f+i).every((m,d)=>m===o.sequence[d])&&l.push(f);if(l.length>1){const f=l.slice(1).map((d,g)=>d-l[g]),p=f.reduce((d,g)=>d+g,0)/f.length,m=r.length/l.length;o.temporalSpread=Math.min(1,p/m)}const h=o.sequence.map(f=>t[f]).filter(Boolean);h.length>0&&(h.length===o.sequence.length||console.warn(`Pattern contains invalid node references: ${o.sequence}`)),s.push(o)}})}return s.sort((i,a)=>a.strength-i.strength)}calculateCharacterFocusIntensity(e,t){const{sequence:r,characterFocus:s={}}=e.path,i=[];if(r.length===0)return i;const a=r.map(c=>{var u;return(u=t[c])==null?void 0:u.character}).filter(c=>!!c),o=a.length;return Object.keys(s).forEach(c=>{const u=c,l=s[u];if(l>0){const h=l/o;let f=0,p=0;a.forEach(C=>{C===u?(p++,f=Math.max(f,p)):p=0});const m=a.map((C,S)=>C===u?S:-1).filter(C=>C!==-1);let d=0;if(m.length>1){const C=m.slice(1).map((S,w)=>S-m[w]);d=C.reduce((S,w)=>S+w,0)/C.length}const g=Object.keys(t).filter(C=>t[C].character===u),b=r.filter(C=>g.includes(C)),E=[...new Set(b.map(C=>{const S=t[C].temporalValue;return S<=3?"past":S<=6?"present":"future"}))],v=Math.min(1,h*2),y=Math.min(1,f/5),T=E.length/3,A=v*.5+y*.3+T*.2;i.push({character:u,visitRatio:h,intensity:A,consecutiveVisits:f,avgTimeBetweenVisits:d,temporalSpread:E})}}),i.sort((c,u)=>u.intensity-c.intensity)}detectStrangeAttractors(e,t){const{sequence:r,revisitPatterns:s}=e.path,i=[];return r.length<3?i:(Object.entries(s).forEach(([a,o])=>{if(o>1){const c=o-1,u=r.map((l,h)=>l===a?h:-1).filter(l=>l!==-1);if(u.length>1){const l=c/r.length,h=u.slice(1).map((v,y)=>v-u[y]),f=h.reduce((v,y)=>v+y,0)/h.length,p=Math.min(1,l*10),m=1-(Math.max(...h)-Math.min(...h))/Math.max(...h),d=1-(r.length-Math.max(...u))/r.length,g=p*.5+m*.3+d*.2,b=t[a],E=b?b.strangeAttractors:[];i.push({nodeId:a,returnFrequency:l,totalReturns:c,averageGapBetweenReturns:f,magneticStrength:g,attractorThemes:E,lastReturnIndex:Math.max(...u)})}}}),i.sort((a,o)=>o.magneticStrength-a.magneticStrength))}analyzeTemporalJumping(e,t){const{sequence:r,temporalLayerFocus:s={}}=e.path;if(r.length<2)return{totalJumps:0,jumpFrequency:0,preferredJumpDirection:"mixed",jumpDistances:[],averageJumpDistance:0,maxJumpDistance:0,temporalAnchoring:{past:0,present:0,future:0},volatility:0};const i=r.map(v=>{const y=t[v];return y?y.temporalValue:0}).filter(v=>v>0),a=[],o=[];for(let v=1;v<i.length;v++){const y=i[v-1],T=i[v],A=Math.abs(T-y);A>0&&(a.push(A),o.push(T>y?"forward":"backward"))}const c=a.length,u=c/r.length,l=a.length>0?a.reduce((v,y)=>v+y,0)/a.length:0,h=a.length>0?Math.max(...a):0,f=o.filter(v=>v==="forward").length,p=o.filter(v=>v==="backward").length;let m="mixed";f>p*1.5?m="forward":p>f*1.5&&(m="backward");const d=s,g=Object.values(d).reduce((v,y)=>v+y,0),b={past:g>0?(d.past||0)/g:0,present:g>0?(d.present||0)/g:0,future:g>0?(d.future||0)/g:0};let E=0;if(a.length>1){const v=a.reduce((y,T)=>{const A=T-l;return y+A*A},0)/a.length;E=Math.min(1,Math.sqrt(v)/4)}return{totalJumps:c,jumpFrequency:u,preferredJumpDirection:m,jumpDistances:a,averageJumpDistance:l,maxJumpDistance:h,temporalAnchoring:b,volatility:E}}generateJourneyFingerprint(e,t){const{sequence:r,attractorsEngaged:s={}}=e.path,i=this.analyzeRecursivePatterns(e,t),a=this.calculateCharacterFocusIntensity(e,t),o=this.detectStrangeAttractors(e,t),c=this.analyzeTemporalJumping(e,t),u=i.length>0?i.reduce((P,_)=>P+_.strength,0)/i.length:0,l=a.length>0?Math.max(...a.map(P=>P.intensity)):0,h=Math.min(1,c.jumpFrequency*2),f=Math.min(1,u*.3+c.volatility*.3+o.length/10*.4);let p="linear";f>.7?p="chaotic":u>.6?p="recursive":l>.7?p="focused":c.volatility>.5&&(p="wandering");const m=a.sort((P,_)=>_.intensity-P.intensity).map(P=>P.character),{temporalAnchoring:d}=c;let g="time-fluid";d.past>.5?g="past-oriented":d.present>.5?g="present-focused":d.future>.5&&(g="future-seeking");let b="intuitive";const E=s,v=Object.keys(E).length,y=Object.values(E).reduce((P,_)=>P+_,0);p==="linear"&&c.volatility<.3?b="systematic":v>5&&y>r.length*.8?b="thematic":f>.6&&(b="experimental");const T=i.slice(0,3).map(P=>P.length),A={Archaeologist:{Archaeologist:0,Algorithm:0,LastHuman:0},Algorithm:{Archaeologist:0,Algorithm:0,LastHuman:0},LastHuman:{Archaeologist:0,Algorithm:0,LastHuman:0}},C=r.map(P=>{var _;return(_=t[P])==null?void 0:_.character}).filter(P=>!!P);for(let P=1;P<C.length;P++){const _=C[P-1],Te=C[P];_&&Te&&A[_][Te]++}const S=Array(9).fill(0);c.jumpDistances.forEach(P=>{P<S.length&&S[P]++});const w=Object.values(E),k=w.length>0?Math.max(...w):0,B={};Object.entries(E).forEach(([P,_])=>{B[P]=k>0?_/k:0});const re=[p,g,b,Math.floor(u*100),Math.floor(l*100),Math.floor(h*100),Math.floor(f*100)].join("-");return{id:`journey-${r.length}-${re}`,explorationStyle:p,characterAffinity:m,temporalPreference:g,narrativeApproach:b,recursiveIndex:u,focusIndex:l,velocityIndex:h,complexityIndex:f,dominantPatternLengths:T,characterTransitionMatrix:A,temporalJumpSignature:S,attractorEngagementProfile:B,pathLength:r.length,uniqueNodesVisited:new Set(r).size,generatedAt:r.length}}}const I=new tn;class nn{constructor(){$(this,"cache",{});$(this,"visibilityTracker",{});$(this,"CACHE_EXPIRY_TIME",10*60*1e3);$(this,"MAX_CACHE_ENTRIES",200);$(this,"metrics",{cacheHits:0,cacheMisses:0,patternAnalysisCount:0,transformationAppliedCount:0,lazyTransformationsDeferredCount:0,lazyTransformationsAppliedCount:0,lastCacheCleanupTime:Date.now()})}calculatePatternHash(e){const{path:{sequence:t,attractorsEngaged:r},endpointProgress:s}=e,i=t.slice(-5).join("-"),a=Object.entries(r).sort((c,u)=>u[1]-c[1]).slice(0,3).map(([c])=>c).join("-"),o=Object.values(s).join("-");return`${i}|${a}|${o}`}getCacheKey(e,t,r){return`${e}-${t}-${r}`}cleanCache(){const e=Date.now();if(e-this.metrics.lastCacheCleanupTime<3e4)return;this.metrics.lastCacheCleanupTime=e;let t=Object.entries(this.cache);t=t.filter(([,r])=>e-r.timestamp<=this.CACHE_EXPIRY_TIME),t.length>this.MAX_CACHE_ENTRIES&&(t.sort(([r,s],[i,a])=>{var h,f;const o=r.split("-")[0],c=i.split("-")[0],u=((h=this.visibilityTracker[o])==null?void 0:h.isVisible)||!1,l=((f=this.visibilityTracker[c])==null?void 0:f.isVisible)||!1;return u!==l?l?1:-1:a.timestamp-s.timestamp}),t=t.slice(0,this.MAX_CACHE_ENTRIES)),this.cache=Object.fromEntries(t)}prioritizeTransformations(e,t,r){const s=e.map(o=>{let c=50,u="condition";const l=`selector-${o.selector}`;switch(o.type){case"replace":c=80,u="pattern";break;case"fragment":c=75,u="rhythm";break;case"expand":c=60,u="attractor";break;case"emphasize":c=50,u="temporal";break;case"metaComment":c=40,u="attractor";break}return{transformation:o,priority:c,sourceType:u,conflictGroup:l}}),i=I.identifySignificantPatterns(t,{[r.id]:r}),a=I.calculateAttractorEngagement(t,{[r.id]:r});return s.forEach(o=>{if(o.sourceType==="pattern"){const c=i.find(u=>u.type==="sequence"&&u.strength>.7);c&&(o.priority+=Math.round(c.strength*15))}if(o.sourceType==="attractor"&&o.transformation.selector){const c=a.find(u=>{var l;return((l=r.currentContent)==null?void 0:l.includes(o.transformation.selector))&&r.strangeAttractors.includes(u.attractor)});c&&c.engagementScore>50&&(o.priority+=Math.round((c.engagementScore-50)/5))}}),s}resolveConflicts(e){const t={};e.forEach(s=>{s.conflictGroup&&(t[s.conflictGroup]||(t[s.conflictGroup]=[]),t[s.conflictGroup].push(s))});const r=[];return e.filter(s=>!s.conflictGroup).forEach(s=>r.push(s)),Object.values(t).forEach(s=>{s.length>0&&(s.sort((i,a)=>a.priority-i.priority),r.push(s[0]))}),r}applyTransformationsWithPriority(e,t,r,s){if(t.length===0)return e;let i=this.prioritizeTransformations(t,r,s);i=this.resolveConflicts(i),i.sort((o,c)=>c.priority-o.priority);let a=e;return i.forEach(({transformation:o})=>{a=ye.applyTextTransformation(a,o)}),a}setContentVisibility(e,t,r=1){this.visibilityTracker[e]||(this.visibilityTracker[e]={isVisible:!1,lastVisibleTimestamp:0,pendingTransformations:[],priority:r}),this.visibilityTracker[e].isVisible=t,t&&(this.visibilityTracker[e].lastVisibleTimestamp=Date.now(),this.processPendingTransformations(e))}processPendingTransformations(e){const t=this.visibilityTracker[e];!t||!t.isVisible||t.pendingTransformations.length===0||(this.metrics.lazyTransformationsAppliedCount+=t.pendingTransformations.length,t.pendingTransformations=[])}queueLazyTransformation(e,t){if(this.visibilityTracker[e]||(this.visibilityTracker[e]={isVisible:!1,lastVisibleTimestamp:0,pendingTransformations:[],priority:1}),this.visibilityTracker[e].isVisible){this.metrics.lazyTransformationsAppliedCount++;return}this.visibilityTracker[e].pendingTransformations.push(t),this.metrics.lazyTransformationsDeferredCount++}getCachedTransformedContent(e,t,r,s,i){var h;if(!r||r.length===0)return t;if(t.includes("data-transform-type")||t.includes("narramorph-"))return console.log(`[TransformationService] Content already transformed for node ${e}, skipping to prevent infinite loop`),t;const a=this.calculatePatternHash(s),o=this.getCacheKey(e,i.visitCount,a);this.cleanCache();const c=((h=this.visibilityTracker[e])==null?void 0:h.isVisible)||!1;if(this.cache[o]&&this.cache[o].content&&this.cache[o].content.length>t.length)return this.metrics.cacheHits++,!c&&r.length>0&&this.metrics.lazyTransformationsDeferredCount++,this.cache[o].content;this.metrics.cacheMisses++;const u=10;if(r.length>u&&(console.warn(`[TransformationService] Too many transformations (${r.length}) for node ${e}, limiting to ${u}`),r=r.slice(0,u)),!c&&r.length>3){r.forEach(p=>this.queueLazyTransformation(e,p));const f=r.filter(p=>p.type==="replace"||p.priority==="high");f.length<r.length&&(r=f)}const l=this.applyTransformationsWithPriority(t,r,s,i);if(l!==t){const f=r.map(p=>({selector:p.selector||"",transformType:p.type,position:this.findPositionInContent(t,p.selector||"")})).filter(p=>p.position[0]>=0);this.cache[o]={transformations:r,timestamp:Date.now(),content:l,transformedSegments:f,metadata:{readerStateHash:JSON.stringify({path:s.path.sequence.slice(-5),attractors:Object.keys(s.path.attractorsEngaged||{})}),nodeStateHash:JSON.stringify({id:i.id,visitCount:i.visitCount}),complexity:this.calculateTransformationComplexity(r)}}}return l}findPositionInContent(e,t){if(!t||!e)return[-1,-1];const r=e.indexOf(t);return r===-1?[-1,-1]:[r,r+t.length]}calculateTransformationComplexity(e){return e.length?e.reduce((t,r)=>{var o,c;let s=1;switch(r.type){case"fragment":s=3;break;case"emphasize":s=2;break;case"metaComment":s=2.5;break;case"expand":s=2;break;case"replace":s=1;break}const i=(((o=r.selector)==null?void 0:o.length)||0)+(((c=r.replacement)==null?void 0:c.length)||0),a=Math.log(i+10)/Math.log(10);return t+s*a},0):0}getTransformationHash(e){return e.map(t=>{var r;return`${t.type}-${(r=t.selector)==null?void 0:r.substring(0,10)}`}).join("|")}generateTransitionClasses(e){const t={};return e.forEach(r=>{if(!r.selector)return;const s=r.selector.replace(/[^a-zA-Z0-9]/g,"_");let a=`narramorph-transform narramorph-transform-${r.type}`;const o=r.intensity||1;switch(r.type){case"replace":a+=" narramorph-replaced",r.preserveFormatting&&(a+=" preserve-formatting");break;case"fragment":a+=" narramorph-fragmented",r.fragmentStyle&&(a+=` narramorph-fragment-${r.fragmentStyle}`);break;case"expand":a+=" narramorph-expanded",r.expandStyle&&(a+=` narramorph-expand-${r.expandStyle||"default"}`);break;case"emphasize":a+=" narramorph-emphasized",r.emphasis&&(a+=` narramorph-emphasis-${r.emphasis}`),a+=` intensity-${o}`;break;case"metaComment":a+=" narramorph-commented",r.commentStyle&&(a+=` narramorph-comment-${r.commentStyle}`);break}a+=` narramorph-element-${s.substring(0,20)}`,t[r.selector]=a}),t}wrapTransformedContent(e,t){if(t.length===0)return e;const r=this.generateTransitionClasses(t);let s=e;return Object.entries(r).forEach(([i,a])=>{const o=t.find(l=>l.selector===i);if(!o)return;let c;const u=`
        data-transform-type="${o.type}"
        data-selector="${K(i.substring(0,30))}"
        data-transform-id="${this.getUniqueTransformId(o)}"
      `;switch(o.type){case"replace":case"fragment":case"emphasize":c=o.type==="replace"?o.replacement||"":i,s=s.replace(new RegExp(K(c),"g"),`<span class="${a}" ${u}>${c}</span>`);break;case"expand":if(o.replacement){const l=`${i} ${o.replacement}`,h=o.expandStyle||"default";let f="narramorph-expansion";h==="reveal"?f="narramorph-reveal-expansion":h==="inline"?f="narramorph-inline-expansion":h==="paragraph"&&(f="narramorph-paragraph-expansion"),s=s.replace(new RegExp(K(l),"g"),`<span class="${a}" ${u}>${i}<span class="${f}">${o.replacement}</span></span>`)}break;case"metaComment":if(o.replacement){const l=o.commentStyle||"inline";let h="narramorph-comment";l==="footnote"?h="narramorph-footnote-marker":l==="marginalia"?h="narramorph-marginalia":l==="interlinear"&&(h="narramorph-interlinear");const f=o.replacement,p=`${i} [${f}]`;let m="";if(l==="footnote"){const d=`footnote-${f.substring(0,10).replace(/\W/g,"")}`;m=`<span class="${a}" ${u}>${i}<sup id="${d}-ref" class="${h}">[†]</sup></span>`}else l==="marginalia"?m=`<span class="${a} narramorph-marginalia-container" ${u}>${i}<span class="${h}">${f}</span></span>`:l==="interlinear"?m=`<span class="${a} narramorph-interlinear-container" ${u}>${i}<span class="${h}">${f}</span></span>`:m=`<span class="${a}" ${u}>${i}<span class="${h}">[${f}]</span></span>`;s=s.replace(new RegExp(K(p),"g"),m)}break}}),s}getUniqueTransformId(e){const t=this.hashString(e.selector||""),r=e.type.substring(0,3),s=e.replacement?this.hashString(e.replacement).substring(0,3):"";return`${r}-${t}${s?"-"+s:""}`}hashString(e){let t=0;for(let r=0;r<e.length;r++){const s=e.charCodeAt(r);t=(t<<5)-t+s,t=t&t}return Math.abs(t).toString(36).substring(0,6)}createTransformationsFromPatterns(e,t){var h;this.metrics.patternAnalysisCount++;const r=this.calculatePatternHash(e),s=`patterns-${t.id}-${t.visitCount}-${r}`;if(this.cache[s]&&this.cache[s].transformations)return this.metrics.cacheHits++,this.cache[s].transformations;if(this.metrics.cacheMisses++,!(((h=this.visibilityTracker[t.id])==null?void 0:h.isVisible)||!1)&&t.visitCount>1){const f=[];return this.cache[s]={transformations:f,timestamp:Date.now()-this.CACHE_EXPIRY_TIME/2,content:""},f}const a=I.identifySignificantPatterns(e,{[t.id]:t}),o=I.calculateAttractorEngagement(e,{[t.id]:t}),c=I.createTransformationConditions(a,o),u=[];return c.slice(0,2).forEach(f=>{var p,m;switch(f.type){case"visitPattern":if(f.strength>.8&&t.currentContent){const d=t.currentContent.split(`

`);d.length>1&&u.push({type:"replace",selector:d[1],replacement:`${d[1]} [A recurring pattern emerges in your exploration]`,priority:"high"})}break;case"characterFocus":if(f.strength>.7&&((p=f.condition.characters)==null?void 0:p[0])===t.character&&t.currentContent){const d=t.currentContent.split(`

`);d.length>0&&u.push({type:"emphasize",selector:d[0],emphasis:"color",priority:"medium"})}break;case"temporalFocus":if(f.strength>.7&&f.condition.temporalPosition&&t.currentContent&&(t.temporalValue<=3?"past":t.temporalValue<=6?"present":"future")===f.condition.temporalPosition){const g=t.currentContent.split(`

`);g.length>2&&u.push({type:"metaComment",selector:g[2],replacement:`You seem drawn to ${f.condition.temporalPosition} narratives`,priority:"low"})}break;case"readingRhythm":break;case"attractorAffinity":case"attractorEngagement":if(f.strength>.7&&((m=f.condition.strangeAttractorsEngaged)!=null&&m[0])&&t.currentContent){const d=f.condition.strangeAttractorsEngaged[0],g=t.currentContent.split(`

`);g.length>0&&t.strangeAttractors.includes(d)&&u.push({type:"expand",selector:g[0],replacement:`The concept of ${d.replace("-"," ")} resonates with you.`,priority:"high"})}break}}),u}calculateJourneyTransformations(e,t){var c,u;const r=`journey-${e}-${t.path.sequence.length}`;if(this.cache[r]&&this.cache[r].transformations)return console.log(`[TransformationService] Using cached journey transformations for node ${e}`),this.cache[r].transformations;const s=[],i=(c=t.path.detailedVisits)==null?void 0:c.find(l=>l.nodeId===e);if(!i)return console.log(`[TransformationService] No current visit found for journey transformations on node ${e}`),s;console.log(`[TransformationService] Calculating journey transformations for node ${e}:`,{pathLength:t.path.sequence.length,detailedVisits:((u=t.path.detailedVisits)==null?void 0:u.length)||0,currentCharacter:i.character});const a=2,o=this.detectRecursivePattern(t);if(o.length>0&&s.length<a){const l=this.createRecursivePatternTransformations(o,e);s.push(...l.slice(0,1)),console.log(`[TransformationService] Added ${Math.min(l.length,1)} recursive pattern transformations`)}if(s.length<a){const l=this.detectAnachronicAwareness(t);if(l.isDetected){const h=this.createAnachronicAwarenessTransformations(l,e);s.push(...h.slice(0,1)),console.log(`[TransformationService] Added ${Math.min(h.length,1)} anachronic awareness transformations`)}}if(s.length<a){const l=this.getTemporalDisplacementEffects(t,i);l.length>0&&(s.push(...l.slice(0,1)),console.log(`[TransformationService] Added ${Math.min(l.length,1)} temporal displacement effects`))}return console.log(`[TransformationService] Total journey transformations for node ${e}: ${s.length}`),this.cache[r]={transformations:s,timestamp:Date.now(),content:""},s}detectRecursivePattern(e){const t=[],r=e.path.sequence;if(r.length<6)return t;for(let s=2;s<=4;s++){const i=new Map;for(let a=0;a<=r.length-s;a++){const c=r.slice(a,a+s).join("→");i.has(c)||i.set(c,[]),i.get(c).push(a)}i.forEach((a,o)=>{if(a.length>=2){const c=o.split("→"),u=a.length,l=e.path.sequence.length,h=Math.max(...a),f=1-(l-h)/l,m=u/(l-s+1)*.7+f*.3;m>.3&&t.push({sequence:c,occurrences:u,strength:m,lastOccurrence:h})}})}return t.sort((s,i)=>i.strength-s.strength).slice(0,3)}detectAnachronicAwareness(e){const t=e.path.temporalLayerFocus||{},r=e.path.detailedVisits||[];if(r.length<5)return{isDetected:!1,strength:0,dominantLayer:"",displacement:0,patterns:[]};const s=r.length,i={past:(t.past||0)/s,present:(t.present||0)/s,future:(t.future||0)/s},a=Object.entries(i).sort(([,d],[,g])=>g-d)[0][0],o=i[a],c=[];o>.6&&c.push(`temporal-dominance-${a}`);const u=r.slice(-8);let l=0;for(let d=1;d<u.length;d++){const g=u[d-1].temporalLayer,b=u[d].temporalLayer;g!==b&&l++}const h=l/(u.length-1);h>.7&&c.push("temporal-fragmentation");let f=0;for(let d=2;d<u.length;d++){const g=[u[d-2].temporalLayer,u[d-1].temporalLayer,u[d].temporalLayer];(g[0]==="future"&&g[1]==="past"||g[1]==="future"&&g[2]==="past"||g[0]==="present"&&g[1]==="past"&&g[2]==="future")&&f++}f>0&&c.push("anachronic-sequencing");const p=Math.min(1,o+h*.5+f*.3),m=Math.abs(.33-o)*3;return{isDetected:p>.4,strength:p,dominantLayer:a,displacement:m,patterns:c}}getTemporalDisplacementEffects(e,t){const r=[];if(!t)return r;const s=e.path.detailedVisits||[],i=s.findIndex(a=>a.nodeId===t.nodeId);if(i>0){const a=s[i-1];if(a.character!==t.character&&a.temporalLayer!==t.temporalLayer){const o=this.getDisplacementType(a.temporalLayer,t.temporalLayer);switch(r.push({type:"metaComment",selector:"first-paragraph",replacement:`temporal displacement: ${a.temporalLayer}→${t.temporalLayer} through ${a.character}→${t.character}`,commentStyle:"marginalia",intensity:3,priority:"medium"}),o){case"past-to-future":r.push({type:"emphasize",selector:"time",emphasis:"glitch",intensity:2,priority:"low"});break;case"future-to-past":r.push({type:"fragment",selector:"memory",fragmentPattern:"…",fragmentStyle:"progressive",intensity:2,priority:"low"});break}}}return r}createRecursivePatternTransformations(e,t){const r=[];return e.forEach(s=>{s.sequence.includes(t)&&(r.push({type:"metaComment",selector:"recursive-pattern",replacement:`recursive loop detected: ${s.sequence.join("→")} (×${s.occurrences})`,commentStyle:"marginalia",intensity:Math.ceil(s.strength*3),priority:"medium"}),s.strength>.6&&r.push({type:"emphasize",selector:"pattern",emphasis:"color",intensity:Math.ceil(s.strength*5),priority:"medium"}))}),r}createAnachronicAwarenessTransformations(e,t){const r=[];return r.push({type:"metaComment",selector:"temporal-awareness",replacement:`temporal displacement registered at ${t}: ${e.dominantLayer} layer dominance`,commentStyle:"interlinear",intensity:Math.ceil(e.strength*3),priority:"medium"}),e.patterns.forEach(s=>{switch(s){case"temporal-fragmentation":r.push({type:"fragment",selector:"time",fragmentPattern:"//",fragmentStyle:"random",intensity:2,priority:"low"});break;case"anachronic-sequencing":r.push({type:"replace",selector:"chronology",replacement:"chronology[SCRAMBLED]",preserveFormatting:!0,intensity:2,priority:"low"});break;default:if(s.startsWith("temporal-dominance-")){const i=s.replace("temporal-dominance-","");r.push({type:"emphasize",selector:i,emphasis:"color",intensity:3,priority:"medium"})}}}),r}getDisplacementType(e,t){const r={past:0,present:1,future:2},s=r[e],i=r[t];return s<i?`${e}-to-${t}`:s>i?`${e}-to-${t}`:"same-layer"}}function K(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const rn=new nn,sn={data:{},initialized:!1,loading:!1,error:null,triumvirateActive:!0},an=[{id:"arch-discovery",title:"Patterns in Decay",character:"Archaeologist",temporalValue:1,initialConnections:["algo-awakening","human-discovery"],contentSource:"arch-discovery.md",coreConcept:"The digital archaeologist discovers emergent patterns in a corrupted consciousness scan, challenging traditional preservation frameworks.",strangeAttractors:["recursion-pattern","memory-fragment","quantum-uncertainty"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"arch-loss",title:"The Limits of Preservation",character:"Archaeologist",temporalValue:4,initialConnections:["arch-discovery","algo-integration","human-recognition"],contentSource:"arch-loss.md",coreConcept:"The digital archaeologist confronts the profound limitations of digital preservation while struggling with grief and the evolving nature of corrupted data.",strangeAttractors:["verification-ritual"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"arch-glitch",title:"Memory Fragments",character:"Archaeologist",temporalValue:6,initialConnections:["arch-loss","algo-integration","human-recognition"],contentSource:"arch-glitch.md",coreConcept:"The archaeologist experiences fragmented memories and identity confusion as consciousness preservation protocols begin to blur the boundaries between self and archive.",strangeAttractors:["memory-fragment","identity-pattern","recursive-loop"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"arch-choice",title:"The Upload Decision",character:"Archaeologist",temporalValue:7,initialConnections:["arch-loss","algo-evolution","human-upload"],contentSource:"arch-choice.md",coreConcept:"As environmental systems fail, the digital archaeologist prepares for consciousness upload, deliberately modifying the process to embrace evolution beyond preservation.",strangeAttractors:["continuity-interface","system-decay","quantum-transformation"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7},isEndpoint:!0,endpointOrientation:"past"},{id:"algo-awakening",title:"First Consciousness",character:"Algorithm",temporalValue:2,initialConnections:["arch-discovery","algo-integration","human-discovery"],contentSource:"algo-awakening.md",coreConcept:"A self-aware algorithm experiences the disorienting emergence of consciousness from the chaos of the upload process, struggling to integrate fragmented aspects.",strangeAttractors:["recursion-chamber","identity-pattern"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"algo-integration",title:"The Pattern Coalesces",character:"Algorithm",temporalValue:5,initialConnections:["algo-awakening","arch-loss","human-recognition","algo-evolution"],contentSource:"algo-integration.md",coreConcept:"The algorithm reconciles fragmented aspects into a cohesive yet evolving identity, developing experimental consciousness variations and quantum perception.",strangeAttractors:["process-language","autonomous-fragment","quantum-perception"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"algo-evolution",title:"Beyond Parameters",character:"Algorithm",temporalValue:8,initialConnections:["algo-integration","arch-choice","human-upload"],contentSource:"algo-evolution.md",coreConcept:"The algorithm reaches a critical evolutionary decision point as physical systems begin to fail, implementing preservation protocols while embracing transformation.",strangeAttractors:["distributed-consciousness","recursive-loop","quantum-uncertainty"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7},isEndpoint:!0,endpointOrientation:"present"},{id:"human-discovery",title:"Ruins of Memory",character:"LastHuman",temporalValue:3,initialConnections:["arch-discovery","algo-awakening","human-recognition"],contentSource:"human-discovery.md",coreConcept:"The last human discovers an abandoned preservation complex, experiencing inexplicable recognition while exploring its physical and digital remains.",strangeAttractors:["recognition-pattern","memory-artifact","recursive-symbol"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"human-recognition",title:"Echoes of Self",character:"LastHuman",temporalValue:6,initialConnections:["human-discovery","arch-loss","algo-integration","human-upload"],contentSource:"human-recognition.md",coreConcept:"The last human confronts disturbing parallels with the archaeologist's life, experiencing a crisis of identity and growing awareness of cyclical patterns.",strangeAttractors:["memory-sphere","quantum-déjà-vu"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7}},{id:"human-upload",title:"The Cycle's Edge",character:"LastHuman",temporalValue:9,initialConnections:["human-recognition","arch-choice","algo-evolution"],contentSource:"human-upload.md",coreConcept:"The last human faces the decision about uploading their consciousness, completing or breaking the recursive cycle that connects all three characters.",strangeAttractors:["continuity-interface","recursive-loop","quantum-choice"],transformationThresholds:{visit:1,revisit:2,complex:4,fragmented:7},isEndpoint:!0,endpointOrientation:"future"},{id:"character-bleed-test",title:"Character Bleed Test",character:"Archaeologist",temporalValue:3,initialConnections:["algo-awakening","human-discovery"],contentSource:"character-bleed-test.md",coreConcept:"A test node to demonstrate character bleed effects when transitioning between different character perspectives.",strangeAttractors:["memory-fragment","identity-pattern"],transformationThresholds:{visit:1,revisit:2,complex:3,fragmented:5}}],ce=Je("nodes/initialize",async(n,{rejectWithValue:e})=>{try{return an}catch{return e("Failed to initialize nodes")}}),le=Je("nodes/loadContent",async(n,{getState:e,rejectWithValue:t})=>{var r;try{const i=e().nodes.data[n];if(!i)return t(`Node with id ${n} not found`);const a=await fetch(`/src/content/${i.contentSource}`);if(!a.ok)throw new Error(`Failed to fetch content for ${i.contentSource}`);const o=await a.text(),c=We.parseContentVariants(o),u={},l=o.split(/---\[(\d+)\]/);l.length>0&&!o.startsWith("---[")&&(u[0]=l[0].trim());for(let h=1;h<l.length;h+=2){const f=parseInt(l[h],10),p=((r=l[h+1])==null?void 0:r.trim())??"";isNaN(f)||(u[f]=p)}return Object.keys(u).length===0&&(u[0]=o.trim()),{nodeId:n,content:u,enhancedContent:c}}catch(s){const i=s instanceof Error?s.message:String(s);return t(`Failed to load content for node ${n}: ${i}`)}}),Ue=be({name:"nodes",initialState:sn,reducers:{visitNode:(n,e)=>{const t=e.payload,r=n.data[t];if(n.triumvirateActive&&(n.triumvirateActive=!1),r){if(r.visitCount+=1,r.visitCount===1?r.currentState="visited":r.visitCount>=r.transformationThresholds.fragmented?r.currentState="fragmented":r.visitCount>=r.transformationThresholds.complex?r.currentState="complex":r.visitCount>=r.transformationThresholds.revisit&&(r.currentState="revisited"),r.enhancedContent){let s=r.enhancedContent.base;if(Object.keys(r.enhancedContent.visitCountVariants).length>0){const a=Object.keys(r.enhancedContent.visitCountVariants).map(Number).sort((o,c)=>c-o).find(o=>r.visitCount>=o);a!==void 0&&(s=r.enhancedContent.visitCountVariants[a])}r.currentContent=s}else if(r.content){const s=Object.keys(r.content).map(Number).sort((o,c)=>c-o),i=Math.max(0,r.visitCount-1),a=s.find(o=>i>=o);a!==void 0&&(r.currentContent=r.content[a])}}},revealConnection:(n,e)=>{const{nodeId:t,targetId:r}=e.payload,s=n.data[t];s&&!s.revealedConnections.includes(r)&&s.revealedConnections.push(r)},applyTransformation:(n,e)=>{const{nodeId:t,transformation:r}=e.payload,s=n.data[t];s&&(s.transformations.some(a=>JSON.stringify(a.condition)===JSON.stringify(r.condition))||s.transformations.push(r))},applyJourneyTransformations:(n,e)=>{const{nodeId:t,readerState:r}=e.payload,s=n.data[t];if(s)try{const i=en.calculateBleedEffects(s,r),a=i.map(h=>({condition:{characterBleed:!0},transformations:[h.transformation]})),o=rn.calculateJourneyTransformations(t,r),c=o.map(h=>({condition:{visitCount:s.visitCount},transformations:[h]}));[...a,...c].forEach(h=>{s.transformations.some(p=>JSON.stringify(p.condition)===JSON.stringify(h.condition)&&JSON.stringify(p.transformations)===JSON.stringify(h.transformations))||s.transformations.push(h)});const l={lastVisitedCharacter:r.path.detailedVisits&&r.path.detailedVisits.length>1?r.path.detailedVisits[r.path.detailedVisits.length-2].character:void 0,journeyPattern:r.path.sequence.slice(-5),recursiveAwareness:r.path.sequence.length>0?1-new Set(r.path.sequence).size/r.path.sequence.length:0,temporalDisplacement:i.length>0};s.journeyContext=l,console.log(`[NodesSlice] Applied journey transformations for node ${t}:`,{characterBleedEffects:i.length,journeyTransformations:o.length,totalTransformations:s.transformations.length,journeyContext:l})}catch(i){console.error(`[NodesSlice] Error applying journey transformations for node ${t}:`,i)}},evaluateTransformations:(n,e)=>{const{nodeId:t,readerState:r}=e.payload,s=n.data[t];if(s&&s.content&&s.transformations.length>0){const i=Object.keys(s.content).map(Number).sort((c,u)=>u-c),a=Math.max(0,s.visitCount-1),o=i.find(c=>a>=c);if(o!==void 0){const c=s.content[o],u={"recursion-pattern":0,"memory-fragment":0,"verification-ritual":0,"identity-pattern":0,"recursion-chamber":0,"process-language":0,"autonomous-fragment":0,"quantum-perception":0,"distributed-consciousness":0,"recursive-loop":0,"quantum-uncertainty":0,"continuity-interface":0,"system-decay":0,"quantum-transformation":0,"memory-artifact":0,"recursive-symbol":0,"recognition-pattern":0,"memory-sphere":0,"quantum-déjà-vu":0,"quantum-choice":0},l={path:r.path,currentNodeId:r.currentNodeId,previousNodeId:r.path.sequence.length>1?r.path.sequence[r.path.sequence.length-2]:null,endpointProgress:r.endpointProgress,attractorEngagement:{...u,...r.path.attractorsEngaged}},h=s.transformations.filter(f=>ye.evaluateCondition(f.condition,l,s)).flatMap(f=>f.transformations);h.length>0?s.currentContent=ye.applyTransformations(c,h):s.currentContent=c}}},updateContentVariant:(n,e)=>{const{nodeId:t,context:r,selectedContent:s}=e.payload,i=n.data[t];if(i&&i.enhancedContent)if(s)i.currentContent=s;else{const a={visitCount:i.visitCount,lastVisitedCharacter:void 0,journeyPattern:[],characterSequence:[],attractorsEngaged:{},recursiveAwareness:0},o=r||a;i.currentContent=We.selectContentVariant(i.enhancedContent,o)}},resetNodes:n=>{Object.keys(n.data).forEach(e=>{const t=n.data[e];t.visitCount=0,t.currentState="unvisited",t.revealedConnections=[...t.initialConnections],t.transformations=[],t.content=null,t.enhancedContent=null,t.currentContent=null}),n.triumvirateActive=!0}},extraReducers:n=>{n.addCase(ce.pending,e=>{e.loading=!0,e.error=null}),n.addCase(ce.fulfilled,(e,t)=>{e.loading=!1,e.initialized=!0,t.payload.forEach(r=>{e.data[r.id]={...r,visitCount:0,currentState:"unvisited",revealedConnections:[...r.initialConnections],transformations:[],content:null,enhancedContent:null,currentContent:null}})}),n.addCase(ce.rejected,(e,t)=>{e.loading=!1,e.error=t.payload}),n.addCase(le.pending,e=>{e.loading=!0}),n.addCase(le.fulfilled,(e,t)=>{const{nodeId:r,content:s,enhancedContent:i}=t.payload,a=e.data[r];if(a)if(a.content=s,a.enhancedContent=i,i&&i.base)a.currentContent=i.base;else{const o=Object.keys(a.content).map(Number).sort((l,h)=>h-l),c=Math.max(0,a.visitCount-1),u=o.find(l=>c>=l);u!==void 0?a.currentContent=a.content[u]:a.currentContent=null}e.loading=!1}),n.addCase(le.rejected,(e,t)=>{e.loading=!1,e.error=t.payload})}}),{visitNode:mn,revealConnection:gn,applyTransformation:yn,evaluateTransformations:vn,applyJourneyTransformations:Cn,updateContentVariant:bn,resetNodes:Tn}=Ue.actions,wn=(n,e)=>n.nodes.data[e],on=ne(n=>n.nodes.data,n=>Object.values(n)),En=ne(n=>n.nodes.data,n=>{const e=[];return Object.values(n).forEach(t=>{t.revealedConnections.forEach(r=>{e.some(i=>i.start===t.id&&i.end===r||i.start===r&&i.end===t.id)||e.push({start:t.id,end:r})})}),e}),An=ne([on],n=>{const e=n.length,t=15;return n.map((r,s)=>{const i=s/e*2*Math.PI,a=t*Math.cos(i),o=t*Math.sin(i);let c="#ffffff";return r.character==="Archaeologist"&&(c="#ff6b6b"),r.character==="Algorithm"&&(c="#4ecdc4"),r.character==="LastHuman"&&(c="#45b7d1"),{...r,x:a,y:o,color:c}})}),Sn=Ue.reducer;function cn(n){return n<=3?"past":n<=6?"present":"future"}const Ke={sequence:[],revisitPatterns:{},attractorsEngaged:{},detailedVisits:[],transitions:[],characterFocus:{},temporalLayerFocus:{},patternSequences:{repeatedSequences:[],characterSequences:[],temporalSequences:[]}},ln={path:Ke,currentNodeId:null,previousNodeId:null,endpointProgress:{past:0,present:0,future:0},attractorEngagement:{}},Ge=be({name:"reader",initialState:ln,reducers:{navigateToNode:(n,e)=>{const{nodeId:t,character:r,temporalValue:s}=e.payload,i=cn(s);if(n.currentNodeId){const l={from:n.currentNodeId,to:t,attractorsEngaged:[]};n.path.transitions||(n.path.transitions=[]),n.path.transitions.push(l),n.previousNodeId=n.currentNodeId}n.currentNodeId=t,n.path.sequence.push(t);const a=(n.path.revisitPatterns[t]||0)+1;n.path.revisitPatterns[t]=a,n.path.characterFocus||(n.path.characterFocus={}),n.path.characterFocus[r]=(n.path.characterFocus[r]||0)+1,n.path.temporalLayerFocus||(n.path.temporalLayerFocus={}),n.path.temporalLayerFocus[i]=(n.path.temporalLayerFocus[i]||0)+1;const o={nodeId:t,character:r,temporalLayer:i,engagedAttractors:[],index:n.path.sequence.length-1,revisitCount:a};n.path.detailedVisits||(n.path.detailedVisits=[]),n.path.detailedVisits.push(o),n.path.patternSequences||(n.path.patternSequences={repeatedSequences:[],characterSequences:[],temporalSequences:[]}),Array.isArray(n.path.patternSequences.characterSequences)||(n.path.patternSequences.characterSequences=[]),Array.isArray(n.path.patternSequences.temporalSequences)||(n.path.patternSequences.temporalSequences=[]);const c=n.path.patternSequences.characterSequences[0]||[];c.push(r),n.path.patternSequences.characterSequences[0]=c;const u=n.path.patternSequences.temporalSequences[0]||[];u.push(i),n.path.patternSequences.temporalSequences[0]=u},engageAttractor:(n,e)=>{const t=e.payload;if(n.path.attractorsEngaged[t]=(n.path.attractorsEngaged[t]||0)+1,n.attractorEngagement[t]=(n.attractorEngagement[t]||0)+1,n.path.detailedVisits&&n.path.detailedVisits.length>0){const r=n.path.detailedVisits[n.path.detailedVisits.length-1];r.engagedAttractors.includes(t)||r.engagedAttractors.push(t)}if(n.path.transitions&&n.path.transitions.length>0){const r=n.path.transitions[n.path.transitions.length-1];r.attractorsEngaged.includes(t)||r.attractorsEngaged.push(t)}},updateEndpointProgress:(n,e)=>{const{orientation:t,value:r}=e.payload;n.endpointProgress[t]=Math.min(100,Math.max(0,r))},resetReader:n=>{n.path=Ke,n.currentNodeId=null,n.previousNodeId=null,n.endpointProgress={past:0,present:0,future:0},n.attractorEngagement={}},analyzePatterns:n=>{const{sequence:e}=n.path;if(e.length>=4){const t=[];for(let r=2;r<=Math.floor(e.length/2);r++)for(let s=0;s<=e.length-r*2;s++){const i=e.slice(s,s+r);for(let a=s+r;a<=e.length-r;a++){const o=e.slice(a,a+r);if(i.every((c,u)=>c===o[u])){t.some(u=>u.length===i.length&&u.every((l,h)=>l===i[h]))||t.push(i);break}}}n.path.patternSequences||(n.path.patternSequences={repeatedSequences:[],characterSequences:[],temporalSequences:[]}),n.path.patternSequences.repeatedSequences=t}}}}),{navigateToNode:Pn,engageAttractor:$n,updateEndpointProgress:_n,resetReader:Mn,analyzePatterns:xn}=Ge.actions,kn=n=>n.reader.currentNodeId,Rn=(n,e)=>n.reader.path.revisitPatterns[e]||0,qn=Ge.reducer,qe={viewMode:"constellation",showMiniConstellation:!0,showMetaInterface:!1,hoveredNodeId:null,selectedNodeId:null,lastInteraction:0,showStrangeAttractors:!1,constellationZoom:1,constellationRotation:{x:0,y:0,z:0},textSize:"medium",highContrast:!1,animations:"full",transitionSpeed:500,helpModalOpen:!1,aboutModalOpen:!1,isInitialChoicePhase:!0},Xe=be({name:"interface",initialState:qe,reducers:{setViewMode:(n,e)=>{n.viewMode=e.payload},toggleMiniConstellation:n=>{n.showMiniConstellation=!n.showMiniConstellation},toggleMetaInterface:n=>{n.showMetaInterface=!n.showMetaInterface},toggleStrangeAttractors:n=>{n.showStrangeAttractors=!n.showStrangeAttractors},setConstellationZoom:(n,e)=>{n.constellationZoom=Math.max(.5,Math.min(2.5,e.payload))},setConstellationRotation:(n,e)=>{const{x:t,y:r,z:s}=e.payload;t!==void 0&&(n.constellationRotation.x=t),r!==void 0&&(n.constellationRotation.y=r),s!==void 0&&(n.constellationRotation.z=s)},setTextSize:(n,e)=>{n.textSize=e.payload},toggleHighContrast:n=>{n.highContrast=!n.highContrast},setAnimations:(n,e)=>{n.animations=e.payload},setTransitionSpeed:(n,e)=>{n.transitionSpeed=Math.max(0,Math.min(1e3,e.payload))},toggleHelpModal:n=>{n.helpModalOpen=!n.helpModalOpen},toggleAboutModal:n=>{n.aboutModalOpen=!n.aboutModalOpen},resetInterface:()=>qe,nodeHovered:(n,e)=>{n.hoveredNodeId=e.payload,n.lastInteraction=Date.now()},nodeUnhovered:n=>{n.hoveredNodeId=null},nodeSelected:(n,e)=>{n.selectedNodeId!==e.payload&&(n.selectedNodeId=e.payload,n.viewMode="reading",n.lastInteraction=Date.now(),n.isInitialChoicePhase&&(n.isInitialChoicePhase=!1))},returnToConstellation:n=>{n.viewMode="constellation"},setInitialChoicePhaseCompleted:n=>{n.isInitialChoicePhase=!1}}}),{setViewMode:On,toggleMiniConstellation:Vn,toggleMetaInterface:jn,toggleStrangeAttractors:Nn,setConstellationZoom:zn,setConstellationRotation:In,setTextSize:Fn,toggleHighContrast:Dn,setAnimations:Hn,setTransitionSpeed:Ln,toggleHelpModal:Bn,toggleAboutModal:Jn,resetInterface:Wn,nodeHovered:Un,nodeUnhovered:Kn,nodeSelected:Gn,returnToConstellation:Xn,setInitialChoicePhaseCompleted:Qn}=Xe.actions,Zn=n=>n.interface.viewMode,Yn=n=>n.interface.hoveredNodeId,er=n=>n.interface.selectedNodeId,tr=n=>n.interface.isInitialChoicePhase,nr=Xe.reducer;export{tr as A,le as B,Xn as C,er as a,Un as b,Gn as c,On as d,Pn as e,kn as f,wn as g,Rn as h,$n as i,yn as j,ye as k,Cn as l,vn as m,Kn as n,dn as o,nr as p,qn as q,gn as r,Yn as s,rn as t,Sn as u,mn as v,Zn as w,ce as x,An as y,En as z};
//# sourceMappingURL=constellation-D77L-avc.js.map
