import{j as l}from"./three-vendor-BSwpqFLI.js";import{b as s,j as D}from"./react-vendor-DaKsb8LL.js";import{u as K,t as V,T as q}from"./narramorph-P_FFBqAj.js";import"./constellation-DYOcMIlB.js";const X=s.memo(({nodeId:R,onVisibilityChange:p})=>{const{node:r,transformedContent:y,newlyTransformed:C,appliedTransformations:d}=K(R),u=s.useRef(null),m=s.useRef(null);s.useRef(null);const N=s.useRef(Date.now()),E=s.useRef(0),S=s.useRef(!0),[M,j]=s.useState(0),[i,k]=s.useState(!0),[W,H]=s.useState(null),[O,v]=s.useState({renderTime:0,transformationsCount:0,visibilityChanges:0,deferredTransformations:0}),[A,$]=s.useState([]);D(t=>t.reader.path),s.useEffect(()=>{const t=e=>{e.message&&(e.message.includes("WebGL context lost")||e.message.includes("THREE.WebGLRenderer"))&&(console.error("[NarramorphRenderer] WebGL context loss detected!",e.message),H(new Error(e.message)))};return window.addEventListener("error",t),()=>{window.removeEventListener("error",t)}},[i,p]),s.useEffect(()=>{if(!u.current)return;m.current&&(m.current.disconnect(),m.current=null),m.current||(k(!0),p&&p(!0));let t=null,e=null,a=!0;return m.current=new IntersectionObserver(h=>{var n;if(!a||!u.current)return;const o=((n=h[0])==null?void 0:n.isIntersecting)??!0,L=Date.now();S.current=i;const w=L-N.current,T=E.current>3&&w<15e3;i!==o&&u.current&&w>3e3&&!T&&a&&(t&&window.clearTimeout(t),e&&window.clearTimeout(e),console.log(`[NarramorphRenderer] Potential visibility change detected: ${i} -> ${o}`),t=window.setTimeout(()=>{i!==o&&u.current&&S.current===i&&a&&(e=window.setTimeout(()=>{var b;if(!a)return;(((b=h[0])==null?void 0:b.isIntersecting)??!0)===o?(N.current=Date.now(),E.current+=1,a&&k(o),setTimeout(()=>{a&&(E.current=0)},15e3),p&&a&&(console.log("[NarramorphRenderer] Calling onVisibilityChange:",o,"Previous:",i),p(o))):console.log("[NarramorphRenderer] Visibility state inconsistent - ignoring change"),e=null},500)),a&&(v(c=>({...c,visibilityChanges:c.visibilityChanges+1})),r!=null&&r.id&&V.setContentVisibility(r.id,o,r.id===R?2:1),o&&j(c=>c+1)),t=null},1200))},{root:null,rootMargin:"500px",threshold:.01}),u.current&&a&&m.current.observe(u.current),()=>{if(a=!1,t&&(window.clearTimeout(t),t=null),e&&(window.clearTimeout(e),e=null),m.current){try{m.current.disconnect(),console.log("[NarramorphRenderer] Intersection observer disconnected cleanly")}catch(h){console.warn("[NarramorphRenderer] Error disconnecting observer:",h)}m.current=null}}},[r==null?void 0:r.id,R,i,p]);const G=s.useMemo(()=>{if(!d.length)return[];if(i)return d;const t=d.filter(e=>e.priority==="high"||e.applyImmediately===!0);return v(e=>({...e,deferredTransformations:d.length-t.length})),t},[d,i]);return s.useEffect(()=>{if(!C||!u.current||!i)return;const t=performance.now();j(e=>e+1),requestAnimationFrame(()=>{var T;const e=(T=u.current)==null?void 0:T.querySelectorAll("[data-transform-type]");if(!e||e.length===0)return;const a=d.map(n=>`${n.type}-${n.selector}`),h=a.filter(n=>!A.includes(n));if(h.length===0)return;const o={replace:[],fragment:[],expand:[],emphasize:[],metaComment:[]};e.forEach(n=>{const c=n.getAttribute("data-transform-type");c&&c in o&&o[c].push(n)});const L=(n,c=50)=>{const b=[];for(let g=0;g<n.length;g+=5)b.push(Array.from(n).slice(g,g+5));b.forEach((g,P)=>{setTimeout(()=>{g.forEach(f=>{const z=f.getAttribute("data-transform-type"),_=f.textContent||"",I=d.find(x=>x.type===z&&_.includes(x.selector||"")&&h.includes(`${x.type}-${x.selector}`));if(I){switch(f.classList.add("narramorph-transform-new"),z){case"replace":f.classList.add("narramorph-replaced");break;case"fragment":f.classList.add("narramorph-fragmented");break;case"expand":f.classList.add("narramorph-expanded");break;case"emphasize":f.classList.add(`narramorph-emphasis-${I.emphasis||"color"}`);break;case"metaComment":f.classList.add("narramorph-commented");break}setTimeout(()=>{f.classList.remove("narramorph-transform-new")},2e3)}})},P*c*5)})};Object.values(o).forEach(n=>{L(n)}),$(a);const w=performance.now();v(n=>({...n,renderTime:w-t,transformationsCount:d.length}))})},[C,d,A,i]),s.useEffect(()=>{r!=null&&r.id&&($([]),v({renderTime:0,transformationsCount:0,visibilityChanges:0,deferredTransformations:0}))},[r==null?void 0:r.id]),W?(console.error("[NarramorphRenderer] Rendering in error state due to WebGL issue"),l.jsxs("div",{className:"narramorph-error",children:[l.jsx("p",{children:"Advanced rendering unavailable"}),l.jsx("div",{dangerouslySetInnerHTML:{__html:(r==null?void 0:r.currentContent)||"Content unavailable"}})]})):!r||!y?l.jsx("div",{className:"narramorph-loading",children:"Loading content..."}):l.jsxs("div",{className:`narramorph-container ${i?"is-visible":"is-hidden"}`,"data-node-id":r.id,"data-visibility":i?"visible":"hidden",style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px"},children:[l.jsx(q,{transformations:G,isNewlyTransformed:C,nodeId:r.id,children:l.jsxs("div",{ref:u,className:`narramorph-content ${i?"is-visible":"is-hidden"}`,"data-transformations-count":G.length,"data-node-id":r.id,"data-visit-count":r.visitCount,style:{display:"block",visibility:"visible",position:"relative"},children:[!y&&l.jsxs("div",{className:"narramorph-loading-indicator",style:{margin:"20px 0"},children:[l.jsx("div",{className:"loading-spinner"}),l.jsx("p",{children:"Preparing narrative transformations..."})]}),y&&l.jsx("div",{dangerouslySetInnerHTML:{__html:y},style:{opacity:i?1:.99,transition:"opacity 0.3s ease-in"}})]})}),!1]},M)});export{X as default};
//# sourceMappingURL=NarramorphRenderer-DSjBENcn.js.map
