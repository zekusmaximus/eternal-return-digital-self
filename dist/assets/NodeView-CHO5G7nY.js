const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/markdown-vendor-BS4Cvup3.js","assets/three-vendor-BSwpqFLI.js","assets/react-vendor-DaKsb8LL.js","assets/MiniConstellation-oMMB3PYU.js","assets/constellation-DYOcMIlB.js","assets/node-view-CX8ZmfD4.js","assets/node-view-BvMPabFr.css","assets/MarginaliaSidebar-CAe_S36R.js","assets/NarramorphRenderer-DSjBENcn.js","assets/narramorph-P_FFBqAj.js","assets/narramorph-DivzNTyX.css"])))=>i.map(i=>d[i]);
import{j as t,_ as T}from"./three-vendor-BSwpqFLI.js";import{b as r,j as L}from"./react-vendor-DaKsb8LL.js";import{u as B}from"./narramorph-P_FFBqAj.js";import{u as O,v as M,w as A}from"./app-B5tT0hPV.js";import{a as J,q as U,g as F,y as W,v as q,z as K}from"./constellation-DYOcMIlB.js";import"./node-view-CX8ZmfD4.js";class Q extends r.Component{constructor(i){super(i),this.state={hasError:!1,error:null}}static getDerivedStateFromError(i){return{hasError:!0,error:i}}componentDidCatch(i,n){console.error("ErrorBoundary caught an error:",i),console.error("Component stack:",n.componentStack)}render(){return this.state.hasError?this.props.fallback:this.props.children}}const X=({children:l,transformations:i,nodeId:n})=>{const[e,S]=r.useState(0),[h,p]=r.useState(!1);r.useEffect(()=>{if(i.length!==e){if(i.length>e){p(!0);const c=setTimeout(()=>{p(!1)},2e3);return()=>clearTimeout(c)}S(i.length)}},[i.length,e]);const w=()=>{if(i.length===0)return"";const c={};i.forEach(N=>{c[N.type]=(c[N.type]||0)+1});const d=[];return c.replace&&d.push(`${c.replace} replacements`),c.emphasize&&d.push(`${c.emphasize} emphasis`),c.expand&&d.push(`${c.expand} expansions`),c.fragment&&d.push(`${c.fragment} fragmentations`),c.metaComment&&d.push(`${c.metaComment} comments`),d.join(", ")};return t.jsxs("div",{className:`simple-transformation-container ${h?"newly-transformed":""}`,"data-transformation-count":i.length,"data-node-id":n,children:[i.length>0&&t.jsxs("div",{className:`transformation-indicator ${h?"active":""}`,title:w(),children:[t.jsx("span",{className:"transformation-count",children:i.length}),h&&i.length>e&&t.jsxs("span",{className:"transformation-change",children:["+",i.length-e]})]}),t.jsx("div",{className:"simple-transformation-content",children:l}),h&&t.jsx("div",{className:"transformation-overlay","aria-hidden":"true"})]})},Y=(l,i)=>{if(!l||!i.length)return l;let n=l;const e=[...i].sort((S,h)=>{const p={high:3,medium:2,low:1},w=p[S.priority||"medium"]||2;return(p[h.priority||"medium"]||2)-w});for(const S of e){const{type:h,selector:p,replacement:w,emphasis:c}=S;if(p)try{switch(h){case"replace":{if(w){const N=`<span class="text-transformation text-replaced" data-transform-type="replace">${w}</span>`;n=n.replace(new RegExp(p,"g"),N)}break}case"emphasize":{const d=c||"color",N=`<span class="text-transformation text-emphasis text-emphasis-${d}" data-transform-type="emphasize" data-emphasis="${d}">${p}</span>`;n=n.replace(new RegExp(p,"g"),N);break}case"expand":{const d=`<span class="text-transformation text-expanded" data-transform-type="expand">${p}</span>`;n=n.replace(new RegExp(p,"g"),d);break}case"fragment":{const d=`<span class="text-transformation text-fragmented" data-transform-type="fragment">${p}</span>`;n=n.replace(new RegExp(p,"g"),d);break}case"metaComment":{const d=`<span class="text-transformation text-commented" data-transform-type="metaComment">${p}</span>`;n=n.replace(new RegExp(p,"g"),d);break}}}catch(d){console.error(`[SimpleTextRenderer] Error applying transformation ${h}:`,d)}}return n},Z=r.memo(({nodeId:l,onRenderComplete:i,onVisibilityChange:n})=>{const{node:e,transformedContent:S,appliedTransformations:h}=B(l),[p,w]=r.useState(""),[c,d]=r.useState(!0),[N,j]=r.useState(!0),f=r.useRef(null),E=r.useRef(null),o=r.useRef(null),[$,x]=r.useState(0);return L(a=>a.reader.path),r.useEffect(()=>{if(e!=null&&e.currentContent){console.log(`[SimpleTextRenderer] Processing content for node: ${e.id}, length: ${e.currentContent.length}`),j(!0);const a=S||e.currentContent;try{console.log("[SimpleTextRenderer] Starting content processing synchronously");const g=Y(a,h);w(g),x(u=>u+1),j(!1),d(!0),i&&(console.log(`[SimpleTextRenderer] Render complete for node: ${e.id}`),setTimeout(i,10)),n&&(console.log("[SimpleTextRenderer] Explicitly marking content as visible"),n(!0)),[100,500,1e3].forEach(u=>{setTimeout(()=>{f.current&&(console.log(`[SimpleTextRenderer] Visibility verification check at ${u}ms`),f.current.isConnected||console.warn(`[SimpleTextRenderer] Content DOM node not connected at ${u}ms`),f.current.style&&(f.current.style.display="block",f.current.style.visibility="visible",f.current.style.opacity="1"),n&&n(!0))},u)})}catch(g){console.error("[SimpleTextRenderer] Error processing content:",g),j(!1)}}},[e==null?void 0:e.currentContent,e==null?void 0:e.id,S,h,i,n]),r.useEffect(()=>{if(f.current)return console.log(`[DEBUG] Setting up IntersectionObserver for node: ${e==null?void 0:e.id}, current visibility: ${c}`),E.current&&E.current.disconnect(),c||(console.log(`[DEBUG] Forcing initial visibility to true for node: ${e==null?void 0:e.id}`),d(!0),n&&n(!0)),E.current=new IntersectionObserver(a=>{const g=a[0];if(!g)return;const v=g.isIntersecting;console.log(`[DEBUG] Intersection detection for node ${e==null?void 0:e.id}: ${v?"visible":"not visible"}, intersectionRatio: ${g.intersectionRatio.toFixed(2)}`),c&&!v?console.log("[DEBUG] Content might be invisible - delaying state change to verify..."):!c&&v&&(console.log("[DEBUG] Content is now visible - updating state immediately"),d(!0),n&&n(!0))},{root:null,rootMargin:"0px",threshold:.01}),E.current.observe(f.current),()=>{var a;console.log(`[DEBUG] Cleaning up IntersectionObserver for node: ${e==null?void 0:e.id}`),(a=E.current)==null||a.disconnect()}},[c,n,e==null?void 0:e.id]),r.useEffect(()=>{if(!f.current)return;console.log(`[DEBUG] Setting up MutationObserver for node: ${e==null?void 0:e.id}`),o.current&&o.current.disconnect(),o.current=new MutationObserver(g=>{g.forEach(v=>{if(v.type==="attributes"&&(v.attributeName==="style"||v.attributeName==="class"||v.attributeName==="display"||v.attributeName==="visibility"||v.attributeName==="opacity")){const u=v.target,C=window.getComputedStyle(u);console.log(`[DEBUG] Style mutation detected on ${u.tagName}#${u.id}.${u.className}:`,{display:C.display,visibility:C.visibility,opacity:C.opacity}),(C.display==="none"||C.visibility==="hidden"||C.opacity==="0")&&(console.warn("[DEBUG] Preventing content from being hidden by style mutation"),u.style.display=u.style.display==="none"?"block":u.style.display,u.style.visibility=u.style.visibility==="hidden"?"visible":u.style.visibility,u.style.opacity=u.style.opacity==="0"?"1":u.style.opacity,u===f.current&&n&&(console.log("[DEBUG] Notifying parent that content is still visible after mutation"),n(!0)))}})}),o.current.observe(f.current,{attributes:!0,attributeFilter:["style","class"],childList:!0,subtree:!0});let a=f.current.parentElement;for(let g=0;g<3&&a;g++)o.current.observe(a,{attributes:!0,attributeFilter:["style","class"]}),a=a.parentElement;return()=>{var g;console.log(`[DEBUG] Cleaning up MutationObserver for node: ${e==null?void 0:e.id}`),(g=o.current)==null||g.disconnect()}},[e==null?void 0:e.id,n]),!e||!e.currentContent?t.jsx("div",{className:"simple-renderer-loading",children:"Loading narrative content..."}):t.jsxs("div",{className:`simple-renderer-container ${c?"is-visible":""}`,"data-node-id":e.id,"data-render-count":$,style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px"},children:[t.jsxs(X,{transformations:h,nodeId:e.id,children:[N&&t.jsxs("div",{className:"simple-renderer-loading",style:{padding:"20px 0"},children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Preparing narrative content..."})]}),t.jsx("div",{ref:f,className:"simple-renderer-content","data-transformations-count":h.length,style:{display:"block",visibility:"visible",opacity:1},children:t.jsx("div",{dangerouslySetInnerHTML:{__html:p},className:"content-inner"})})]}),!1]})});function V(l){return"memory"in l}const k=r.lazy(()=>(console.log("[NodeView] Loading ReactMarkdown component"),T(()=>import("./markdown-vendor-BS4Cvup3.js").then(l=>l.i),__vite__mapDeps([0,1,2])).then(l=>(console.log("[NodeView] ReactMarkdown component loaded"),l)))),ee=r.lazy(()=>T(()=>import("./MiniConstellation-oMMB3PYU.js"),__vite__mapDeps([3,1,2,4,5,6]))),te=r.lazy(()=>T(()=>import("./MarginaliaSidebar-CAe_S36R.js"),__vite__mapDeps([7,1,2,4,5,6]))),z=T(()=>import("./NarramorphRenderer-DSjBENcn.js"),__vite__mapDeps([8,1,2,9,4,10])),ne=r.lazy(()=>(console.log("[NodeView] Loading NarramorphRenderer component"),z.then(l=>(console.log("[NodeView] NarramorphRenderer component loaded"),l)))),H=T(()=>import("./markdown-vendor-BS4Cvup3.js").then(l=>l.a),__vite__mapDeps([0,1,2])).then(l=>(console.log("[NodeView] remark-gfm plugin loaded"),l.default)),ie=!1,re=()=>t.jsxs("div",{className:"content-loading",children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Loading content..."})]}),I=()=>t.jsx("div",{className:"side-component-loading"}),ue=()=>{const l=O(),i=L(J),n=L(U),e=L(s=>i?F(s,i):null),S=r.useMemo(()=>M.getUniqueViewKey(),[]),h=r.useRef(null),[p,w]=r.useState(!1),[c,d]=r.useState(!1),[N,j]=r.useState(ie),[f,E]=r.useState(!0),o=r.useRef(null),[$,x]=r.useState({loadStarted:!1,contentLoaded:!1,renderStarted:!1,narramorphActivated:!1,visibilityIssue:!1,errorOccurred:!1});r.useEffect(()=>{if(n==="reading"){M.registerViewMount("reading",!0);const s=A.checkWebGLSupport();E(!s.isLowEndDevice),console.log(`[NodeView] Mounted reading view, WebGL available: ${f}`)}return()=>{n==="reading"&&(M.registerViewMount("reading",!1),console.log("[NodeView] Unmounted reading view"))}},[n,f]),r.useEffect(()=>(i&&console.time(`node-${i}-visibility`),()=>{i&&console.timeEnd(`node-${i}-visibility`)}),[i]);const[a,g]=r.useState({transitionTime:0,lastViewMode:n,transitionCount:0,renderCount:0}),[v,u]=r.useState({jsHeapSizeLimit:0,totalJSHeapSize:0,usedJSHeapSize:0,timestamp:0});r.useEffect(()=>{if(a.lastViewMode!==n){const s=Date.now();if(console.log(`[NodeView] View transition: ${a.lastViewMode} -> ${n} at ${s}`),g(m=>({...m,lastViewMode:n,transitionTime:s,transitionCount:m.transitionCount+1})),x(m=>({...m,loadStarted:!1,contentLoaded:!1,renderStarted:!1,narramorphActivated:!1,visibilityIssue:!1,errorOccurred:!1})),V(performance)&&performance.memory){const m=performance.memory;u({jsHeapSizeLimit:m.jsHeapSizeLimit,totalJSHeapSize:m.totalJSHeapSize,usedJSHeapSize:m.usedJSHeapSize,timestamp:s}),console.log("[NodeView] Memory usage at transition:",{usedHeap:Math.round(m.usedJSHeapSize/(1024*1024))+"MB",totalHeap:Math.round(m.totalJSHeapSize/(1024*1024))+"MB",limit:Math.round(m.jsHeapSizeLimit/(1024*1024))+"MB"})}}g(s=>({...s,renderCount:s.renderCount+1}))},[n,a.lastViewMode]),r.useEffect(()=>{i&&(!(e!=null&&e.content)||!(e!=null&&e.currentContent))&&(console.log(`[NodeView] Loading content for node: ${i}`,{viewMode:n,transitionCount:a.transitionCount,timeElapsed:Date.now()-a.transitionTime+"ms"}),x(s=>({...s,loadStarted:!0})),l(W(i))),e!=null&&e.currentContent&&(console.log(`[NodeView] Content loaded for node: ${i}`,{contentLength:e.currentContent.length,visitCount:e.visitCount,timeElapsed:Date.now()-a.transitionTime+"ms"}),x(s=>({...s,contentLoaded:!0})),(e.currentContent.includes("[object Object]")||e.currentContent.includes("undefined")||e.currentContent.length<10)&&console.error("[NodeView] Possible content corruption detected:",{contentStart:e.currentContent.substring(0,100),contentLength:e.currentContent.length}))},[i,e,l,n,a.transitionCount,a.transitionTime]),r.useEffect(()=>{i&&l(q(i))},[i,l]),r.useEffect(()=>{if(e!=null&&e.currentContent){console.log(`[NodeView] Preparing to activate Narramorph for node: ${e.id}`,{viewMode:n,timeElapsed:Date.now()-a.transitionTime+"ms",contentLength:e.currentContent.length}),x(y=>({...y,renderStarted:!0}));let s=!1;console.log("[NodeView] Preloading NarramorphRenderer component"),z.then(()=>{if(s=!0,console.log("[NodeView] NarramorphRenderer preload complete"),e!=null&&e.id&&(console.log(`[NodeView] Activating Narramorph renderer for node: ${e.id} after preload`),w(!0),x(y=>({...y,narramorphActivated:!0})),o.current)){const y=o.current.getBoundingClientRect();console.log("[NodeView] Post-preload container dimensions:",{width:y.width,height:y.height,display:window.getComputedStyle(o.current).display,visibility:window.getComputedStyle(o.current).visibility})}}).catch(y=>{console.error("[NodeView] Error preloading NarramorphRenderer:",y),j(!0)});const m=setTimeout(()=>{if(o.current){console.log("[NodeView] Force checking content visibility");const y=o.current.offsetParent!==null,b=o.current.getBoundingClientRect(),R=window.getComputedStyle(o.current);console.log("[NodeView] Content visibility check:",{isVisible:y,width:b.width,height:b.height,display:R.display,visibility:R.visibility,zIndex:R.zIndex,position:R.position,opacity:R.opacity,componentLoaded:s}),(!y||b.width===0||b.height===0)&&(console.warn("[NodeView] Content invisible after rendering - forcing simple renderer"),j(!0),x(P=>({...P,visibilityIssue:!0})))}},1500);return()=>clearTimeout(m)}},[e==null?void 0:e.currentContent,e==null?void 0:e.id,n,a.transitionTime]),r.useEffect(()=>{const s=m=>{var y;if(m.message&&(m.message.includes("WebGL context lost")||m.message.includes("THREE.WebGLRenderer"))&&(console.error("[NodeView] WebGL context loss detected!",{message:m.message,stack:((y=m.error)==null?void 0:y.stack)||"No stack trace",viewMode:n,timeElapsed:Date.now()-a.transitionTime+"ms",renderCount:a.renderCount}),d(!0),w(!1),x(b=>({...b,errorOccurred:!0})),V(performance)&&performance.memory)){const b=performance.memory;u({jsHeapSizeLimit:b.jsHeapSizeLimit,totalJSHeapSize:b.totalJSHeapSize,usedJSHeapSize:b.usedJSHeapSize,timestamp:Date.now()}),console.log("[NodeView] Memory usage at WebGL error:",{usedHeap:Math.round(b.usedJSHeapSize/1048576)+"MB",totalHeap:Math.round(b.totalJSHeapSize/1048576)+"MB",limit:Math.round(b.jsHeapSizeLimit/1048576)+"MB"})}};return window.addEventListener("error",s),()=>{window.removeEventListener("error",s)}},[n,a.renderCount,a.transitionTime]);const C=()=>{l(K())};if(n!=="reading"||!e)return null;const _=`${e.character.toLowerCase()}-theme`,D=()=>e.temporalValue<=3?"past-indicator":e.temporalValue<=6?"present-indicator":"future-indicator",G=()=>e.currentContent?t.jsxs("div",{ref:o,className:`content-container ${e.currentState}`,"data-content-loaded":"true","data-node-id":e.id,"data-visit-count":e.visitCount,style:{position:"relative",visibility:"visible",display:"block"},children:[N||!f?t.jsx("div",{className:"simple-renderer-wrapper",style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px",opacity:1,zIndex:5},children:t.jsx(Z,{nodeId:e.id,onRenderComplete:()=>{console.log("[NodeView] SimpleTextRenderer completed rendering"),o.current&&(console.log("[NodeView] Forcing container visibility after render complete"),o.current.style.display="block",o.current.style.visibility="visible",o.current.style.opacity="1"),x(s=>({...s,visibilityIssue:!1})),setTimeout(()=>{if(o.current){const s=o.current.offsetParent!==null&&window.getComputedStyle(o.current).display!=="none"&&window.getComputedStyle(o.current).visibility!=="hidden";console.log(`[NodeView] Post-render visibility check: ${s?"visible":"not visible"}`),s||(console.warn("[NodeView] Content became invisible after render - forcing visibility"),o.current.style.display="block",o.current.style.visibility="visible",o.current.style.opacity="1")}},500)},onVisibilityChange:s=>{if(console.log(`[NodeView] Content visibility changed to: ${s?"visible":"hidden"}`),!s&&o.current){console.warn("[NodeView] Forcing content visibility after hidden state detected"),o.current.style.display="block",o.current.style.visibility="visible",o.current.style.opacity="1";return}x(m=>({...m,visibilityIssue:!s}))}},`simple-${e.id}-${e.visitCount}`)}):t.jsx(r.Suspense,{fallback:t.jsx(re,{}),children:p&&!c?t.jsx(Q,{fallback:t.jsxs("div",{className:"fallback-content",style:{visibility:"visible",display:"block"},children:[t.jsx("p",{className:"error-notice",children:"Advanced rendering unavailable - showing basic content"}),t.jsx(k,{remarkPlugins:[()=>H],children:e.currentContent})]}),children:t.jsx("div",{style:{minHeight:"200px",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(ne,{nodeId:e.id,onVisibilityChange:s=>{console.log(`[NodeView] Content visibility changed to: ${s?"visible":"hidden"}`);const m=setTimeout(()=>{o.current&&(x(y=>({...y,visibilityIssue:!s})),s||j(!0))},1e3);return()=>clearTimeout(m)}},`narramorph-${e.id}-${e.visitCount}`)})}):t.jsxs("div",{style:{visibility:"visible",display:"block",position:"relative",minHeight:"100px"},children:[t.jsxs("div",{className:"content-loading",style:{marginBottom:"10px"},children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Preparing content..."})]}),t.jsx(k,{remarkPlugins:[()=>H],children:e.currentContent},`markdown-${e.id}-${e.visitCount}`)]})}),t.jsxs("div",{className:"debug-indicator",children:[t.jsx("div",{className:`status-dot ${$.contentLoaded?"status-green":"status-red"}`,title:"Content loaded"}),t.jsx("div",{className:`status-dot ${$.narramorphActivated?"status-green":"status-yellow"}`,title:"Narramorph active"}),t.jsx("div",{className:`status-dot ${$.errorOccurred?"status-red":"status-green"}`,title:"No errors"}),t.jsx("div",{className:`status-dot ${$.visibilityIssue?"status-red":"status-green"}`,title:"Content visible"}),t.jsx("div",{className:`status-dot ${N?"status-blue":"status-yellow"}`,title:"Simple renderer"}),t.jsx("div",{className:`status-dot ${f?"status-green":"status-red"}`,title:"WebGL available"}),t.jsxs("div",{className:"debug-metrics",children:[t.jsxs("span",{title:"View transition count",children:["T:",a.transitionCount]}),t.jsxs("span",{title:"Render count",children:["R:",a.renderCount]}),v.usedJSHeapSize>0&&t.jsxs("span",{title:"Memory usage",children:["M:",Math.round(v.usedJSHeapSize/(1024*1024)),"MB"]})]})]})]}):t.jsx("div",{className:"node-loading",children:t.jsx("span",{children:"Loading narrative fragment..."})});return t.jsxs("div",{className:`node-view-container ${_}`,children:[t.jsx("div",{className:`temporal-indicator ${D()}`}),t.jsxs("div",{className:"node-header",children:[t.jsx("h1",{children:e.title}),t.jsxs("div",{className:"node-metadata",children:[t.jsx("span",{className:"node-character",children:e.character}),t.jsx("span",{className:"node-state",children:e.currentState}),t.jsxs("span",{className:"node-visits",children:["Visits: ",e.visitCount]})]})]}),t.jsx("div",{className:"node-content force-visible",style:{position:"relative"},children:G()}),t.jsx("div",{className:"node-navigation",children:t.jsx("button",{onClick:C,className:"navigation-button",children:"Return to Constellation"})}),t.jsx("div",{style:{position:"absolute",bottom:"20px",right:"20px",width:"300px",height:"300px",pointerEvents:"auto"},children:t.jsx(r.Suspense,{fallback:t.jsx(I,{}),children:t.jsx(ee,{currentNodeId:e.id,ref:h})})}),t.jsx(r.Suspense,{fallback:t.jsx(I,{}),children:t.jsx(te,{nodeId:e.id,strangeAttractors:e.strangeAttractors})})]},S)};export{ue as default};
//# sourceMappingURL=NodeView-CHO5G7nY.js.map
