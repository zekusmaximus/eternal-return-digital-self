import{j as o}from"./three-vendor-CMUj8LmA.js";import{b as s,c as H}from"./react-vendor-CLXXY-Bz.js";import{u as _,t as K,T as q}from"./narramorph-DAUxO-pP.js";import"./constellation-9EXX-9rV.js";const J=s.memo(({nodeId:x,onVisibilityChange:p})=>{const{node:r,transformedContent:b,newlyTransformed:R,appliedTransformations:l}=_(x),n=s.useRef(null),h=s.useRef(null),[k,T]=s.useState(0),[a,w]=s.useState(!0),[A,M]=s.useState(null),[B,y]=s.useState({renderTime:0,transformationsCount:0,visibilityChanges:0,deferredTransformations:0}),[N,S]=s.useState([]);H(t=>t.reader.path),s.useEffect(()=>{const t=e=>{e.message&&(e.message.includes("WebGL context lost")||e.message.includes("THREE.WebGLRenderer"))&&(console.error("[NarramorphRenderer] WebGL context loss detected!",e.message),M(new Error(e.message)))};return window.addEventListener("error",t),()=>{window.removeEventListener("error",t)}},[]),s.useEffect(()=>{if(!n.current){console.log("[NarramorphRenderer] Content ref not available yet");return}return console.log("[NarramorphRenderer] Setting up visibility observer for node:",r==null?void 0:r.id),h.current&&h.current.disconnect(),w(!0),p&&(console.log("[NarramorphRenderer] Setting initial visibility to visible"),p(!0)),h.current=new IntersectionObserver(t=>{var f;const e=((f=t[0])==null?void 0:f.isIntersecting)??!0;if(n.current){const c=n.current.getBoundingClientRect(),m=window.getComputedStyle(n.current);console.log(`[NarramorphRenderer] Visibility check: ${e?"visible":"hidden"}`,{dimensions:`${Math.round(c.width)}x${Math.round(c.height)}`,display:m.display,visibility:m.visibility,opacity:m.opacity,position:m.position})}a!==e&&n.current&&(console.log(`[NarramorphRenderer] Visibility changed to: ${e?"visible":"hidden"}`),w(e),p&&p(e),y(c=>({...c,visibilityChanges:c.visibilityChanges+1})),r!=null&&r.id&&K.setContentVisibility(r.id,e,r.id===x?2:1),e&&T(c=>c+1))},{root:null,rootMargin:"500px",threshold:.01}),n.current&&(h.current.observe(n.current),console.log("[NarramorphRenderer] Started observing content visibility"),setTimeout(()=>{if(n.current){const t=n.current.getBoundingClientRect(),e=window.getComputedStyle(n.current);console.log("[NarramorphRenderer] Initial visibility check:",{visible:a,dimensions:`${Math.round(t.width)}x${Math.round(t.height)}`,display:e.display,visibility:e.visibility,opacity:e.opacity})}},50)),()=>{var t;console.log("[NarramorphRenderer] Cleaning up visibility observer"),(t=h.current)==null||t.disconnect()}},[r==null?void 0:r.id,x,p]);const E=s.useMemo(()=>{if(!l.length)return[];if(a)return l;const t=l.filter(e=>e.priority==="high"||e.applyImmediately===!0);return y(e=>({...e,deferredTransformations:l.length-t.length})),t},[l,a]);return s.useEffect(()=>{if(!R||!n.current||!a)return;const t=performance.now();T(e=>e+1),requestAnimationFrame(()=>{var L;const e=(L=n.current)==null?void 0:L.querySelectorAll("[data-transform-type]");if(!e||e.length===0)return;const f=l.map(i=>`${i.type}-${i.selector}`),c=f.filter(i=>!N.includes(i));if(c.length===0)return;const m={replace:[],fragment:[],expand:[],emphasize:[],metaComment:[]};e.forEach(i=>{const g=i.getAttribute("data-transform-type");g&&g in m&&m[g].push(i)});const G=(i,g=50)=>{const C=[];for(let u=0;u<i.length;u+=5)C.push(Array.from(i).slice(u,u+5));C.forEach((u,W)=>{setTimeout(()=>{u.forEach(d=>{const $=d.getAttribute("data-transform-type"),I=d.textContent||"",j=l.find(v=>v.type===$&&I.includes(v.selector||"")&&c.includes(`${v.type}-${v.selector}`));if(j){switch(d.classList.add("narramorph-transform-new"),$){case"replace":d.classList.add("narramorph-replaced");break;case"fragment":d.classList.add("narramorph-fragmented");break;case"expand":d.classList.add("narramorph-expanded");break;case"emphasize":d.classList.add(`narramorph-emphasis-${j.emphasis||"color"}`);break;case"metaComment":d.classList.add("narramorph-commented");break}setTimeout(()=>{d.classList.remove("narramorph-transform-new")},2e3)}})},W*g*5)})};Object.values(m).forEach(i=>{G(i)}),S(f);const z=performance.now();y(i=>({...i,renderTime:z-t,transformationsCount:l.length}))})},[R,l,N,a]),s.useEffect(()=>{r!=null&&r.id&&(S([]),y({renderTime:0,transformationsCount:0,visibilityChanges:0,deferredTransformations:0}))},[r==null?void 0:r.id]),A?(console.error("[NarramorphRenderer] Rendering in error state due to WebGL issue"),o.jsxs("div",{className:"narramorph-error",children:[o.jsx("p",{children:"Advanced rendering unavailable"}),o.jsx("div",{dangerouslySetInnerHTML:{__html:(r==null?void 0:r.currentContent)||"Content unavailable"}})]})):!r||!b?(console.log("[NarramorphRenderer] Showing loading state - content not available yet"),o.jsx("div",{className:"narramorph-loading",children:"Loading content..."})):(console.log(`[NarramorphRenderer] Rendering content for node: ${r.id}, visible: ${a}`),o.jsxs("div",{className:`narramorph-container ${a?"is-visible":"is-hidden"}`,"data-node-id":r.id,"data-visibility":a?"visible":"hidden",style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px"},children:[o.jsx(q,{transformations:E,isNewlyTransformed:R,nodeId:r.id,children:o.jsxs("div",{ref:n,className:`narramorph-content ${a?"is-visible":"is-hidden"}`,"data-transformations-count":E.length,"data-node-id":r.id,"data-visit-count":r.visitCount,style:{display:"block",visibility:"visible",position:"relative"},children:[!b&&o.jsxs("div",{className:"narramorph-loading-indicator",style:{margin:"20px 0"},children:[o.jsx("div",{className:"loading-spinner"}),o.jsx("p",{children:"Preparing narrative transformations..."})]}),b&&o.jsx("div",{dangerouslySetInnerHTML:{__html:b},style:{opacity:a?1:.99,transition:"opacity 0.3s ease-in"}})]})}),!1]},k))});export{J as default};
//# sourceMappingURL=NarramorphRenderer-BHn5tT2_.js.map
