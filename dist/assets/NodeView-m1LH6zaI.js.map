{"version":3,"mappings":"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","names":["ErrorBoundary","Component","props","error","errorInfo","SimpleTransformationContainer","children","transformations","nodeId","prevTransformationCount","setPrevTransformationCount","useState","isNewlyTransformed","setIsNewlyTransformed","transformationSignature","setTransformationSignature","useEffect","currentSignature","t","timer","getTransformationDescription","typeCount","descriptions","jsxs","jsx","SimpleTextRenderer","onRenderComplete","onVisibilityChange","node","transformedContent","appliedTransformations","useNodeState","processedContent","setProcessedContent","isVisible","setIsVisible","isLoading","setIsLoading","corruptionDetected","setCorruptionDetected","renderCount","setRenderCount","contentRef","useRef","callbacksCalledRef","dispatch","useDispatch","useSelector","state","baseContent","isContentCorrupted","recoverNodeContent","finalContent","finalTextCleanup","validateNodeContent","prev","hasMemory","performance","ReactMarkdown","lazy","__vitePreload","module","MiniConstellation","MarginaliaSidebar","NarramorphRendererPromise","NarramorphRenderer","remarkGfmPromise","ContentLoading","SideComponentLoading","NodeView","useAppDispatch","selectedNodeId","selectSelectedNodeId","viewMode","selectViewMode","selectNodeById","uniqueViewKey","useMemo","viewManager","useNarramorph","setUseNarramorph","useWebGLFallback","setUseWebGLFallback","forceSimpleRenderer","setForceSimpleRenderer","contentContainerRef","renderCompleteCalledRef","processedNodeRef","narramorphActivatedRef","lastVisitedIdRef","viewTransitionState","setViewTransitionState","memoryStats","setMemoryStats","useCallback","contentDebug","setContentDebug","isStillVisible","now","memory","loadNodeContent","contentLength","_a","cleanCurrentContent","contentCorrupted","contentPreview","hasCurrentContent","componentLoaded","preBoundingRect","err","visibilityTimer","boundingRect","computedStyle","visitNode","currentContent","title","synopsis","addVisitedNode","handleWebGLContextLoss","event","handleReturnToConstellation","returnToConstellation","characterClass","getTemporalClass","renderNodeContent","Suspense"],"ignoreList":[],"sources":["../../src/components/common/ErrorBoundary.tsx","../../src/components/NodeView/SimpleTransformationContainer.tsx","../../src/components/NodeView/SimpleTextRenderer.tsx","../../src/components/NodeView/NodeView.tsx"],"sourcesContent":["import { Component, ErrorInfo, ReactNode } from 'react';\r\n\r\ninterface Props {\r\n  children: ReactNode;\r\n  fallback: ReactNode;\r\n}\r\n\r\ninterface State {\r\n  hasError: boolean;\r\n  error: Error | null;\r\n}\r\n\r\n/**\r\n * ErrorBoundary component to catch and handle errors in its child components.\r\n * Provides a fallback UI when an error occurs.\r\n */\r\nclass ErrorBoundary extends Component<Props, State> {\r\n  constructor(props: Props) {\r\n    super(props);\r\n    this.state = { \r\n      hasError: false,\r\n      error: null\r\n    };\r\n  }\r\n\r\n  static getDerivedStateFromError(error: Error): State {\r\n    // Update state so the next render will show the fallback UI\r\n    return { \r\n      hasError: true,\r\n      error: error\r\n    };\r\n  }\r\n\r\n  componentDidCatch(error: Error, errorInfo: ErrorInfo): void {\r\n    // Log the error to console\r\n    console.error('ErrorBoundary caught an error:', error);\r\n    console.error('Component stack:', errorInfo.componentStack);\r\n  }\r\n\r\n  render(): ReactNode {\r\n    if (this.state.hasError) {\r\n      // Render fallback UI\r\n      return this.props.fallback;\r\n    }\r\n\r\n    return this.props.children;\r\n  }\r\n}\r\n\r\nexport default ErrorBoundary;","/**\r\n * SimpleTransformationContainer Component\r\n * \r\n * A lightweight, reliable container for text transformations.\r\n * This is a simplified version of TransformationAnimationContainer\r\n * that prioritizes stability and content visibility over complex effects.\r\n */\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport { TextTransformation } from '../../types';\r\n\r\ninterface SimpleTransformationContainerProps {\r\n  children: React.ReactNode;\r\n  transformations: TextTransformation[];\r\n  nodeId: string;\r\n}\r\n\r\nconst SimpleTransformationContainer: React.FC<SimpleTransformationContainerProps> = ({\r\n  children,\r\n  transformations,\r\n  nodeId\r\n}) => {  // Track previous transformation count to detect changes\r\n  const [prevTransformationCount, setPrevTransformationCount] = useState(0);\r\n  const [isNewlyTransformed, setIsNewlyTransformed] = useState(false);\r\n  const [transformationSignature, setTransformationSignature] = useState('');\r\n  \r\n  // When transformations change, update state to show indicators\r\n  useEffect(() => {\r\n    // Create a signature to detect actual transformation changes, not just count changes\r\n    const currentSignature = transformations\r\n      .map(t => `${t.type}-${t.selector || 'no-selector'}-${JSON.stringify(t)}`)\r\n      .sort()\r\n      .join('|');\r\n    \r\n    if (currentSignature !== transformationSignature) {\r\n      // Detect if new transformations were added\r\n      if (transformations.length > prevTransformationCount) {\r\n        setIsNewlyTransformed(true);\r\n        \r\n        // Reset the newly transformed flag after animations would complete\r\n        const timer = setTimeout(() => {\r\n          setIsNewlyTransformed(false);\r\n        }, 2000);\r\n        \r\n        // Update state\r\n        setPrevTransformationCount(transformations.length);\r\n        setTransformationSignature(currentSignature);\r\n        \r\n        return () => clearTimeout(timer);\r\n      } else {\r\n        // Just update tracking without animation if count didn't increase\r\n        setPrevTransformationCount(transformations.length);\r\n        setTransformationSignature(currentSignature);\r\n      }\r\n    }\r\n  }, [transformations, transformationSignature, prevTransformationCount]);\r\n  \r\n  // Get a description of transformation activity for tooltip\r\n  const getTransformationDescription = () => {\r\n    if (transformations.length === 0) return '';\r\n    \r\n    const typeCount: Record<string, number> = {};\r\n    transformations.forEach(t => {\r\n      typeCount[t.type] = (typeCount[t.type] || 0) + 1;\r\n    });\r\n    \r\n    // Generate a description based on the types of transformations\r\n    const descriptions = [];\r\n    \r\n    if (typeCount['replace']) {\r\n      descriptions.push(`${typeCount['replace']} replacements`);\r\n    }\r\n    \r\n    if (typeCount['emphasize']) {\r\n      descriptions.push(`${typeCount['emphasize']} emphasis`);\r\n    }\r\n    \r\n    if (typeCount['expand']) {\r\n      descriptions.push(`${typeCount['expand']} expansions`);\r\n    }\r\n    \r\n    if (typeCount['fragment']) {\r\n      descriptions.push(`${typeCount['fragment']} fragmentations`);\r\n    }\r\n    \r\n    if (typeCount['metaComment']) {\r\n      descriptions.push(`${typeCount['metaComment']} comments`);\r\n    }\r\n    \r\n    return descriptions.join(', ');\r\n  };\r\n  \r\n  return (\r\n    <div \r\n      className={`simple-transformation-container ${isNewlyTransformed ? 'newly-transformed' : ''}`}\r\n      data-transformation-count={transformations.length}\r\n      data-node-id={nodeId}\r\n    >\r\n      {/* Visual indicator for active transformations - much simpler than the complex version */}\r\n      {transformations.length > 0 && (\r\n        <div \r\n          className={`transformation-indicator ${isNewlyTransformed ? 'active' : ''}`}\r\n          title={getTransformationDescription()}\r\n        >\r\n          <span className=\"transformation-count\">{transformations.length}</span>\r\n          {isNewlyTransformed && transformations.length > prevTransformationCount && (\r\n            <span className=\"transformation-change\">\r\n              +{transformations.length - prevTransformationCount}\r\n            </span>\r\n          )}\r\n        </div>\r\n      )}\r\n      \r\n      {/* Main content */}\r\n      <div className=\"simple-transformation-content\">\r\n        {children}\r\n      </div>\r\n      \r\n      {/* Optional overlay for transition effects */}\r\n      {isNewlyTransformed && (\r\n        <div \r\n          className=\"transformation-overlay\"\r\n          aria-hidden=\"true\"\r\n        />\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default SimpleTransformationContainer;","/**\r\n * SimpleTextRenderer Component\r\n * \r\n * A lightweight, reliable alternative to the NarramorphRenderer\r\n * that prioritizes stability and content visibility over visual effects.\r\n * \r\n * This component:\r\n * 1. Renders node content with minimal dependencies\r\n * 2. Uses pure React/DOM rendering without WebGL\r\n * 3. Maintains proper text display even when resources are constrained\r\n * 4. Provides graceful fallbacks and simplified transformations\r\n * 5. EMERGENCY FIX: Prevents and recovers from content corruption\r\n */\r\n\r\nimport { useEffect, useState, useRef } from 'react';\r\nimport { useNodeState } from '../../hooks/useNodeState';\r\nimport { useSelector, useDispatch } from 'react-redux';\r\nimport { RootState } from '../../store/types';\r\nimport { recoverNodeContent, validateNodeContent } from '../../store/slices/nodesSlice';\r\nimport { isContentCorrupted, finalTextCleanup } from '../../utils/contentSanitizer';\r\nimport '../../styles/NarramorphTransformations.css';\r\nimport '../../styles/SimpleTextRenderer.css';\r\nimport SimpleTransformationContainer from './SimpleTransformationContainer';\r\n\r\ninterface SimpleTextRendererProps {\r\n  nodeId?: string;\r\n  onRenderComplete?: () => void;\r\n  onVisibilityChange?: (isVisible: boolean) => void;\r\n}\r\n\r\nexport default function SimpleTextRenderer({ nodeId, onRenderComplete, onVisibilityChange }: SimpleTextRendererProps) {\r\n  const { node, transformedContent, appliedTransformations } = useNodeState(nodeId);\r\n  const [processedContent, setProcessedContent] = useState<string>('');\r\n  const [isVisible, setIsVisible] = useState(true);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [corruptionDetected, setCorruptionDetected] = useState(false);\r\n  const [renderCount, setRenderCount] = useState(0);\r\n  \r\n  const contentRef = useRef<HTMLDivElement | null>(null);\r\n  const callbacksCalledRef = useRef(false);\r\n  const dispatch = useDispatch();\r\n  const readingPath = useSelector((state: RootState) => state.reader.path);\r\n\r\n  useEffect(() => {\r\n    callbacksCalledRef.current = false;\r\n  }, [node?.id]);\r\n\r\n  useEffect(() => {\r\n    if (node?.currentContent || node?.originalContent) {\r\n      setIsLoading(true);\r\n      setCorruptionDetected(false);\r\n      \r\n      try {\r\n        const baseContent = node.originalContent || node.currentContent || '';\r\n        \r\n        if (isContentCorrupted(baseContent)) {\r\n          setCorruptionDetected(true);\r\n          if (node.originalContent && node.originalContent !== baseContent) {\r\n            dispatch(recoverNodeContent(node.id));\r\n            return;\r\n          } else {\r\n            setProcessedContent('⚠️ Content temporarily unavailable. Please refresh to restore.');\r\n            setIsLoading(false);\r\n            return;\r\n          }\r\n        }\r\n          const content = transformedContent || baseContent;\r\n        const finalContent = finalTextCleanup(content);\r\n        \r\n        setProcessedContent(finalContent);\r\n        dispatch(validateNodeContent(node.id));\r\n        setRenderCount(prev => prev + 1);\r\n        setIsLoading(false);\r\n        setIsVisible(true);\r\n        \r\n        if (!callbacksCalledRef.current) {\r\n          callbacksCalledRef.current = true;\r\n          if (onRenderComplete) {\r\n            setTimeout(onRenderComplete, 10);\r\n          }\r\n          if (onVisibilityChange) {\r\n            onVisibilityChange(true);\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error(`[SimpleTextRenderer] Error processing content:`, error);\r\n        setCorruptionDetected(true);\r\n        setProcessedContent('❌ Content processing error. Please refresh to restore.');\r\n        setIsLoading(false);\r\n      }\r\n    }\r\n  }, [node?.currentContent, node?.originalContent, node?.id, transformedContent, dispatch, onRenderComplete, onVisibilityChange]);\r\n\r\n  if (!node || !node.currentContent) {\r\n    return <div className=\"simple-renderer-loading\">Loading narrative content...</div>;\r\n  }\r\n\r\n  return (\r\n    <div\r\n      className={`simple-renderer-container ${isVisible ? 'is-visible' : ''}`}\r\n      data-node-id={node.id}\r\n      data-render-count={renderCount}\r\n      style={{\r\n        display: 'block',\r\n        visibility: 'visible',\r\n        position: 'relative',\r\n        minHeight: '200px'\r\n      }}\r\n    >\r\n      <SimpleTransformationContainer\r\n        transformations={appliedTransformations}\r\n        nodeId={node.id}\r\n      >\r\n        {isLoading && (\r\n          <div className=\"simple-renderer-loading\" style={{ padding: '20px 0' }}>\r\n            <div className=\"loading-spinner\"></div>\r\n            <p>Preparing narrative content...</p>\r\n          </div>\r\n        )}\r\n        \r\n        {corruptionDetected && (\r\n          <div className=\"content-corruption-warning\" style={{ \r\n            padding: '15px', \r\n            margin: '10px 0', \r\n            backgroundColor: '#fff3cd', \r\n            border: '1px solid #ffeeba', \r\n            borderRadius: '4px', \r\n            color: '#856404' \r\n          }}>\r\n            <strong>⚠️ Content Recovery Mode</strong>\r\n            <p>Content corruption detected. Attempting recovery...</p>\r\n          </div>\r\n        )}\r\n        \r\n        <div\r\n          ref={contentRef}\r\n          className=\"simple-renderer-content\"\r\n          data-transformations-count={appliedTransformations.length}\r\n          data-corruption-detected={corruptionDetected}\r\n          style={{\r\n            display: 'block',\r\n            visibility: 'visible',\r\n            opacity: corruptionDetected ? 0.7 : 1\r\n          }}\r\n        >\r\n          <div\r\n            dangerouslySetInnerHTML={{ __html: processedContent }}\r\n            className=\"content-inner\"\r\n          />\r\n        </div>\r\n      </SimpleTransformationContainer>\r\n      \r\n      {process.env.NODE_ENV === 'development' && (\r\n        <div className=\"simple-renderer-debug\">\r\n          <div className=\"debug-info\">\r\n            <span>Node: {node.id}</span>\r\n            <span>Transformations: {appliedTransformations.length}</span>\r\n            <span>Renders: {renderCount}</span>\r\n            <span>Path Length: {readingPath.sequence.length}</span>\r\n            <span>Visibility: {isVisible ? 'Visible' : 'Hidden'}</span>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","// src/components/NodeView/NodeView.tsx\r\n\r\nimport { useEffect, useState, lazy, Suspense, useRef, useMemo, useCallback } from 'react';\r\nimport ErrorBoundary from '../common/ErrorBoundary';\r\nimport SimpleTextRenderer from './SimpleTextRenderer';\r\nimport { viewManager } from '../../services/ViewManager';\r\nimport { useSelector } from 'react-redux';\r\nimport {\r\n  selectSelectedNodeId,\r\n  returnToConstellation,\r\n  selectViewMode,\r\n} from '../../store/slices/interfaceSlice';\r\nimport { loadNodeContent, selectNodeById, visitNode, validateNodeContent, recoverNodeContent } from '../../store/slices/nodesSlice';\r\nimport { useAppDispatch } from '../../store/hooks';\r\nimport { addVisitedNode } from '../../store/slices/readerSlice';\r\nimport './NodeView.css';\r\nimport '../common/ErrorStyles.css'; // Import error and debug styles\r\nimport { RootState } from '../../store';\r\nimport { finalTextCleanup } from '../../utils/contentSanitizer';\r\n\r\n// Define interface for the non-standard performance.memory API\r\ninterface MemoryInfo {\r\n  jsHeapSizeLimit: number;\r\n  totalJSHeapSize: number;\r\n  usedJSHeapSize: number;\r\n}\r\n\r\n// Extend Performance interface\r\ninterface ExtendedPerformance extends Performance {\r\n  memory?: MemoryInfo;\r\n}\r\n\r\n// Type guard for memory property\r\nfunction hasMemory(performance: Performance): performance is ExtendedPerformance {\r\n  return 'memory' in performance;\r\n}\r\n\r\n// Dynamically import heavy components with loading tracking\r\nconst ReactMarkdown = lazy(() => {\r\n  console.log('[NodeView] Loading ReactMarkdown component');\r\n  return import('react-markdown').then(module => {\r\n    console.log('[NodeView] ReactMarkdown component loaded');\r\n    return module;\r\n  });\r\n});\r\n\r\nconst MiniConstellation = lazy(() => import('./MiniConstellation'));\r\nconst MarginaliaSidebar = lazy(() => import('./MarginaliaSidebar'));\r\n\r\n// Pre-load NarramorphRenderer to avoid race conditions with content loading\r\nconst NarramorphRendererPromise = import('./NarramorphRenderer');\r\nconst NarramorphRenderer = lazy(() => {\r\n  console.log('[NodeView] Loading NarramorphRenderer component');\r\n  return NarramorphRendererPromise.then(module => {\r\n    console.log('[NodeView] NarramorphRenderer component loaded');\r\n    return module;\r\n  });\r\n});\r\n\r\n// Dynamically import remark plugin with loading tracking\r\nconst remarkGfmPromise = import('remark-gfm').then(module => {\r\n  console.log('[NodeView] remark-gfm plugin loaded');\r\n  return module.default;\r\n});\r\n\r\n// Loading components\r\nconst ContentLoading = () => (\r\n  <div className=\"content-loading\">\r\n    <div className=\"loading-spinner\"></div>\r\n    <p>Loading content...</p>\r\n  </div>\r\n);\r\n\r\nconst SideComponentLoading = () => <div className=\"side-component-loading\"></div>;\r\n\r\nconst NodeView = () => {\r\n  const dispatch = useAppDispatch();\r\n  const selectedNodeId = useSelector(selectSelectedNodeId);\r\n  const viewMode = useSelector(selectViewMode);\r\n  const node = useSelector((state: RootState) => selectedNodeId ? selectNodeById(state, selectedNodeId) : null);\r\n\r\n  const uniqueViewKey = useMemo(() => viewManager.getUniqueViewKey(), []);\r\n\r\n  const [useNarramorph, setUseNarramorph] = useState(false);\r\n  const [useWebGLFallback, setUseWebGLFallback] = useState(false);\r\n  const [forceSimpleRenderer, setForceSimpleRenderer] = useState(true);\r\n  const webGLAvailable = true;\r\n\r\n  const contentContainerRef = useRef<HTMLDivElement>(null);\r\n  const renderCompleteCalledRef = useRef(false);\r\n  const processedNodeRef = useRef<string | null>(null);\r\n  const narramorphActivatedRef = useRef(false);\r\n  const lastVisitedIdRef = useRef<string | null>(null);\r\n\r\n  const [viewTransitionState, setViewTransitionState] = useState({\r\n    transitionTime: Date.now(),\r\n    lastViewMode: viewMode,\r\n    transitionCount: 0,\r\n    renderCount: 0\r\n  });\r\n\r\n  const [memoryStats, setMemoryStats] = useState({\r\n    jsHeapSizeLimit: 0,\r\n    totalJSHeapSize: 0,\r\n    usedJSHeapSize: 0,\r\n    timestamp: 0\r\n  });\r\n\r\n  const onVisibilityChange = useCallback((isVisible: boolean) => {\r\n    console.log(`[NodeView] Content visibility changed to: ${isVisible ? 'visible' : 'hidden'}`);\r\n\r\n    if (!isVisible && contentContainerRef.current) {\r\n      console.warn('[NodeView] Forcing content visibility after hidden state detected');\r\n      contentContainerRef.current.style.display = 'block';\r\n      contentContainerRef.current.style.visibility = 'visible';\r\n      contentContainerRef.current.style.opacity = '1';\r\n      return;\r\n    }\r\n  }, []);\r\n\r\n  const [contentDebug, setContentDebug] = useState({\r\n    loadStarted: false,\r\n    contentLoaded: false,\r\n    renderStarted: false,\r\n    narramorphActivated: false,\r\n    visibilityIssue: false,\r\n    errorOccurred: false\r\n  });\r\n\r\n  const onRenderComplete = useCallback(() => {\r\n    if (renderCompleteCalledRef.current) {\r\n      console.log('[NodeView] Skipping duplicate onRenderComplete call');\r\n      return;\r\n    }\r\n\r\n    renderCompleteCalledRef.current = true;\r\n    console.log('[NodeView] SimpleTextRenderer completed rendering');\r\n\r\n    if (contentContainerRef.current) {\r\n      console.log('[NodeView] Forcing container visibility after render complete');\r\n      contentContainerRef.current.style.display = 'block';\r\n      contentContainerRef.current.style.visibility = 'visible';\r\n      contentContainerRef.current.style.opacity = '1';\r\n    }\r\n\r\n    setContentDebug(prev => ({ ...prev, visibilityIssue: false }));\r\n\r\n    setTimeout(() => {\r\n      if (contentContainerRef.current) {\r\n        const isStillVisible =\r\n          contentContainerRef.current.offsetParent !== null &&\r\n          window.getComputedStyle(contentContainerRef.current).display !== 'none' &&\r\n          window.getComputedStyle(contentContainerRef.current).visibility !== 'hidden';\r\n\r\n        console.log(`[NodeView] Post-render visibility check: ${isStillVisible ? 'visible' : 'not visible'}`);\r\n\r\n        if (!isStillVisible) {\r\n          console.warn('[NodeView] Content became invisible after render - forcing visibility');\r\n          contentContainerRef.current.style.display = 'block';\r\n          contentContainerRef.current.style.visibility = 'visible';\r\n          contentContainerRef.current.style.opacity = '1';\r\n        }\r\n      }\r\n    }, 500);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (selectedNodeId !== processedNodeRef.current) {\r\n      renderCompleteCalledRef.current = false;\r\n      processedNodeRef.current = selectedNodeId;\r\n      narramorphActivatedRef.current = false;\r\n    }\r\n  }, [selectedNodeId]);\r\n\r\n  useEffect(() => {\r\n    if (viewTransitionState.lastViewMode !== viewMode) {\r\n      const now = Date.now();\r\n      console.log(`[NodeView] View transition: ${viewTransitionState.lastViewMode} -> ${viewMode} at ${now}`);\r\n\r\n      setViewTransitionState(prev => ({\r\n        ...prev,\r\n        lastViewMode: viewMode,\r\n        transitionTime: now,\r\n        transitionCount: prev.transitionCount + 1,\r\n        renderCount: prev.renderCount + 1\r\n      }));\r\n\r\n      setContentDebug({\r\n        loadStarted: false,\r\n        contentLoaded: false,\r\n        renderStarted: false,\r\n        narramorphActivated: false,\r\n        visibilityIssue: false,\r\n        errorOccurred: false\r\n      });\r\n\r\n      if (hasMemory(performance) && performance.memory) {\r\n        const memory = performance.memory;\r\n        setMemoryStats({\r\n          jsHeapSizeLimit: memory.jsHeapSizeLimit,\r\n          totalJSHeapSize: memory.totalJSHeapSize,\r\n          usedJSHeapSize: memory.usedJSHeapSize,\r\n          timestamp: now\r\n        });\r\n      }\r\n    } else {\r\n      setViewTransitionState(prev => ({\r\n        ...prev,\r\n        renderCount: prev.renderCount + 1\r\n      }));\r\n    }\r\n  }, [viewMode, viewTransitionState.lastViewMode]);\r\n\r\n  useEffect(() => {\r\n    const needsContent = selectedNodeId && !node?.content;\r\n    if (needsContent) {\r\n      console.log(`[NodeView] Loading content for node: ${selectedNodeId}`, {\r\n        viewMode\r\n      });\r\n      setContentDebug(prev => ({ ...prev, loadStarted: true }));\r\n      dispatch(loadNodeContent(selectedNodeId));\r\n    }\r\n  }, [selectedNodeId, dispatch, viewMode, node?.content]);\r\n  const contentLength = node?.currentContent?.length || 0;\r\n\r\n  // Create clean content for ReactMarkdown fallbacks\r\n  const cleanCurrentContent = useMemo(() => {\r\n    if (!node?.currentContent) return '';\r\n    return finalTextCleanup(node.currentContent);\r\n  }, [node?.currentContent]);\r\n\r\n  const contentCorrupted = useMemo(() => {\r\n    if (!node?.currentContent) return false;\r\n    return (\r\n      node.currentContent.includes('[object Object]') ||\r\n      node.currentContent.includes('undefined') ||\r\n      node.currentContent.length < 10\r\n    );\r\n  }, [node?.currentContent]);\r\n\r\n  const contentPreview = useMemo(() => {\r\n    return node?.currentContent?.substring(0, 50) || 'NO CONTENT';\r\n  }, [node?.currentContent]);\r\n\r\n  useEffect(() => {\r\n    if (node?.id && processedNodeRef.current === selectedNodeId) {\r\n      const hasCurrentContent = contentLength > 0;\r\n\r\n      console.log(`[NodeView] Content processed for node: ${selectedNodeId}`, {\r\n        hasContent: hasCurrentContent,\r\n        visitCount: node.visitCount,\r\n        contentLength,\r\n        contentPreview,\r\n        enhancedContentExists: !!node.enhancedContent,\r\n        contentExists: !!node.content\r\n      });\r\n\r\n      setContentDebug(prev => ({ ...prev, contentLoaded: hasCurrentContent }));\r\n\r\n      if (hasCurrentContent && contentCorrupted) {\r\n        console.error(`[NodeView] Possible content corruption detected:`, {\r\n          contentStart: contentPreview,\r\n          contentLength\r\n        });\r\n      }\r\n    }\r\n  }, [\r\n    selectedNodeId,\r\n    node?.id,\r\n    node?.visitCount,\r\n    node?.content,\r\n    node?.enhancedContent,\r\n    contentLength,\r\n    contentPreview,\r\n    contentCorrupted\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    if (node?.id && contentLength > 0 && !narramorphActivatedRef.current) {\r\n      console.log(`[NodeView] Preparing to activate Narramorph for node: ${node.id}`, {\r\n        viewMode,\r\n        hasContent: contentLength > 0\r\n      });\r\n      setContentDebug(prev => ({ ...prev, renderStarted: true }));\r\n\r\n      narramorphActivatedRef.current = true;\r\n\r\n      let componentLoaded = false;\r\n\r\n      console.log('[NodeView] Preloading NarramorphRenderer component');\r\n      NarramorphRendererPromise.then(() => {\r\n        componentLoaded = true;\r\n        console.log('[NodeView] NarramorphRenderer preload complete');\r\n\r\n        if (node?.id) {\r\n          console.log(`[NodeView] Activating Narramorph renderer for node: ${node.id} after preload`);\r\n\r\n          setUseNarramorph(true);\r\n          setContentDebug(prev => ({ ...prev, narramorphActivated: true }));\r\n\r\n          if (contentContainerRef.current) {\r\n            const preBoundingRect = contentContainerRef.current.getBoundingClientRect();\r\n            console.log('[NodeView] Post-preload container dimensions:', {\r\n              width: preBoundingRect.width,\r\n              height: preBoundingRect.height,\r\n              display: window.getComputedStyle(contentContainerRef.current).display,\r\n              visibility: window.getComputedStyle(contentContainerRef.current).visibility\r\n            });\r\n          }\r\n        }\r\n      }).catch(err => {\r\n        console.error('[NodeView] Error preloading NarramorphRenderer:', err);\r\n        setForceSimpleRenderer(true);\r\n      });\r\n\r\n      const visibilityTimer = setTimeout(() => {\r\n        if (contentContainerRef.current) {\r\n          console.log('[NodeView] Force checking content visibility');\r\n          const isVisible = contentContainerRef.current.offsetParent !== null;\r\n          const boundingRect = contentContainerRef.current.getBoundingClientRect();\r\n          const computedStyle = window.getComputedStyle(contentContainerRef.current);\r\n\r\n          console.log('[NodeView] Content visibility check:', {\r\n            isVisible,\r\n            width: boundingRect.width,\r\n            height: boundingRect.height,\r\n            display: computedStyle.display,\r\n            visibility: computedStyle.visibility,\r\n            zIndex: computedStyle.zIndex,\r\n            position: computedStyle.position,\r\n            opacity: computedStyle.opacity,\r\n            componentLoaded\r\n          });\r\n\r\n          if (!isVisible || boundingRect.width === 0 || boundingRect.height === 0) {\r\n            console.warn('[NodeView] Content invisible after rendering - forcing simple renderer');\r\n            setForceSimpleRenderer(true);\r\n            setContentDebug(prev => ({ ...prev, visibilityIssue: true }));\r\n          }\r\n        }\r\n      }, 1500);\r\n\r\n      return () => clearTimeout(visibilityTimer);\r\n    }\r\n    return undefined;\r\n  }, [contentLength, node?.id, viewMode]);\r\n\r\n  useEffect(() => {\r\n    if (!node?.id || node.id === lastVisitedIdRef.current) return;\r\n\r\n    dispatch(visitNode(node.id));\r\n    // Create a plain-text synopsis from current content (first 100 chars)\r\n    // Use refs or stable values to avoid adding node.currentContent and node.title to dependencies\r\n    const currentContent = node.currentContent ?? '';\r\n    const title = node.title ?? '';\r\n\r\n    const synopsis =\r\n      currentContent\r\n        .replace(/<[^>]*>/g, '')\r\n        .replace(/\\s+/g, ' ')\r\n        .trim()\r\n        .slice(0, 100);\r\n\r\n    dispatch(\r\n      addVisitedNode({\r\n        id: node.id,\r\n        title,\r\n        synopsis,\r\n      }),\r\n    );    // Update ref to prevent duplicate processing\r\n    lastVisitedIdRef.current = node.id;\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [dispatch, node?.id]);\r\n  \r\n  // EMERGENCY CONTENT RECOVERY: Validate content on each render and trigger recovery if needed\r\n  useEffect(() => {\r\n    if (node?.id && node?.currentContent) {\r\n      // Validate content integrity\r\n      dispatch(validateNodeContent(node.id));\r\n      \r\n      // If content is marked as corrupted, attempt recovery\r\n      if (node.transformationState === 'corrupted' && node.originalContent) {\r\n        console.warn(`[NodeView] Content corruption detected for node ${node.id}, initiating recovery`);\r\n        dispatch(recoverNodeContent(node.id));\r\n      }\r\n    }\r\n  }, [node?.id, node?.currentContent, node?.transformationState, node?.originalContent, dispatch]);\r\n  \r\n  // Handle WebGL context loss errors\r\n  useEffect(() => {\r\n    const handleWebGLContextLoss = (event: ErrorEvent) => {\r\n      if (event.message &&\r\n         (event.message.includes('WebGL context lost') ||\r\n          event.message.includes('THREE.WebGLRenderer'))) {\r\n        console.error('[NodeView] WebGL context loss detected!', {\r\n          message: event.message,\r\n          stack: event.error?.stack || 'No stack trace',\r\n          viewMode,\r\n          timeElapsed: Date.now() - viewTransitionState.transitionTime + 'ms',\r\n          renderCount: viewTransitionState.renderCount\r\n        });\r\n\r\n        setUseWebGLFallback(true);\r\n        setUseNarramorph(false);\r\n        setContentDebug(prev => ({ ...prev, errorOccurred: true }));\r\n\r\n        if (hasMemory(performance) && performance.memory) {\r\n          const memory = performance.memory;\r\n          setMemoryStats({\r\n            jsHeapSizeLimit: memory.jsHeapSizeLimit,\r\n            totalJSHeapSize: memory.totalJSHeapSize,\r\n            usedJSHeapSize: memory.usedJSHeapSize,\r\n            timestamp: Date.now()\r\n          });\r\n\r\n          console.log(`[NodeView] Memory usage at WebGL error:`, {\r\n            usedHeap: Math.round(memory.usedJSHeapSize / (1024 * 1024)) + 'MB',\r\n            totalHeap: Math.round(memory.totalJSHeapSize / (1024 * 1024)) + 'MB',\r\n            limit: Math.round(memory.jsHeapSizeLimit / (1024 * 1024)) + 'MB'\r\n          });\r\n        }\r\n      }\r\n    };\r\n\r\n    window.addEventListener('error', handleWebGLContextLoss);\r\n\r\n    return () => {\r\n      window.removeEventListener('error', handleWebGLContextLoss);\r\n    };\r\n  }, [viewMode, viewTransitionState.renderCount, viewTransitionState.transitionTime]);\r\n\r\n  const handleReturnToConstellation = () => {\r\n    dispatch(returnToConstellation());\r\n  };\r\n\r\n  if (viewMode !== 'reading' || !node) {\r\n    return null;\r\n  }\r\n\r\n  const characterClass = `${node.character.toLowerCase()}-theme`;\r\n\r\n  const getTemporalClass = () => {\r\n    if (node.temporalValue <= 3) return 'past-indicator';\r\n    if (node.temporalValue <= 6) return 'present-indicator';\r\n    return 'future-indicator';\r\n  };\r\n\r\n  const renderNodeContent = () => {\r\n    if (!node.currentContent) {\r\n      return (\r\n        <div className=\"node-loading\">\r\n          <span>Loading narrative fragment...</span>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    // Add a wrapper with debug information\r\n    return (\r\n      <div\r\n        ref={contentContainerRef}\r\n        className={`content-container ${node.currentState}`}\r\n        data-content-loaded=\"true\"\r\n        data-node-id={node.id}\r\n        data-visit-count={node.visitCount}\r\n        style={{ position: 'relative', visibility: 'visible', display: 'block' }}\r\n      >\r\n        {/* Determine the appropriate renderer to use based on conditions */}\r\n        {forceSimpleRenderer || !webGLAvailable ? (\r\n          // Use SimpleTextRenderer when either forced or WebGL isn't available\r\n          <div\r\n            className=\"simple-renderer-wrapper\"\r\n            style={{\r\n              display: 'block',\r\n              visibility: 'visible',\r\n              position: 'relative',\r\n              minHeight: '200px',\r\n              opacity: 1,\r\n              zIndex: 5\r\n            }}\r\n          >\r\n            <SimpleTextRenderer\r\n              key={`simple-${node.id}-${node.visitCount}`}\r\n              nodeId={node.id}\r\n              onRenderComplete={onRenderComplete}\r\n              onVisibilityChange={onVisibilityChange}\r\n            />\r\n          </div>\r\n        ) : (\r\n          // Try advanced rendering if conditions allow\r\n          <Suspense fallback={<ContentLoading />}>\r\n            {useNarramorph && !useWebGLFallback ? (\r\n              // Try to use Narramorph, but with error boundary and fallback\r\n              <ErrorBoundary\r\n                fallback={                  <div className=\"fallback-content\" style={{ visibility: 'visible', display: 'block' }}>\r\n                    <p className=\"error-notice\">Advanced rendering unavailable - showing basic content</p>\r\n                    <ReactMarkdown remarkPlugins={[() => remarkGfmPromise]}>{cleanCurrentContent}</ReactMarkdown>\r\n                  </div>\r\n                }\r\n              >\r\n                {/* Render placeholder div to reserve space during loading */}\r\n                <div\r\n                  style={{\r\n                    minHeight: '200px',\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    justifyContent: 'center'\r\n                  }}\r\n                >\r\n                  <NarramorphRenderer\r\n                    key={`narramorph-${node.id}-${node.visitCount}`}\r\n                    nodeId={node.id}\r\n                    onVisibilityChange={(isVisible: boolean) => {\r\n                      console.log(`[NodeView] Content visibility changed to: ${isVisible ? 'visible' : 'hidden'}`);\r\n                      \r\n                      // Use a ref to track visibility changes over time\r\n                      const visibilityTimer = setTimeout(() => {\r\n                        // Only update state if component is still mounted\r\n                        if (contentContainerRef.current) {\r\n                          setContentDebug(prev => ({ ...prev, visibilityIssue: !isVisible }));\r\n                          \r\n                          // Only force simple renderer if content remains invisible\r\n                          if (!isVisible) {\r\n                            setForceSimpleRenderer(true);\r\n                          }\r\n                        }\r\n                      }, 1000); // Wait 1 second before applying changes\r\n                      \r\n                      return () => clearTimeout(visibilityTimer);\r\n                    }}\r\n                  />\r\n                </div>\r\n              </ErrorBoundary>\r\n            ) : (\r\n              // Fallback to basic rendering with ReactMarkdown\r\n              <div style={{ visibility: 'visible', display: 'block', position: 'relative', minHeight: '100px' }}>\r\n                <div className=\"content-loading\" style={{ marginBottom: '10px' }}>\r\n                  <div className=\"loading-spinner\"></div>\r\n                  <p>Preparing content...</p>\r\n                </div>                <ReactMarkdown\r\n                  key={`markdown-${node.id}-${node.visitCount}`}\r\n                  remarkPlugins={[() => remarkGfmPromise]}\r\n                >\r\n                  {cleanCurrentContent}\r\n                </ReactMarkdown>\r\n              </div>\r\n            )}\r\n          </Suspense>\r\n        )}\r\n        \r\n        {/* Enhanced debug indicator with transition tracking */}\r\n        <div className=\"debug-indicator\">\r\n          <div className={`status-dot ${contentDebug.contentLoaded ? 'status-green' : 'status-red'}`} title=\"Content loaded\"></div>\r\n          <div className={`status-dot ${contentDebug.narramorphActivated ? 'status-green' : 'status-yellow'}`} title=\"Narramorph active\"></div>\r\n          <div className={`status-dot ${contentDebug.errorOccurred ? 'status-red' : 'status-green'}`} title=\"No errors\"></div>\r\n          <div className={`status-dot ${contentDebug.visibilityIssue ? 'status-red' : 'status-green'}`} title=\"Content visible\"></div>\r\n          <div className={`status-dot ${forceSimpleRenderer ? 'status-blue' : 'status-yellow'}`} title=\"Simple renderer\"></div>\r\n          <div className={`status-dot ${webGLAvailable ? 'status-green' : 'status-red'}`} title=\"WebGL available\"></div>\r\n          <div className=\"debug-metrics\">\r\n            <span title=\"View transition count\">T:{viewTransitionState.transitionCount}</span>\r\n            <span title=\"Render count\">R:{viewTransitionState.renderCount}</span>\r\n            {memoryStats.usedJSHeapSize > 0 && (\r\n              <span title=\"Memory usage\">\r\n                M:{Math.round(memoryStats.usedJSHeapSize / (1024 * 1024))}MB\r\n              </span>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n  \r\n  return (\r\n    <div \r\n      key={uniqueViewKey}\r\n      className={`node-view-container ${characterClass}`}\r\n    >\r\n      <div className={`temporal-indicator ${getTemporalClass()}`}></div>\r\n\r\n      <div className=\"node-header\">\r\n        <h1>{node.title}</h1>\r\n        <div className=\"node-metadata\">\r\n          <span className=\"node-character\">{node.character}</span>\r\n          <span className=\"node-state\">{node.currentState}</span>\r\n          <span className=\"node-visits\">Visits: {node.visitCount}</span>\r\n        </div>\r\n      </div>\r\n      \r\n      <div\r\n        className=\"node-content force-visible\"\r\n        style={{\r\n          position: 'relative'\r\n        }}\r\n      >\r\n        {renderNodeContent()}\r\n      </div>\r\n      \r\n      <div className=\"node-navigation\">\r\n        <button onClick={handleReturnToConstellation} className=\"navigation-button\">\r\n          Return to Constellation\r\n        </button>\r\n      </div>\r\n      \r\n      {/* Mini constellation for context - fixed in bottom right corner */}\r\n      <div style={{\r\n        position: 'absolute',\r\n        bottom: '20px',\r\n        right: '20px',\r\n        width: '300px',\r\n        height: '300px',\r\n        pointerEvents: 'auto'\r\n      }}>\r\n        <Suspense fallback={<SideComponentLoading />}>\r\n          <MiniConstellation />\r\n        </Suspense>\r\n      </div>\r\n      \r\n      {/* Sidebar with marginalia */}\r\n      <Suspense fallback={<SideComponentLoading />}>\r\n        <MarginaliaSidebar\r\n          nodeId={node.id}\r\n          strangeAttractors={node.strangeAttractors}\r\n        />\r\n      </Suspense>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default NodeView;\r\n"],"file":"assets/NodeView-m1LH6zaI.js"}