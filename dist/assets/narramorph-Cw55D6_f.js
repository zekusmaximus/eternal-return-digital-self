const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/constellation-CzSJAdlk.js","assets/three-vendor-rJ5vKMTC.js","assets/react-vendor-DaKsb8LL.js"])))=>i.map(i=>d[i]);
import{_ as z,j as b}from"./three-vendor-rJ5vKMTC.js";import{u as M,b as o,j as N}from"./react-vendor-DaKsb8LL.js";import{f as q,g as O,h as I,e as _,v as D,d as L,r as P,i as B,j as F,t as R,k,l as J,m as H,u as K}from"./constellation-CzSJAdlk.js";const U=E=>{const r=M(),[m,f]=o.useState([]),[g,x]=o.useState(!1),l=o.useRef(new Set),T=o.useRef(0),$=N(q),c=E||$,e=N(t=>c?O(t,c):null),p=N(t=>t.nodes.data),V=N(t=>c?I(t,c):0),s=N(t=>t.reader),v=o.useCallback(t=>{const n=p[t];n?(r(_({nodeId:t,character:n.character,temporalValue:n.temporalValue,attractors:n.strangeAttractors})),r(D(t)),r(L("reading")),console.log(`Navigating to node: ${t}`)):console.error(`Could not navigate to node: ${t} - node data not found`)},[r,p]),A=o.useCallback((t,n)=>{r(P({nodeId:t,targetId:n}))},[r]),w=o.useCallback(t=>{r(B(t))},[r]),S=o.useCallback((t,n)=>{r(F({nodeId:t,transformation:n}))},[r]),j=o.useMemo(()=>e?e.revealedConnections:[],[e]),a=o.useMemo(()=>{const t=(e==null?void 0:e.originalContent)||(e==null?void 0:e.currentContent);if(!t)return[];try{const n=R.calculateAllTransformations(t,e,s,p);return console.log(`[useNodeState] Master transformation integration calculated ${n.length} transformations for node ${e.id}:`,{characterBleed:n.filter(i=>i.priority==="high"&&(i.type==="emphasize"||i.type==="fragment")).length,journeyPatterns:n.filter(i=>i.priority==="high"&&i.type!=="emphasize"&&i.type!=="fragment").length,nodeRules:n.filter(i=>i.priority!=="high").length,totalTransformations:n.length,baseContentLength:t.length,usingOriginalContent:!!(e!=null&&e.originalContent)}),n}catch(n){return console.error(`[useNodeState] Error in master transformation calculation for node ${e.id}:`,n),[]}},[e,s,p]),u=o.useMemo(()=>{const t=(e==null?void 0:e.originalContent)||(e==null?void 0:e.currentContent);if(!t)return null;try{const n=R.getTransformedContent({...e,currentContent:t},s,p);if(n!==t&&a.length>0){const i=k.wrapTransformedContent(n,a);return console.log(`[useNodeState] Applied transformation wrapping for node ${e.id}:`,{originalLength:t.length,transformedLength:n.length,wrappedLength:i.length,transformationsCount:a.length,usingOriginalContent:!!(e!=null&&e.originalContent)}),i}return n}catch(n){return console.error(`[useNodeState] Error in master content transformation for node ${e.id}:`,n),t}},[e,s,p,a]);o.useEffect(()=>{if(!e||a.length===0)return;JSON.stringify(m)!==JSON.stringify(a)&&(f(a),x(!0))},[e,a,m]),o.useEffect(()=>{if(g){const t=setTimeout(()=>{x(!1)},2e3);return()=>clearTimeout(t)}},[g]),o.useEffect(()=>{if(!e||!c)return;const t=Date.now();if(t-T.current<500)return;if(e.currentContent&&(e.currentContent.includes("data-transform-type")||e.currentContent.includes("narramorph-")||e.currentContent.includes("[TransformationService]")||e.currentContent.includes("recursive loop detected")||e.currentContent.includes("temporal displacement"))){console.log(`[useNodeState] Content already transformed for node ${c}, skipping legacy transformation dispatch`);return}const n=`${c}-${e.visitCount}`;if(l.current.has(n)){console.log(`[useNodeState] Skipping already applied legacy transformations for ${n}`);return}if(console.log(`[useNodeState] Applying legacy transformation dispatch for node ${c} (visitCount: ${e.visitCount})`),T.current=t,l.current.add(n),l.current.size>50){const C=Array.from(l.current).slice(-25);l.current.clear(),C.forEach(d=>l.current.add(d))}if(r(J({nodeId:c,readerState:s})),e.visitCount===1&&S(c,{condition:{visitCount:1},transformations:[{type:"emphasize",selector:"first-paragraph",emphasis:"italic"}]}),e.visitCount>=2&&e.visitCount<=3){const i=k.createTransformationsFromPatterns(s,e);if(i.length>0&&i.length<=2){const C={condition:{visitCount:e.visitCount},transformations:i.slice(0,1)};S(c,C)}}r(H({nodeId:c,readerState:s}))},[c,e,r,S,s]),o.useEffect(()=>{var C;if(!e||!c||!e.enhancedContent||!(e.enhancedContent.base&&e.enhancedContent.base.length>0||Object.keys(e.enhancedContent.visitCountVariants).length>0||Object.keys(e.enhancedContent.sectionVariants).length>0))return;const i={visitCount:Math.min(e.visitCount,5),lastVisitedCharacter:s.path.sequence.length>1?(C=p[s.path.sequence[s.path.sequence.length-2]])==null?void 0:C.character:void 0,journeyPattern:s.path.sequence.slice(-5),characterSequence:s.path.sequence.slice(-5).map(d=>{var y;return(y=p[d])==null?void 0:y.character}).filter(d=>d!==void 0),attractorsEngaged:s.path.attractorsEngaged||{},recursiveAwareness:s.path.sequence.length>0?1-new Set(s.path.sequence).size/s.path.sequence.length:0};z(async()=>{const{contentVariantService:d}=await import("./constellation-CzSJAdlk.js").then(y=>y.I);return{contentVariantService:d}},__vite__mapDeps([0,1,2])).then(({contentVariantService:d})=>{const y=d.selectContentVariant(e.enhancedContent,i);y!==e.currentContent&&r(K({nodeId:c,context:i,selectedContent:y}))})},[e,c,s.path,p,r]);const h=o.useCallback(t=>e?R.evaluateCondition(t,s,e):!1,[e,s]);return{node:e,navigateTo:v,revealNodeConnection:A,engageWithAttractor:w,applyNodeTransformation:S,evaluateCondition:h,neighbors:j,revisitCount:V,transformedContent:u,newlyTransformed:g,appliedTransformations:m}},X=({children:E,transformations:r,isNewlyTransformed:m,nodeId:f})=>{const g=o.useRef(null),x=o.useRef(null),[l,T]=o.useState("idle"),[$,c]=o.useState(r.length),[e,p]=o.useState(0),[V,s]=o.useState(null),[v,A]=o.useState(!0);o.useEffect(()=>{if(e<3){const a=setTimeout(()=>{p(u=>u+1),console.log(`[AnimationContainer] Forced re-render for node: ${f}, attempt: ${e+1}`)},100);return()=>clearTimeout(a)}},[f,e]),o.useEffect(()=>{if(m){T("entering");const a=setTimeout(()=>{T("active")},1e3);return()=>clearTimeout(a)}},[m,r]),o.useEffect(()=>{T("idle"),c(r.length),console.log(`[AnimationContainer] Node changed to: ${f}, transformations: ${r.length}`)},[f,r.length]),o.useLayoutEffect(()=>{if(!g.current)return;const a=()=>{if(!g.current)return;const n=window.getComputedStyle(g.current),i=g.current.getBoundingClientRect(),C={width:i.width,height:i.height,visibility:n.visibility,display:n.display,opacity:n.opacity,position:n.position,zIndex:n.zIndex,overflow:n.overflow};s(C);const d=i.width>0&&i.height>0&&n.visibility!=="hidden"&&n.display!=="none"&&parseFloat(n.opacity)>0;A(d),v!==d&&console.log(`[AnimationContainer] Content visibility changed to: ${d?"visible":"hidden"}`,{nodeId:f,transformations:r.length,animationState:l,measurements:C})};a();const u=setTimeout(a,1100);let h=null;const t=new MutationObserver(n=>{n.length>2&&console.log(`[AnimationContainer] DOM mutations detected: ${n.length}`),h&&clearTimeout(h),h=window.setTimeout(()=>{a(),h=null},500)});return t.observe(g.current,{attributes:!0,childList:!0,subtree:!1}),()=>{clearTimeout(u),t.disconnect()}},[f,r,l,v]);const w=()=>{if(l==="idle")return"";const a=r.some(t=>t.type==="replace"),u=r.some(t=>t.type==="emphasize"),h=r.some(t=>t.type==="expand");return l==="entering"?a?"narramorph-container-replace-active":u?"narramorph-container-emphasis-active":h?"narramorph-container-expand-active":"narramorph-container-transform-active":"narramorph-container-active"},S=()=>{if(r.length===0)return"";const a={};r.forEach(h=>{a[h.type]=(a[h.type]||0)+1});const u=[];return a.replace&&u.push(`${a.replace} replacements`),a.emphasize&&u.push(`${a.emphasize} emphasis`),a.expand&&u.push(`${a.expand} expansions`),a.fragment&&u.push(`${a.fragment} fragmentations`),a.metaComment&&u.push(`${a.metaComment} comments`),u.join(", ")},j=r.length!==$;return o.useEffect(()=>{m&&console.log(`[AnimationContainer] Animation started for node: ${f}`,{transformations:r.length,animationState:l,contentVisible:v})},[m,f,r.length,l,v]),b.jsxs("div",{ref:g,className:`narramorph-animation-container ${w()}`,"data-transformation-count":r.length,"data-newly-transformed":m,"data-animation-state":l,"data-visible":v,"data-render-attempt":e,style:{overflow:"visible",minHeight:"150px",position:"relative",visibility:"visible",display:"block",opacity:1},children:[r.length>0&&b.jsxs("div",{className:`narramorph-transformation-indicator ${m?"active":""}`,title:S(),children:[b.jsx("span",{className:"transformation-count",children:r.length}),j&&b.jsxs("span",{className:"transformation-change-indicator",children:[r.length>$?"+":"",r.length-$]})]}),b.jsx("div",{ref:x,className:"narramorph-animation-content",style:{position:"relative",visibility:"visible",display:"block",opacity:1,minHeight:"100px"},children:e===0?b.jsx("div",{className:"animation-placeholder",style:{padding:"20px",textAlign:"center"},children:b.jsx("p",{children:"Preparing narrative..."})}):E}),!1]})};export{X as T,U as u};
//# sourceMappingURL=narramorph-Cw55D6_f.js.map
