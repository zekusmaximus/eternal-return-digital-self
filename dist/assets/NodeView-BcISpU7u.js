const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/markdown-vendor-Bfyu7to_.js","assets/three-vendor-rJ5vKMTC.js","assets/react-vendor-DaKsb8LL.js","assets/MiniConstellation-9K4DNj81.js","assets/constellation-D8AaAQ1t.js","assets/node-view-GFMNrUCl.js","assets/node-view-CrwFC8Ay.css","assets/MarginaliaSidebar-CgaFnjof.js","assets/NarramorphRenderer-JQuTsLy5.js","assets/narramorph-BBDYQQAX.js","assets/narramorph-DivzNTyX.css"])))=>i.map(i=>d[i]);
import{j as t,_ as L}from"./three-vendor-rJ5vKMTC.js";import{b as n,j as I,u as K}from"./react-vendor-DaKsb8LL.js";import{u as Q}from"./narramorph-BBDYQQAX.js";import{B,C as G,a as X,w as Y,g as Z,D as ee,v as te,E as ne,F as re}from"./constellation-D8AaAQ1t.js";import{v as ie}from"./app-e3lbHxA-.js";import{u as se}from"./node-view-GFMNrUCl.js";class oe extends n.Component{constructor(r){super(r),this.state={hasError:!1,error:null}}static getDerivedStateFromError(r){return{hasError:!0,error:r}}componentDidCatch(r,l){console.error("ErrorBoundary caught an error:",r),console.error("Component stack:",l.componentStack)}render(){return this.state.hasError?this.props.fallback:this.props.children}}function ae(s){return s?[s.includes("[object Object]"),s.includes("undefined"),s.includes('<span class="glitch-text"><span class="glitch-text">'),s.match(/<<\*\*span\*\*/g),s.length<10,s.split("<span").length>10].some(l=>l):!0}function le(s){if(!s)return"";try{let r=s;return r=r.replace(/\*#\s*/g,""),r=r.replace(/\s{2,}/g," "),r=r.split(`
`).map(l=>l.trim()).join(`
`),r=r.replace(/\n\s*\n\s*\n/g,`

`),r.trim()}catch(r){return console.error("[ContentSanitizer] Error sanitizing display content:",r),s}}const ce=({children:s,transformations:r,nodeId:l})=>{const[e,w]=n.useState(0),[y,j]=n.useState(!1),[N,C]=n.useState("");n.useEffect(()=>{const d=r.map(i=>`${i.type}-${i.selector||"no-selector"}-${JSON.stringify(i)}`).sort().join("|");if(d!==N)if(r.length>e){j(!0);const i=setTimeout(()=>{j(!1)},2e3);return w(r.length),C(d),()=>clearTimeout(i)}else w(r.length),C(d)},[r,N,e]);const R=()=>{if(r.length===0)return"";const d={};r.forEach(v=>{d[v.type]=(d[v.type]||0)+1});const i=[];return d.replace&&i.push(`${d.replace} replacements`),d.emphasize&&i.push(`${d.emphasize} emphasis`),d.expand&&i.push(`${d.expand} expansions`),d.fragment&&i.push(`${d.fragment} fragmentations`),d.metaComment&&i.push(`${d.metaComment} comments`),i.join(", ")};return t.jsxs("div",{className:`simple-transformation-container ${y?"newly-transformed":""}`,"data-transformation-count":r.length,"data-node-id":l,children:[r.length>0&&t.jsxs("div",{className:`transformation-indicator ${y?"active":""}`,title:R(),children:[t.jsx("span",{className:"transformation-count",children:r.length}),y&&r.length>e&&t.jsxs("span",{className:"transformation-change",children:["+",r.length-e]})]}),t.jsx("div",{className:"simple-transformation-content",children:s}),y&&t.jsx("div",{className:"transformation-overlay","aria-hidden":"true"})]})},de=n.memo(({nodeId:s,onRenderComplete:r,onVisibilityChange:l})=>{const{node:e,transformedContent:w,appliedTransformations:y}=Q(s),[j,N]=n.useState(""),[C,R]=n.useState(!0),[d,i]=n.useState(!0),[v,E]=n.useState(!1),$=n.useRef(null),k=n.useRef(null),f=n.useRef(null),[M,z]=n.useState(0);I(g=>g.reader.path);const S=n.useRef(!1),T=K();return n.useEffect(()=>{var g;if(e!=null&&e.currentContent||e!=null&&e.originalContent){console.log(`[SimpleTextRenderer] Processing content for node: ${e.id}, length: ${(g=e.originalContent||e.currentContent)==null?void 0:g.length}`),i(!0),E(!1);try{const a=e.originalContent||e.currentContent||"";if(ae(a))if(console.error(`[SimpleTextRenderer] Content corruption detected for node ${e.id}:`,{contentLength:a.length,contentPreview:a.substring(0,100)}),E(!0),e.originalContent&&e.originalContent!==a){console.log(`[SimpleTextRenderer] Attempting content recovery for node ${e.id}`),T(B(e.id));return}else{N("⚠️ Content temporarily unavailable. Please refresh to restore."),i(!1);return}const x=w||a,p=le(x);console.log(`[SimpleTextRenderer] Content processing complete for node ${e.id}:`,{originalLength:a.length,transformedLength:x.length,finalLength:p.length,appliedTransformations:y.length,usingOriginalContent:!!e.originalContent}),N(p),T(G(e.id)),z(u=>u+1),i(!1),R(!0),S.current||(S.current=!0,r&&(console.log(`[SimpleTextRenderer] Render complete for node: ${e.id}`),setTimeout(r,10)),l&&(console.log("[SimpleTextRenderer] Explicitly marking content as visible"),l(!0)))}catch(a){console.error("[SimpleTextRenderer] Error processing content:",a),E(!0),N("❌ Content processing error. Please refresh to restore."),i(!1)}}},[e==null?void 0:e.currentContent,e==null?void 0:e.originalContent,e==null?void 0:e.id,w,T]),n.useEffect(()=>{S.current=!1},[e==null?void 0:e.id]),n.useEffect(()=>{const g=$.current,a=k.current;if(g)return console.log(`[DEBUG] Setting up IntersectionObserver for node: ${e==null?void 0:e.id}, current visibility: ${C}`),a&&a.disconnect(),C||(console.log(`[DEBUG] Forcing initial visibility to true for node: ${e==null?void 0:e.id}`),R(!0),l&&!S.current&&l(!0)),console.log(`[DEBUG] Skipping IntersectionObserver setup to prevent infinite loops for node: ${e==null?void 0:e.id}`),()=>{console.log(`[DEBUG] Cleaning up IntersectionObserver for node: ${e==null?void 0:e.id}`),a&&a.disconnect()}},[e==null?void 0:e.id,C]),n.useEffect(()=>{const g=$.current;if(!g)return;console.log(`[DEBUG] Setting up MutationObserver for node: ${e==null?void 0:e.id}`),f.current&&f.current.disconnect();let a=null;return f.current=new MutationObserver(x=>{a&&clearTimeout(a),a=window.setTimeout(()=>{x.forEach(p=>{if(p.type==="attributes"&&(p.attributeName==="style"||p.attributeName==="class"||p.attributeName==="display"||p.attributeName==="visibility"||p.attributeName==="opacity")){const u=p.target,b=window.getComputedStyle(u);console.log(`[DEBUG] Style mutation detected on ${u.tagName}#${u.id}.${u.className}:`,{display:b.display,visibility:b.visibility,opacity:b.opacity}),(b.display==="none"||b.visibility==="hidden"||parseFloat(b.opacity)===0)&&(console.warn("[DEBUG] Preventing content from being hidden by style mutation"),u.style.display=u.style.display==="none"?"block":u.style.display,u.style.visibility=u.style.visibility==="hidden"?"visible":u.style.visibility,u.style.opacity=parseFloat(u.style.opacity)===0?"1":u.style.opacity,u===g&&l&&!S.current&&(console.log("[DEBUG] Notifying parent that content is still visible after mutation"),l(!0)))}})},100)}),f.current.observe(g,{attributes:!0,attributeFilter:["style","class"],childList:!1,subtree:!1}),()=>{var x;console.log(`[DEBUG] Cleaning up MutationObserver for node: ${e==null?void 0:e.id}`),a&&clearTimeout(a),(x=f.current)==null||x.disconnect()}},[e==null?void 0:e.id]),!e||!e.currentContent?t.jsx("div",{className:"simple-renderer-loading",children:"Loading narrative content..."}):t.jsxs("div",{className:`simple-renderer-container ${C?"is-visible":""}`,"data-node-id":e.id,"data-render-count":M,style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px"},children:["      ",t.jsxs(ce,{transformations:y,nodeId:e.id,children:[d&&t.jsxs("div",{className:"simple-renderer-loading",style:{padding:"20px 0"},children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Preparing narrative content..."})]}),v&&t.jsxs("div",{className:"content-corruption-warning",style:{padding:"15px",margin:"10px 0",backgroundColor:"#fff3cd",border:"1px solid #ffeeba",borderRadius:"4px",color:"#856404"},children:[t.jsx("strong",{children:"⚠️ Content Recovery Mode"}),t.jsx("p",{children:"Content corruption detected. Attempting recovery..."})]}),t.jsx("div",{ref:$,className:"simple-renderer-content","data-transformations-count":y.length,"data-corruption-detected":v,style:{display:"block",visibility:"visible",opacity:v?.7:1},children:t.jsx("div",{dangerouslySetInnerHTML:{__html:j},className:"content-inner"})})]}),!1]})});function D(s){return"memory"in s}const H=n.lazy(()=>(console.log("[NodeView] Loading ReactMarkdown component"),L(()=>import("./markdown-vendor-Bfyu7to_.js").then(s=>s.i),__vite__mapDeps([0,1,2])).then(s=>(console.log("[NodeView] ReactMarkdown component loaded"),s)))),ue=n.lazy(()=>L(()=>import("./MiniConstellation-9K4DNj81.js"),__vite__mapDeps([3,1,2,4,5,6]))),pe=n.lazy(()=>L(()=>import("./MarginaliaSidebar-CgaFnjof.js"),__vite__mapDeps([7,1,2,4,5,6]))),A=L(()=>import("./NarramorphRenderer-JQuTsLy5.js"),__vite__mapDeps([8,1,2,9,4,10])),me=n.lazy(()=>(console.log("[NodeView] Loading NarramorphRenderer component"),A.then(s=>(console.log("[NodeView] NarramorphRenderer component loaded"),s)))),P=L(()=>import("./markdown-vendor-Bfyu7to_.js").then(s=>s.a),__vite__mapDeps([0,1,2])).then(s=>(console.log("[NodeView] remark-gfm plugin loaded"),s.default)),fe=()=>t.jsxs("div",{className:"content-loading",children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Loading content..."})]}),O=()=>t.jsx("div",{className:"side-component-loading"}),xe=()=>{var _;const s=se(),r=I(X),l=I(Y),e=I(o=>r?Z(o,r):null),w=n.useMemo(()=>ie.getUniqueViewKey(),[]),[y,j]=n.useState(!1),[N,C]=n.useState(!1),[R,d]=n.useState(!0),i=n.useRef(null),v=n.useRef(!1),E=n.useRef(null),$=n.useRef(!1),k=n.useRef(null),[f,M]=n.useState({transitionTime:Date.now(),lastViewMode:l,transitionCount:0,renderCount:0}),[z,S]=n.useState({jsHeapSizeLimit:0,totalJSHeapSize:0,usedJSHeapSize:0,timestamp:0}),T=n.useCallback(o=>{if(console.log(`[NodeView] Content visibility changed to: ${o?"visible":"hidden"}`),!o&&i.current){console.warn("[NodeView] Forcing content visibility after hidden state detected"),i.current.style.display="block",i.current.style.visibility="visible",i.current.style.opacity="1";return}v.current||a(c=>({...c,visibilityIssue:!o}))},[]),[g,a]=n.useState({loadStarted:!1,contentLoaded:!1,renderStarted:!1,narramorphActivated:!1,visibilityIssue:!1,errorOccurred:!1}),x=n.useCallback(()=>{if(v.current){console.log("[NodeView] Skipping duplicate onRenderComplete call");return}v.current=!0,console.log("[NodeView] SimpleTextRenderer completed rendering"),i.current&&(console.log("[NodeView] Forcing container visibility after render complete"),i.current.style.display="block",i.current.style.visibility="visible",i.current.style.opacity="1"),a(o=>({...o,visibilityIssue:!1})),setTimeout(()=>{if(i.current){const o=i.current.offsetParent!==null&&window.getComputedStyle(i.current).display!=="none"&&window.getComputedStyle(i.current).visibility!=="hidden";console.log(`[NodeView] Post-render visibility check: ${o?"visible":"not visible"}`),o||(console.warn("[NodeView] Content became invisible after render - forcing visibility"),i.current.style.display="block",i.current.style.visibility="visible",i.current.style.opacity="1")}},500)},[]);n.useEffect(()=>{r!==E.current&&(v.current=!1,E.current=r,$.current=!1)},[r]),n.useEffect(()=>{if(f.lastViewMode!==l){const o=Date.now();if(console.log(`[NodeView] View transition: ${f.lastViewMode} -> ${l} at ${o}`),M(c=>({...c,lastViewMode:l,transitionTime:o,transitionCount:c.transitionCount+1,renderCount:c.renderCount+1})),a(c=>({...c,loadStarted:!1,contentLoaded:!1,renderStarted:!1,narramorphActivated:!1,visibilityIssue:!1,errorOccurred:!1})),D(performance)&&performance.memory){const c=performance.memory;S({jsHeapSizeLimit:c.jsHeapSizeLimit,totalJSHeapSize:c.totalJSHeapSize,usedJSHeapSize:c.usedJSHeapSize,timestamp:o})}}else M(o=>({...o,renderCount:o.renderCount+1}))},[l,f.lastViewMode]),n.useEffect(()=>{r&&!(e!=null&&e.content)&&(console.log(`[NodeView] Loading content for node: ${r}`,{viewMode:l}),a(c=>({...c,loadStarted:!0})),s(ee(r)))},[r,s,l,e==null?void 0:e.content]);const p=((_=e==null?void 0:e.currentContent)==null?void 0:_.length)||0,u=n.useMemo(()=>e!=null&&e.currentContent?e.currentContent.includes("[object Object]")||e.currentContent.includes("undefined")||e.currentContent.length<10:!1,[e==null?void 0:e.currentContent]),b=n.useMemo(()=>{var o;return((o=e==null?void 0:e.currentContent)==null?void 0:o.substring(0,50))||"NO CONTENT"},[e==null?void 0:e.currentContent]);n.useEffect(()=>{if(e!=null&&e.id&&E.current===r){const o=p>0;console.log(`[NodeView] Content processed for node: ${r}`,{hasContent:o,visitCount:e.visitCount,contentLength:p,contentPreview:b,enhancedContentExists:!!e.enhancedContent,contentExists:!!e.content}),a(c=>({...c,contentLoaded:o})),o&&u&&console.error("[NodeView] Possible content corruption detected:",{contentStart:b,contentLength:p})}},[r,e==null?void 0:e.id,e==null?void 0:e.visitCount,e==null?void 0:e.content,e==null?void 0:e.enhancedContent,p,b,u]),n.useEffect(()=>{if(e!=null&&e.id&&p>0&&!$.current){console.log(`[NodeView] Preparing to activate Narramorph for node: ${e.id}`,{viewMode:l,hasContent:p>0}),a(m=>({...m,renderStarted:!0})),$.current=!0;let o=!1;console.log("[NodeView] Preloading NarramorphRenderer component"),A.then(()=>{if(o=!0,console.log("[NodeView] NarramorphRenderer preload complete"),e!=null&&e.id&&(console.log(`[NodeView] Activating Narramorph renderer for node: ${e.id} after preload`),j(!0),a(m=>({...m,narramorphActivated:!0})),i.current)){const m=i.current.getBoundingClientRect();console.log("[NodeView] Post-preload container dimensions:",{width:m.width,height:m.height,display:window.getComputedStyle(i.current).display,visibility:window.getComputedStyle(i.current).visibility})}}).catch(m=>{console.error("[NodeView] Error preloading NarramorphRenderer:",m),d(!0)});const c=setTimeout(()=>{if(i.current){console.log("[NodeView] Force checking content visibility");const m=i.current.offsetParent!==null,h=i.current.getBoundingClientRect(),V=window.getComputedStyle(i.current);console.log("[NodeView] Content visibility check:",{isVisible:m,width:h.width,height:h.height,display:V.display,visibility:V.visibility,zIndex:V.zIndex,position:V.position,opacity:V.opacity,componentLoaded:o}),(!m||h.width===0||h.height===0)&&(console.warn("[NodeView] Content invisible after rendering - forcing simple renderer"),d(!0),a(q=>({...q,visibilityIssue:!0})))}},1500);return()=>clearTimeout(c)}},[p,e==null?void 0:e.id,l]),n.useEffect(()=>{if(!(e!=null&&e.id)||e.id===k.current)return;s(te(e.id));const o=(e.currentContent??"").replace(/<\/?[^>]+(>|$)/g,"").replace(/\s+/g," ").trim().slice(0,100);s(ne({id:e.id,title:e.title??"",synopsis:o})),k.current=e.id},[s,e==null?void 0:e.id]),n.useEffect(()=>{e!=null&&e.id&&(e!=null&&e.currentContent)&&(s(G(e.id)),e.transformationState==="corrupted"&&e.originalContent&&(console.warn(`[NodeView] Content corruption detected for node ${e.id}, initiating recovery`),s(B(e.id))))},[e==null?void 0:e.id,e==null?void 0:e.currentContent,e==null?void 0:e.transformationState,e==null?void 0:e.originalContent,s]),n.useEffect(()=>{const o=c=>{var m;if(c.message&&(c.message.includes("WebGL context lost")||c.message.includes("THREE.WebGLRenderer"))&&(console.error("[NodeView] WebGL context loss detected!",{message:c.message,stack:((m=c.error)==null?void 0:m.stack)||"No stack trace",viewMode:l,timeElapsed:Date.now()-f.transitionTime+"ms",renderCount:f.renderCount}),C(!0),j(!1),a(h=>({...h,errorOccurred:!0})),D(performance)&&performance.memory)){const h=performance.memory;S({jsHeapSizeLimit:h.jsHeapSizeLimit,totalJSHeapSize:h.totalJSHeapSize,usedJSHeapSize:h.usedJSHeapSize,timestamp:Date.now()}),console.log("[NodeView] Memory usage at WebGL error:",{usedHeap:Math.round(h.usedJSHeapSize/1048576)+"MB",totalHeap:Math.round(h.totalJSHeapSize/1048576)+"MB",limit:Math.round(h.jsHeapSizeLimit/1048576)+"MB"})}};return window.addEventListener("error",o),()=>{window.removeEventListener("error",o)}},[l,f.renderCount,f.transitionTime]);const J=()=>{s(re())};if(l!=="reading"||!e)return null;const F=`${e.character.toLowerCase()}-theme`,U=()=>e.temporalValue<=3?"past-indicator":e.temporalValue<=6?"present-indicator":"future-indicator",W=()=>e.currentContent?t.jsxs("div",{ref:i,className:`content-container ${e.currentState}`,"data-content-loaded":"true","data-node-id":e.id,"data-visit-count":e.visitCount,style:{position:"relative",visibility:"visible",display:"block"},children:[R?t.jsx("div",{className:"simple-renderer-wrapper",style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px",opacity:1,zIndex:5},children:t.jsx(de,{nodeId:e.id,onRenderComplete:x,onVisibilityChange:T},`simple-${e.id}-${e.visitCount}`)}):t.jsx(n.Suspense,{fallback:t.jsx(fe,{}),children:y&&!N?t.jsx(oe,{fallback:t.jsxs("div",{className:"fallback-content",style:{visibility:"visible",display:"block"},children:[t.jsx("p",{className:"error-notice",children:"Advanced rendering unavailable - showing basic content"}),t.jsx(H,{remarkPlugins:[()=>P],children:e.currentContent})]}),children:t.jsx("div",{style:{minHeight:"200px",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(me,{nodeId:e.id,onVisibilityChange:o=>{console.log(`[NodeView] Content visibility changed to: ${o?"visible":"hidden"}`);const c=setTimeout(()=>{i.current&&(a(m=>({...m,visibilityIssue:!o})),o||d(!0))},1e3);return()=>clearTimeout(c)}},`narramorph-${e.id}-${e.visitCount}`)})}):t.jsxs("div",{style:{visibility:"visible",display:"block",position:"relative",minHeight:"100px"},children:[t.jsxs("div",{className:"content-loading",style:{marginBottom:"10px"},children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"Preparing content..."})]}),t.jsx(H,{remarkPlugins:[()=>P],children:e.currentContent},`markdown-${e.id}-${e.visitCount}`)]})}),t.jsxs("div",{className:"debug-indicator",children:[t.jsx("div",{className:`status-dot ${g.contentLoaded?"status-green":"status-red"}`,title:"Content loaded"}),t.jsx("div",{className:`status-dot ${g.narramorphActivated?"status-green":"status-yellow"}`,title:"Narramorph active"}),t.jsx("div",{className:`status-dot ${g.errorOccurred?"status-red":"status-green"}`,title:"No errors"}),t.jsx("div",{className:`status-dot ${g.visibilityIssue?"status-red":"status-green"}`,title:"Content visible"}),t.jsx("div",{className:`status-dot ${R?"status-blue":"status-yellow"}`,title:"Simple renderer"}),t.jsx("div",{className:"status-dot status-green",title:"WebGL available"}),t.jsxs("div",{className:"debug-metrics",children:[t.jsxs("span",{title:"View transition count",children:["T:",f.transitionCount]}),t.jsxs("span",{title:"Render count",children:["R:",f.renderCount]}),z.usedJSHeapSize>0&&t.jsxs("span",{title:"Memory usage",children:["M:",Math.round(z.usedJSHeapSize/(1024*1024)),"MB"]})]})]})]}):t.jsx("div",{className:"node-loading",children:t.jsx("span",{children:"Loading narrative fragment..."})});return t.jsxs("div",{className:`node-view-container ${F}`,children:[t.jsx("div",{className:`temporal-indicator ${U()}`}),t.jsxs("div",{className:"node-header",children:[t.jsx("h1",{children:e.title}),t.jsxs("div",{className:"node-metadata",children:[t.jsx("span",{className:"node-character",children:e.character}),t.jsx("span",{className:"node-state",children:e.currentState}),t.jsxs("span",{className:"node-visits",children:["Visits: ",e.visitCount]})]})]}),t.jsx("div",{className:"node-content force-visible",style:{position:"relative"},children:W()}),t.jsx("div",{className:"node-navigation",children:t.jsx("button",{onClick:J,className:"navigation-button",children:"Return to Constellation"})}),t.jsx("div",{style:{position:"absolute",bottom:"20px",right:"20px",width:"300px",height:"300px",pointerEvents:"auto"},children:t.jsx(n.Suspense,{fallback:t.jsx(O,{}),children:t.jsx(ue,{})})}),t.jsx(n.Suspense,{fallback:t.jsx(O,{}),children:t.jsx(pe,{nodeId:e.id,strangeAttractors:e.strangeAttractors})})]},w)};export{xe as default};
//# sourceMappingURL=NodeView-BcISpU7u.js.map
