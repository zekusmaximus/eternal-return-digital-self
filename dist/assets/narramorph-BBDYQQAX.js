import{u as z,b as a,j as S}from"./react-vendor-DaKsb8LL.js";import{f as M,g as D,h as L,e as O,v as V,d as I,r as B,i as F,j as J,t as R,k,l as P,m as H}from"./constellation-D8AaAQ1t.js";import{j as C}from"./three-vendor-rJ5vKMTC.js";const G=x=>{const r=z(),[d,p]=a.useState([]),[f,N]=a.useState(!1),c=a.useRef(new Set),v=a.useRef(0),T=S(M),s=x||T,e=S(t=>s?D(t,s):null),h=S(t=>t.nodes.data),j=S(t=>s?L(t,s):0),u=S(t=>t.reader),g=a.useCallback(t=>{const n=h[t];n?(r(O({nodeId:t,character:n.character,temporalValue:n.temporalValue,attractors:n.strangeAttractors})),r(V(t)),r(I("reading")),console.log(`Navigating to node: ${t}`)):console.error(`Could not navigate to node: ${t} - node data not found`)},[r,h]),A=a.useCallback((t,n)=>{r(B({nodeId:t,targetId:n}))},[r]),w=a.useCallback(t=>{r(F(t))},[r]),y=a.useCallback((t,n)=>{r(J({nodeId:t,transformation:n}))},[r]),E=a.useMemo(()=>e?e.revealedConnections:[],[e]),o=a.useMemo(()=>{const t=(e==null?void 0:e.originalContent)||(e==null?void 0:e.currentContent);if(!t)return[];try{const n=R.calculateAllTransformations(t,e,u,h);return console.log(`[useNodeState] Master transformation integration calculated ${n.length} transformations for node ${e.id}:`,{characterBleed:n.filter(i=>i.priority==="high"&&(i.type==="emphasize"||i.type==="fragment")).length,journeyPatterns:n.filter(i=>i.priority==="high"&&i.type!=="emphasize"&&i.type!=="fragment").length,nodeRules:n.filter(i=>i.priority!=="high").length,totalTransformations:n.length,baseContentLength:t.length,usingOriginalContent:!!(e!=null&&e.originalContent)}),n}catch(n){return console.error(`[useNodeState] Error in master transformation calculation for node ${e.id}:`,n),[]}},[e,u,h]),l=a.useMemo(()=>{const t=(e==null?void 0:e.originalContent)||(e==null?void 0:e.currentContent);if(!t)return null;try{const n=R.getTransformedContent({...e,currentContent:t},u,h);if(n!==t&&o.length>0){const i=k.wrapTransformedContent(n,o);return console.log(`[useNodeState] Applied transformation wrapping for node ${e.id}:`,{originalLength:t.length,transformedLength:n.length,wrappedLength:i.length,transformationsCount:o.length,usingOriginalContent:!!(e!=null&&e.originalContent)}),i}return n}catch(n){return console.error(`[useNodeState] Error in master content transformation for node ${e.id}:`,n),t}},[e,u,h,o]);a.useEffect(()=>{if(!e||o.length===0)return;JSON.stringify(d)!==JSON.stringify(o)&&(p(o),N(!0))},[e,o,d]),a.useEffect(()=>{if(f){const t=setTimeout(()=>{N(!1)},2e3);return()=>clearTimeout(t)}},[f]),a.useEffect(()=>{if(!e||!s)return;const t=Date.now();if(t-v.current<500)return;if(e.currentContent&&(e.currentContent.includes("data-transform-type")||e.currentContent.includes("narramorph-")||e.currentContent.includes("[TransformationService]")||e.currentContent.includes("recursive loop detected")||e.currentContent.includes("temporal displacement"))){console.log(`[useNodeState] Content already transformed for node ${s}, skipping legacy transformation dispatch`);return}const n=`${s}-${e.visitCount}`;if(c.current.has(n)){console.log(`[useNodeState] Skipping already applied legacy transformations for ${n}`);return}if(console.log(`[useNodeState] Applying legacy transformation dispatch for node ${s} (visitCount: ${e.visitCount})`),v.current=t,c.current.add(n),c.current.size>50){const b=Array.from(c.current).slice(-25);c.current.clear(),b.forEach($=>c.current.add($))}if(r(P({nodeId:s,readerState:u})),e.visitCount===1&&y(s,{condition:{visitCount:1},transformations:[{type:"emphasize",selector:"first-paragraph",emphasis:"italic"}]}),e.visitCount>=2&&e.visitCount<=3){const i=k.createTransformationsFromPatterns(u,e);if(i.length>0&&i.length<=2){const b={condition:{visitCount:e.visitCount},transformations:i.slice(0,1)};y(s,b)}}r(H({nodeId:s,readerState:u}))},[s,e,r,y,u]);const m=a.useCallback(t=>e?R.evaluateCondition(t,u,e):!1,[e,u]);return{node:e,navigateTo:g,revealNodeConnection:A,engageWithAttractor:w,applyNodeTransformation:y,evaluateCondition:m,neighbors:E,revisitCount:j,transformedContent:l,newlyTransformed:f,appliedTransformations:d}},Q=({children:x,transformations:r,isNewlyTransformed:d,nodeId:p})=>{const f=a.useRef(null),N=a.useRef(null),[c,v]=a.useState("idle"),[T,s]=a.useState(r.length),[e,h]=a.useState(0),[j,u]=a.useState(null),[g,A]=a.useState(!0);a.useEffect(()=>{if(e<3){const o=setTimeout(()=>{h(l=>l+1),console.log(`[AnimationContainer] Forced re-render for node: ${p}, attempt: ${e+1}`)},100);return()=>clearTimeout(o)}},[p,e]),a.useEffect(()=>{if(d){v("entering");const o=setTimeout(()=>{v("active")},1e3);return()=>clearTimeout(o)}},[d,r]),a.useEffect(()=>{v("idle"),s(r.length),console.log(`[AnimationContainer] Node changed to: ${p}, transformations: ${r.length}`)},[p,r.length]),a.useLayoutEffect(()=>{if(!f.current)return;const o=()=>{if(!f.current)return;const n=window.getComputedStyle(f.current),i=f.current.getBoundingClientRect(),b={width:i.width,height:i.height,visibility:n.visibility,display:n.display,opacity:n.opacity,position:n.position,zIndex:n.zIndex,overflow:n.overflow};u(b);const $=i.width>0&&i.height>0&&n.visibility!=="hidden"&&n.display!=="none"&&parseFloat(n.opacity)>0;A($),g!==$&&console.log(`[AnimationContainer] Content visibility changed to: ${$?"visible":"hidden"}`,{nodeId:p,transformations:r.length,animationState:c,measurements:b})};o();const l=setTimeout(o,1100);let m=null;const t=new MutationObserver(n=>{n.length>2&&console.log(`[AnimationContainer] DOM mutations detected: ${n.length}`),m&&clearTimeout(m),m=window.setTimeout(()=>{o(),m=null},500)});return t.observe(f.current,{attributes:!0,childList:!0,subtree:!1}),()=>{clearTimeout(l),t.disconnect()}},[p,r,c,g]);const w=()=>{if(c==="idle")return"";const o=r.some(t=>t.type==="replace"),l=r.some(t=>t.type==="emphasize"),m=r.some(t=>t.type==="expand");return c==="entering"?o?"narramorph-container-replace-active":l?"narramorph-container-emphasis-active":m?"narramorph-container-expand-active":"narramorph-container-transform-active":"narramorph-container-active"},y=()=>{if(r.length===0)return"";const o={};r.forEach(m=>{o[m.type]=(o[m.type]||0)+1});const l=[];return o.replace&&l.push(`${o.replace} replacements`),o.emphasize&&l.push(`${o.emphasize} emphasis`),o.expand&&l.push(`${o.expand} expansions`),o.fragment&&l.push(`${o.fragment} fragmentations`),o.metaComment&&l.push(`${o.metaComment} comments`),l.join(", ")},E=r.length!==T;return a.useEffect(()=>{d&&console.log(`[AnimationContainer] Animation started for node: ${p}`,{transformations:r.length,animationState:c,contentVisible:g})},[d,p,r.length,c,g]),C.jsxs("div",{ref:f,className:`narramorph-animation-container ${w()}`,"data-transformation-count":r.length,"data-newly-transformed":d,"data-animation-state":c,"data-visible":g,"data-render-attempt":e,style:{overflow:"visible",minHeight:"150px",position:"relative",visibility:"visible",display:"block",opacity:1},children:[r.length>0&&C.jsxs("div",{className:`narramorph-transformation-indicator ${d?"active":""}`,title:y(),children:[C.jsx("span",{className:"transformation-count",children:r.length}),E&&C.jsxs("span",{className:"transformation-change-indicator",children:[r.length>T?"+":"",r.length-T]})]}),C.jsx("div",{ref:N,className:"narramorph-animation-content",style:{position:"relative",visibility:"visible",display:"block",opacity:1,minHeight:"100px"},children:e===0?C.jsx("div",{className:"animation-placeholder",style:{padding:"20px",textAlign:"center"},children:C.jsx("p",{children:"Preparing narrative..."})}):x}),!1]})};export{Q as T,G as u};
//# sourceMappingURL=narramorph-BBDYQQAX.js.map
