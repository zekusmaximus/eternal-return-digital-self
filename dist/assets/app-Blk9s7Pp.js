const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ConstellationView-B60f226z.js","assets/three-vendor-rJ5vKMTC.js","assets/react-vendor-DaKsb8LL.js","assets/constellation-CzSJAdlk.js","assets/node-view-XdiLjT_l.js","assets/node-view-CrwFC8Ay.css","assets/ConstellationView-oNlteI-u.css","assets/NodeView-6vaqF1dp.js","assets/narramorph-Cw55D6_f.js","assets/narramorph-DivzNTyX.css","assets/NodeView-C1rEK9p3.css","assets/Onboarding-CwvHfpUY.js","assets/onboarding-B7DM0J75.js","assets/onboarding-DUJh0eI2.css"])))=>i.map(i=>d[i]);
var U=Object.defineProperty;var z=(o,e,t)=>e in o?U(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var m=(o,e,t)=>z(o,typeof e!="symbol"?e+"":e,t);import{S as q,j as u,_ as W}from"./three-vendor-rJ5vKMTC.js";import{b as d,g as H,p as B,c as F,k as K,F as J,l as X,P as Y,m as Q,n as Z,o as ee,q as te,j as ne}from"./react-vendor-DaKsb8LL.js";import{u as oe}from"./node-view-XdiLjT_l.js";import{o as se,p as re,q as ie,w as ae,x as ce,y as le}from"./constellation-CzSJAdlk.js";const h=class h{constructor(){m(this,"contexts",new Map);m(this,"activeContextId",null);m(this,"contextCounter",0);m(this,"contextLossEvents",0);m(this,"maxAllowedContexts",1);m(this,"diagnosticsEnabled",!1);m(this,"memoryCheckInterval",null);m(this,"isInitialized",!1);this.isInitialized||(this.startMemoryMonitoring(),console.log("[WebGLContextManager] Initialized"),this.isInitialized=!0,window.addEventListener("beforeunload",()=>{this.disposeAllContexts()}))}static getInstance(){return h.instance||(h.instance=new h),h.instance}registerContext(e,t,n=1,i=()=>{},a=()=>{}){let r=null;for(const[c,f]of this.contexts.entries())if(f.type===t){r=c;break}r&&(console.log(`[WebGLContextManager] Found existing ${t} context, disposing it first`),this.disposeContext(r));const s=`webgl-context-${++this.contextCounter}-${t}-${Date.now()}`;console.log(`[WebGLContextManager] Registering new ${t} WebGL context: ${s}`),e.outputColorSpace=q,e.shadowMap.enabled=!1,this.contexts.set(s,{id:s,type:t,gl:e,active:!0,createdAt:Date.now(),priority:n,suspend:i,resume:a,memoryUsage:{geometries:0,textures:0}}),this.enforceContextLimits(),this.updateContextMemoryUsage(s);const l=e.domElement,g=c=>{c.preventDefault(),this.handleContextLoss(s,c)},p=()=>{this.handleContextRestoration(s)};return l.removeEventListener("webglcontextlost",g),l.removeEventListener("webglcontextrestored",p),l.addEventListener("webglcontextlost",g),l.addEventListener("webglcontextrestored",p),s}disposeContext(e){const t=this.contexts.get(e);if(!t)return console.warn(`[WebGLContextManager] Attempted to dispose unknown context: ${e}`),!1;console.log(`[WebGLContextManager] Disposing ${t.type} WebGL context: ${e}`);try{return t.gl.dispose(),this.contexts.delete(e),this.activeContextId===e&&(this.activeContextId=null),this.enforceContextLimits(),!0}catch(n){return console.error(`[WebGLContextManager] Error disposing context ${e}:`,n),!1}}suspendContext(e){const t=this.contexts.get(e);if(!t)return!1;if(t.active){console.log(`[WebGLContextManager] Suspending ${t.type} WebGL context: ${e}`),t.active=!1,t.suspend(),t.gl.setPixelRatio(.5),t.gl.setSize(1,1,!1);try{const n=t.gl.getContext();n&&"UNPACK_COLORSPACE_CONVERSION_WEBGL"in n&&n.hint(n.GENERATE_MIPMAP_HINT,n.FASTEST)}catch{}return!0}return!1}resumeContext(e){const t=this.contexts.get(e);return t?t.active?!1:(console.log(`[WebGLContextManager] Resuming ${t.type} WebGL context: ${e}`),t.active=!0,t.resume(),this.activeContextId=e,this.enforceContextLimits(),!0):!1}isContextTypeActive(e){for(const[,t]of this.contexts.entries())if(t.type===e&&t.active)return!0;return!1}handleContextLoss(e,t){const n=this.contexts.get(e);n&&(this.contextLossEvents++,console.error(`[WebGLContextManager] WebGL context loss detected for ${n.type} context: ${e}`),console.error(`[WebGLContextManager] Total context loss events: ${this.contextLossEvents}`),t.preventDefault(),n.active=!1,this.emergencyResourceRecovery(),window.dispatchEvent(new CustomEvent("webgl-context-loss",{detail:{contextId:e,type:n.type}})))}handleContextRestoration(e){const t=this.contexts.get(e);t&&(console.log(`[WebGLContextManager] WebGL context restored for ${t.type} context: ${e}`),t.active=!0,window.dispatchEvent(new CustomEvent("webgl-context-restored",{detail:{contextId:e,type:t.type}})))}enforceContextLimits(){const e=Array.from(this.contexts.values()).filter(t=>t.active).sort((t,n)=>n.priority-t.priority);if(e.length>this.maxAllowedContexts){console.log(`[WebGLContextManager] Too many active contexts (${e.length}/${this.maxAllowedContexts}), suspending lower priority contexts`);for(let t=this.maxAllowedContexts;t<e.length;t++)this.suspendContext(e[t].id)}}emergencyResourceRecovery(){if(console.log("[WebGLContextManager] Performing emergency resource recovery"),window.gc)try{window.gc()}catch{}const e=Array.from(this.contexts.values()).sort((t,n)=>n.priority-t.priority);if(e.length>0)for(let t=1;t<e.length;t++)this.suspendContext(e[t].id)}startMemoryMonitoring(){this.memoryCheckInterval&&clearInterval(this.memoryCheckInterval),this.memoryCheckInterval=setInterval(()=>{if(!this.diagnosticsEnabled)return;for(const[t]of this.contexts.entries())this.updateContextMemoryUsage(t);const e={geometries:0,textures:0,contexts:this.contexts.size,active:Array.from(this.contexts.values()).filter(t=>t.active).length};for(const t of this.contexts.values())t.memoryUsage&&(e.geometries+=t.memoryUsage.geometries,e.textures+=t.memoryUsage.textures);e.contexts>0&&this.diagnosticsEnabled&&console.log("[WebGLContextManager] Memory usage:",e)},3e4)}updateContextMemoryUsage(e){const t=this.contexts.get(e);if(t)try{const n=t.gl;n&&n.info&&(t.memoryUsage={geometries:n.info.memory.geometries,textures:n.info.memory.textures})}catch{}}getActiveContext(){const e=Array.from(this.contexts.values()).filter(t=>t.active).sort((t,n)=>n.priority-t.priority);return e.length>0?e[0]:null}disposeAllContexts(){console.log(`[WebGLContextManager] Disposing all WebGL contexts (${this.contexts.size})`);for(const[e,t]of this.contexts.entries())try{t.gl.dispose()}catch(n){console.error(`[WebGLContextManager] Error disposing context ${e}:`,n)}this.contexts.clear(),this.activeContextId=null,this.memoryCheckInterval&&(clearInterval(this.memoryCheckInterval),this.memoryCheckInterval=null)}getRendererFromRef(e){return e.current}checkWebGLSupport(){var t;const e={webgl:!1,webgl2:!1,extensions:[],maxTextures:0,vendor:void 0,renderer:void 0,isLowEndDevice:!1};try{const n=document.createElement("canvas"),i=n.getContext("webgl");if(e.webgl=!!i,i){const r=i.getSupportedExtensions();e.extensions=r||[],e.maxTextures=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS);const s=i.getExtension("WEBGL_debug_renderer_info");if(s){e.vendor=i.getParameter(s.UNMASKED_VENDOR_WEBGL),e.renderer=i.getParameter(s.UNMASKED_RENDERER_WEBGL);const l=((t=e.renderer)==null?void 0:t.toLowerCase())||"";e.isLowEndDevice=l.includes("intel")||l.includes("hd graphics")||l.includes("mobile")||!e.extensions.includes("OES_texture_float")}}const a=n.getContext("webgl2");e.webgl2=!!a,n.remove()}catch(n){console.error("[WebGLContextManager] Error checking WebGL support:",n)}return e}};m(h,"instance");let R=h;const D=R.getInstance(),x=class x{constructor(){m(this,"state",{activeView:"loading",previousView:null,isTransitioning:!1,transitionStartTime:0,uniqueViewKey:"view-0",transitionCount:0});m(this,"transitionCallbacks",{});m(this,"transitionTimeout",null);m(this,"viewComponents",new Map);m(this,"transitionDuration",300);m(this,"lastMountTimes",new Map);m(this,"mountThrottleMs",500);console.log("[ViewManager] Initialized"),this.viewComponents.set("constellation",!1),this.viewComponents.set("reading",!1),this.viewComponents.set("loading",!1)}static getInstance(){return x.instance||(x.instance=new x),x.instance}getViewState(){return{...this.state}}setActiveView(e){if(e===this.state.activeView&&!this.state.isTransitioning){console.log(`[ViewManager] View ${e} is already active, ignoring`);return}console.log(`[ViewManager] Transitioning from ${this.state.activeView} to ${e}`),this.transitionTimeout&&(clearTimeout(this.transitionTimeout),this.transitionTimeout=null);const t=this.state.activeView,n=t!==e;this.state={...this.state,previousView:t,activeView:e,isTransitioning:!0,transitionStartTime:Date.now(),transitionCount:this.state.transitionCount+1,uniqueViewKey:n?`view-${Date.now()}-${crypto.randomUUID().slice(0,8)}`:this.state.uniqueViewKey},this.transitionCallbacks.onBeforeTransition&&this.transitionCallbacks.onBeforeTransition(t,e),this.manageWebGLContexts(t,e),this.transitionTimeout=setTimeout(()=>{this.state={...this.state,isTransitioning:!1},this.transitionCallbacks.onAfterTransition&&this.transitionCallbacks.onAfterTransition(t,e),console.log(`[ViewManager] Transition to ${e} complete (${Date.now()-this.state.transitionStartTime}ms)`),this.transitionTimeout=null},this.transitionDuration)}registerTransitionCallbacks(e){this.transitionCallbacks={...e}}registerViewMount(e,t){const n=Date.now(),i=this.lastMountTimes.get(e)||0,a=n-i;if(!t&&a<this.mountThrottleMs){console.log(`[ViewManager] Ignoring rapid unmount of ${e} (${a}ms after mount)`);return}t&&this.lastMountTimes.set(e,n),this.viewComponents.set(e,t),console.log(`[ViewManager] View ${e} ${t?"mounted":"unmounted"}`);let r=0;const s=[];this.viewComponents.forEach((l,g)=>{l&&(r++,s.push(g))}),r>1&&s.includes("constellation")&&s.includes("reading")&&console.warn("[ViewManager] Multiple main views mounted simultaneously:",s.join(", "))}isViewActive(e){return this.state.activeView===e}getUniqueViewKey(){return this.state.uniqueViewKey}manageWebGLContexts(e,t){e==="constellation"&&t==="reading"&&D.isContextTypeActive("constellation")&&console.log("[ViewManager] Suspending constellation WebGL context during transition to reading view"),e==="reading"&&t==="constellation"&&console.log("[ViewManager] Will resume constellation WebGL context")}getViewTransitionMetrics(){return{transitionCount:this.state.transitionCount,averageTransitionTime:0,problematicTransitions:0}}};m(x,"instance");let T=x;const b=T.getInstance();function S(o){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?S=function(t){return typeof t}:S=function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},S(o)}function ue(o,e){if(!(o instanceof e))throw new TypeError("Cannot call a class as a function")}function fe(o,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(o,n.key,n)}}function me(o,e,t){return e&&fe(o.prototype,e),o}function de(o,e){return e&&(S(e)==="object"||typeof e=="function")?e:E(o)}function A(o){return A=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},A(o)}function E(o){if(o===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return o}function ge(o,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");o.prototype=Object.create(e&&e.prototype,{constructor:{value:o,writable:!0,configurable:!0}}),e&&G(o,e)}function G(o,e){return G=Object.setPrototypeOf||function(n,i){return n.__proto__=i,n},G(o,e)}function L(o,e,t){return e in o?Object.defineProperty(o,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):o[e]=t,o}var O=function(o){ge(e,o);function e(){var t,n;ue(this,e);for(var i=arguments.length,a=new Array(i),r=0;r<i;r++)a[r]=arguments[r];return n=de(this,(t=A(e)).call.apply(t,[this].concat(a))),L(E(n),"state",{bootstrapped:!1}),L(E(n),"_unsubscribe",void 0),L(E(n),"handlePersistorState",function(){var s=n.props.persistor,l=s.getState(),g=l.bootstrapped;g&&(n.props.onBeforeLift?Promise.resolve(n.props.onBeforeLift()).finally(function(){return n.setState({bootstrapped:!0})}):n.setState({bootstrapped:!0}),n._unsubscribe&&n._unsubscribe())}),n}return me(e,[{key:"componentDidMount",value:function(){this._unsubscribe=this.props.persistor.subscribe(this.handlePersistorState),this.handlePersistorState()}},{key:"componentWillUnmount",value:function(){this._unsubscribe&&this._unsubscribe()}},{key:"render",value:function(){return typeof this.props.children=="function"?this.props.children(this.state.bootstrapped):this.state.bootstrapped?this.props.children:this.props.loading}}]),e}(d.PureComponent);L(O,"defaultProps",{children:null,loading:null});var v={},y={},C={},P;function pe(){if(P)return C;P=1,C.__esModule=!0,C.default=i;function o(a){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?o=function(s){return typeof s}:o=function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},o(a)}function e(){}var t={getItem:e,setItem:e,removeItem:e};function n(a){if((typeof self>"u"?"undefined":o(self))!=="object"||!(a in self))return!1;try{var r=self[a],s="redux-persist ".concat(a," test");r.setItem(s,"test"),r.getItem(s),r.removeItem(s)}catch{return!1}return!0}function i(a){var r="".concat(a,"Storage");return n(r)?self[r]:t}return C}var V;function he(){if(V)return y;V=1,y.__esModule=!0,y.default=t;var o=e(pe());function e(n){return n&&n.__esModule?n:{default:n}}function t(n){var i=(0,o.default)(n);return{getItem:function(r){return new Promise(function(s,l){s(i.getItem(r))})},setItem:function(r,s){return new Promise(function(l,g){l(i.setItem(r,s))})},removeItem:function(r){return new Promise(function(s,l){s(i.removeItem(r))})}}}return y}var $;function xe(){if($)return v;$=1,v.__esModule=!0,v.default=void 0;var o=e(he());function e(n){return n&&n.__esModule?n:{default:n}}var t=(0,o.default)("local");return v.default=t,v}var ve=xe();const we=H(ve),be={key:"eternal-return",version:1,storage:we,blacklist:["interface"]},ye=F({nodes:ae,reader:ie,interface:re}),Ce=K(be,ye),j=se({reducer:Ce,middleware:o=>o({serializableCheck:{ignoredActions:[J,X,Y,Q,Z,ee]}}),devTools:typeof window<"u"&&"process"in window&&typeof window.process.env.NODE_ENV<"u"&&window.process.env.NODE_ENV!=="production"}),Se=B(j);function Ee(o){return"memory"in o}const Le=d.lazy(()=>W(()=>import("./ConstellationView-B60f226z.js"),__vite__mapDeps([0,1,2,3,4,5,6]))),_e=d.lazy(()=>W(()=>import("./NodeView-6vaqF1dp.js"),__vite__mapDeps([7,1,2,8,3,9,4,5,10]))),Me=d.lazy(()=>W(()=>import("./Onboarding-CwvHfpUY.js"),__vite__mapDeps([11,1,2,12,13]))),Re=()=>u.jsxs("div",{className:"loading-container",children:[u.jsx("div",{className:"loading-spinner"}),u.jsx("p",{children:"Loading view..."})]});function Te(){const o=oe(),e=ne(ce),[t,n]=d.useState([]),i=d.useRef(e),[a,r]=d.useState([]),s=d.useRef(null),l=d.useRef([]);return d.useEffect(()=>{l.current=a},[a]),d.useEffect(()=>{if(!s.current){console.log("[App] Starting performance monitoring");let g=0;const p=5e3,c=()=>{var w;const f=performance.now();if(f-g>p){g=f;const _=l.current,N=1e3/(f-(((w=_[_.length-1])==null?void 0:w.timestamp)||f-1e3));let I;Ee(performance)&&performance.memory&&(I={jsHeapSizeLimit:performance.memory.jsHeapSizeLimit,totalJSHeapSize:performance.memory.totalJSHeapSize,usedJSHeapSize:performance.memory.usedJSHeapSize}),r(k=>{const M=[...k,{timestamp:f,fps:Math.min(60,N),memory:I}];return M.length>10?M.slice(-10):M})}s.current=requestAnimationFrame(c)};s.current=requestAnimationFrame(c)}return()=>{s.current&&(cancelAnimationFrame(s.current),s.current=null)}},[]),d.useEffect(()=>{i.current!==e&&(b.setActiveView(e),console.log(`[App] View transition: ${i.current} -> ${e}`),n(g=>{const p=[...g,{from:i.current,to:e,timestamp:Date.now()}],c=l.current;if(c.length>0){const f=c[c.length-1];console.log("[App] Performance at transition:",{fps:f.fps.toFixed(1),memory:f.memory?{used:(f.memory.usedJSHeapSize/(1024*1024)).toFixed(1)+"MB",total:(f.memory.totalJSHeapSize/(1024*1024)).toFixed(1)+"MB"}:"unavailable",transitions:p.length})}return p}),i.current=e)},[e]),d.useEffect(()=>{console.log("[App] Initializing application"),o(le())},[o]),d.useEffect(()=>{const g=c=>{c.message&&(c.message.includes("WebGL context lost")||c.message.includes("THREE.WebGLRenderer"))&&console.error("[App] WebGL context loss detected at app level!",{message:c.message,viewMode:e,transitions:t.length,timestamp:Date.now()})},p=c=>{const{contextId:f,type:w}=c.detail;console.error("[App] WebGL context loss event received from WebGLContextManager",{contextId:f,type:w,viewMode:e,timestamp:Date.now()}),D.checkWebGLSupport().isLowEndDevice&&console.warn("[App] Device seems to be low-end, may need to disable visual effects")};return window.addEventListener("error",g),window.addEventListener("webgl-context-loss",p),b.registerTransitionCallbacks({onBeforeTransition:(c,f)=>{console.log(`[App] ViewManager transition started: ${c} → ${f}`)},onAfterTransition:(c,f)=>{console.log(`[App] ViewManager transition completed: ${c} → ${f}`)}}),()=>{window.removeEventListener("error",g),window.removeEventListener("webgl-context-loss",p),console.log("[App] Unmounting")}},[e,t.length]),u.jsxs("div",{className:"app-container",children:[u.jsx("header",{className:"app-header",children:u.jsx("h1",{className:"app-title",children:"The Eternal Return of the Digital Self"})}),u.jsxs("div",{className:"stars-container",children:[u.jsx("div",{className:"stars"}),u.jsx("div",{className:"stars2"}),u.jsx("div",{className:"stars3"})]}),u.jsx(d.Suspense,{fallback:u.jsx(Re,{}),children:e==="constellation"?u.jsx(Le,{},`constellation-${b.getUniqueViewKey()}`):u.jsx(_e,{},`node-${b.getUniqueViewKey()}`)}),u.jsx(d.Suspense,{fallback:u.jsx("div",{}),children:u.jsx(Me,{})}),!1]})}function Ae(){return u.jsx(te,{store:j,children:u.jsx(O,{loading:u.jsx("div",{children:"Loading..."}),persistor:Se,children:u.jsx(Te,{})})})}const $e=Object.freeze(Object.defineProperty({__proto__:null,default:Ae},Symbol.toStringTag,{value:"Module"}));export{$e as a,b as v,D as w};
//# sourceMappingURL=app-Blk9s7Pp.js.map
