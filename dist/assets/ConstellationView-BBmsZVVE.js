const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ThreeJSComponents-DD1dFE9Y.js","assets/three-vendor-rJ5vKMTC.js","assets/react-vendor-DaKsb8LL.js","assets/node-view-GFMNrUCl.js","assets/constellation-D8AaAQ1t.js","assets/node-view-CrwFC8Ay.css"])))=>i.map(i=>d[i]);
var z=Object.defineProperty;var D=(r,e,a)=>e in r?z(r,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[e]=a;var d=(r,e,a)=>D(r,typeof e!="symbol"?e+"":e,a);import{j as n,_}from"./three-vendor-rJ5vKMTC.js";import{u as $,b as s,j as g}from"./react-vendor-DaKsb8LL.js";import{y as q,z as B,A as H,a as J,s as Y,d as F}from"./constellation-D8AaAQ1t.js";import{v as G,w as T}from"./app-e3lbHxA-.js";import"./node-view-GFMNrUCl.js";const u=class u{constructor(){d(this,"basePositions",{});d(this,"currentPositions",{});d(this,"lastUpdateTime",0);d(this,"updateCallbacks",new Set);d(this,"isUpdating",!1)}static getInstance(){return u.instance||(u.instance=new u),u.instance}setBasePositions(e){this.basePositions={...e},this.currentPositions={...e}}updatePositions(e,a=!1){return this.isUpdating?this.currentPositions:(this.isUpdating=!0,e-this.lastUpdateTime>=.15&&(this.lastUpdateTime=e,Object.keys(this.basePositions).forEach(i=>{const o=this.basePositions[i];if(o)if(a)this.currentPositions[i]=[...o];else{const m=Math.sin(o[0]*.1+e*.02)*.01,f=Math.sin((o[1]+100)*.1+e*.02)*.01,b=Math.sin((o[2]+200)*.1+e*.02)*.01,p=.01,C=Math.min(Math.abs(m),p)*Math.sign(m),c=Math.min(Math.abs(f),p)*Math.sign(f),x=Math.min(Math.abs(b),p)*Math.sign(b),P=[o[0]+C,o[1]+c,o[2]+x];this.currentPositions[i]=P}}),this.updateCallbacks.forEach(i=>{try{i({...this.currentPositions})}catch(o){console.error("Error in position update callback:",o)}})),this.isUpdating=!1,this.currentPositions)}getCurrentPositions(){return{...this.currentPositions}}subscribeToUpdates(e){return this.updateCallbacks.add(e),()=>this.updateCallbacks.delete(e)}reset(){this.basePositions={},this.currentPositions={},this.lastUpdateTime=0,this.updateCallbacks.clear(),this.isUpdating=!1}};d(u,"instance");let N=u;const K=s.lazy(()=>_(()=>import("./ThreeJSComponents-DD1dFE9Y.js"),__vite__mapDeps([0,1,2,3,4,5]))),Q=()=>n.jsxs("div",{className:"constellation-loading",children:[n.jsx("div",{className:"loading-spinner"}),n.jsx("p",{children:"Generating constellation view..."})]}),X=({onDismiss:r})=>n.jsxs("div",{className:"webgl-error-container",children:[n.jsx("div",{className:"webgl-error-header",children:"WebGL Error Detected"}),n.jsx("div",{className:"webgl-error-message",children:"A graphics rendering error occurred. This may affect the constellation display. You can continue using the application in text-only mode."}),n.jsx("div",{className:"webgl-error-actions",children:n.jsx("button",{className:"webgl-error-action",onClick:r,children:"Continue in Text Mode"})})]}),ie=()=>{const r=$(),[e,a]=s.useState(null),l=g(q),i=g(B),o=g(t=>t.nodes.triumvirateActive),m=s.useMemo(()=>["arch-discovery","algo-awakening","human-discovery"],[]),f=g(H),b=g(J),p=g(Y),C=s.useRef(null),c=s.useRef(null);s.useEffect(()=>(console.log("[ConstellationView] Component mounted"),G.registerViewMount("constellation",!0),()=>{console.log("[ConstellationView] Component unmounting"),G.registerViewMount("constellation",!1),c.current&&(console.log(`[ConstellationView] Unmounting, disposing WebGL context: ${c.current}`),T.disposeContext(c.current),c.current=null)}),[]);const x=s.useMemo(()=>i.map(t=>({source:t.start,target:t.end})),[i]),P=s.useMemo(()=>i.map(t=>({source:t.start,target:t.end})),[i]),M=s.useRef(N.getInstance()),[j,U]=s.useState({}),I=s.useMemo(()=>{console.log("Calculating positions for nodes:",l.length);const t={};return l.length===0?(console.warn("No nodes to position"),t):(l.forEach((h,E)=>{const W=l.length,w=15,L=2/W,A=Math.PI*(3-Math.sqrt(5)),v=E*L-1+L/2,y=Math.sqrt(1-v*v),V=E*A,S=Math.cos(V)*y*w,O=Math.sin(V)*y*w;t[h.id]=[S,v*w,O]}),M.current.setBasePositions(t),t)},[l]);s.useEffect(()=>{const t=M.current.subscribeToUpdates(h=>{U(h)});return()=>{t()}},[]);const k=Object.keys(j).length>0?j:I,R=s.useCallback(t=>{if(c.current){console.log(`[ConstellationView] Context already registered: ${c.current}`);return}const h=T.registerContext(t,"constellation",2,()=>{console.log("[ConstellationView] Suspending WebGL rendering")},()=>{console.log("[ConstellationView] Resuming WebGL rendering")});c.current=h,console.log(`[ConstellationView] Registered WebGL context: ${h}`)},[]);return n.jsxs("div",{className:"constellation-container",children:[n.jsx(s.Suspense,{fallback:n.jsx(Q,{}),children:n.jsx(K,{nodes:l,nodePositions:k,connections:P,mappedConnections:x,instancedMeshRef:C,isInitialChoicePhase:f,triumvirateActive:o,triumvirateNodes:m,onWebGLContextCreated:R,onWebGLError:t=>{console.error("[ConstellationView] WebGL error reported:",t),a(t)},positionSynchronizer:M.current,selectedNodeId:b,hoveredNodeId:p,isMinimap:!1})}),e&&n.jsx(X,{onDismiss:()=>{r(F("reading")),a(null)}})]})};export{ie as default};
//# sourceMappingURL=ConstellationView-BBmsZVVE.js.map
