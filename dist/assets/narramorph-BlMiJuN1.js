const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/constellation-CzSJAdlk.js","assets/three-vendor-rJ5vKMTC.js","assets/react-vendor-DaKsb8LL.js"])))=>i.map(i=>d[i]);
import{_ as I,j as T}from"./three-vendor-rJ5vKMTC.js";import{u as M,b as o,j as A}from"./react-vendor-DaKsb8LL.js";import{f as k,g as O,h as _,e as D,v as L,d as q,r as P,i as B,j as F,t as j,k as V,l as J,m as K,u as H}from"./constellation-CzSJAdlk.js";const Z=l=>{const e=M(),[u,m]=o.useState([]),[C,N]=o.useState(!1),p=o.useRef(new Set),$=o.useRef(0),S=A(k),c=l||S,t=A(n=>c?O(n,c):null),g=A(n=>n.nodes.data),z=A(n=>c?_(n,c):0),s=A(n=>n.reader),y=o.useCallback(n=>{const r=g[n];r?(e(D({nodeId:n,character:r.character,temporalValue:r.temporalValue,attractors:r.strangeAttractors})),e(L(n)),e(q("reading")),console.log(`Navigating to node: ${n}`)):console.error(`Could not navigate to node: ${n} - node data not found`)},[e,g]),x=o.useCallback((n,r)=>{e(P({nodeId:n,targetId:r}))},[e]),w=o.useCallback(n=>{e(B(n))},[e]),E=o.useCallback((n,r)=>{e(F({nodeId:n,transformation:r}))},[e]),R=o.useMemo(()=>t?t.revealedConnections:[],[t]),a=o.useMemo(()=>{const n=(t==null?void 0:t.originalContent)||(t==null?void 0:t.currentContent);if(!n)return[];try{const r=j.calculateAllTransformations(n,t,s,g);return console.log(`[useNodeState] Master transformation integration calculated ${r.length} transformations for node ${t.id}:`,{characterBleed:r.filter(i=>i.priority==="high"&&(i.type==="emphasize"||i.type==="fragment")).length,journeyPatterns:r.filter(i=>i.priority==="high"&&i.type!=="emphasize"&&i.type!=="fragment").length,nodeRules:r.filter(i=>i.priority!=="high").length,totalTransformations:r.length,baseContentLength:n.length,usingOriginalContent:!!(t!=null&&t.originalContent)}),r}catch(r){return console.error(`[useNodeState] Error in master transformation calculation for node ${t.id}:`,r),[]}},[t,s,g]),d=o.useMemo(()=>{const n=(t==null?void 0:t.originalContent)||(t==null?void 0:t.currentContent);if(!n)return null;try{const r=j.getTransformedContent({...t,currentContent:n},s,g);if(r!==n&&a.length>0){const i=V.wrapTransformedContent(r,a);return console.log(`[useNodeState] Applied transformation wrapping for node ${t.id}:`,{originalLength:n.length,transformedLength:r.length,wrappedLength:i.length,transformationsCount:a.length,usingOriginalContent:!!(t!=null&&t.originalContent)}),i}return r}catch(r){return console.error(`[useNodeState] Error in master content transformation for node ${t.id}:`,r),n}},[t,s,g,a]);o.useEffect(()=>{if(!t||a.length===0)return;JSON.stringify(u)!==JSON.stringify(a)&&(m(a),N(!0))},[t,a,u]),o.useEffect(()=>{if(C){const n=setTimeout(()=>{N(!1)},2e3);return()=>clearTimeout(n)}},[C]),o.useEffect(()=>{if(!t||!c)return;const n=Date.now();if(n-$.current<500)return;if(t.currentContent&&(t.currentContent.includes("data-transform-type")||t.currentContent.includes("narramorph-")||t.currentContent.includes("[TransformationService]")||t.currentContent.includes("recursive loop detected")||t.currentContent.includes("temporal displacement"))){console.log(`[useNodeState] Content already transformed for node ${c}, skipping legacy transformation dispatch`);return}const r=`${c}-${t.visitCount}`;if(p.current.has(r)){console.log(`[useNodeState] Skipping already applied legacy transformations for ${r}`);return}if(console.log(`[useNodeState] Applying legacy transformation dispatch for node ${c} (visitCount: ${t.visitCount})`),$.current=n,p.current.add(r),p.current.size>50){const v=Array.from(p.current).slice(-25);p.current.clear(),v.forEach(h=>p.current.add(h))}if(e(J({nodeId:c,readerState:s})),t.visitCount===1&&E(c,{condition:{visitCount:1},transformations:[{type:"emphasize",selector:"first-paragraph",emphasis:"italic"}]}),t.visitCount>=2&&t.visitCount<=3){const i=V.createTransformationsFromPatterns(s,t);if(i.length>0&&i.length<=2){const v={condition:{visitCount:t.visitCount},transformations:i.slice(0,1)};E(c,v)}}e(K({nodeId:c,readerState:s}))},[c,t,e,E,s]),o.useEffect(()=>{var v;if(!t||!c||!t.enhancedContent||!(t.enhancedContent.base&&t.enhancedContent.base.length>0||Object.keys(t.enhancedContent.visitCountVariants).length>0||Object.keys(t.enhancedContent.sectionVariants).length>0))return;const i={visitCount:Math.min(t.visitCount,5),lastVisitedCharacter:s.path.sequence.length>1?(v=g[s.path.sequence[s.path.sequence.length-2]])==null?void 0:v.character:void 0,journeyPattern:s.path.sequence.slice(-5),characterSequence:s.path.sequence.slice(-5).map(h=>{var b;return(b=g[h])==null?void 0:b.character}).filter(h=>h!==void 0),attractorsEngaged:s.path.attractorsEngaged||{},recursiveAwareness:s.path.sequence.length>0?1-new Set(s.path.sequence).size/s.path.sequence.length:0};I(async()=>{const{contentVariantService:h}=await import("./constellation-CzSJAdlk.js").then(b=>b.I);return{contentVariantService:h}},__vite__mapDeps([0,1,2])).then(({contentVariantService:h})=>{const b=h.selectContentVariant(t.enhancedContent,i);b!==t.currentContent&&e(H({nodeId:c,context:i,selectedContent:b}))})},[t,c,s.path,g,e]);const f=o.useCallback(n=>t?j.evaluateCondition(n,s,t):!1,[t,s]);return{node:t,navigateTo:y,revealNodeConnection:x,engageWithAttractor:w,applyNodeTransformation:E,evaluateCondition:f,neighbors:R,revisitCount:z,transformedContent:d,newlyTransformed:C,appliedTransformations:u}};function Q(l){return l?[l.includes("[object Object]"),l.includes("undefined"),l.includes('<span class="glitch-text"><span class="glitch-text">'),l.match(/<<\*\*span\*\*/g),l.length<10,l.split("<span").length>10].some(u=>u):!0}function U(l){if(!l)return"";try{let e=l;return e=e.replace(/perspective shift:\s*\w+\s*→\s*\w+\.?/gi,""),e=e.replace(/\[TEMPORAL_MARKER:[^\]]+\]/gi,""),e=e.replace(/strange attractor resonance:\s*[.\d/()]+\s*\w*/gi,""),e=e.replace(/\[(?:PATTERN_DETECTED|ANALYSIS_COMPLETE|DATA_INTEGRITY)[^[\]]*\]/gi,""),e=e.replace(/character perspective shift/gi,""),e=e.replace(/\(stable\)s\.?/gi,""),e=e.replace(/\(unstable\)\.?/gi,""),e=e.replace(/\([\w\s]+\)[a-z]\.?/gi,""),e=e.replace(/\s+/g," "),e=e.replace(/([a-z])([A-Z])/g,"$1 $2"),e=e.replace(/([a-z])through\b/gi,"$1 through"),e=e.replace(/([a-z])and\b/gi,"$1 and"),e=e.replace(/\s*\.\s*\./g,"."),e=e.replace(/\s*,\s*,/g,","),e=e.replace(/\s*;\s*;/g,";"),e=e.replace(/\s+([.,;!?])/g,"$1"),e=e.replace(/\n\s*\n\s*\n/g,`

`),e=e.split(`
`).map(u=>u.trim()).join(`
`),e=e.trim(),console.log(`[ContentSanitizer] Final text cleanup: ${l.length} → ${e.length} characters`),e}catch(e){return console.error("[ContentSanitizer] Error in final text cleanup:",e),l}}const X=({children:l,transformations:e,isNewlyTransformed:u,nodeId:m})=>{const C=o.useRef(null),N=o.useRef(null),[p,$]=o.useState("idle"),[S,c]=o.useState(e.length),[t,g]=o.useState(0),[z,s]=o.useState(null),[y,x]=o.useState(!0);o.useEffect(()=>{if(t<3){const a=setTimeout(()=>{g(d=>d+1),console.log(`[AnimationContainer] Forced re-render for node: ${m}, attempt: ${t+1}`)},100);return()=>clearTimeout(a)}},[m,t]),o.useEffect(()=>{if(u){$("entering");const a=setTimeout(()=>{$("active")},1e3);return()=>clearTimeout(a)}},[u,e]),o.useEffect(()=>{$("idle"),c(e.length),console.log(`[AnimationContainer] Node changed to: ${m}, transformations: ${e.length}`)},[m,e.length]),o.useLayoutEffect(()=>{if(!C.current)return;const a=()=>{if(!C.current)return;const r=window.getComputedStyle(C.current),i=C.current.getBoundingClientRect(),v={width:i.width,height:i.height,visibility:r.visibility,display:r.display,opacity:r.opacity,position:r.position,zIndex:r.zIndex,overflow:r.overflow};s(v);const h=i.width>0&&i.height>0&&r.visibility!=="hidden"&&r.display!=="none"&&parseFloat(r.opacity)>0;x(h),y!==h&&console.log(`[AnimationContainer] Content visibility changed to: ${h?"visible":"hidden"}`,{nodeId:m,transformations:e.length,animationState:p,measurements:v})};a();const d=setTimeout(a,1100);let f=null;const n=new MutationObserver(r=>{r.length>2&&console.log(`[AnimationContainer] DOM mutations detected: ${r.length}`),f&&clearTimeout(f),f=window.setTimeout(()=>{a(),f=null},500)});return n.observe(C.current,{attributes:!0,childList:!0,subtree:!1}),()=>{clearTimeout(d),n.disconnect()}},[m,e,p,y]);const w=()=>{if(p==="idle")return"";const a=e.some(n=>n.type==="replace"),d=e.some(n=>n.type==="emphasize"),f=e.some(n=>n.type==="expand");return p==="entering"?a?"narramorph-container-replace-active":d?"narramorph-container-emphasis-active":f?"narramorph-container-expand-active":"narramorph-container-transform-active":"narramorph-container-active"},E=()=>{if(e.length===0)return"";const a={};e.forEach(f=>{a[f.type]=(a[f.type]||0)+1});const d=[];return a.replace&&d.push(`${a.replace} replacements`),a.emphasize&&d.push(`${a.emphasize} emphasis`),a.expand&&d.push(`${a.expand} expansions`),a.fragment&&d.push(`${a.fragment} fragmentations`),a.metaComment&&d.push(`${a.metaComment} comments`),d.join(", ")},R=e.length!==S;return o.useEffect(()=>{u&&console.log(`[AnimationContainer] Animation started for node: ${m}`,{transformations:e.length,animationState:p,contentVisible:y})},[u,m,e.length,p,y]),T.jsxs("div",{ref:C,className:`narramorph-animation-container ${w()}`,"data-transformation-count":e.length,"data-newly-transformed":u,"data-animation-state":p,"data-visible":y,"data-render-attempt":t,style:{overflow:"visible",minHeight:"150px",position:"relative",visibility:"visible",display:"block",opacity:1},children:[e.length>0&&T.jsxs("div",{className:`narramorph-transformation-indicator ${u?"active":""}`,title:E(),children:[T.jsx("span",{className:"transformation-count",children:e.length}),R&&T.jsxs("span",{className:"transformation-change-indicator",children:[e.length>S?"+":"",e.length-S]})]}),T.jsx("div",{ref:N,className:"narramorph-animation-content",style:{position:"relative",visibility:"visible",display:"block",opacity:1,minHeight:"100px"},children:t===0?T.jsx("div",{className:"animation-placeholder",style:{padding:"20px",textAlign:"center"},children:T.jsx("p",{children:"Preparing narrative..."})}):l}),!1]})};export{X as T,U as f,Q as i,Z as u};
//# sourceMappingURL=narramorph-BlMiJuN1.js.map
