import{j as l}from"./three-vendor-rJ5vKMTC.js";import{b as s,j as _}from"./react-vendor-DaKsb8LL.js";import{u as z,T as K}from"./narramorph-Cw55D6_f.js";import{k as q}from"./constellation-CzSJAdlk.js";const Q=s.memo(({nodeId:y,onVisibilityChange:h})=>{const{node:n,transformedContent:b,newlyTransformed:C,appliedTransformations:u}=z(y),m=s.useRef(null),d=s.useRef(null);s.useRef(null);const w=s.useRef(Date.now()),x=s.useRef(0),R=s.useRef(!0),[D,E]=s.useState(0),[i,L]=s.useState(!0),[H,P]=s.useState(null),[B,v]=s.useState({renderTime:0,transformationsCount:0,visibilityChanges:0,deferredTransformations:0}),[j,k]=s.useState([]);_(e=>e.reader.path),s.useEffect(()=>{const e=r=>{r.message&&(r.message.includes("WebGL context lost")||r.message.includes("THREE.WebGLRenderer"))&&(console.error("[NarramorphRenderer] WebGL context loss detected!",r.message),P(new Error(r.message)))};return window.addEventListener("error",e),()=>{window.removeEventListener("error",e)}},[i,h]);const T=s.useCallback((e,r,t)=>{if(!t||!m.current)return!1;const o=Date.now()-w.current,f=x.current>3&&o<15e3;return i!==e&&o>3e3&&!f&&r===i},[i]),S=s.useCallback((e,r)=>{r&&(w.current=Date.now(),x.current+=1,L(e),setTimeout(()=>{r&&(x.current=0)},15e3),h&&(console.log("[NarramorphRenderer] Calling onVisibilityChange:",e,"Previous:",i),h(e)),v(t=>({...t,visibilityChanges:t.visibilityChanges+1})),n!=null&&n.id&&q.setContentVisibility(n.id,e,n.id===y?2:1),e&&E(t=>t+1))},[i,h,n==null?void 0:n.id,y]),N=s.useCallback((e,r,t)=>{var o;if(!t)return;(((o=r[0])==null?void 0:o.isIntersecting)??!0)===e?S(e,t):console.log("[NarramorphRenderer] Visibility state inconsistent - ignoring change")},[S]),A=s.useCallback((e,r,t)=>{T(e,R.current,t)&&setTimeout(()=>{N(e,r,t)},500)},[T,N]),$=s.useCallback((e,r,t)=>{const a=e.getAttribute("data-transform-type"),o=e.textContent||"",f=r.find(p=>p.type===a&&o.includes(p.selector||"")&&t.includes(`${p.type}-${p.selector}`));if(!f)return;e.classList.add("narramorph-transform-new");const c={replace:"narramorph-replaced",fragment:"narramorph-fragmented",expand:"narramorph-expanded",emphasize:`narramorph-emphasis-${f.emphasis||"color"}`,metaComment:"narramorph-commented"}[a];c&&e.classList.add(c),setTimeout(()=>{e.classList.remove("narramorph-transform-new")},2e3)},[]),G=s.useCallback((e,r,t)=>{e.forEach(a=>{$(a,r,t)})},[$]),W=s.useCallback((e,r=5)=>{const t=[];for(let a=0;a<e.length;a+=r)t.push(Array.from(e).slice(a,a+r));return t},[]),I=s.useCallback((e,r,t,a=50)=>{const o=W(e,5),f=5;o.forEach((g,c)=>{setTimeout(()=>{G(g,r,t)},c*a*f)})},[W,G]);s.useEffect(()=>{if(!m.current)return;d.current&&(d.current.disconnect(),d.current=null),d.current||(L(!0),h&&h(!0));let e=null,r=!0;return d.current=new IntersectionObserver(t=>{var o;if(!r||!m.current)return;const a=((o=t[0])==null?void 0:o.isIntersecting)??!0;R.current=i,T(a,R.current,r)&&(e&&window.clearTimeout(e),console.log(`[NarramorphRenderer] Potential visibility change detected: ${i} -> ${a}`),e=window.setTimeout(()=>{A(a,t,r),e=null},1200))},{root:null,rootMargin:"500px",threshold:.01}),m.current&&r&&d.current.observe(m.current),()=>{if(r=!1,e&&(window.clearTimeout(e),e=null),d.current){try{d.current.disconnect(),console.log("[NarramorphRenderer] Intersection observer disconnected cleanly")}catch(t){console.warn("[NarramorphRenderer] Error disconnecting observer:",t)}d.current=null}}},[n==null?void 0:n.id,y,i,h,A,T]);const M=s.useMemo(()=>{if(!u.length)return[];if(i)return u;const e=u.filter(r=>r.priority==="high"||r.applyImmediately===!0);return v(r=>({...r,deferredTransformations:u.length-e.length})),e},[u,i]);return s.useEffect(()=>{if(!C||!m.current||!i)return;const e=performance.now();E(r=>r+1),requestAnimationFrame(()=>{var g;const r=(g=m.current)==null?void 0:g.querySelectorAll("[data-transform-type]");if(!r||r.length===0)return;const t=u.map(c=>`${c.type}-${c.selector}`),a=t.filter(c=>!j.includes(c));if(a.length===0)return;const o={replace:[],fragment:[],expand:[],emphasize:[],metaComment:[]};r.forEach(c=>{const p=c.getAttribute("data-transform-type");p&&p in o&&o[p].push(c)}),Object.values(o).forEach(c=>{I(c,u,a)}),k(t);const f=performance.now();v(c=>({...c,renderTime:f-e,transformationsCount:u.length}))})},[C,u,j,i,I]),s.useEffect(()=>{n!=null&&n.id&&(k([]),v({renderTime:0,transformationsCount:0,visibilityChanges:0,deferredTransformations:0}))},[n==null?void 0:n.id]),H?(console.error("[NarramorphRenderer] Rendering in error state due to WebGL issue"),l.jsxs("div",{className:"narramorph-error",children:[l.jsx("p",{children:"Advanced rendering unavailable"}),l.jsx("div",{dangerouslySetInnerHTML:{__html:(n==null?void 0:n.currentContent)||"Content unavailable"}})]})):!n||!b?l.jsx("div",{className:"narramorph-loading",children:"Loading content..."}):l.jsxs("div",{className:`narramorph-container ${i?"is-visible":"is-hidden"}`,"data-node-id":n.id,"data-visibility":i?"visible":"hidden",style:{display:"block",visibility:"visible",position:"relative",minHeight:"200px"},children:[l.jsx(K,{transformations:M,isNewlyTransformed:C,nodeId:n.id,children:l.jsxs("div",{ref:m,className:`narramorph-content ${i?"is-visible":"is-hidden"}`,"data-transformations-count":M.length,"data-node-id":n.id,"data-visit-count":n.visitCount,style:{display:"block",visibility:"visible",position:"relative"},children:[!b&&l.jsxs("div",{className:"narramorph-loading-indicator",style:{margin:"20px 0"},children:[l.jsx("div",{className:"loading-spinner"}),l.jsx("p",{children:"Preparing narrative transformations..."})]}),b&&l.jsx("div",{dangerouslySetInnerHTML:{__html:b},style:{opacity:i?1:.99,transition:"opacity 0.3s ease-in"}})]})}),!1]},D)});export{Q as default};
//# sourceMappingURL=NarramorphRenderer-CE8Mlc4A.js.map
